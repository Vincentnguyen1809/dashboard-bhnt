<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Master Plan: D·ªãch V·ª• Marketing BHNT ‚Äî Final</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- New TaskItem and TaskList components -->
  <script src="./TaskItem.js"></script>
  <script src="./TaskList.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f5f5f5; }
    .chart-container { position: relative; width:100%; max-width:350px; margin:0 auto; height:300px; max-height:350px; }
    .nav-link { display:flex; align-items:center; padding:0.625rem 1rem; border-radius:0.375rem; color:#374151; font-weight:500; font-size:0.9375rem; transition:all .15s; cursor:pointer; margin-bottom:0.25rem; }
    .nav-link:hover{ background:#e5e7eb; }
    .nav-link.active{ background:#dbeafe; color:#1e40af; }
    .nav-link .emoji{ font-size:1.25rem; margin-right:0.75rem; }
    .sidebar{ transform:translateX(-100%); transition: transform .3s; position:fixed; inset:0 auto 0 0; z-index:30; background:#fafafa; border-right:1px solid #e5e7eb; width:16rem; }
    .sidebar.open{ transform:translateX(0); }
    @media (min-width:1024px){ .sidebar{ transform:none; position:static; } }
    .task-card{ background:#fff; border-radius:0.5rem; padding:1.25rem; margin-bottom:1rem; border:1px solid #e5e7eb; transition:box-shadow .2s; }
    .task-card:hover{ box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .task-card.completed{ background:#f0fdf4; border-color:#86efac; }
    .task-card.overdue{ background:#fef2f2; border-color:#fca5a5; }
    .task-header{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.75rem; }
    .task-title{ font-size:1rem; font-weight:600; color:#111827; flex:1; padding-right:1rem; }
    .task-status{ font-size:0.6875rem; font-weight:600; padding:0.25rem 0.625rem; border-radius:0.25rem; text-transform:uppercase; letter-spacing:.025em; white-space:nowrap; }
    .status-pending{ background:#f3f4f6; color:#6b7280; }
    .status-completed{ background:#dcfce7; color:#166534; }
    .status-overdue{ background:#fee2e2; color:#991b1b; }
    .task-details{ margin-top:0.75rem; }
    .task-details-label{ font-weight:600; font-size:0.875rem; color:#374151; margin-bottom:0.5rem; }
    .task-detail-list{ list-style:disc; margin-left:1.25rem; font-size:0.875rem; color:#6b7280; line-height:1.6; }
    .task-detail-list li{ margin-bottom:0.375rem; }
    .task-meta{ font-size:0.8125rem; color:#9ca3af; margin-top:0.75rem; display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; }
    .deadline-countdown{ font-weight:600; margin-left:0.25rem; display:inline-flex; align-items:center; gap:0.25rem; }
    .deadline-safe{ color:#0f766e; }
    .deadline-warning{ color:#b45309; }
    .deadline-danger{ color:#b91c1c; }
    .task-action-area{ margin-top:1rem; padding-top:1rem; border-top:1px solid #f3f4f6; }
    .completed-comment-wrapper{ margin-top:0.75rem; padding:0.75rem; background:#f9fafb; border-radius:0.5rem; border:1px solid #e5e7eb; }
    .completed-comment.collapsible .comment-content{ max-height:3em; overflow:hidden; position:relative; }
    .completed-comment.collapsible.expanded .comment-content{ max-height:none; }
    .see-more-btn{ margin-top:0.5rem; color:#2563eb; font-size:0.875rem; font-weight:500; cursor:pointer; background:none; border:none; padding:0; text-decoration:underline; }
    .see-more-btn:hover{ color:#1d4ed8; }
    .task-input-group{ display:flex; gap:0.5rem; align-items:center; width:100%; flex-wrap:nowrap; }
    .task-complete-btn{ margin-left:auto; }
    .task-link-input{ flex:1; min-width:0; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.5rem 0.75rem; font-size:1rem; color:#374151; transition:.2s; }
    .task-link-input:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .task-link-input:disabled{ background:#f9fafb; color:#9ca3af; cursor:not-allowed; }
    .task-btn{ padding:0.5rem 1rem; font-size:0.875rem; font-weight:500; border-radius:0.375rem; transition:.2s; cursor:pointer; border:none; white-space:nowrap; }
    .task-btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn-complete{ background:#10b981; color:#fff; }
    .btn-complete:hover:not(:disabled){ background:#059669; }
    .btn-view{ background:#0ea5e9; color:#fff; }
    .btn-view:hover:not(:disabled){ background:#0284c7; }
    .task-btn.btn-secondary{ background:#e5e7eb; color:#1f2937; }
    .task-btn.btn-secondary:hover:not(:disabled){ background:#d1d5db; }
    .task-btn.btn-danger{ background:#ef4444; color:#fff; }
    .task-btn.btn-danger:hover:not(:disabled){ background:#dc2626; }
    .task-btn.btn-outline{ background:#fff; color:#1f2937; border:1px solid #d1d5db; }
    .task-btn.btn-outline:hover:not(:disabled){ background:#f3f4f6; }
    .task-completed-actions{ display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
    .task-icon-btn{ width:2.5rem; height:2.5rem; border-radius:0.375rem; border:1px solid #d1d5db; background:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.2s; }
    .task-icon-btn:hover{ background:#e5e7eb; }
    .task-icon-btn:disabled{ cursor:not-allowed; opacity:.5; }
    .task-icon-btn svg{ width:1.1rem; height:1.1rem; color:#374151; }
    .edit-dropdown-wrapper{ position:relative; display:inline-block; }
    .edit-dropdown-menu{ display:none; position:absolute; top:100%; right:0; margin-top:0.25rem; background:#fff; border:1px solid #e5e7eb; border-radius:0.375rem; box-shadow:0 4px 6px -1px rgba(0,0,0,.1); min-width:150px; z-index:10; }
    .edit-dropdown-menu.show{ display:block; }
    .dropdown-item{ padding:0.625rem 1rem; font-size:0.875rem; color:#374151; cursor:pointer; display:flex; align-items:center; gap:0.5rem; }
    .dropdown-item:hover{ background:#f3f4f6; }
    .dropdown-item.delete{ color:#dc2626; }
    .dropdown-item.delete:hover{ background:#fef2f2; }
    .btn-cancel{ background:#e5e7eb; color:#374151; }
    .btn-cancel:hover{ background:#d1d5db; }
    .progress-bar{ background:#e5e7eb; border-radius:9999px; overflow:hidden; height:0.75rem; }
    .progress-bar-inner{ background:#3b82f6; height:100%; transition:width .5s; }
    .section-title{ font-size:1.875rem; font-weight:700; color:#111827; margin-bottom:0.75rem; }
    .section-subtitle{ font-size:1rem; color:#6b7280; margin-bottom:2rem; line-height:1.5; }
    .phase-title{ font-size:1.25rem; font-weight:600; color:#1e40af; margin-top:2rem; margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:2px solid #dbeafe; }
    .notes-textarea{ width:100%; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.75rem; font-size:1rem; resize:none; min-height:120px; font-family:inherit; }
    .notes-textarea:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .notes-table{ width:100%; border-collapse:collapse; font-size:0.875rem; }
    .notes-table th{ background:#f9fafb; padding:0.75rem; text-align:left; font-weight:600; color:#374151; border-bottom:2px solid #e5e7eb; }
    .notes-table td{ padding:0.75rem; border-bottom:1px solid #f3f4f6; color:#6b7280; }
    .notes-table tr:hover{ background:#f9fafb; }
    .custom-type-item{ display:inline-flex; align-items:center; gap:0.375rem; padding:0.25rem 0.75rem; background:#dbeafe; border-radius:9999px; margin:0.25rem; font-size:0.8125rem; color:#1e40af; }
    .note-type-dropdown{ position:relative; margin-top:0.75rem; }
    .note-type-trigger{ width:100%; display:flex; justify-content:space-between; align-items:center; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.6rem 0.75rem; background:#fff; font-size:0.875rem; color:#374151; cursor:pointer; transition:.2s; }
    .note-type-trigger:hover{ border-color:#3b82f6; }
    .note-type-trigger svg{ width:1rem; height:1rem; color:#6b7280; transition:transform .2s; }
    .note-type-dropdown.open .note-type-trigger svg{ transform:rotate(180deg); }
    .note-type-panel{ position:absolute; inset:calc(100% + 0.25rem) 0 auto 0; background:#fff; border:1px solid #e5e7eb; border-radius:0.5rem; box-shadow:0 10px 25px -10px rgba(15,23,42,.35); padding:0.75rem; z-index:30; display:none; }
    .note-type-dropdown.open .note-type-panel{ display:block; }
    .note-type-new{ display:flex; gap:0.5rem; margin-bottom:0.75rem; }
    .note-type-new input{ flex:1; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.45rem 0.6rem; font-size:1rem; }
    .note-type-new input:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.12); }
    .note-type-options{ max-height:220px; overflow-y:auto; display:flex; flex-direction:column; gap:0.35rem; }
    .note-type-option{ display:flex; justify-content:space-between; align-items:center; padding:0.45rem 0.6rem; border-radius:0.375rem; background:#f9fafb; font-size:0.875rem; cursor:pointer; transition:background .2s, color .2s, box-shadow .2s; outline:none; }
    .note-type-option:hover, .note-type-option:focus{ background:#e0f2fe; color:#1d4ed8; box-shadow:inset 0 0 0 1px #bfdbfe; }
    .note-type-option.active{ background:#dbeafe; color:#1d4ed8; font-weight:600; }
    .note-type-option span{ pointer-events:none; }
    .note-type-remove{ border:none; background:none; color:#ef4444; font-size:1rem; cursor:pointer; padding:0.125rem; line-height:1; }
    .note-type-remove:hover{ color:#b91c1c; }
    .note-type-feedback{ min-height:1rem; margin-top:0.25rem; font-size:0.75rem; display:block; }
    .note-type-feedback.hidden{ display:none; }
    .task-link-feedback{ font-size:0.75rem; margin-top:0.35rem; color:#b91c1c; display:none; }
    .task-link-feedback.show{ display:block; }
    .task-log-link{ color:#2563eb; font-weight:600; text-decoration:none; }
    .task-log-link:hover{ text-decoration:underline; }

    /* Drag-and-Drop Styles */
    .sortable-ghost{ opacity:0.4; background:#e0e7ff; border:2px dashed #6366f1; }
    .sortable-chosen{ transform:scale(1.02); box-shadow:0 8px 16px rgba(0,0,0,0.15); cursor:grabbing; }
    .sortable-drag{ opacity:1; }
    .draggable-disabled .task-header{ cursor:default !important; }
    [data-draggable="true"] .task-header{ cursor:move; user-select:none; }
    [data-draggable="false"] .task-header{ cursor:default; }
    #dynamic-menu-tasks-container{ min-height:100px; }
    .activity-table th{ white-space:nowrap; }
    #cover-page{ transition:background 0.3s ease-in-out; }
    #cover-page.cover-has-image{ background-color:transparent; }
    #cover-page.cover-has-color{ background-image:none !important; }
    .filter-container{ display:flex; flex-wrap:wrap; align-items:flex-end; gap:1rem; margin-bottom:1.5rem; }
    .filter-field{ display:flex; flex-direction:column; gap:0.35rem; }
    .filter-actions{ display:flex; align-items:flex-end; }
    .filter-input, .form-select{ width:100%; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.5rem 0.75rem; font-size:1rem; background:#fff; }
    .filter-input:focus, .form-select:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .time-filter-wrapper{ position:relative; }
    .custom-date-popover{ position:absolute; inset:auto auto auto 0; top:calc(100% + 0.5rem); width:18rem; max-width:90vw; background:#fff; border:1px solid #e5e7eb; border-radius:0.5rem; padding:1rem; box-shadow:0 20px 25px -15px rgba(15,23,42,.4); z-index:40; }
    .custom-date-popover.hidden{ display:none; }
    .custom-date-popover .filter-field{ gap:0.25rem; }
    .note-content-clamp{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; white-space:pre-line; }
    .note-read-more-btn{ margin-top:0.5rem; display:inline-flex; align-items:center; gap:0.35rem; font-size:0.8125rem; color:#2563eb; font-weight:600; }
    .note-read-more-btn:hover{ text-decoration:underline; }
    .note-modal-overlay{ display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:60; justify-content:flex-end; }
    .note-modal-overlay.active{ display:flex; }
    .note-modal-panel{ background:#fff; width:100%; max-width:none; height:100%; overflow-y:auto; padding:2rem 1.75rem; box-shadow:-8px 0 30px rgba(15,23,42,.25); transform:translateX(100%); transition:transform .3s ease-in-out; }
    @media (min-width:768px){
      .note-modal-panel{ width:25vw; max-width:24rem; }
    }
    .note-modal-overlay.active .note-modal-panel{ transform:translateX(0); }
    .note-modal-close{ background:none; border:none; font-size:1.5rem; line-height:1; cursor:pointer; color:#4b5563; }
    .note-attachment-chip{ margin-top:0.5rem; display:inline-flex; align-items:center; gap:0.35rem; font-size:0.8125rem; color:#0f172a; background:#e0f2fe; border-radius:9999px; padding:0.25rem 0.75rem; }
    .sidebar-logo{ max-height:2.5rem; width:auto; }
    .modal-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; align-items:center; justify-content:center; backdrop-filter: blur(2px); }
    .modal-overlay.active{ display:flex; }
    .modal-content{ background:#fff; padding:1.75rem; border-radius:0.75rem; max-width:420px; width:90%; box-shadow:0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04); }
    .modal-title{ font-size:1.25rem; font-weight:700; color:#111827; margin-bottom:0.75rem; }
    .modal-message{ color:#6b7280; margin-bottom:1.5rem; line-height:1.5; }
    .modal-buttons{ display:flex; gap:0.75rem; justify-content:flex-end; }
    #toast-notification{ max-width:400px; min-width:280px; }
    #toast-notification.show{ display:block; animation:slideInRight 0.3s ease-out; }
    #toast-notification.hide{ animation:slideOutRight 0.3s ease-in; }
    @keyframes slideInRight{ from{ opacity:0; transform:translateX(100%); } to{ opacity:1; transform:translateX(0); } }
    @keyframes slideOutRight{ from{ opacity:1; transform:translateX(0); } to{ opacity:0; transform:translateX(100%); } }
    .toast-content{ display:flex; align-items:center; gap:0.75rem; padding:1rem 1.25rem; border-radius:0.5rem; box-shadow:0 10px 25px -5px rgba(0,0,0,.15); background:#fff; border-left:4px solid; }
    .toast-content.success{ border-left-color:#10b981; background:#f0fdf4; }
    .toast-content.error{ border-left-color:#ef4444; background:#fef2f2; }
    .toast-icon{ font-size:1.25rem; line-height:1; }
    .toast-message{ flex:1; font-size:0.875rem; font-weight:500; }
    .toast-content.success .toast-message{ color:#166534; }
    .toast-content.error .toast-message{ color:#991b1b; }
    .card-section{ background:#fff; border-radius:0.5rem; padding:1.5rem; margin-bottom:1.5rem; border:1px solid #e5e7eb; }
    .card-title{ font-size:1.125rem; font-weight:600; color:#111827; }
    .stat-card{ background:#fff; border-radius:0.5rem; padding:1.5rem; border:1px solid #e5e7eb; }
    .note-form-footer{ display:flex; flex-direction:column; gap:1rem; margin-top:1.5rem; }
    .note-form-meta{ display:flex; flex-direction:column; gap:1rem; width:100%; }
    .note-meta-group{ display:flex; flex-direction:column; gap:0.5rem; }
    @media (min-width:768px){
      .note-form-footer{ flex-direction:row; align-items:center; }
      .note-form-meta{ flex-direction:row; align-items:center; gap:1.5rem; }
      .note-meta-group{ min-width:220px; }
    }
    .content-header-right{ margin-left:auto; display:flex; align-items:flex-start; justify-content:flex-end; gap:1.5rem; flex-wrap:wrap; flex:1 1 auto; }
    .content-header-title{ min-width:180px; text-align:left; }
    .notification-wrapper{ position:relative; }
    .notification-bell{ position:relative; width:2.5rem; height:2.5rem; border-radius:9999px; border:1px solid #e5e7eb; background:#fff; display:inline-flex; align-items:center; justify-content:center; color:#1f2937; transition:background .2s, color .2s; }
    .notification-bell:hover{ background:#f3f4f6; color:#111827; }
    .notification-badge{ position:absolute; top:-0.15rem; right:-0.15rem; background:#ef4444; color:#fff; font-size:0.65rem; font-weight:700; border-radius:9999px; padding:0.15rem 0.4rem; display:none; }
    .notification-badge.show{ display:inline-flex; }
    .notification-dropdown{ position:absolute; right:0; margin-top:0.75rem; width:20rem; max-height:20rem; overflow-y:auto; background:#fff; border:1px solid #e5e7eb; border-radius:0.75rem; box-shadow:0 20px 30px -15px rgba(15,23,42,.35); z-index:60; display:none; }
    .notification-dropdown.show{ display:block; }
    @media (max-width:640px){
      .notification-dropdown{ position:fixed; right:0.5rem; left:0.5rem; width:auto; max-width:calc(100vw - 1rem); margin-top:0.5rem; }
    }
    .notification-header{ padding:0.75rem 1rem; border-bottom:1px solid #f3f4f6; display:flex; align-items:center; justify-content:space-between; }
    .notification-list{ list-style:none; margin:0; padding:0; }
    .notification-item{ padding:0.75rem 1rem; border-bottom:1px solid #f3f4f6; display:flex; flex-direction:column; gap:0.35rem; cursor:pointer; transition:background .2s; }
    .notification-item:hover{ background:#f3f4f6; }
    .notification-item.unread{ background:#f8fafc; }
    .notification-item.unread:hover{ background:#e0f2fe; }
    .notification-item:last-child{ border-bottom:none; }
    .notification-time{ font-size:0.75rem; color:#9ca3af; }
    .mark-all-read{ font-size:0.75rem; font-weight:600; color:#2563eb; cursor:pointer; background:none; border:none; padding:0; }
    .mark-all-read:hover{ text-decoration:underline; }
    .notification-empty{ padding:1rem; text-align:center; color:#6b7280; font-size:0.875rem; display:none; }
    .settings-page-grid{ display:grid; grid-template-columns:1fr; gap:1.5rem; }
    .settings-group-card{ background:#f9fafb; border:1px solid #e5e7eb; border-radius:0.75rem; padding:1.25rem; display:flex; flex-direction:column; gap:1rem; }
    .settings-group-title{ font-size:1rem; font-weight:600; color:#1f2937; }
    .settings-file-control{ display:flex; flex-direction:column; gap:0.75rem; }
    .settings-file-default{ display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap; }
    .settings-file-active{ display:flex; }
    .settings-file-active.hidden{ display:none; }
    .settings-file-selected{ display:flex; align-items:center; gap:1rem; flex-wrap:wrap; }
    .settings-file-actions{ display:flex; align-items:center; gap:1rem; }
    .settings-file-action{ font-size:0.8125rem; font-weight:600; cursor:pointer; background:none; border:none; padding:0; }
    .settings-file-action.text-blue{ color:#2563eb; }
    .settings-file-action.text-red{ color:#dc2626; }
    .settings-file-action:hover{ text-decoration:underline; }
    .settings-selected-name{ font-size:0.875rem; font-weight:600; color:#1f2937; max-width:12rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    @media (min-width:1024px){
      .settings-page-grid{ grid-template-columns:1fr 1fr; }
    }
    @media (max-width:640px){
      .content-header-right{ width:100%; }
    }
    .settings-preview-box{ width:6rem; height:6rem; border:1px dashed #cbd5f5; border-radius:0.75rem; display:flex; align-items:center; justify-content:center; background:#f8fafc; overflow:hidden; }
    .settings-preview-box img{ width:100%; height:100%; object-fit:contain; }
    .settings-helper{ font-size:0.75rem; color:#6b7280; }
    @media (max-width:640px){
      .custom-date-popover{ width:100%; }
    }
    @media (max-width:768px){
      .card-section, .stat-card{ padding:1rem; }
      #toast-notification{ right:1rem; left:1rem; max-width:none; }
    }
    /* Plan Manager Styles */
    .menu-item{ background:#fff; border:1px solid #e5e7eb; border-radius:0.5rem; padding:1rem; margin-bottom:0.75rem; cursor:move; }
    .menu-item.dragging{ opacity:0.5; }
    .menu-item-header{ display:flex; align-items:center; justify-content:space-between; }
    .menu-item-left{ display:flex; align-items:center; gap:1rem; flex:1; }
    .menu-item-icon{ font-size:1.5rem; }
    .menu-item-name{ font-size:1rem; font-weight:600; color:#1f2937; }
    .menu-item-type{ font-size:0.75rem; color:#6b7280; background:#f3f4f6; padding:0.25rem 0.5rem; border-radius:0.25rem; }
    .menu-item-actions{ display:flex; gap:0.5rem; }
    .menu-item-btn{ padding:0.375rem 0.75rem; font-size:0.8125rem; border-radius:0.375rem; border:1px solid #d1d5db; background:#fff; cursor:pointer; transition:all .2s; }
    .menu-item-btn:hover{ background:#f3f4f6; }
    .menu-item-btn.danger{ color:#dc2626; border-color:#fca5a5; }
    .menu-item-btn.danger:hover{ background:#fef2f2; }
    .tasks-list{ margin-top:1rem; padding-top:1rem; border-top:1px solid #e5e7eb; display:none; }
    .tasks-list.expanded{ display:block; }
    .task-item{ background:#f9fafb; border:1px solid #e5e7eb; border-radius:0.375rem; padding:0.875rem; margin-bottom:0.5rem; }
    .task-item-header{ display:flex; align-items:start; justify-content:space-between; gap:1rem; }
    .task-item-title{ font-size:0.9375rem; font-weight:500; color:#374151; flex:1; }
    .task-item-meta{ font-size:0.8125rem; color:#6b7280; margin-top:0.5rem; }
    .task-item-actions{ display:flex; gap:0.5rem; }
    .task-item-btn{ padding:0.25rem 0.625rem; font-size:0.75rem; border-radius:0.25rem; border:1px solid #d1d5db; background:#fff; cursor:pointer; transition:all .2s; }
    .task-item-btn:hover{ background:#e5e7eb; }
    .task-item-btn.danger{ color:#dc2626; }
    .task-item-btn.danger:hover{ background:#fef2f2; border-color:#fca5a5; }
    .assignee-chip{ display:inline-flex; align-items:center; gap:0.5rem; background:#dbeafe; color:#1e40af; padding:0.375rem 0.75rem; border-radius:9999px; font-size:0.8125rem; font-weight:500; }
    .assignee-chip button{ background:none; border:none; color:#1e40af; cursor:pointer; font-size:1rem; line-height:1; padding:0; margin-left:0.25rem; }
    .assignee-chip button:hover{ color:#1e3a8a; }
    .drag-handle{ cursor:grab; color:#9ca3af; font-size:1.25rem; padding:0.25rem; }
    .drag-handle:active{ cursor:grabbing; }
    .toggle-tasks-btn{ font-size:0.875rem; color:#2563eb; background:none; border:none; cursor:pointer; padding:0.5rem 0; }
    .toggle-tasks-btn:hover{ text-decoration:underline; }

    /* Enhanced Mobile Responsiveness */
    @media (max-width: 768px) {
      .stat-card, .card-section { padding: 1rem; margin-bottom: 1rem; }
      .modal-content { max-width: 95%; margin: 1rem; padding: 1.25rem; }
      .task-header { flex-direction: column; align-items: flex-start; }
      .task-status { margin-top: 0.5rem; }
      .chart-container { max-width: 100%; height: 250px; }
      header { padding: 0.75rem 1rem; }
      .content-header-title { font-size: 0.875rem !important; }
      main { padding: 0.5rem !important; }
      .p-6 { padding: 1rem !important; }
      .grid { gap: 1rem !important; }
      .sidebar-logo { max-height: 2rem; }
      #sidebar-user-profile { padding: 0.75rem; }
      .task-card { padding: 1rem; }
      .modal-buttons { flex-direction: column; }
      .modal-buttons button { width: 100%; }
      .filter-container { gap: 0.75rem; }
      .filter-field { min-width: 100%; }
      .overflow-x-auto { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .task-completed-actions { flex-wrap: wrap; justify-content: flex-start; }
      .settings-page-grid { grid-template-columns: 1fr; }
      .task-meta { flex-wrap: wrap; gap: 0.375rem; }
      textarea { font-size: 1rem; } /* Prevent zoom on iOS */
      input, select { font-size: 1rem; } /* Prevent zoom on iOS */
    }
    @media (max-width: 640px) {
      .task-title { font-size: 0.875rem; }
      .task-meta { font-size: 0.75rem; }
      .nav-link { padding: 0.5rem 0.75rem; font-size: 0.875rem; }
      .card-title { font-size: 1rem; }
      table { font-size: 0.8125rem; display: block; overflow-x: auto; white-space: nowrap; }
      th, td { padding: 0.5rem; }
      .menu-item-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
      .menu-item-actions { width: 100%; justify-content: flex-start; }
      .task-item-header { flex-direction: column; gap: 0.5rem; }
      .task-item-actions { width: 100%; }
    }
    /* Loading spinner animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="text-gray-800">
  <!-- Delete Task Modal -->
  <div id="delete-task-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="delete-task-title">
      <h3 id="delete-task-title" class="modal-title">X√°c nh·∫≠n x√≥a k·∫øt qu·∫£</h3>
      <p class="modal-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a k·∫øt qu·∫£ n√†y kh√¥ng? (Are you sure you want to delete this result?)</p>
      <div class="modal-buttons">
        <button id="cancel-delete-task-btn" class="task-btn btn-cancel">Kh√¥ng</button>
        <button id="confirm-delete-task-btn" class="task-btn" style="background-color:#ef4444; color:#fff;">C√≥</button>
      </div>
    </div>
  </div>

  <!-- Edit Options Modal -->
  <div id="edit-options-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="edit-options-title">
      <h3 id="edit-options-title" class="modal-title">Ch·ªçn h√†nh ƒë·ªông</h3>
      <p class="modal-message">B·∫°n mu·ªën l√†m g√¨ v·ªõi task ƒë√£ ho√†n th√†nh n√†y?</p>
      <div class="modal-buttons">
        <button id="btn-edit-link-option" class="task-btn btn-complete">‚úèÔ∏è Ch·ªânh s·ª≠a Link</button>
        <button id="btn-delete-result-option" class="task-btn" style="background-color:#ef4444; color:#fff;">üóëÔ∏è X√≥a K·∫øt Qu·∫£</button>
        <button id="cancel-edit-options-btn" class="task-btn btn-cancel">H·ªßy</button>
      </div>
    </div>
  </div>

  <!-- Edit Link Modal -->
  <div id="edit-link-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="edit-link-title">
      <h3 id="edit-link-title" class="modal-title">Ch·ªânh s·ª≠a link</h3>
      <p class="modal-message">Nh·∫≠p link m·ªõi cho task ƒë√£ ho√†n th√†nh:</p>
      <input type="url" id="edit-link-input" class="filter-input mb-4" placeholder="Nh·∫≠p link m·ªõi..." style="width: 100%;" />
      <div class="modal-buttons">
        <button id="cancel-edit-link-btn" class="task-btn btn-cancel">H·ªßy</button>
        <button id="confirm-edit-link-btn" class="task-btn btn-complete">L∆∞u</button>
      </div>
    </div>
  </div>

  <!-- Delete Note Modal -->
  <div id="delete-note-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="delete-note-title">
      <h3 id="delete-note-title" class="modal-title">X√°c nh·∫≠n x√≥a ghi ch√∫</h3>
      <p class="modal-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ghi ch√∫ n√†y kh√¥ng?</p>
      <div class="modal-buttons">
        <button id="cancel-delete-note-btn" class="task-btn btn-cancel">Kh√¥ng</button>
        <button id="confirm-delete-note-btn" class="task-btn" style="background-color:#ef4444; color:#fff;">C√≥</button>
      </div>
    </div>
  </div>

  <div id="note-detail-modal" class="note-modal-overlay" aria-hidden="true">
    <div class="note-modal-panel" role="dialog" aria-modal="true" aria-labelledby="note-modal-title">
      <div class="flex items-start justify-between gap-6">
        <div>
          <h3 id="note-modal-title" class="text-xl font-semibold text-slate-900">Chi ti·∫øt ghi ch√∫</h3>
          <p class="text-sm text-slate-500 mt-1">Xem to√†n b·ªô n·ªôi dung v√† t·ªáp ƒë√≠nh k√®m.</p>
        </div>
        <button id="note-modal-close" class="note-modal-close" aria-label="ƒê√≥ng">&times;</button>
      </div>
      <div id="note-modal-content" class="mt-6 text-base leading-relaxed text-slate-700 whitespace-pre-line"></div>
      <div id="note-modal-attachment" class="mt-6"></div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast-notification" class="fixed top-4 right-4 z-50 hidden transition-all duration-300 transform translate-x-0"></div>

  <!-- User Add/Edit Modal -->
  <div id="user-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" style="max-width: 500px;">
      <div class="flex items-center justify-between mb-4">
        <h3 id="user-modal-title" class="modal-title mb-0">Th√™m Ng∆∞·ªùi D√πng</h3>
        <button type="button" id="user-modal-close" class="modal-close text-gray-400 hover:text-gray-600 text-2xl leading-none" aria-label="Close">&times;</button>
      </div>
      <form id="user-form" class="space-y-4">
        <div>
          <label for="user-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input type="email" id="user-email" class="filter-input" required />
        </div>
        <div>
          <label for="user-display-name" class="block text-sm font-medium text-gray-700 mb-1">T√™n hi·ªÉn th·ªã</label>
          <input type="text" id="user-display-name" class="filter-input" required />
        </div>
        <div>
          <label for="user-password" class="block text-sm font-medium text-gray-700 mb-1">M·∫≠t kh·∫©u</label>
          <input type="password" id="user-password" class="filter-input" minlength="6" required />
          <p class="text-xs text-gray-500 mt-1">T·ªëi thi·ªÉu 6 k√Ω t·ª±</p>
        </div>
        <div>
          <label for="user-role" class="block text-sm font-medium text-gray-700 mb-1">Vai tr√≤</label>
          <select id="user-role" class="filter-input" required>
            <option value="employee">Employee</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div id="user-error-message" class="text-red-600 text-sm hidden"></div>
        <div class="modal-buttons">
          <button type="button" id="user-cancel-btn" class="task-btn btn-cancel">H·ªßy</button>
          <button type="submit" id="user-submit-btn" class="task-btn btn-complete">L∆∞u</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete User Confirmation Modal -->
  <div id="delete-user-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <h3 class="modal-title">X√°c nh·∫≠n x√≥a ng∆∞·ªùi d√πng</h3>
      <p class="modal-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
      <div class="modal-buttons">
        <button id="cancel-delete-user-btn" class="task-btn btn-cancel">Kh√¥ng</button>
        <button id="confirm-delete-user-btn" class="task-btn" style="background-color:#ef4444; color:#fff;">C√≥, X√≥a</button>
      </div>
    </div>
  </div>

  <!-- Menu Add/Edit Modal -->
  <div id="menu-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" style="max-width: 600px;">
      <h3 id="menu-modal-title" class="modal-title">Th√™m Menu M·ªõi</h3>
      <form id="menu-form" class="space-y-4">
        <div>
          <label for="menu-name" class="block text-sm font-medium text-gray-700 mb-1">T√™n Menu</label>
          <input type="text" id="menu-name" class="filter-input" placeholder="VD: Gƒê 5: Tri·ªÉn Khai" required />
        </div>
        <div>
          <label for="menu-icon" class="block text-sm font-medium text-gray-700 mb-1">Icon (Emoji)</label>
          <div class="flex gap-2">
            <input type="text" id="menu-icon" class="filter-input" placeholder="üìå" maxlength="2" required />
            <button type="button" id="emoji-picker-btn" class="task-btn btn-view px-4">Ch·ªçn Emoji</button>
          </div>
          <div id="emoji-picker" class="hidden mt-2 p-3 border border-gray-300 rounded-lg bg-white max-h-60 overflow-y-auto">
            <div class="grid grid-cols-8 gap-2 text-2xl">
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üìä</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üéØ</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üèóÔ∏è</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">‚öôÔ∏è</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üöÄ</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üìù</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üîß</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üóÇÔ∏è</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üìå</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">‚≠ê</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üíº</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üìà</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üí°</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üé®</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üì±</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üåü</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üî•</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">‚ú®</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üéÅ</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üèÜ</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üìö</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üéì</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üîî</button>
              <button type="button" class="emoji-option hover:bg-gray-100 p-2 rounded">üìß</button>
            </div>
          </div>
        </div>
        <div>
          <label for="menu-type" class="block text-sm font-medium text-gray-700 mb-1">Lo·∫°i Menu</label>
          <select id="menu-type" class="filter-input" required>
            <option value="task-list">Task List (Danh s√°ch c√¥ng vi·ªác)</option>
            <option value="external-link">External Link (Li√™n k·∫øt ngo√†i)</option>
          </select>
        </div>
        <div id="menu-slug-field">
          <label for="menu-slug" class="block text-sm font-medium text-gray-700 mb-1">URL Slug</label>
          <input type="text" id="menu-slug" class="filter-input" placeholder="VD: giaidoan5, trienkhai" pattern="[a-z0-9\-]+" title="Ch·ªâ ƒë∆∞·ª£c d√πng ch·ªØ th∆∞·ªùng, s·ªë v√† d·∫•u g·∫°ch ngang" />
          <p class="text-xs text-gray-500 mt-1">URL s·∫Ω l√†: /[slug] (VD: /giaidoan5). Ch·ªâ d√πng ch·ªØ th∆∞·ªùng, s·ªë v√† d·∫•u g·∫°ch ngang.</p>
        </div>
        <div id="menu-link-field" class="hidden">
          <label for="menu-link" class="block text-sm font-medium text-gray-700 mb-1">URL Li√™n k·∫øt</label>
          <input type="url" id="menu-link" class="filter-input" placeholder="https://example.com" />
        </div>
        <div id="menu-error-message" class="text-red-600 text-sm hidden"></div>
        <div class="modal-buttons">
          <button type="button" id="menu-cancel-btn" class="task-btn btn-cancel">H·ªßy</button>
          <button type="submit" id="menu-submit-btn" class="task-btn btn-complete">L∆∞u</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Menu Confirmation Modal -->
  <div id="delete-menu-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <h3 class="modal-title">X√°c nh·∫≠n x√≥a menu</h3>
      <p class="modal-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a menu n√†y v√† t·∫•t c·∫£ tasks b√™n trong kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
      <div class="modal-buttons">
        <button id="cancel-delete-menu-btn" class="task-btn btn-cancel">Kh√¥ng</button>
        <button id="confirm-delete-menu-btn" class="task-btn" style="background-color:#ef4444; color:#fff;">C√≥, X√≥a</button>
      </div>
    </div>
  </div>

  <!-- Task Add/Edit Modal -->
  <div id="task-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" style="max-width: 650px;">
      <h3 id="task-modal-title" class="modal-title">Th√™m Task M·ªõi</h3>
      <form id="task-form" class="space-y-4">
        <div>
          <label for="task-name" class="block text-sm font-medium text-gray-700 mb-1">T√™n Task</label>
          <input type="text" id="task-name" class="filter-input" placeholder="VD: Task 1.1: Nghi√™n c·ª©u th·ªã tr∆∞·ªùng" required />
        </div>
        <div>
          <label for="task-description" class="block text-sm font-medium text-gray-700 mb-1">M√¥ t·∫£ (t·ª´ng d√≤ng)</label>
          <textarea id="task-description" class="filter-input" rows="5" placeholder="M·ªói d√≤ng l√† m·ªôt m·ª•c c√¥ng vi·ªác chi ti·∫øt&#10;D√≤ng 1: C√¥ng vi·ªác A&#10;D√≤ng 2: C√¥ng vi·ªác B"></textarea>
          <p class="text-xs text-gray-500 mt-1">M·ªói d√≤ng s·∫Ω hi·ªÉn th·ªã nh∆∞ m·ªôt bullet point</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="task-start-date" class="block text-sm font-medium text-gray-700 mb-1">Ng√†y b·∫Øt ƒë·∫ßu</label>
            <input type="date" id="task-start-date" class="filter-input" />
          </div>
          <div>
            <label for="task-end-date" class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
            <input type="date" id="task-end-date" class="filter-input" required />
          </div>
        </div>
        <div>
          <label for="task-assignee" class="block text-sm font-medium text-gray-700 mb-1">Ph·ª• Tr√°ch</label>
          <select id="task-assignee" class="filter-input" required>
            <option value="">-- Ch·ªçn ph·ª• tr√°ch --</option>
            <!-- Assignees will be populated dynamically -->
          </select>
        </div>
        <div id="task-error-message" class="text-red-600 text-sm hidden"></div>
        <div class="modal-buttons">
          <button type="button" id="task-cancel-btn" class="task-btn btn-cancel">H·ªßy</button>
          <button type="submit" id="task-submit-btn" class="task-btn btn-complete">L∆∞u</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Task from Plan Manager Confirmation Modal -->
  <div id="delete-plan-task-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <h3 class="modal-title">X√°c nh·∫≠n x√≥a task</h3>
      <p class="modal-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a task n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
      <div class="modal-buttons">
        <button id="cancel-delete-plan-task-btn" class="task-btn btn-cancel">Kh√¥ng</button>
        <button id="confirm-delete-plan-task-btn" class="task-btn" style="background-color:#ef4444; color:#fff;">C√≥, X√≥a</button>
      </div>
    </div>
  </div>

  <!-- Assignee Add Modal -->
  <div id="assignee-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <h3 class="modal-title">Th√™m Ph·ª• Tr√°ch M·ªõi</h3>
      <form id="assignee-form" class="space-y-4">
        <div>
          <label for="assignee-name" class="block text-sm font-medium text-gray-700 mb-1">T√™n B·ªô Ph·∫≠n/Nh√≥m</label>
          <input type="text" id="assignee-name" class="filter-input" placeholder="VD: Marketing, Technical Team" required />
        </div>
        <div id="assignee-error-message" class="text-red-600 text-sm hidden"></div>
        <div class="modal-buttons">
          <button type="button" id="assignee-cancel-btn" class="task-btn btn-cancel">H·ªßy</button>
          <button type="submit" id="assignee-submit-btn" class="task-btn btn-complete">L∆∞u</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Assignee Confirmation Modal -->
  <div id="delete-assignee-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <h3 class="modal-title">X√°c nh·∫≠n x√≥a ph·ª• tr√°ch</h3>
      <p class="modal-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ph·ª• tr√°ch n√†y kh√¥ng?</p>
      <div class="modal-buttons">
        <button id="cancel-delete-assignee-btn" class="task-btn btn-cancel">Kh√¥ng</button>
        <button id="confirm-delete-assignee-btn" class="task-btn" style="background-color:#ef4444; color:#fff;">C√≥, X√≥a</button>
      </div>
    </div>
  </div>

  <section id="cover-page" class="min-h-screen flex flex-col items-center justify-center bg-sky-100 text-center px-6 py-16">
    <div class="max-w-4xl mx-auto space-y-8">
      <div id="cover-logo-wrapper" class="flex justify-center">
        <a id="cover-logo-link" href="/" aria-label="Trang ch·ªß" class="inline-flex">
          <img id="cover-logo" class="h-24 w-auto hidden" alt="Logo d·ª± √°n" />
        </a>
      </div>
      <h2 id="cover-slogan" class="text-2xl md:text-3xl font-semibold text-blue-800 hidden"></h2>
      <div class="space-y-4" id="cover-content-wrapper">
        <h1 id="cover-title" class="text-3xl md:text-4xl font-bold text-blue-900">D·ª± √°n K·∫ø ho·∫°ch D·ªãch v·ª• Marketing Assistant</h1>
        <p id="cover-description" class="text-lg text-gray-700 leading-relaxed">Cung c·∫•p m·ªôt l·ªô tr√¨nh (master plan) chi ti·∫øt, A-Z, ƒë·ªÉ x√¢y d·ª±ng v√† ra m·∫Øt d·ªãch v·ª• Marketing Assistant.</p>
        <div class="space-y-1 text-gray-700" id="cover-contacts">
          <p>Qu·∫£n l√Ω d·ª± √°n / K·ªπ thu·∫≠t: <strong id="cover-contact-manager">[Ch∆∞a c·∫≠p nh·∫≠t]</strong></p>
          <p>V·∫≠n h√†nh: <strong id="cover-contact-ops">[Ch∆∞a c·∫≠p nh·∫≠t]</strong></p>
        </div>
      </div>
      <div id="cover-youtube-container" class="hidden w-full max-w-3xl mx-auto">
        <div class="aspect-w-16 aspect-h-9 relative" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
          <iframe id="cover-youtube-iframe" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
      </div>
      <button id="start-plan-btn" class="task-btn btn-complete text-lg px-10 py-3">B·∫ÆT ƒê·∫¶U K·∫æ HO·∫†CH</button>
    </div>
  </section>

  <!-- Login Page -->
  <section id="login-page" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 px-6 py-16 hidden" style="background-image: url('https://images.unsplash.com/photo-1557683316-973673baf926?auto=format&fit=crop&w=1920&q=80'); background-size: cover; background-position: center; background-blend-mode: overlay;">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <div id="login-logo-wrapper" class="flex justify-center mb-4">
          <img id="login-logo" class="h-16 w-auto hidden" alt="Logo" />
        </div>
        <h2 class="text-2xl font-bold text-gray-800">ƒêƒÉng Nh·∫≠p</h2>
        <p class="text-gray-600 mt-2">ƒêƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p k·∫ø ho·∫°ch d·ª± √°n</p>
      </div>
      <form id="login-form" class="space-y-6">
        <div>
          <label for="login-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
          <input
            type="email"
            id="login-email"
            class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="your@email.com"
            required
          />
        </div>
        <div>
          <label for="login-password" class="block text-sm font-medium text-gray-700 mb-2">M·∫≠t kh·∫©u</label>
          <div class="relative">
            <input
              type="password"
              id="login-password"
              class="w-full border border-gray-300 rounded-lg px-4 py-2.5 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
            />
            <button
              type="button"
              class="password-toggle absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
              data-target="login-password"
              aria-label="Toggle password visibility"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                <path class="eye-closed hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
              </svg>
            </button>
          </div>
        </div>
        <div id="login-error" class="text-red-600 text-sm hidden"></div>
        <button
          type="submit"
          id="login-btn"
          class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
        >
          ƒêƒÉng Nh·∫≠p
        </button>
      </form>
      <div class="mt-4 text-center">
        <button type="button" id="forgot-password-link" class="text-sm text-blue-600 hover:text-blue-800 hover:underline">
          Qu√™n m·∫≠t kh·∫©u?
        </button>
      </div>
      <div class="mt-4 text-center">
        <p class="text-sm text-gray-600">Li√™n h·ªá Admin ƒë·ªÉ ƒë∆∞·ª£c c·∫•p t√†i kho·∫£n</p>
      </div>
    </div>
  </section>

  <!-- Forgot Password Modal - TASK 12 -->
  <div id="forgot-password-modal" class="modal-overlay">
    <div class="modal-content max-w-md">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">üîë ƒê·∫∑t L·∫°i M·∫≠t Kh·∫©u</h2>
        <button class="modal-close" data-modal="forgot-password-modal">&times;</button>
      </div>
      <div class="modal-body">
        <p class="text-sm text-gray-600 mb-4">
          Nh·∫≠p email c·ªßa b·∫°n v√† ch√∫ng t√¥i s·∫Ω g·ª≠i link ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ƒë·∫øn h·ªôp th∆∞ c·ªßa b·∫°n.
        </p>
        <form id="forgot-password-form" class="space-y-4">
          <div>
            <label for="forgot-password-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input
              type="email"
              id="forgot-password-email"
              class="filter-input"
              placeholder="your@email.com"
              required
            />
          </div>
          <div id="forgot-password-error" class="text-red-600 text-sm hidden"></div>
          <div id="forgot-password-success" class="text-green-600 text-sm hidden"></div>
          <div class="flex justify-end gap-2">
            <button type="button" class="task-btn" data-modal="forgot-password-modal">H·ªßy</button>
            <button type="submit" id="forgot-password-btn" class="task-btn btn-complete">
              G·ª≠i Email ƒê·∫∑t L·∫°i
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="app-layout" class="flex h-screen overflow-hidden hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar lg:static" aria-label="Thanh ƒëi·ªÅu h∆∞·ªõng">
      <div class="flex h-full flex-col">
        <div class="flex items-center h-16 px-5 border-b border-gray-200 gap-3">
          <a id="sidebar-logo-link" href="/" aria-label="Trang ch·ªß" class="flex-shrink-0 inline-flex">
            <img id="sidebar-logo" class="sidebar-logo hidden" alt="Logo sidebar" />
          </a>
          <button id="close-menu" class="lg:hidden ml-auto text-gray-600 hover:text-gray-900 text-2xl" aria-label="ƒê√≥ng menu">&times;</button>
        </div>
        <div class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-gray-500" id="sidebar-branding-title">Master Plan (A-Z+)</div>
        <nav id="main-navigation" class="flex-1 p-3 space-y-1 overflow-y-auto">
          <!-- Dynamic menu items will be inserted here -->
          <a class="nav-link" href="/tongquan"><span class="emoji">üìä</span><span>T·ªïng Quan</span></a>
          <a class="nav-link" href="/giaidoan1"><span class="emoji">üéØ</span><span>Gƒê 1: N·ªÅn T·∫£ng</span></a>
          <a class="nav-link" href="/giaidoan2"><span class="emoji">üèóÔ∏è</span><span>Gƒê 2: X√¢y D·ª±ng</span></a>
          <a class="nav-link" href="/giaidoan3"><span class="emoji">‚öôÔ∏è</span><span>Gƒê 3: V·∫≠n H√†nh & T·ªëi ∆Øu</span></a>
          <a class="nav-link" href="/giaidoan4"><span class="emoji">üöÄ</span><span>Gƒê 4: Ra M·∫Øt</span></a>
          <a class="nav-link" href="/ghichu"><span class="emoji">üìù</span><span>Ghi Ch√∫ D·ª± √Ån</span></a>

          <!-- Admin-only links -->
          <div id="admin-nav-section" class="hidden border-t border-gray-300 pt-2 mt-2">
            <a class="nav-link" href="/quan-ly-nguoi-dung" id="nav-user-management"><span class="emoji">üë•</span><span>Qu·∫£n L√Ω Ng∆∞·ªùi D√πng</span></a>
            <a class="nav-link" href="/quan-ly-ke-hoach" id="nav-plan-manager"><span class="emoji">üóÇÔ∏è</span><span>Qu·∫£n L√Ω K·∫ø Ho·∫°ch</span></a>
            <a class="nav-link" href="/cai-dat"><span class="emoji">üîß</span><span>C√†i ƒê·∫∑t</span></a>
          </div>
        </nav>

        <!-- User Profile (moved to sidebar bottom) -->
        <div id="sidebar-user-profile" class="border-t border-gray-200 p-4 mt-auto">
          <div class="flex items-center gap-3 mb-3">
            <div id="sidebar-user-avatar-wrapper" class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 overflow-hidden flex-shrink-0">
              <img id="sidebar-user-avatar" class="w-full h-full object-cover hidden" alt="User avatar" />
              <svg id="sidebar-default-avatar-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
            </div>
            <div class="flex-1 min-w-0">
              <div id="sidebar-current-user-name" class="text-sm font-medium text-gray-800 truncate"></div>
              <div id="sidebar-current-user-role" class="text-xs text-gray-500"></div>
            </div>
          </div>
          <button id="sidebar-logout-btn" class="w-full text-sm font-medium text-red-600 hover:text-red-700 hover:bg-red-50 py-2 px-3 rounded-md transition hidden">
            ƒêƒÉng xu·∫•t
          </button>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 relative overflow-y-auto bg-gray-50">
      <!-- Top bar -->
      <header class="sticky top-0 z-20 flex flex-wrap items-center gap-4 px-6 py-3 bg-white border-b border-gray-200">
        <button id="open-menu" class="mobile-menu-button lg:hidden text-gray-600 hover:text-gray-900" aria-label="M·ªü menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
        <h2 id="current-section-title" class="content-header-title text-base sm:text-lg font-semibold text-gray-800 hidden"></h2>
        <div class="content-header-right">
          <div id="notification-wrapper" class="notification-wrapper">
            <button id="notification-bell" class="notification-bell" aria-label="Th√¥ng b√°o" aria-haspopup="true" aria-expanded="false">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
              <span id="notification-badge" class="notification-badge" aria-hidden="true">0</span>
              <span class="sr-only">M·ªü danh s√°ch th√¥ng b√°o</span>
            </button>
            <div id="notification-dropdown" class="notification-dropdown" role="menu" aria-hidden="true">
              <div class="notification-header">
                <span class="text-sm font-semibold text-gray-700">Th√¥ng b√°o</span>
                <span class="text-xs text-gray-400">Nh·∫•n v√†o t·ª´ng th√¥ng b√°o ƒë·ªÉ ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc</span>
              </div>
              <ul id="notification-list" class="notification-list" role="list"></ul>
              <div id="notification-empty" class="notification-empty">Kh√¥ng c√≥ th√¥ng b√°o quan tr·ªçng.</div>
            </div>
          </div>
          <div class="flex flex-col items-end gap-1 text-right">
            <div class="text-sm font-medium text-gray-700">Ng√†y Ra M·∫Øt (D-Day)</div>
            <div class="text-base font-bold text-red-600">15/03/2026</div>
            <div id="project-share-info" class="text-xs text-gray-500 hidden leading-snug max-w-xs">
              <span class="font-medium text-gray-600 block">Chia s·∫ª d·ª± √°n</span>
              <span id="project-id-label" class="block text-gray-600"></span>
              <span id="project-share-url" class="block text-blue-600 break-words"></span>
            </div>
          </div>
        </div>
      </header>

      <div class="p-6 max-w-7xl mx-auto">
        <div id="content-sections">
          <!-- Overview -->
          <section id="overview" class="content-section">
            <h2 class="sr-only">T·ªïng Quan</h2>
            <p class="section-subtitle">D√°n link k·∫øt qu·∫£ cho t·ª´ng task r·ªìi b·∫•m ‚ÄúHo√†n Th√†nh‚Äù. H·ªá th·ªëng t·ª± c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô, bi·ªÉu ƒë·ªì, v√† c·∫£nh b√°o deadline.</p>

            <div id="upcoming-deadlines-container" class="card-section hidden">
              <h3 class="card-title text-orange-600">‚ö†Ô∏è Deadline S·∫Øp T·ªõi (Trong 7 ng√†y)</h3>
              <ul id="upcoming-deadlines-list" class="list-disc list-inside space-y-1.5 text-gray-700"></ul>
            </div>
            <div id="overdue-tasks-container" class="card-section hidden">
              <h3 class="card-title text-red-600">üö® Tasks Qu√° H·∫°n</h3>
              <ul id="overdue-tasks-list" class="list-disc list-inside space-y-1.5 text-gray-700"></ul>
            </div>

            <div class="card-section">
              <h3 class="card-title">T·ªïng Ti·∫øn ƒê·ªô (To√†n D·ª± √Ån)</h3>
              <div class="flex items-center justify-between mb-2">
                <div class="flex flex-col">
                  <span class="text-sm font-medium text-gray-600">Ti·∫øn ƒë·ªô</span>
                  <span id="total-progress-text" class="text-sm font-bold text-blue-600">0 / 0 Tasks</span>
                </div>
                <span id="total-progress-percent" class="text-2xl font-bold text-blue-600">0%</span>
              </div>
              <div class="progress-bar"><div id="total-progress-bar" class="progress-bar-inner" style="width:0%"></div></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="stat-card">
                <h3 class="card-title text-center">T·ª∑ L·ªá Ho√†n Th√†nh</h3>
                <div class="chart-container"><canvas id="progressChart"></canvas></div>
              </div>
              <div class="stat-card">
                <h3 class="card-title">Ti·∫øn ƒê·ªô Theo Giai ƒêo·∫°n</h3>
                <div id="phase-progress-container" class="space-y-4">
                  <!-- Dynamic phase progress bars will be rendered here from Firestore -->
                </div>
              </div>
            </div>

            <div id="note-statistics-card" class="card-section mb-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="card-title">Ghi Ch√∫ Th·ªëng K√™</h3>
                <span id="note-stats-total" class="text-sm text-gray-600">T·ªïng s·ªë ghi ch√∫: 0</span>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <h4 class="text-sm font-semibold text-gray-700 mb-3">Ph√¢n lo·∫°i ghi ch√∫</h4>
                  <div id="note-stats-text" class="space-y-2 text-sm text-gray-600"></div>
                </div>
                <div>
                  <h4 class="text-sm font-semibold text-gray-700 mb-3">Bi·ªÉu ƒë·ªì c·ªôt</h4>
                  <div class="relative h-[350px] max-h-[350px]">
                    <canvas id="note-stats-chart" class="absolute inset-0 w-full h-full"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div id="activity-log-section" class="card-section">
              <div class="flex items-center justify-between mb-3 flex-wrap gap-3">
                <h3 class="card-title">T·ªïng Quan Ho·∫°t ƒê·ªông</h3>
                <span id="activity-log-count" class="text-sm text-gray-500"></span>
              </div>
              <div class="overflow-x-auto">
                <table class="notes-table activity-table">
                  <thead>
                    <tr>
                      <th style="width:20%">Giai ƒëo·∫°n</th>
                      <th style="width:15%">Tr·∫°ng th√°i</th>
                      <th style="width:35%">T√™n Task</th>
                      <th style="width:15%">Th·ªùi gian ho√†n th√†nh</th>
                      <th style="width:15%">Th·ªùi gian c·∫≠p nh·∫≠t</th>
                    </tr>
                  </thead>
                  <tbody id="activity-log-body"></tbody>
                </table>
              </div>
              <button id="activity-log-toggle" class="task-btn btn-view mt-3 hidden">Xem th√™m</button>
            </div>
          </section>

          <!-- Gƒê1 -->
          <section id="gd1" class="content-section hidden">
            <h2 class="sr-only">Giai ƒêo·∫°n 1: N·ªÅn T·∫£ng &amp; Chi·∫øn L∆∞·ª£c</h2>
            <p class="section-subtitle">M·ª•c ti√™u: ƒê·ªãnh h√¨nh r√µ ch√∫ng ta l√† ai, b√°n g√¨, b√°n cho ai.</p>
            <h3 class="phase-title">Tu·∫ßn 1-2: Nghi√™n C·ª©u & ƒê·ªãnh V·ªã</h3>
            <div id="gd1-week1-2" class="space-y-4"></div>
            <h3 class="phase-title">Tu·∫ßn 3-4: Thi·∫øt K·∫ø D·ªãch V·ª• & Gi√°</h3>
            <div id="gd1-week3-4" class="space-y-4"></div>
          </section>

          <!-- Gƒê2 -->
          <section id="gd2" class="content-section hidden">
            <h2 class="sr-only">Giai ƒêo·∫°n 2: X√¢y D·ª±ng H·∫° T·∫ßng &amp; T√†i S·∫£n</h2>
            <p class="section-subtitle">Website, Funnel, Social, Portfolio, Sales Kit, H·ª£p ƒë·ªìng, N·ªôi dung & Nh√¢n s·ª±.</p>
            <h3 class="phase-title">Tu·∫ßn 5-8: H·∫° T·∫ßng K·ªπ Thu·∫≠t</h3>
            <div id="gd2-week5-8" class="space-y-4"></div>
            <h3 class="phase-title">Tu·∫ßn 9-11: Portfolio & Sales Kit</h3>
            <div id="gd2-week9-11" class="space-y-4"></div>
            <h3 class="phase-title">Tu·∫ßn 12-13: N·ªôi dung & V·∫≠n h√†nh</h3>
            <div id="gd2-week12-13" class="space-y-4"></div>
          </section>

          <!-- Gƒê3 -->
          <section id="gd3" class="content-section hidden">
            <h2 class="sr-only">Giai ƒêo·∫°n 3: V·∫≠n H√†nh &amp; T·ªëi ∆Øu (A-Z+)</h2>
            <p class="section-subtitle">Nh√¢n s·ª±, SOPs, Sales scripts, CSKH, r·ªßi ro, test & k·∫ø ho·∫°ch ra m·∫Øt.</p>
            <h3 class="phase-title">Tu·∫ßn 14-15: Nh√¢n S·ª± & SOPs</h3>
            <div id="gd3-week14-15" class="space-y-4"></div>
            <h3 class="phase-title">Tu·∫ßn 16-17: K·ªãch B·∫£n & R·ªßi Ro</h3>
            <div id="gd3-week16-17" class="space-y-4"></div>
          </section>

          <!-- Gƒê4 -->
          <section id="gd4" class="content-section hidden">
            <h2 class="sr-only">Giai ƒêo·∫°n 4: Ra M·∫Øt (D-Day)</h2>
            <p class="section-subtitle">Build hype, ki·ªÉm tra k·ªπ thu·∫≠t, ra m·∫Øt & t·ªïng k·∫øt.</p>
            <div id="gd4-week18" class="space-y-4"></div>
          </section>

          <!-- Notes -->
          <section id="notes" class="content-section hidden">
            <h2 class="sr-only">Ghi Ch√∫ D·ª± √Ån</h2>
            <div class="card-section">
              <h3 class="card-title">Ghi Ch√∫ M·ªõi</h3>
              <textarea id="notes-textarea" class="notes-textarea" placeholder="Nh·∫≠p ghi ch√∫ c·ªßa b·∫°n h√¥m nay..."></textarea>
              <div class="note-form-footer">
                <div class="note-form-meta">
                  <div class="note-meta-group flex-1">
                    <div class="note-type-dropdown" id="note-type-dropdown">
                      <button type="button" class="note-type-trigger" id="note-type-trigger" aria-haspopup="true" aria-expanded="false">
                        <span id="note-type-trigger-label">Ch·ªçn lo·∫°i ghi ch√∫</span>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                      </button>
                      <div class="note-type-panel" id="note-type-panel" role="menu">
                        <div class="note-type-new">
                          <input type="text" id="note-type-new-input" placeholder="Th√™m lo·∫°i m·ªõi..."/>
                          <button type="button" id="note-type-create-btn" class="task-btn btn-complete">Th√™m</button>
                        </div>
                        <div class="note-type-options" id="note-type-options"></div>
                        <p id="note-type-feedback" class="note-type-feedback hidden"></p>
                        <p class="text-xs text-gray-500 mt-2">T·ªëi ƒëa 10 lo·∫°i ghi ch√∫. X√≥a ho·∫∑c t·∫°o lo·∫°i m·ªõi tr·ª±c ti·∫øp t·∫°i ƒë√¢y.</p>
                      </div>
                    </div>
                    <p class="text-xs text-gray-500">Ch·ªçn lo·∫°i ghi ch√∫ ho·∫∑c t·∫°o m·ªõi ngay trong danh s√°ch.</p>
                  </div>
                  <div class="note-meta-group">
                    <label class="text-sm font-medium text-gray-700" for="note-file-upload">ƒê√≠nh k√®m t·ªáp (t√πy ch·ªçn)</label>
                    <input type="file" id="note-file-upload" class="w-full text-sm text-gray-600" />
                  </div>
                </div>
                <button id="save-note-btn" class="task-btn btn-complete w-full md:w-auto md:px-6 md:ml-auto">üíæ L∆∞u Ghi Ch√∫</button>
              </div>
            </div>

            <hr class="my-6"/>

            <div class="card-section">
              <h3 class="card-title">L·ªçc Ghi Ch√∫</h3>
              <div class="filter-container">
                <div class="filter-field flex-1 min-w-[220px] md:max-w-md">
                  <label class="text-sm font-medium text-gray-700" for="filter-keyword">T·ª´ kh√≥a</label>
                  <input type="text" id="filter-keyword" class="filter-input" placeholder="T√¨m theo n·ªôi dung..." />
                </div>
                <div class="filter-field w-full sm:w-auto min-w-[160px]">
                  <label class="text-sm font-medium text-gray-700" for="filter-type">Lo·∫°i</label>
                  <select id="filter-type" class="filter-input"><option value="">T·∫•t c·∫£ lo·∫°i</option></select>
                </div>
                <div class="filter-field w-full sm:w-auto min-w-[160px] time-filter-wrapper">
                  <label class="text-sm font-medium text-gray-700" for="filter-time">Th·ªùi gian</label>
                  <select id="filter-time" class="filter-input">
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="today">H√¥m nay</option>
                    <option value="yesterday">H√¥m qua</option>
                    <option value="7days">7 ng√†y qua</option>
                    <option value="14days">14 ng√†y qua</option>
                    <option value="thisMonth">Th√°ng n√†y</option>
                    <option value="lastMonth">Th√°ng tr∆∞·ªõc</option>
                    <option value="custom">T√πy ch·ªçn</option>
                  </select>
                  <div id="custom-date-popover" class="custom-date-popover hidden" aria-hidden="true">
                    <div class="filter-field">
                      <label class="text-xs font-medium text-gray-600" for="filter-date-from">T·ª´ ng√†y</label>
                      <input type="date" id="filter-date-from" class="filter-input" />
                    </div>
                    <div class="filter-field mt-3">
                      <label class="text-xs font-medium text-gray-600" for="filter-date-to">ƒê·∫øn ng√†y</label>
                      <input type="date" id="filter-date-to" class="filter-input" />
                    </div>
                  </div>
                </div>
                <div class="filter-actions w-full sm:w-auto">
                  <button id="reset-filter-btn" class="task-btn btn-cancel w-full sm:w-auto">üîÑ Reset</button>
                </div>
              </div>
            </div>

            <div class="card-section">
              <h3 class="card-title">Ghi Ch√∫ ƒê√£ L∆∞u</h3>
              <div class="overflow-x-auto">
                <table class="notes-table">
                  <thead>
                    <tr>
                      <th style="width:15%">Ng√†y Gi·ªù</th>
                      <th style="width:15%">Lo·∫°i</th>
                      <th style="width:60%">N·ªôi Dung</th>
                      <th style="width:10%; text-align:center;">X√≥a</th>
                    </tr>
                  </thead>
                  <tbody id="notes-list-container"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section id="settings" class="content-section hidden">
            <h2 class="sr-only">C√†i ƒê·∫∑t D·ª± √Ån</h2>
            <p class="section-subtitle">T√πy ch·ªânh giao di·ªán v√† th√¥ng tin hi·ªÉn th·ªã tr√™n trang ch·ªß, sidebar.</p>
            <div class="card-section space-y-8">
              <div class="settings-page-grid">
                <div class="space-y-6">
                  <div class="settings-group-card">
                    <h3 class="settings-group-title">Nh·∫≠n di·ªán th∆∞∆°ng hi·ªáu</h3>
                    <div class="settings-file-control">
                      <label class="text-sm font-medium text-gray-700" for="setting-logo-upload">Logo (hi·ªÉn th·ªã ·ªü Cover, Sidebar & Login Page)</label>
                      <div class="settings-file-default" id="setting-logo-default">
                        <button type="button" id="setting-logo-choose" class="task-btn btn-view px-4 py-2">Ch·ªçn file</button>
                        <span id="setting-logo-filename" class="text-sm text-gray-500">Ch∆∞a ch·ªçn file</span>
                      </div>
                      <div class="settings-file-active hidden" id="setting-logo-active">
                        <div class="settings-file-selected">
                          <div class="settings-preview-box"><img id="logo-preview" alt="Xem tr∆∞·ªõc logo" class="hidden" /></div>
                          <div class="flex flex-col gap-2">
                            <span id="setting-logo-selected-name" class="settings-selected-name"></span>
                            <div class="settings-file-actions">
                              <button type="button" id="setting-logo-change" class="settings-file-action text-blue">ƒê·ªïi</button>
                              <button type="button" id="setting-logo-remove" class="settings-file-action text-red">G·ª°</button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <input type="file" id="setting-logo-upload" class="hidden" accept="image/*" />
                      <p class="settings-helper">T·∫£i logo PNG/SVG t·ªëi ƒëa 2MB.</p>
                      <p class="text-xs text-gray-500 mt-1">L∆∞u √Ω: N·∫øu upload file l·ªói, b·∫°n c·∫ßn c·∫•u h√¨nh CORS tr√™n Firebase Storage.</p>
                    </div>
                    <div class="settings-file-control">
                      <label class="text-sm font-medium text-gray-700" for="setting-favicon-upload">Favicon</label>
                      <div class="settings-file-default" id="setting-favicon-default">
                        <button type="button" id="setting-favicon-choose" class="task-btn btn-view px-4 py-2">Ch·ªçn file</button>
                        <span id="setting-favicon-filename" class="text-sm text-gray-500">Ch∆∞a ch·ªçn file</span>
                      </div>
                      <div class="settings-file-active hidden" id="setting-favicon-active">
                        <div class="settings-file-selected">
                          <div class="settings-preview-box"><img id="favicon-preview" alt="Xem tr∆∞·ªõc favicon" class="hidden" /></div>
                          <div class="flex flex-col gap-2">
                            <span id="setting-favicon-selected-name" class="settings-selected-name"></span>
                            <div class="settings-file-actions">
                              <button type="button" id="setting-favicon-change" class="settings-file-action text-blue">ƒê·ªïi</button>
                              <button type="button" id="setting-favicon-remove" class="settings-file-action text-red">G·ª°</button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <input type="file" id="setting-favicon-upload" class="hidden" accept="image/*" />
                      <p class="settings-helper">Khuy·∫øn ngh·ªã ·∫£nh vu√¥ng (512x512px).</p>
                      <p class="text-xs text-gray-500 mt-1">L∆∞u √Ω: N·∫øu upload file l·ªói, b·∫°n c·∫ßn c·∫•u h√¨nh CORS tr√™n Firebase Storage.</p>
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-700" for="setting-slogan">Slogan</label>
                      <input type="text" id="setting-slogan" class="filter-input" placeholder="V√≠ d·ª•: Think Smart - Grow Faster" />
                    </div>
                  </div>
                  <div class="settings-group-card">
                    <h3 class="settings-group-title">Qu·∫£n l√Ω d·ª± √°n</h3>
                    <div>
                      <label class="text-sm font-medium text-gray-700" for="setting-contact-manager">Qu·∫£n l√Ω d·ª± √°n / K·ªπ thu·∫≠t</label>
                      <input type="text" id="setting-contact-manager" class="filter-input" placeholder="Nh·∫≠p t√™n" />
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-700" for="setting-contact-ops">V·∫≠n h√†nh</label>
                      <input type="text" id="setting-contact-ops" class="filter-input" placeholder="Nh·∫≠p t√™n" />
                    </div>
                    <div class="settings-file-control">
                      <label class="text-sm font-medium text-gray-700" for="setting-avatar-upload">Avatar c√° nh√¢n c·ªßa b·∫°n</label>
                      <div class="settings-file-default" id="setting-avatar-default">
                        <button type="button" id="setting-avatar-choose" class="task-btn btn-view px-4 py-2">Ch·ªçn file</button>
                        <span id="setting-avatar-filename" class="text-sm text-gray-500">Ch∆∞a ch·ªçn file</span>
                      </div>
                      <div class="settings-file-active hidden" id="setting-avatar-active">
                        <div class="settings-file-selected">
                          <div class="settings-preview-box"><img id="avatar-preview" alt="Xem tr∆∞·ªõc avatar" class="hidden rounded-full" /></div>
                          <div class="flex flex-col gap-2">
                            <span id="setting-avatar-selected-name" class="settings-selected-name"></span>
                            <div class="settings-file-actions">
                              <button type="button" id="setting-avatar-change" class="settings-file-action text-blue">ƒê·ªïi</button>
                              <button type="button" id="setting-avatar-remove" class="settings-file-action text-red">G·ª°</button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <input type="file" id="setting-avatar-upload" class="hidden" accept="image/jpeg,image/png,image/jpg" />
                      <p class="settings-helper">Khuy·∫øn ngh·ªã ·∫£nh vu√¥ng (800x800px). Ch·∫•p nh·∫≠n JPG, PNG.</p>
                      <p class="text-xs text-gray-500 mt-1">‚ö†Ô∏è L∆∞u √Ω: ·∫¢nh n√†y CH·ªà hi·ªÉn th·ªã cho t√†i kho·∫£n c·ªßa b·∫°n. M·ªói ng∆∞·ªùi d√πng c√≥ avatar ri√™ng.</p>
                    </div>
                  </div>
                </div>
                <div class="space-y-6">
                  <div class="settings-group-card">
                    <h3 class="settings-group-title">T√πy ch·ªânh Cover Page</h3>
                    <div class="settings-file-control">
                      <label class="text-sm font-medium text-gray-700" for="setting-cover-image-upload">·∫¢nh n·ªÅn Cover Page</label>
                      <div class="settings-file-default" id="setting-cover-image-default">
                        <button type="button" id="setting-cover-image-choose" class="task-btn btn-view px-4 py-2">Ch·ªçn file</button>
                        <span id="setting-cover-image-filename" class="text-sm text-gray-500">Ch∆∞a ch·ªçn file</span>
                      </div>
                      <div class="settings-file-active hidden" id="setting-cover-image-active">
                        <div class="settings-file-selected">
                          <div class="settings-preview-box"><img id="cover-image-preview" alt="Xem tr∆∞·ªõc ·∫£nh n·ªÅn" class="hidden" /></div>
                          <div class="flex flex-col gap-2">
                            <span id="setting-cover-image-selected-name" class="settings-selected-name"></span>
                            <div class="settings-file-actions">
                              <button type="button" id="setting-cover-image-change" class="settings-file-action text-blue">ƒê·ªïi</button>
                              <button type="button" id="setting-cover-image-remove" class="settings-file-action text-red">G·ª°</button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <input type="file" id="setting-cover-image-upload" class="hidden" accept="image/*" />
                      <p class="settings-helper">·∫¢nh s·∫Ω hi·ªÉn th·ªã to√†n m√†n h√¨nh ·ªü trang Cover.</p>
                      <p class="text-xs text-gray-500 mt-1">L∆∞u √Ω: N·∫øu upload file l·ªói, b·∫°n c·∫ßn c·∫•u h√¨nh CORS tr√™n Firebase Storage.</p>
                    </div>
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-gray-700" for="setting-cover-color">M√†u n·ªÅn Cover Page</label>
                      <input type="color" id="setting-cover-color" class="h-10 w-24 border border-gray-200 rounded" />
                      <p class="settings-helper">N·∫øu kh√¥ng c√≥ ·∫£nh n·ªÅn, m√†u n√†y s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng.</p>
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-700" for="setting-cover-title">Ti√™u ƒë·ªÅ Cover Page</label>
                      <input type="text" id="setting-cover-title" class="filter-input" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ ch√≠nh" />
                      <p class="settings-helper">Ti√™u ƒë·ªÅ ch√≠nh hi·ªÉn th·ªã tr√™n trang Cover.</p>
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-700" for="setting-cover-description">M√¥ t·∫£ Cover Page</label>
                      <textarea id="setting-cover-description" class="filter-input" rows="3" placeholder="Nh·∫≠p m√¥ t·∫£ chi ti·∫øt"></textarea>
                      <p class="settings-helper">M√¥ t·∫£ ng·∫Øn v·ªÅ d·ª± √°n hi·ªÉn th·ªã tr√™n trang Cover.</p>
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-700" for="setting-cover-font">Font ch·ªØ Cover Page</label>
                      <select id="setting-cover-font" class="filter-input">
                        <option value="Inter, system-ui, sans-serif">Inter (M·∫∑c ƒë·ªãnh)</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Helvetica, sans-serif">Helvetica</option>
                        <option value="Georgia, serif">Georgia</option>
                        <option value="Times New Roman, serif">Times New Roman</option>
                        <option value="Courier New, monospace">Courier New</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="Tahoma, sans-serif">Tahoma</option>
                        <option value="Roboto, sans-serif">Roboto</option>
                        <option value="Open Sans, sans-serif">Open Sans</option>
                      </select>
                      <p class="settings-helper">Ch·ªçn font ch·ªØ cho ti√™u ƒë·ªÅ v√† m√¥ t·∫£ tr√™n Cover.</p>
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-700" for="setting-cover-text-size">K√≠ch th∆∞·ªõc ch·ªØ (px)</label>
                      <input type="number" id="setting-cover-text-size" class="filter-input" min="12" max="32" step="1" placeholder="16" />
                      <p class="settings-helper">K√≠ch th∆∞·ªõc font ch·ªØ c∆° b·∫£n (12-32px). M·∫∑c ƒë·ªãnh: 16px.</p>
                    </div>
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-gray-700" for="setting-cover-text-color">M√†u ch·ªØ Cover Page</label>
                      <input type="color" id="setting-cover-text-color" class="h-10 w-24 border border-gray-200 rounded" />
                      <p class="settings-helper">M√†u ch·ªØ cho ti√™u ƒë·ªÅ v√† m√¥ t·∫£ tr√™n Cover.</p>
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-700" for="setting-cover-youtube">Link YouTube Cover Page</label>
                      <input type="url" id="setting-cover-youtube" class="filter-input" placeholder="https://www.youtube.com/watch?v=..." />
                      <p class="settings-helper">Video YouTube s·∫Ω hi·ªÉn th·ªã tr√™n trang Cover, ngay ph√≠a tr√™n n√∫t "B·∫ÆT ƒê·∫¶U K·∫æ HO·∫†CH".</p>
                    </div>
                  </div>
                  <div class="settings-group-card">
                    <h3 class="settings-group-title">T√πy ch·ªânh Login Page (Admin Only)</h3>
                    <p class="text-sm text-gray-600 mb-4">‚ö†Ô∏è Logo ƒëƒÉng nh·∫≠p s·∫Ω t·ª± ƒë·ªông s·ª≠ d·ª•ng logo t·ª´ "Nh·∫≠n di·ªán th∆∞∆°ng hi·ªáu" ·ªü tr√™n. B·∫°n ch·ªâ c·∫ßn t·∫£i ·∫£nh n·ªÅn b√™n d∆∞·ªõi.</p>
                    <div class="settings-file-control">
                      <label class="text-sm font-medium text-gray-700" for="setting-login-bg-upload">·∫¢nh n·ªÅn Login Page</label>
                      <div class="settings-file-default" id="setting-login-bg-default">
                        <button type="button" id="setting-login-bg-choose" class="task-btn btn-view px-4 py-2">Ch·ªçn file</button>
                        <span id="setting-login-bg-filename" class="text-sm text-gray-500">Ch∆∞a ch·ªçn file</span>
                      </div>
                      <div class="settings-file-active hidden" id="setting-login-bg-active">
                        <div class="settings-file-selected">
                          <div class="settings-preview-box"><img id="login-bg-preview" alt="Xem tr∆∞·ªõc ·∫£nh n·ªÅn login" class="hidden" /></div>
                          <div class="flex flex-col gap-2">
                            <span id="setting-login-bg-selected-name" class="settings-selected-name"></span>
                            <div class="settings-file-actions">
                              <button type="button" id="setting-login-bg-change" class="settings-file-action text-blue">ƒê·ªïi</button>
                              <button type="button" id="setting-login-bg-remove" class="settings-file-action text-red">G·ª°</button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <input type="file" id="setting-login-bg-upload" class="hidden" accept="image/*" />
                      <p class="settings-helper">·∫¢nh n·ªÅn s·∫Ω hi·ªÉn th·ªã tr√™n trang ƒëƒÉng nh·∫≠p. N·∫øu kh√¥ng upload, s·∫Ω d√πng ·∫£nh m·∫∑c ƒë·ªãnh.</p>
                      <p class="text-xs text-gray-500 mt-1">L∆∞u √Ω: N·∫øu upload file l·ªói, b·∫°n c·∫ßn c·∫•u h√¨nh CORS tr√™n Firebase Storage.</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Change Password Section (All Users) - TASK 11 -->
              <div class="border-t border-gray-300 pt-8 mt-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üîê ƒê·ªïi M·∫≠t Kh·∫©u</h3>
                <div class="settings-group-card">
                  <p class="text-sm text-gray-600 mb-4">Thay ƒë·ªïi m·∫≠t kh·∫©u c·ªßa b·∫°n ƒë·ªÉ b·∫£o m·∫≠t t√†i kho·∫£n</p>
                  <form id="change-password-form" class="space-y-4">
                    <div>
                      <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                      <div class="relative">
                        <input type="password" id="current-password" class="filter-input pr-10" required />
                        <button
                          type="button"
                          class="password-toggle absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                          data-target="current-password"
                          aria-label="Toggle password visibility"
                        >
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            <path class="eye-closed hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                          </svg>
                        </button>
                      </div>
                    </div>
                    <div>
                      <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">M·∫≠t kh·∫©u m·ªõi</label>
                      <div class="relative">
                        <input type="password" id="new-password" class="filter-input pr-10" minlength="6" required />
                        <button
                          type="button"
                          class="password-toggle absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                          data-target="new-password"
                          aria-label="Toggle password visibility"
                        >
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            <path class="eye-closed hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                          </svg>
                        </button>
                      </div>
                      <p class="text-xs text-gray-500 mt-1">T·ªëi thi·ªÉu 6 k√Ω t·ª±</p>
                    </div>
                    <div>
                      <label for="confirm-new-password" class="block text-sm font-medium text-gray-700 mb-1">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                      <div class="relative">
                        <input type="password" id="confirm-new-password" class="filter-input pr-10" minlength="6" required />
                        <button
                          type="button"
                          class="password-toggle absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                          data-target="confirm-new-password"
                          aria-label="Toggle password visibility"
                        >
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            <path class="eye-closed hidden" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                          </svg>
                        </button>
                      </div>
                    </div>
                    <div id="change-password-error" class="text-red-600 text-sm hidden"></div>
                    <div id="change-password-success" class="text-green-600 text-sm hidden"></div>
                    <div class="flex justify-end">
                      <button type="submit" id="change-password-btn" class="task-btn btn-complete px-6">üîí ƒê·ªïi M·∫≠t Kh·∫©u</button>
                    </div>
                  </form>
                </div>
              </div>

              <div class="flex justify-end">
                <button id="save-settings-btn" class="task-btn btn-complete px-6">üíæ L∆∞u C√†i ƒê·∫∑t</button>
              </div>
            </div>
          </section>

          <!-- User Management (Admin Only) -->
          <section id="user-management" class="content-section hidden">
            <h2 class="sr-only">Qu·∫£n L√Ω Ng∆∞·ªùi D√πng</h2>
            <p class="section-subtitle">Qu·∫£n l√Ω ng∆∞·ªùi d√πng, ph√¢n quy·ªÅn v√† ki·ªÉm so√°t truy c·∫≠p v√†o h·ªá th·ªëng.</p>

            <div class="card-section">
              <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
                <h3 class="card-title">üë• Danh S√°ch Ng∆∞·ªùi D√πng</h3>
                <button id="add-user-btn" class="task-btn btn-complete px-4 py-2">+ Th√™m ng∆∞·ªùi d√πng</button>
              </div>
              <div class="overflow-x-auto">
                <table class="notes-table w-full">
                  <thead>
                    <tr>
                      <th class="text-left">Email</th>
                      <th class="text-left">T√™n hi·ªÉn th·ªã</th>
                      <th class="text-left">Vai tr√≤</th>
                      <th class="text-left">Ng√†y t·∫°o</th>
                      <th class="text-center">H√†nh ƒë·ªông</th>
                    </tr>
                  </thead>
                  <tbody id="users-table-body">
                    <!-- Users will be populated here -->
                  </tbody>
                </table>
              </div>
              <p class="text-xs text-gray-500 mt-4">
                <strong>Admin:</strong> To√†n quy·ªÅn truy c·∫≠p, bao g·ªìm Qu·∫£n L√Ω K·∫ø Ho·∫°ch.<br>
                <strong>Employee:</strong> Ch·ªâ xem k·∫ø ho·∫°ch, t·∫°o ghi ch√∫, ƒë√°nh d·∫•u task ho√†n th√†nh, v√† comment.
              </p>
            </div>
          </section>

          <!-- Plan Manager -->
          <section id="plan-manager" class="content-section hidden">
            <h2 class="sr-only">Qu·∫£n L√Ω K·∫ø Ho·∫°ch</h2>
            <p class="section-subtitle">Qu·∫£n l√Ω menu (phases) v√† tasks c·ªßa d·ª± √°n. Thay ƒë·ªïi ·ªü ƒë√¢y s·∫Ω c·∫≠p nh·∫≠t sidebar v√† t·ªïng quan ngay l·∫≠p t·ª©c.</p>

            <div class="card-section">
              <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
                <h3 class="card-title">üìã C·∫•u Tr√∫c Menu & Tasks</h3>
                <div class="flex gap-2">
                  <button id="add-menu-btn" class="task-btn btn-complete px-4 py-2">+ Th√™m Menu M·ªõi</button>
                </div>
              </div>

              <div id="menus-container" class="space-y-3">
                <!-- Menus will be dynamically rendered here -->
              </div>

              <div id="no-menus-message" class="text-center py-12 text-gray-500 hidden">
                <p class="text-lg">Ch∆∞a c√≥ menu n√†o. Nh·∫•n "Th√™m Menu M·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
              </div>
            </div>

            <div class="card-section">
              <h3 class="card-title">üè¢ Qu·∫£n L√Ω Ph·ª• Tr√°ch (Assignees)</h3>
              <div class="flex items-center justify-between mb-4">
                <p class="text-sm text-gray-600">Danh s√°ch b·ªô ph·∫≠n/nh√≥m c√≥ th·ªÉ ƒë∆∞·ª£c g√°n cho tasks</p>
                <button id="add-assignee-btn" class="task-btn btn-complete px-4 py-2">+ Th√™m Ph·ª• Tr√°ch</button>
              </div>
              <div id="assignees-list" class="flex flex-wrap gap-2">
                <!-- Assignees will be rendered here -->
              </div>
            </div>
          </section>

          <!-- Dynamic Menu Section -->
          <section id="dynamic-menu" class="content-section hidden">
            <div id="dynamic-menu-title-container"></div>
            <div id="dynamic-menu-tasks-container" class="space-y-4">
              <!-- Dynamic menu tasks will be rendered here -->
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- =================================================== -->
<!-- CH√åA KH√ìA FIREBASE C·ª¶A B·∫†N ƒê·∫∂T ·ªû ƒê√ÇY -->
<!-- =================================================== -->
<script>
  // 1. D√°n const firebaseConfig c·ªßa b·∫°n v√†o ƒë√¢y
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyDX-XFXDgziXmsHkWHuUH5zlANYm0dehKY",
    authDomain: "vincent-nguyen.firebaseapp.com",
    projectId: "vincent-nguyen",
    storageBucket: "vincent-nguyen.firebasestorage.app",
    messagingSenderId: "15594526987",
    appId: "1:15594526987:web:50e4ecf8548302d598aa0e",
    measurementId: "G-CV6XDV7WSC"
  };

  // 2. Th√™m d√≤ng n√†y ƒë·ªÉ code ch√≠nh c·ªßa b·∫°n (·ªü d∆∞·ªõi) c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c
  window.FIREBASE_CONFIG = firebaseConfig;
</script>
<!-- =================================================== -->


<!-- Code ch√≠nh c·ªßa b·∫°n b·∫Øt ƒë·∫ßu t·ª´ ƒë√¢y (D√≤ng 357) -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, collection, addDoc, deleteDoc, query, where, orderBy, getDocs, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, EmailAuthProvider, reauthenticateWithCredential, updatePassword, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  document.addEventListener('DOMContentLoaded', () => {
    // ========= CONSTANTS =========
    const DAY_MS = 24 * 60 * 60 * 1000;
    const projectPlanStart = new Date(2025, 10, 10);
    const projectLaunchDate = new Date(2026, 2, 15);
    const timelineSegments = [
      { week:'gd1-week1-2', duration:14 },
      { week:'gd1-week3-4', duration:14 },
      { week:'gd2-week5-8', duration:28 },
      { week:'gd2-week9-11', duration:21 },
      { week:'gd2-week12-13', duration:14 },
      { week:'gd3-week14-15', duration:14 },
      { week:'gd3-week16-17', duration:14 },
      { week:'gd4-week18', duration:7 },
    ];
    const defaultCustomTypes = ['√ù t∆∞·ªüng','Vi·ªác c·∫ßn l√†m','R·ªßi ro','Kh√°c'];
    const STATIC_PROJECT_ID = 'thinksmart-main-plan';
    const defaultSettings = {
      slogan: '',
      contactManager: '',
      contactOps: '',
      logoUrl: '',
      logoStoragePath: '',
      faviconUrl: '',
      faviconStoragePath: '',
      coverImageUrl: '',
      coverImageStoragePath: '',
      coverColor: '',
      coverTitle: 'D·ª± √°n K·∫ø ho·∫°ch D·ªãch v·ª• Marketing Assistant',
      coverDescription: 'Cung c·∫•p m·ªôt l·ªô tr√¨nh (master plan) chi ti·∫øt, A-Z, ƒë·ªÉ x√¢y d·ª±ng v√† ra m·∫Øt d·ªãch v·ª• Marketing Assistant.',
      coverTextFont: 'Inter, system-ui, sans-serif',
      coverTextSize: '16',
      coverTextColor: '#1e3a8a',
      avatarUrl: '',
      avatarStoragePath: '',
    };
    const NOTE_TRUNCATE_LIMIT = 160;

    // ========= DATA =========
    const tasksData = [
      // Gƒê1 ‚Äì Tu·∫ßn 1-2
      { id:'1.1', phase:'gd1', week:'gd1-week1-2', title:'Task 1.1: Nghi√™n c·ª©u th·ªã tr∆∞·ªùng & ƒê·ªëi th·ªß', deadline:'12/11/2025', owner:'BOD, Marketing', details:[
        'Ph√¢n t√≠ch website, fanpage c·ªßa 5-10 ƒë·ªëi th·ªß (c·∫£ tr·ª±c ti·∫øp v√† gi√°n ti·∫øp).',
        'L·∫≠p file Excel so s√°nh: g√≥i, gi√°, ƒëi·ªÉm m·∫°nh/y·∫øu.',
        'T√¨m kho·∫£ng tr·ªëng th·ªã tr∆∞·ªùng.'
      ]},
      { id:'1.2', phase:'gd1', week:'gd1-week1-2', title:'Task 1.2: Ch·ªët T√™n Th∆∞∆°ng Hi·ªáu & Domain', deadline:'13/11/2025', owner:'BOD, Marketing', details:[
        'Brainstorm 20+ t√™n (d·ªÖ nh·ªõ, chuy√™n nghi·ªáp).',
        'Ki·ªÉm tra domain .vn/.com v√† t√™n tr√™n MXH.',
        'Ch·ªët t√™n v√† mua domain.'
      ]},
      { id:'1.3', phase:'gd1', week:'gd1-week1-2', title:'Task 1.3: Ch·ªët Ch√¢n dung Kh√°ch h√†ng (Target Audience)', deadline:'19/11/2025', owner:'BOD, Marketing', details:[
        'Nh·∫Øm ƒë·∫øn ai (TVV m·ªõi, Leader, GA...)',
        'N·ªói ƒëau ch√≠nh; m·ª•c ti√™u.',
        'V·∫Ω 2-3 persona chi ti·∫øt.'
      ]},
      { id:'1.4', phase:'gd1', week:'gd1-week1-2', title:'Task 1.4: Ph√°t tri·ªÉn B·ªô Nh·∫≠n Di·ªán Th∆∞∆°ng Hi·ªáu (Brand Kit)', deadline:'19/11/2025', owner:'Marketing, Design', details:[
        'Thi·∫øt k·∫ø Logo (ƒë·ªß + icon).',
        'Ch·ªët 3-5 m√†u (m√£ hex).',
        'Ch·ªët font ti√™u ƒë·ªÅ & n·ªôi dung.',
        'L√†m Brand Guideline PDF c∆° b·∫£n.'
      ]},
      // Gƒê1 ‚Äì Tu·∫ßn 3-4
      { id:'1.5', phase:'gd1', week:'gd1-week3-4', title:'Task 1.5: Thi·∫øt k·∫ø G√≥i D·ªãch V·ª•', deadline:'27/11/2025', owner:'Product, Sales', details:[
        'X√¢y 3 g√≥i: C∆° b·∫£n/Chuy√™n nghi·ªáp/Cao c·∫•p.',
        'B·∫£ng so s√°nh h·∫°ng m·ª•c (Fanpage, Web, Video AI, Ads, B√°o c√°o...).',
        'Li·ªát k√™ r√µ "Kh√¥ng bao g·ªìm".'
      ]},
      { id:'1.6', phase:'gd1', week:'gd1-week3-4', title:'Task 1.6: X√¢y d·ª±ng Ch√≠nh S√°ch Gi√° (Pricing)', deadline:'28/11/2025', owner:'Product, Sales, Finance', details:[
        'ƒê·ªãnh gi√° cho 3 g√≥i (li√™n quan 1.5).',
        'File Excel t√≠nh COGS.',
        'M·ª•c ti√™u l·ª£i nhu·∫≠n g·ªôp 30-50%.'
      ]},
      { id:'1.7', phase:'gd1', week:'gd1-week3-4', title:'Task 1.7: X√¢y d·ª±ng Ch√≠nh S√°ch B√°n H√†ng', deadline:'04/12/2025', owner:'Sales', details:[
        'Ch√≠nh s√°ch hoa h·ªìng (Sales/CTV).',
        'Ch√≠nh s√°ch thanh to√°n.',
        'ƒêi·ªÅu kho·∫£n cam k·∫øt/ho√†n ti·ªÅn (ch·∫∑t ch·∫Ω).'
      ]},
      { id:'1.8', phase:'gd1', week:'gd1-week3-4', title:'Task 1.8: Ph√°c th·∫£o Quy tr√¨nh l√†m vi·ªác (Client Workflow)', deadline:'04/12/2025', owner:'Product, Ops', details:[
        'V·∫Ω flowchart Miro/Figma.',
        '5 b∆∞·ªõc: Sales ch·ªët ‚Üí B√†n giao Ops ‚Üí Onboarding ‚Üí Tri·ªÉn khai h·∫±ng th√°ng ‚Üí B√°o c√°o & Gia h·∫°n.'
      ]},

      // Gƒê2 ‚Äì Tu·∫ßn 5-8
      { id:'2.1', phase:'gd2', week:'gd2-week5-8', title:'Task 2.1: X√¢y d·ª±ng Website Ch√≠nh', deadline:'08/01/2026', owner:'Marketing, IT/Dev', details:[
        'Trang: Home, About, D·ªãch v·ª•, B·∫£ng gi√°, Case Studies, Blog, Li√™n h·ªá.',
        'ƒê·∫πp, chuy√™n nghi·ªáp, mobile-first.'
      ]},
      { id:'2.2', phase:'gd2', week:'gd2-week5-8', title:'Task 2.2: X√¢y d·ª±ng Ph·ªÖu Thu Lead (Sales Funnel)', deadline:'15/01/2026', owner:'Marketing', details:[
        'Thi·∫øt k·∫ø Lead Magnet.',
        'Landing Page t·∫∑ng t√†i li·ªáu.',
        'Email t·ª± ƒë·ªông g·ª≠i qu√† & nu√¥i d∆∞·ª°ng.'
      ]},
      { id:'2.3', phase:'gd2', week:'gd2-week5-8', title:'Task 2.3: X√¢y d·ª±ng K√™nh Social Media', deadline:'16/01/2026', owner:'Marketing', details:[
        'T·∫°o & t·ªëi ∆∞u Fanpage/LinkedIn/YouTube.',
        'ƒêƒÉng 3-5 b√†i m·ªìi m·ªói k√™nh.'
      ]},

      // Gƒê2 ‚Äì Tu·∫ßn 9-11
      { id:'2.4A', phase:'gd2', week:'gd2-week9-11', title:'Task 2.4.A: Ch·∫°y d·ª± √°n "Beta" (L·∫•y Case Study TH·∫¨T)', deadline:'29/01/2026', owner:'Marketing, Sales', details:[
        'L√†m th·ª≠ cho 2-3 TVV (mi·ªÖn ph√≠/gi√° r·∫ª).',
        'Thu 3 case Before-After + 1 video testimonial 30-60s.'
      ]},
      { id:'2.4B', phase:'gd2', week:'gd2-week9-11', title:'Task 2.4.B: X√¢y d·ª±ng "G√≥i Demo" (T√†i s·∫£n M·∫´u)', deadline:'29/01/2026', owner:'Marketing, Design', details:[
        'Website m·∫´u cho TVV t∆∞·ªüng t∆∞·ª£ng.',
        'B·ªô 4 b√†i content m·∫´u.',
        '1-2 video AI m·∫´u (HeyGen).',
        'T·ªïng h·ª£p v√†o 1 folder GDrive.'
      ]},
      { id:'2.5', phase:'gd2', week:'gd2-week9-11', title:'Task 2.5: X√¢y d·ª±ng B·ªô T√†i Li·ªáu B√°n H√†ng (Sales Kit)', deadline:'05/02/2026', owner:'Sales, Marketing', details:[
        'Sales Deck: v·∫•n ƒë·ªÅ ‚Üí gi·∫£i ph√°p ‚Üí g√≥i ‚Üí case.',
        'Proposal template.',
        'Folder Sales Kit t·ªïng h·ª£p.'
      ]},
      { id:'2.5C', phase:'gd2', week:'gd2-week9-11', title:'Task 2.5.C: So·∫°n th·∫£o H·ª£p ƒë·ªìng m·∫´u (Ph√°p l√Ω)', deadline:'05/02/2026', owner:'BOD, Legal', details:[
        'Tham v·∫•n lu·∫≠t s∆∞/m·∫´u chu·∫©n.',
        'R√µ scope theo 3 g√≥i; s·ªë l·∫ßn s·ª≠a; mi·ªÖn tr·ª´; b·∫£o m·∫≠t.'
      ]},

      // Gƒê2 ‚Äì Tu·∫ßn 12-13
      { id:'2.6', phase:'gd2', week:'gd2-week12-13', title:'Task 2.6: Vi·∫øt K·ªãch B·∫£n Video B√°n H√†ng', deadline:'12/02/2026', owner:'Marketing', details:[
        'Script (60s) v·∫•n ƒë·ªÅ-gi·∫£i ph√°p.',
        'Script (2-3p) gi·ªõi thi·ªáu d·ªãch v·ª•.',
        'Script (60s) testimonial.',
        'C√≥ l·ªùi tho·∫°i & m√¥ t·∫£ h√¨nh ·∫£nh.'
      ]},
      { id:'2.7', phase:'gd2', week:'gd2-week12-13', title:'Task 2.7: Quay & D·ª±ng 3 Video B√°n H√†ng', deadline:'26/02/2026', owner:'Marketing', details:[
        'S·∫£n xu·∫•t theo k·ªãch b·∫£n 2.6.',
        '∆Øu ti√™n ch·∫•t l∆∞·ª£ng/AI.',
        'Ph·ª• ƒë·ªÅ, nh·∫°c n·ªÅn, CTA r√µ.'
      ]},
      { id:'2.8', phase:'gd2', week:'gd2-week12-13', title:'Task 2.8: X√¢y d·ª±ng K·∫ø ho·∫°ch Tuy·ªÉn d·ª•ng', deadline:'12/02/2026', owner:'HR', details:[
        'X√°c ƒë·ªãnh v·ªã tr√≠ c·ªët l√µi (1 Content, 1 Account).',
        'JD chi ti·∫øt, ƒëƒÉng tin.',
        'Danh s√°ch 3-5 freelancer d·ª± ph√≤ng.'
      ]},
      { id:'2.9', phase:'gd2', week:'gd2-week12-13', title:'Task 2.9: Chu·∫©n b·ªã T√†i s·∫£n Qu·∫£ng c√°o (Ads)', deadline:'12/02/2026', owner:'Marketing, Ads', details:[
        'T·∫°o 3-5 BM d·ª± ph√≤ng.',
        'Pixel + c√†i l√™n Web/Funnel.',
        'X√°c minh domain FB.',
        'Chu·∫©n b·ªã 1-2 t√†i kho·∫£n Ads c√° nh√¢n.'
      ]},
      { id:'2.10', phase:'gd2', week:'gd2-week12-13', title:'Task 2.10: X√¢y d·ª±ng Template V·∫≠n h√†nh (Internal)', deadline:'12/02/2026', owner:'Ops', details:[
        'Folder Template cho KH m·ªõi.',
        'Project Template (Trello/Base).',
        'Template b√°o c√°o th√°ng (Slides).'
      ]},

      // Gƒê3 ‚Äì Tu·∫ßn 14-15
      { id:'3.1', phase:'gd3', week:'gd3-week14-15', title:'Task 3.1: Ho√†n t·∫•t Ph·ªèng v·∫•n & Ch·ªët nh√¢n s·ª±', deadline:'19/02/2026', owner:'HR', details:[
        'Ph·ªèng v·∫•n, ch·ªët Offer.',
        'K√Ω Hƒê lao ƒë·ªông/d·ªãch v·ª•.'
      ]},
      { id:'3.2A', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.A: Thi·∫øt k·∫ø Client Briefing Form', deadline:'19/02/2026', owner:'Ops, Marketing', details:[
        'Google Form l·∫•y th√¥ng tin.',
        'C√¢u h·ªèi: link, TOV, 3 ƒë·ªëi th·ªß, tu·ª≥ ch·ªçn clone AI...'
      ]},
      { id:'3.2.1', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.1: SOP - Onboarding Kh√°ch H√†ng M·ªõi', deadline:'26/02/2026', owner:'Ops', details:[
        'B√†n giao Sales‚ÜíAM; email ch√†o; h·∫πn kick-off; t·∫°o project (2.10); kick-off.'
      ]},
      { id:'3.2.2', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.2: SOP - D·ªãch V·ª• Qu·∫£n l√Ω Content/Website', deadline:'26/02/2026', owner:'Ops, Content', details:[
        'Content plan th√°ng ‚Üí s·∫£n xu·∫•t ‚Üí duy·ªát (‚â§2 l·∫ßn s·ª≠a/b√†i) ‚Üí l√™n l·ªãch ‚Üí b√°o c√°o.'
      ]},
      { id:'3.2.3', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.3: SOP - D·ªãch V·ª• AI Video (HeyGen/ElevenLabs)', deadline:'26/02/2026', owner:'Ops, Media', details:[
        'Nh·∫≠n brief ‚Üí duy·ªát k·ªãch b·∫£n ‚Üí nh√°p (watermark) ‚Üí duy·ªát (ch·ªâ l·ªói) ‚Üí b√†n giao full HD.'
      ]},
      { id:'3.2B', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.B: Quy tr√¨nh H∆∞·ªõng d·∫´n KH d√πng AI Tools', deadline:'26/02/2026', owner:'Ops, Media', details:[
        '2 video h∆∞·ªõng d·∫´n: quay m·∫´u cho HeyGen; x√°c th·ª±c voice ElevenLabs.'
      ]},
      { id:'3.3', phase:'gd3', week:'gd3-week14-15', title:'Task 3.3: ƒê√†o t·∫°o Nh√¢n s·ª± m·ªõi', deadline:'27/02/2026', owner:'HR, Ops', details:[
        'Training 1 bu·ªïi: 3 g√≥i (1.5), SOPs (3.2.x), k·ªãch b·∫£n sales (3.9).'
      ]},

      // Gƒê3 ‚Äì Tu·∫ßn 16-17
      { id:'3.8A', phase:'gd3', week:'gd3-week16-17', title:'Task 3.8.A: Vi·∫øt Ebook Lead Magnet', deadline:'01/03/2026', owner:'Marketing, Content', details:[
        'Ebook 10-15 trang PDF, ch·ªß ƒë·ªÅ ph√π h·ª£p ph·ªÖu (2.2).'
      ]},
      { id:'3.9', phase:'gd3', week:'gd3-week16-17', title:'Task 3.9: So·∫°n K·ªãch B·∫£n B√°n H√†ng (Sales Scripts)', deadline:'01/03/2026', owner:'Sales', details:[
        'Telesales; email l·∫°nh; x·ª≠ l√Ω t·ª´ ch·ªëi; follow-up 3 l·∫ßn.'
      ]},
      { id:'3.10', phase:'gd3', week:'gd3-week16-17', title:'Task 3.10: So·∫°n B·ªô FAQ', deadline:'01/03/2026', owner:'Marketing, Sales', details:[
        'T·ªëi thi·ªÉu 10 c√¢u: cam k·∫øt lead, ng√¢n s√°ch ads, duy·ªát n·ªôi dung, Hƒê t·ªëi thi·ªÉu...'
      ]},
      { id:'3.11', phase:'gd3', week:'gd3-week16-17', title:'Task 3.11: Thi·∫øt l·∫≠p H·ªá th·ªëng CSKH & SLA', deadline:'05/03/2026', owner:'Ops', details:[
        'Ch·ªët k√™nh h·ªó tr·ª£; so·∫°n SLA; Form ƒëo CSAT h√†ng th√°ng.'
      ]},
      { id:'3.12', phase:'gd3', week:'gd3-week16-17', title:'Task 3.12: K·∫ø ho·∫°ch Qu·∫£n Tr·ªã R·ªßi Ro', deadline:'05/03/2026', owner:'BOD, Ops', details:[
        'Ph∆∞∆°ng √°n cho 5 r·ªßi ro: k·ª≥ v·ªçng, nh√¢n s·ª± ngh·ªâ, ch·∫≠m duy·ªát, tool tƒÉng gi√°, h·∫øt kh√°ch.'
      ]},
      { id:'3.4', phase:'gd3', week:'gd3-week16-17', title:'Task 3.4: Test To√†n b·ªô H·ªá th·ªëng (Internal Testing)', deadline:'06/03/2026', owner:'To√†n ƒë·ªôi', details:[
        'Test Web (2.1), Funnel (2.2), Form li√™n h·ªá, checklist l·ªói.'
      ]},
      { id:'3.5', phase:'gd3', week:'gd3-week16-17', title:'Task 3.5: L√™n K·∫ø Ho·∫°ch N·ªôi Dung Tu·∫ßn L·ªÖ Ra M·∫Øt', deadline:'06/03/2026', owner:'Marketing', details:[
        'L·ªãch 09/03-15/03: k√™nh, n·ªôi dung, media; vi·∫øt s·∫µn 100%.'
      ]},
      { id:'3.6', phase:'gd3', week:'gd3-week16-17', title:'Task 3.6: Chu·∫©n b·ªã Ch∆∞∆°ng tr√¨nh Khuy·∫øn M√£i Ra M·∫Øt', deadline:'06/03/2026', owner:'Sales, Marketing', details:[
        'Ch·ªçn 1 ∆∞u ƒë√£i (v√≠ d·ª• -20% cho 10 KH ƒë·∫ßu); thi·∫øt k·∫ø banner.'
      ]},
      { id:'3.7', phase:'gd3', week:'gd3-week16-17', title:'Task 3.7: R√† so√°t T·ªïng th·ªÉ (Final Check)', deadline:'08/03/2026', owner:'BOD', details:[
        'CEO check: Sales Kit, Hƒê, Website, Ph·ªÖu, Video, Nh√¢n s·ª±, Content ra m·∫Øt.'
      ]},

      // Gƒê4 ‚Äì Tu·∫ßn 18
      { id:'4.1', phase:'gd4', week:'gd4-week18', title:'Task 4.1: Build Hype (tr∆∞·ªõc D-Day)', deadline:'14/03/2026', owner:'Marketing, Sales', details:[
        'Teaser + ƒë·∫øm ng∆∞·ª£c; Sales nh·∫Øn 20 KH ti·ªÅm nƒÉng v·ªÅ ∆∞u ƒë√£i.'
      ]},
      { id:'4.2', phase:'gd4', week:'gd4-week18', title:'Task 4.2: Ki·ªÉm tra K·ªπ thu·∫≠t L·∫ßn Cu·ªëi', deadline:'14/03/2026', owner:'IT, Marketing', details:[
        'Server, website, form ho·∫°t ƒë·ªông; t√†i kho·∫£n Ads & n·∫°p ti·ªÅn s·∫µn s√†ng.'
      ]},
      { id:'4.3', phase:'gd4', week:'gd4-week18', title:'Task 4.3 (D-DAY): Ra M·∫Øt Ch√≠nh Th·ª©c', deadline:'15/03/2026', owner:'To√†n ƒë·ªôi', details:[
        '08:00 g·ª≠i Email Launch; 09:00 ƒëƒÉng b√†i ƒë·ªìng lo·∫°t; 09:01 c·∫£ team chia s·∫ª; tr·ª±c chi·∫øn c·∫£ ng√†y.'
      ]},
      { id:'4.4', phase:'gd4', week:'gd4-week18', title:'Task 4.4: H·ªçp nhanh Cu·ªëi ng√†y', deadline:'15/03/2026', owner:'To√†n ƒë·ªôi', details:[
        '17:00 h·ªçp 30 ph√∫t: t·ªïng k·∫øt lead, KH ch·ªët, v·∫•n ƒë·ªÅ ph√°t sinh.'
      ]},
    ];

    const phaseLabels = {
      gd1: 'Giai ƒêo·∫°n 1: N·ªÅn T·∫£ng & Chi·∫øn L∆∞·ª£c',
      gd2: 'Giai ƒêo·∫°n 2: X√¢y D·ª±ng H·∫° T·∫ßng & T√†i S·∫£n',
      gd3: 'Giai ƒêo·∫°n 3: V·∫≠n H√†nh & T·ªëi ∆Øu',
      gd4: 'Giai ƒêo·∫°n 4: Ra M·∫Øt',
    };

    const taskMap = tasksData.reduce((acc, task) => {
      acc[task.id] = task;
      return acc;
    }, {});

    // ========= STATE =========
    let taskState = {};
    let allTasks = [];
    let notes = [];
    let filteredNotes = [];
    let selectedTimeFilter = 'all';
    let customTypes = defaultCustomTypes.slice();
    let selectedNoteType = customTypes[0] || '';
    let db = null;
    let storage = null;
    let projectRef = null;
    let isProjectReady = false;
    let hasShownSyncWarning = false;
    let progressChart;
    let noteStatsChart = null;
    let taskInputs = [];
    let completeButtons = [];
    let viewButtons = [];
    let debouncedSyncTaskState = () => {};
    let activityLogShowAll = false;
    let currentSettings = { ...defaultSettings };
    let noteDetailModal = null;
    let noteModalContent = null;
    let noteModalAttachment = null;
    let noteModalCloseBtn = null;
    const linkFeedbackTimers = {};
    let noteTypeFeedbackTimer = null;
    const pendingFileRemovals = { logo:false, favicon:false, coverImage:false, avatar:false, loginBg:false };
    let logoFileControl = null;
    let faviconFileControl = null;
    let coverImageFileControl = null;
    let avatarFileControl = null;
    let loginBgFileControl = null;
    let notifications = [];
    let notificationState = {};
    let notificationsInitialized = false;
    let activityLogs = [];

    // Auth & User Management State
    let auth = null;
    let currentUser = null;
    let currentUserData = null;
    let allUsers = [];
    let isAdmin = false;

    // Dynamic Data State
    let dynamicMenus = [];
    let dynamicTasks = {};
    let assignees = [];
    let taskComments = {};
    let expandedMenus = new Set(); // Track which menus are expanded
    const openCommentSections = new Set();
    const autoOpenedCommentSections = new Set();

    // Modal State
    let currentEditingUserId = null;
    let currentEditingMenuId = null;
    let currentEditingTaskId = null;
    let currentEditingAssigneeId = null;
    let currentMenuIdForTask = null;

    // ========= HELPERS =========
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

    function formatDate(date){
      const d = String(date.getDate()).padStart(2,'0');
      const m = String(date.getMonth()+1).padStart(2,'0');
      const y = date.getFullYear();
      return `${d}/${m}/${y}`;
    }
    function parseDate(ddmmyyyy){
      if(!ddmmyyyy) return null;
      const [d,m,y] = ddmmyyyy.split('/').map(Number);
      if(!d||!m||!y) return null;
      return new Date(y, m-1, d);
    }
    function normalizeTimestamp(value){
      if(!value) return null;
      if(typeof value === 'string') return value;
      if(value instanceof Date) return value.toISOString();
      if(typeof value === 'number') return new Date(value).toISOString();
      if(typeof value.toDate === 'function'){ return value.toDate().toISOString(); }
      if(typeof value.seconds === 'number'){ return new Date(value.seconds * 1000).toISOString(); }
      return null;
    }
    function formatDateTime(iso){
      if(!iso) return '-';
      const date = new Date(iso);
      if(Number.isNaN(date.getTime())) return '-';
      const d = String(date.getDate()).padStart(2,'0');
      const m = String(date.getMonth()+1).padStart(2,'0');
      const y = date.getFullYear();
      const h = String(date.getHours()).padStart(2,'0');
      const min = String(date.getMinutes()).padStart(2,'0');
      return `${d}/${m}/${y} ${h}:${min}`;
    }
    function formatDateFromISO(iso){
      if(!iso) return '';
      const date = new Date(iso);
      if(Number.isNaN(date.getTime())) return '';
      const d = String(date.getDate()).padStart(2,'0');
      const m = String(date.getMonth()+1).padStart(2,'0');
      const y = date.getFullYear();
      return `${d}/${m}/${y}`;
    }
    function isValidUrl(url){
      if(!url) return false;
      return /^https?:\/\//i.test(url.trim());
    }
    function hasValidCompletionLink(state){
      if(!state) return false;
      const link = (state.link || '').trim();
      return link !== '' && isValidUrl(link);
    }
    function getCurrentUserName(){
      return (currentUserData && (currentUserData.displayName || currentUserData.email)) || 'Ng∆∞·ªùi d√πng';
    }

    /**
     * Get the current URL path for a menu ID (Single Source of Truth)
     * Always fetches from the latest dynamicMenus array
     * @param {string} menuId - The menu document ID
     * @returns {string} The URL path (e.g., "/giai-doan1")
     */
    function getMenuPath(menuId){
      const menu = dynamicMenus.find(m => m.id === menuId);
      if(!menu){
        console.warn('‚ö†Ô∏è [MENU PATH] Menu not found:', menuId);
        return '/tongquan'; // Fallback to overview
      }
      const slug = menu.slug || `dynamic-menu/${menuId}`;
      return `/${slug}`;
    }
    function updateCompleteButtonState(taskId){
      const group = document.querySelector(`[data-input-group="${taskId}"]`);
      if(!group) return;
      const btn = group.querySelector('.task-complete-btn');
      if(!btn) return;
      const state = ensureTaskEntry(taskId);
      const enabled = isProjectReady && hasValidCompletionLink(state);
      btn.disabled = !enabled;
    }
    function debounce(fn, wait=300){
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(null, args), wait);
      };
    }
    function escapeHtml(value){
      if(value == null) return '';
      const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;' };
      map['"'] = '&quot;';
      map["'"] = '&#39;';
      return String(value).replace(/[&<>"']/g, ch => map[ch] || ch);
    }
    function getFileNameFromUrl(url){
      if(!url) return '';
      try {
        const parsed = new URL(url, window.location.origin);
        const segments = parsed.pathname.split('/').filter(Boolean);
        return segments.length ? decodeURIComponent(segments.pop()) : '';
      } catch(error){
        const sanitized = url.split('?')[0] || '';
        const parts = sanitized.split('/').filter(Boolean);
        return parts.length ? decodeURIComponent(parts.pop()) : '';
      }
    }
    function readFileAsDataURL(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error || new Error('Kh√¥ng th·ªÉ ƒë·ªçc file'));
        reader.readAsDataURL(file);
      });
    }
    function createSettingsFileControl({ key, input, defaultWrapper, activeWrapper, defaultLabel, selectedLabel, preview, chooseBtn, changeBtn, removeBtn, onPreviewChange }){
      if(!input) return null;

      const updateDefaultLabel = (text) => {
        if(defaultLabel) defaultLabel.textContent = text || 'Ch∆∞a ch·ªçn file';
      };

      const showDefaultState = () => {
        if(defaultWrapper) defaultWrapper.classList.remove('hidden');
        if(activeWrapper) activeWrapper.classList.add('hidden');
        if(preview){
          preview.src = '';
          preview.classList.add('hidden');
        }
        if(selectedLabel) selectedLabel.textContent = '';
      };

      const showActiveState = (name, url) => {
        if(defaultWrapper) defaultWrapper.classList.add('hidden');
        if(activeWrapper) activeWrapper.classList.remove('hidden');
        if(selectedLabel) selectedLabel.textContent = name || 'ƒê√£ ch·ªçn file';
        if(preview && url){
          preview.src = url;
          preview.classList.remove('hidden');
        }
      };

      const triggerPreviewChange = (value) => {
        if(typeof onPreviewChange === 'function') onPreviewChange(value);
      };

      const applyRemoval = () => {
        pendingFileRemovals[key] = true;
        input.value = '';
        updateDefaultLabel('Ch∆∞a ch·ªçn file');
        showDefaultState();
        triggerPreviewChange('');
      };

      const handleFileSelection = (file) => {
        if(!file){
          return;
        }
        const name = file.name || 'file';
        updateDefaultLabel(name);
        readFileAsDataURL(file).then(dataUrl => {
          pendingFileRemovals[key] = false;
          showActiveState(name, dataUrl);
          triggerPreviewChange(dataUrl);
        }).catch(error => {
          console.error('Kh√¥ng th·ªÉ xem tr∆∞·ªõc file:', error);
          applyRemoval();
        });
      };

      input.addEventListener('change', () => {
        const file = input.files && input.files[0];
        if(file){
          handleFileSelection(file);
        } else if(!selectedLabel || !selectedLabel.textContent){
          updateDefaultLabel('Ch∆∞a ch·ªçn file');
        }
      });

      const openPicker = (event) => {
        event.preventDefault();
        input.click();
      };

      if(chooseBtn) chooseBtn.addEventListener('click', openPicker);
      if(changeBtn) changeBtn.addEventListener('click', openPicker);
      if(removeBtn) removeBtn.addEventListener('click', (event) => {
        event.preventDefault();
        applyRemoval();
      });

      return {
        setFromUrl(url){
          const name = getFileNameFromUrl(url) || '';
          if(url){
            pendingFileRemovals[key] = false;
            updateDefaultLabel(name || 'ƒê√£ ch·ªçn file');
            showActiveState(name, url);
            triggerPreviewChange(url);
          } else {
            pendingFileRemovals[key] = false;
            updateDefaultLabel('Ch∆∞a ch·ªçn file');
            showDefaultState();
            triggerPreviewChange('');
          }
        },
        clear(){
          applyRemoval();
        },
      };
    }
    async function uploadAsset(file, folder){
      if(!file) return { url:null, storagePath:'' };
      const safeName = (file.name || `asset-${Date.now()}`).replace(/[^a-zA-Z0-9._-]/g, '_');
      const path = `${folder}/${Date.now()}-${safeName}`;
      if(storage){
        try {
          const ref = storageRef(storage, path);
          await uploadBytes(ref, file);
          const url = await getDownloadURL(ref);
          showToast('Upload successful!', 'success');
          return { url, storagePath: ref.fullPath };
        } catch(error){
          console.error('Upload asset th·∫•t b·∫°i, s·∫Ω d√πng ph∆∞∆°ng √°n d·ª± ph√≤ng.', error);
          showToast('Upload failed. Check permissions.', 'error');
        }
      }
      try {
        const base64 = await readFileAsDataURL(file);
        return { url: base64, storagePath: '' };
      } catch(error){
        console.error('Kh√¥ng th·ªÉ ƒë·ªçc file ƒë√≠nh k√®m:', error);
        showToast(`Kh√¥ng th·ªÉ ƒë·ªçc file "${file.name}"`, 'error');
        return { url:null, storagePath:'' };
      }
    }
    function applyFavicon(url){
      let link = document.querySelector('link[rel="icon"]');
      if(!link){
        link = document.createElement('link');
        link.rel = 'icon';
        document.head.appendChild(link);
      }
      if(url){
        link.href = url;
      } else if(link){
        link.removeAttribute('href');
      }
    }
    function showToast(message, type = 'success'){
      const toastContainer = $('#toast-notification');
      if(!toastContainer) return;
      const icon = type === 'success' ? '‚úÖ' : '‚ùå';
      toastContainer.innerHTML = `<div class="toast-content ${type}"><span class="toast-icon">${icon}</span><span class="toast-message">${escapeHtml(message)}</span></div>`;
      toastContainer.classList.remove('hidden', 'hide');
      toastContainer.classList.add('show');
      setTimeout(() => {
        toastContainer.classList.remove('show');
        toastContainer.classList.add('hide');
        setTimeout(() => {
          toastContainer.classList.add('hidden');
          toastContainer.classList.remove('hide');
          toastContainer.innerHTML = '';
        }, 300);
      }, 3000);
    }
    // Helper function to extract YouTube video ID from URL
    function extractYouTubeVideoId(url){
      if(!url) return null;
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    }

    function renderCoverPage(settings = {}){
      const logoEl = $('#cover-logo');
      const logoWrapper = $('#cover-logo-wrapper');
      const logoLink = $('#cover-logo-link');
      const sloganEl = $('#cover-slogan');
      const managerEl = $('#cover-contact-manager');
      const opsEl = $('#cover-contact-ops');
      const coverSection = $('#cover-page');
      const coverTitleEl = $('#cover-title');
      const coverDescEl = $('#cover-description');
      const coverContentWrapper = $('#cover-content-wrapper');
      const youtubeContainer = $('#cover-youtube-container');
      const youtubeIframe = $('#cover-youtube-iframe');

      const logoUrl = (settings.logoUrl || '').trim();
      if(logoEl){
        if(logoUrl){
          logoEl.src = logoUrl;
          logoEl.classList.remove('hidden');
          if(logoWrapper) logoWrapper.classList.remove('hidden');
          if(logoLink) logoLink.classList.remove('hidden');
        } else {
          logoEl.src = '';
          logoEl.classList.add('hidden');
          if(logoWrapper) logoWrapper.classList.add('hidden');
          if(logoLink) logoLink.classList.add('hidden');
        }
      }
      if(sloganEl){
        const slogan = (settings.slogan || '').trim();
        if(slogan){
          sloganEl.textContent = slogan;
          sloganEl.classList.remove('hidden');
        } else {
          sloganEl.textContent = '';
          sloganEl.classList.add('hidden');
        }
      }
      const font = (settings.coverTextFont || '').trim() || defaultSettings.coverTextFont;
      const size = (settings.coverTextSize || '').trim() || defaultSettings.coverTextSize;
      const color = (settings.coverTextColor || '').trim() || defaultSettings.coverTextColor;

      if(coverTitleEl){
        const title = (settings.coverTitle || '').trim() || defaultSettings.coverTitle;
        coverTitleEl.textContent = title;
        // Apply font and color directly to title
        coverTitleEl.style.fontFamily = font;
        coverTitleEl.style.color = color;
      }
      if(coverDescEl){
        const desc = (settings.coverDescription || '').trim() || defaultSettings.coverDescription;
        coverDescEl.textContent = desc;
        // Apply font and color directly to description
        coverDescEl.style.fontFamily = font;
        coverDescEl.style.color = color;
      }
      if(coverContentWrapper){
        coverContentWrapper.style.fontFamily = font;
        coverContentWrapper.style.fontSize = size + 'px';
        coverContentWrapper.style.color = color;
      }
      if(managerEl){
        const manager = (settings.contactManager || '').trim() || '[Ch∆∞a c·∫≠p nh·∫≠t]';
        managerEl.textContent = manager;
      }
      if(opsEl){
        const ops = (settings.contactOps || '').trim() || '[Ch∆∞a c·∫≠p nh·∫≠t]';
        opsEl.textContent = ops;
      }
      if(coverSection){
        const imageUrl = (settings.coverImageUrl || '').trim();
        const color = (settings.coverColor || '').trim();
        coverSection.style.backgroundImage = '';
        coverSection.style.backgroundSize = '';
        coverSection.style.backgroundPosition = '';
        coverSection.style.backgroundColor = '';
        coverSection.style.backgroundRepeat = '';
        coverSection.classList.remove('cover-has-image','cover-has-color');
        if(imageUrl){
          coverSection.style.backgroundImage = `url('${imageUrl}')`;
          coverSection.style.backgroundSize = 'cover';
          coverSection.style.backgroundPosition = 'center';
          coverSection.style.backgroundRepeat = 'no-repeat';
          coverSection.classList.add('cover-has-image');
        } else if(color){
          coverSection.style.backgroundColor = color;
          coverSection.classList.add('cover-has-color');
        }
      }

      // Render YouTube video if provided
      if(youtubeContainer && youtubeIframe){
        const youtubeUrl = (settings.coverYoutubeUrl || '').trim();
        const videoId = extractYouTubeVideoId(youtubeUrl);
        if(videoId){
          youtubeIframe.src = `https://www.youtube.com/embed/${videoId}`;
          youtubeContainer.classList.remove('hidden');
        } else {
          youtubeIframe.src = '';
          youtubeContainer.classList.add('hidden');
        }
      }
    }
    function renderSidebar(settings = {}){
      const logoEl = $('#sidebar-logo');
      const logoLink = $('#sidebar-logo-link');
      const brandingTitle = $('#sidebar-branding-title');
      const logoUrl = (settings.logoUrl || '').trim();
      const hasLogo = !!logoUrl;
      if(logoEl){
        if(hasLogo){
          logoEl.src = logoUrl;
          logoEl.alt = settings.slogan ? `Logo - ${settings.slogan}` : 'Logo d·ª± √°n';
          logoEl.classList.remove('hidden');
        } else {
          logoEl.src = '';
          logoEl.classList.add('hidden');
        }
      }
      if(logoLink){
        logoLink.classList.toggle('hidden', !hasLogo);
      }
      if(brandingTitle){
        brandingTitle.textContent = 'Master Plan (A-Z+)';
      }
    }
    function renderLoginPage(settings = {}){
      const loginPage = $('#login-page');
      const loginLogoEl = $('#login-logo');
      const loginLogoWrapper = $('#login-logo-wrapper');

      // Use the same logo from Brand Identity
      const logoUrl = (settings.logoUrl || '').trim();
      if(loginLogoEl){
        if(logoUrl){
          loginLogoEl.src = logoUrl;
          loginLogoEl.classList.remove('hidden');
          if(loginLogoWrapper) loginLogoWrapper.classList.remove('hidden');
        } else {
          loginLogoEl.src = '';
          loginLogoEl.classList.add('hidden');
          if(loginLogoWrapper) loginLogoWrapper.classList.add('hidden');
        }
      }

      // Set login background image
      if(loginPage){
        const loginBgUrl = (settings.loginBgUrl || '').trim();
        if(loginBgUrl){
          loginPage.style.backgroundImage = `url('${loginBgUrl}')`;
        } else {
          // Use default background
          loginPage.style.backgroundImage = "url('https://images.unsplash.com/photo-1557683316-973673baf926?auto=format&fit=crop&w=1920&q=80')";
        }
      }
    }
    function renderAvatar(avatarUrl){
      // Sidebar avatar
      const url = (avatarUrl || '').trim();
      const sidebarAvatarImg = $('#sidebar-user-avatar');
      const sidebarDefaultIcon = $('#sidebar-default-avatar-icon');
      if(sidebarAvatarImg && sidebarDefaultIcon){
        if(url){
          sidebarAvatarImg.src = url;
          sidebarAvatarImg.classList.remove('hidden');
          sidebarDefaultIcon.classList.add('hidden');
        } else {
          sidebarAvatarImg.src = '';
          sidebarAvatarImg.classList.add('hidden');
          sidebarDefaultIcon.classList.remove('hidden');
        }
      }
    }
    function populateSettingsForm(settings = {}){
      const sloganInput = $('#setting-slogan');
      const managerInput = $('#setting-contact-manager');
      const opsInput = $('#setting-contact-ops');
      const colorInput = $('#setting-cover-color');
      const coverTitleInput = $('#setting-cover-title');
      const coverDescInput = $('#setting-cover-description');
      const coverFontInput = $('#setting-cover-font');
      const coverTextSizeInput = $('#setting-cover-text-size');
      const coverTextColorInput = $('#setting-cover-text-color');
      const coverYoutubeInput = $('#setting-cover-youtube');

      if(sloganInput) sloganInput.value = settings.slogan || '';
      if(managerInput) managerInput.value = settings.contactManager || '';
      if(opsInput) opsInput.value = settings.contactOps || '';
      if(colorInput){
        const color = (settings.coverColor || '').trim();
        colorInput.value = color && /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(color) ? color : '#bae6fd';
      }
      if(coverTitleInput) coverTitleInput.value = settings.coverTitle || defaultSettings.coverTitle;
      if(coverDescInput) coverDescInput.value = settings.coverDescription || defaultSettings.coverDescription;
      if(coverFontInput) coverFontInput.value = settings.coverTextFont || defaultSettings.coverTextFont;
      if(coverTextSizeInput) coverTextSizeInput.value = settings.coverTextSize || defaultSettings.coverTextSize;
      if(coverTextColorInput){
        const textColor = (settings.coverTextColor || '').trim();
        coverTextColorInput.value = textColor && /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(textColor) ? textColor : '#1e3a8a';
      }
      if(coverYoutubeInput) coverYoutubeInput.value = settings.coverYoutubeUrl || '';

      const logoInput = $('#setting-logo-upload'); if(logoInput) logoInput.value = '';
      const faviconInput = $('#setting-favicon-upload'); if(faviconInput) faviconInput.value = '';
      const coverImageInput = $('#setting-cover-image-upload'); if(coverImageInput) coverImageInput.value = '';
      const avatarInput = $('#setting-avatar-upload'); if(avatarInput) avatarInput.value = '';
      const loginBgInput = $('#setting-login-bg-upload'); if(loginBgInput) loginBgInput.value = '';
      if(logoFileControl) logoFileControl.setFromUrl((settings.logoUrl || '').trim());
      if(faviconFileControl) faviconFileControl.setFromUrl((settings.faviconUrl || '').trim());
      if(coverImageFileControl) coverImageFileControl.setFromUrl((settings.coverImageUrl || '').trim());
      if(loginBgFileControl) loginBgFileControl.setFromUrl((settings.loginBgUrl || '').trim());
      // Load avatar from current user data (user-specific)
      if(avatarFileControl) avatarFileControl.setFromUrl((currentUserData.avatarUrl || '').trim());
    }
    async function saveSettings(){
      if(!ensureProjectReady()) return;
      const sloganInput = $('#setting-slogan');
      const managerInput = $('#setting-contact-manager');
      const opsInput = $('#setting-contact-ops');
      const logoInput = $('#setting-logo-upload');
      const faviconInput = $('#setting-favicon-upload');
      const coverImageInput = $('#setting-cover-image-upload');
      const avatarInput = $('#setting-avatar-upload');
      const loginBgInput = $('#setting-login-bg-upload');
      const colorInput = $('#setting-cover-color');
      const coverTitleInput = $('#setting-cover-title');
      const coverDescInput = $('#setting-cover-description');
      const coverFontInput = $('#setting-cover-font');
      const coverTextSizeInput = $('#setting-cover-text-size');
      const coverTextColorInput = $('#setting-cover-text-color');
      const coverYoutubeInput = $('#setting-cover-youtube');

      const nextSettings = { ...currentSettings };
      nextSettings.slogan = sloganInput ? sloganInput.value.trim() : '';
      nextSettings.contactManager = managerInput ? managerInput.value.trim() : '';
      nextSettings.contactOps = opsInput ? opsInput.value.trim() : '';
      const colorValue = colorInput ? (colorInput.value || '').trim() : '';
      nextSettings.coverColor = /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(colorValue) ? colorValue : '';
      nextSettings.coverTitle = coverTitleInput ? coverTitleInput.value.trim() : defaultSettings.coverTitle;
      nextSettings.coverDescription = coverDescInput ? coverDescInput.value.trim() : defaultSettings.coverDescription;
      nextSettings.coverTextFont = coverFontInput ? coverFontInput.value.trim() : defaultSettings.coverTextFont;
      nextSettings.coverTextSize = coverTextSizeInput ? coverTextSizeInput.value.trim() : defaultSettings.coverTextSize;
      const textColorValue = coverTextColorInput ? (coverTextColorInput.value || '').trim() : '';
      nextSettings.coverTextColor = /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(textColorValue) ? textColorValue : defaultSettings.coverTextColor;
      nextSettings.coverYoutubeUrl = coverYoutubeInput ? coverYoutubeInput.value.trim() : '';

      if(pendingFileRemovals.logo){
        nextSettings.logoUrl = '';
        nextSettings.logoStoragePath = '';
      } else if(logoInput && logoInput.files && logoInput.files[0]){
        const uploadResult = await uploadAsset(logoInput.files[0], 'branding/logos');
        if(uploadResult.url){
          nextSettings.logoUrl = uploadResult.url;
          nextSettings.logoStoragePath = uploadResult.storagePath || '';
        }
      }

      if(pendingFileRemovals.favicon){
        nextSettings.faviconUrl = '';
        nextSettings.faviconStoragePath = '';
      } else if(faviconInput && faviconInput.files && faviconInput.files[0]){
        const uploadResult = await uploadAsset(faviconInput.files[0], 'branding/favicon');
        if(uploadResult.url){
          nextSettings.faviconUrl = uploadResult.url;
          nextSettings.faviconStoragePath = uploadResult.storagePath || '';
        }
      }

      if(pendingFileRemovals.coverImage){
        nextSettings.coverImageUrl = '';
        nextSettings.coverImageStoragePath = '';
      } else if(coverImageInput && coverImageInput.files && coverImageInput.files[0]){
        const uploadResult = await uploadAsset(coverImageInput.files[0], 'branding/cover');
        if(uploadResult.url){
          nextSettings.coverImageUrl = uploadResult.url;
          nextSettings.coverImageStoragePath = uploadResult.storagePath || '';
        }
      }

      if(pendingFileRemovals.loginBg){
        nextSettings.loginBgUrl = '';
        nextSettings.loginBgStoragePath = '';
      } else if(loginBgInput && loginBgInput.files && loginBgInput.files[0]){
        const uploadResult = await uploadAsset(loginBgInput.files[0], 'branding/login');
        if(uploadResult.url){
          nextSettings.loginBgUrl = uploadResult.url;
          nextSettings.loginBgStoragePath = uploadResult.storagePath || '';
        }
      }

      // Handle user avatar separately (user-specific, not project-wide)
      let userAvatarUrl = currentUserData.avatarUrl || '';
      if(pendingFileRemovals.avatar){
        userAvatarUrl = '';
      } else if(avatarInput && avatarInput.files && avatarInput.files[0]){
        const uploadResult = await uploadAsset(avatarInput.files[0], `user/${currentUser.uid}/avatar`);
        if(uploadResult.url){
          userAvatarUrl = uploadResult.url;
        }
      }

      try {
        // Save project settings
        await updateProjectData({ settings: nextSettings });
        currentSettings = { ...nextSettings };

        // Save user avatar to user document
        if(currentUser){
          await updateDoc(doc(db, 'users', currentUser.uid), {
            avatarUrl: userAvatarUrl,
            updatedAt: serverTimestamp()
          });
          currentUserData.avatarUrl = userAvatarUrl;
        }

        renderCoverPage(currentSettings);
        renderSidebar(currentSettings);
        renderLoginPage(currentSettings);
        applyFavicon(currentSettings.faviconUrl || '');
        renderAvatar(userAvatarUrl);
        populateSettingsForm(currentSettings);
        showToast('ƒê√£ l∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng', 'success');
      } catch(error){
        console.error('Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t:', error);
        showToast('Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      }
    }
    function openNoteDetailModal(note){
      if(!noteDetailModal || !noteModalContent || !note) return;
      noteModalContent.textContent = note.content || '';
      if(noteModalAttachment){
        if(note.attachmentUrl){
          const isImage = (note.attachmentMime || '').startsWith('image/');
          const safeName = escapeHtml(note.attachmentName || 'T·ªáp ƒë√≠nh k√®m');
          if(isImage){
            noteModalAttachment.innerHTML = `<div class="space-y-2"><div class="text-sm font-medium text-slate-600">T·ªáp ƒë√≠nh k√®m:</div><img src="${note.attachmentUrl}" alt="${safeName}" class="w-full max-h-96 object-contain rounded-lg border border-slate-200" loading="lazy" /></div>`;
          } else {
            noteModalAttachment.innerHTML = `<div class="space-y-2"><div class="text-sm font-medium text-slate-600">T·ªáp ƒë√≠nh k√®m:</div><a href="${note.attachmentUrl}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 text-blue-600 font-semibold"><span>üìé</span><span>${safeName}</span></a></div>`;
          }
        } else {
          noteModalAttachment.innerHTML = '';
        }
      }
      noteDetailModal.classList.add('active');
      noteDetailModal.setAttribute('aria-hidden','false');
    }
    function closeNoteDetailModal(){
      if(!noteDetailModal) return;
      noteDetailModal.classList.remove('active');
      noteDetailModal.setAttribute('aria-hidden','true');
      if(noteModalContent) noteModalContent.textContent = '';
      if(noteModalAttachment) noteModalAttachment.innerHTML = '';
    }
    function evaluateDeadline(deadline, completed){
      if(!deadline) return null;
      const target = parseDate(deadline);
      if(!target) return null;
      const today = new Date(); today.setHours(0,0,0,0);
      const diff = Math.ceil((target - today) / DAY_MS);
      if(completed){
        return { status:'completed', diffDays: diff, text:'', className:'' };
      }
      if(diff < 0){
        return { status:'danger', diffDays: diff, text:`Qu√° h·∫°n ${Math.abs(diff)} ng√†y`, className:'deadline-danger' };
      }
      if(diff <= 7){
        const text = diff === 0 ? 'H·∫°n h√¥m nay' : `C√≤n ${diff} ng√†y`;
        return { status:'warning', diffDays: diff, text, className:'deadline-warning' };
      }
      return { status:'safe', diffDays: diff, text:`C√≤n ${diff} ng√†y`, className:'deadline-safe' };
    }

    function sanitizeTaskState(){
      const sanitized = {};
      Object.keys(taskState).forEach(id => {
        const state = taskState[id] || {};
        const rawComments = Array.isArray(state.comments) ? state.comments : [];
        const comments = rawComments
          .slice(-50)
          .map(comment => ({
            text: String(comment.text || '').trim().slice(0, 2000),
            userName: String(comment.userName || '').trim().slice(0, 200),
            timestamp: normalizeTimestamp(comment.timestamp),
          }))
          .filter(comment => comment.text.length > 0);
        sanitized[id] = {
          completed: !!state.completed,
          link: (state.link || '').trim(),
          completedAt: normalizeTimestamp(state.completedAt),
          updatedAt: normalizeTimestamp(state.updatedAt),
          comments,
        };
      });
      return sanitized;
    }

    function ensureTaskEntry(id){
      if(!taskState[id]){
        taskState[id] = {
          completed: false,
          link: '',
          completedAt: null,
          updatedAt: null,
          comments: [],
        };
      }
      if(!Array.isArray(taskState[id].comments)){
        const legacyComment = typeof taskState[id].comment === 'string' && taskState[id].comment.trim()
          ? [{ text: taskState[id].comment.trim(), userName: '', timestamp: new Date().toISOString() }]
          : [];
        taskState[id].comments = legacyComment;
      }
      if(taskState[id].comment !== undefined){
        delete taskState[id].comment;
      }
      return taskState[id];
    }

    function normalizeTaskState(rawState){
      const defaults = buildDefaultTaskState();
      const normalized = {};
      Object.keys(defaults).forEach(id => {
        const existing = rawState && rawState[id] ? rawState[id] : {};
        const rawComments = Array.isArray(existing.comments) ? existing.comments : [];
        const comments = rawComments
          .map(comment => ({
            text: String(comment.text || '').trim(),
            userName: String(comment.userName || '').trim(),
            timestamp: normalizeTimestamp(comment.timestamp),
          }))
          .filter(comment => comment.text.length > 0)
          .slice(-50);
        normalized[id] = {
          completed: !!existing.completed,
          link: (existing.link || '').trim(),
          completedAt: normalizeTimestamp(existing.completedAt),
          updatedAt: normalizeTimestamp(existing.updatedAt),
          comments,
        };
      });
      return normalized;
    }

    function sanitizeActivityLogs(){
      if(!Array.isArray(activityLogs)) return [];
      return activityLogs
        .slice(0, 200)
        .map(entry => ({
          id: entry.id || `${entry.taskId || 'log'}-${normalizeTimestamp(entry.updatedAt) || Date.now()}`,
          taskId: entry.taskId || '',
          taskName: (entry.taskName || '').trim(),
          phase: (entry.phase || '').trim(),
          status: (entry.status || 'completed').trim(),
          completedAt: normalizeTimestamp(entry.completedAt),
          updatedAt: normalizeTimestamp(entry.updatedAt) || new Date().toISOString(),
          performedBy: (entry.performedBy || '').trim().slice(0, 200),
        }))
        .filter(entry => entry.taskId && entry.updatedAt);
    }

    function normalizeActivityLogs(rawLogs){
      if(!Array.isArray(rawLogs)) return [];
      return rawLogs
        .map(log => {
          const taskMeta = taskMap[log.taskId] || {};
          const normalizedUpdatedAt = normalizeTimestamp(log.updatedAt) || normalizeTimestamp(log.completedAt) || new Date().toISOString();
          return {
            id: typeof log.id === 'string' && log.id ? log.id : `${log.taskId || 'log'}-${normalizedUpdatedAt}`,
            taskId: log.taskId || '',
            taskName: (log.taskName || taskMeta.title || '').trim(),
            phase: (log.phase || taskMeta.phase || '').trim(),
            status: (log.status || (log.completedAt ? 'completed' : 'updated') || 'completed').trim(),
            completedAt: normalizeTimestamp(log.completedAt),
            updatedAt: normalizedUpdatedAt,
            performedBy: (log.performedBy || '').trim(),
          };
        })
        .filter(log => log.taskId && log.updatedAt)
        .sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime())
        .slice(0, 200);
    }

    function recordActivityEntry({ taskId, taskName, phase, status, timestamp = new Date().toISOString(), completedAt = null, performedBy, menuId }){
      if(!taskId) return;
      const performer = performedBy || getCurrentUserName();
      const entry = {
        id: `${taskId}-${Date.now()}`,
        taskId,
        taskName: taskName || `Task ${taskId}`,
        phase: phase || '-',
        status,
        completedAt: completedAt || (status === 'completed' ? timestamp : null),
        updatedAt: timestamp,
        performedBy: performer,
        menuId: menuId || null, // Store menu ID for dynamic tasks
      };
      activityLogs = [entry, ...activityLogs].slice(0, 200);
    }

    function recordTaskActivity(taskId, status, timestamp = new Date().toISOString()){
      const task = taskMap[taskId];
      if(!task) return;
      recordActivityEntry({
        taskId,
        taskName: task.title,
        phase: task.phase,
        status,
        timestamp,
        completedAt: status === 'completed' ? timestamp : null,
      });
    }

    function showLinkFeedback(taskId, message = '', type = 'error'){
      const feedbackEl = document.querySelector(`[data-link-feedback="${taskId}"]`);
      if(!feedbackEl) return;
      if(linkFeedbackTimers[taskId]){
        clearTimeout(linkFeedbackTimers[taskId]);
        delete linkFeedbackTimers[taskId];
      }
      if(!message){
        feedbackEl.textContent = '';
        feedbackEl.classList.remove('show');
        return;
      }
      feedbackEl.textContent = message;
      feedbackEl.classList.add('show');
      feedbackEl.style.color = type === 'success' ? '#047857' : '#b91c1c';
      linkFeedbackTimers[taskId] = setTimeout(() => {
        feedbackEl.classList.remove('show');
        feedbackEl.textContent = '';
        delete linkFeedbackTimers[taskId];
      }, 2500);
    }

    function saveTaskComment(taskId){
      if(!ensureProjectReady()) return;
      const commentInput = document.querySelector(`[data-comment-input="${taskId}"]`);
      if(!commentInput) return;
      const commentText = commentInput.value.trim();
      if(!commentText) return;

      const state = ensureTaskEntry(taskId);
      if(!Array.isArray(state.comments)){
        state.comments = [];
      }

      state.comments.push({
        text: commentText,
        userName: getCurrentUserName(),
        timestamp: new Date().toISOString(),
      });

      state.updatedAt = new Date().toISOString();
      commentInput.value = '';
      openCommentSections.add(taskId);
      syncTaskState();
      updateUI();
      showToast('Comment ƒë√£ ƒë∆∞·ª£c l∆∞u', 'success');
    }

    function initializeCommentSection(taskId){
      const section = document.querySelector(`[data-comment-section="${taskId}"]`);
      if(!section || section.dataset.ready === 'true') return;
      section.innerHTML = `
        <div class="mt-3 pt-3 border-t border-gray-200">
          <label class="block text-sm font-medium text-gray-700 mb-2">üí¨ Comments</label>
          <div class="task-comments-list mb-3 space-y-2" data-comments-list="${taskId}"></div>
          <div class="flex gap-2">
            <textarea class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y" rows="2" placeholder="Nh·∫≠p comment..." data-comment-input="${taskId}"></textarea>
            <button type="button" class="task-btn btn-complete self-end px-4 py-2" data-comment-save="${taskId}">üí¨ Comment</button>
          </div>
        </div>
      `;
      section.dataset.ready = 'true';
      section.setAttribute('aria-hidden', 'true');

      const saveBtn = section.querySelector(`[data-comment-save="${taskId}"]`);
      if(saveBtn && !saveBtn.dataset.bound){
        saveBtn.dataset.bound = 'true';
        saveBtn.addEventListener('click', () => saveTaskComment(taskId));
      }

      const commentInput = section.querySelector(`[data-comment-input="${taskId}"]`);
      if(commentInput && !commentInput.dataset.bound){
        commentInput.dataset.bound = 'true';
        commentInput.addEventListener('keydown', e => {
          if(e.key === 'Enter' && !e.shiftKey){
            e.preventDefault();
            saveTaskComment(taskId);
          }
        });
      }
    }

    function showNoteTypeFeedback(message = '', type = 'info'){
      const feedbackEl = $('#note-type-feedback');
      if(!feedbackEl) return;
      if(noteTypeFeedbackTimer){
        clearTimeout(noteTypeFeedbackTimer);
        noteTypeFeedbackTimer = null;
      }
      if(!message){
        feedbackEl.textContent = '';
        feedbackEl.classList.add('hidden');
        return;
      }
      const color = type === 'error' ? '#dc2626' : type === 'success' ? '#047857' : '#1f2937';
      feedbackEl.style.color = color;
      feedbackEl.textContent = message;
      feedbackEl.classList.remove('hidden');
      noteTypeFeedbackTimer = setTimeout(() => {
        feedbackEl.classList.add('hidden');
        feedbackEl.textContent = '';
        noteTypeFeedbackTimer = null;
      }, 2500);
    }
    function computeTaskSchedule(){
      const segmentTimeline = {};
      let cursor = new Date(projectPlanStart);
      timelineSegments.forEach((segment, index) => {
        const start = new Date(cursor);
        let end = new Date(start);
        end.setDate(end.getDate() + segment.duration - 1);
        if(index === timelineSegments.length - 1){
          end = new Date(projectLaunchDate);
        }
        segmentTimeline[segment.week] = { start, end };
        cursor = new Date(end);
        cursor.setDate(cursor.getDate() + 1);
      });

      const tasksByWeek = tasksData.reduce((acc, task) => {
        if(!acc[task.week]) acc[task.week] = [];
        acc[task.week].push(task);
        return acc;
      }, {});

      Object.entries(tasksByWeek).forEach(([week, list]) => {
        const timeline = segmentTimeline[week];
        if(!timeline) return;
        const segmentStart = new Date(timeline.start);
        const segmentEnd = new Date(timeline.end);
        const segmentDuration = Math.max(1, Math.round((segmentEnd - segmentStart) / DAY_MS) + 1);
        const baseDuration = Math.max(1, Math.floor(segmentDuration / list.length));
        let remainder = segmentDuration - baseDuration * list.length;
        let currentStart = new Date(segmentStart);

        list.forEach((task, index) => {
          let duration = baseDuration;
          if(remainder > 0){
            duration += 1;
            remainder -= 1;
          }
          const taskStart = new Date(currentStart);
          let taskEnd = new Date(taskStart);
          if(index === list.length - 1){
            taskEnd = new Date(segmentEnd);
          } else {
            taskEnd.setDate(taskEnd.getDate() + duration - 1);
          }
          task.startDate = formatDate(taskStart);
          task.endDate = formatDate(taskEnd);
          task.deadline = task.endDate;
          task.durationDays = Math.max(1, Math.round((taskEnd - taskStart) / DAY_MS) + 1);
          currentStart = new Date(taskEnd);
          currentStart.setDate(currentStart.getDate() + 1);
        });
      });
    }

    computeTaskSchedule();

    function buildDefaultTaskState(){
      const state = {};
      tasksData.forEach(t => {
        state[t.id] = {
          completed: false,
          link: '',
          completedAt: null,
          updatedAt: null,
          comments: [],
        };
      });
      return state;
    }

    taskState = buildDefaultTaskState();

    // ========= TASK SORTING & DRAG-AND-DROP HELPERS =========

    /**
     * Natural sort comparison for task names
     * Handles numbers correctly (e.g., Task 2 < Task 10)
     */
    function naturalSort(a, b) {
      const nameA = (a.title || a.name || '').toLowerCase();
      const nameB = (b.title || b.name || '').toLowerCase();

      return nameA.localeCompare(nameB, 'vi', { numeric: true, sensitivity: 'base' });
    }

    /**
     * Sort tasks by due date
     */
    function sortByDueDate(a, b) {
      const dateA = a.endDate ? new Date(a.endDate) : new Date('9999-12-31');
      const dateB = b.endDate ? new Date(b.endDate) : new Date('9999-12-31');
      return dateA - dateB;
    }

    /**
     * Sort tasks array based on selected mode
     * @param {Array} tasks - Array of task objects
     * @param {string} sortMode - 'custom', 'name', or 'duedate'
     * @returns {Array} - Sorted tasks array
     */
    function sortTasks(tasks, sortMode = 'custom') {
      const tasksCopy = [...tasks];

      switch(sortMode) {
        case 'name':
          return tasksCopy.sort(naturalSort);
        case 'duedate':
          return tasksCopy.sort(sortByDueDate);
        case 'custom':
        default:
          // Sort by order field (already done by Firestore query)
          return tasksCopy.sort((a, b) => (a.order || 0) - (b.order || 0));
      }
    }

    /**
     * Handle sort dropdown change
     * @param {string} menuId - The menu ID
     * @param {string} sortMode - The selected sort mode
     */
    function handleSortChange(menuId, sortMode) {
      console.log('üîÑ [SORT] Changing sort mode:', { menuId, sortMode });

      const tasks = dynamicTasks[menuId] || [];
      const sortedTasks = sortTasks(tasks, sortMode);

      // Update the dynamicTasks array with sorted tasks
      dynamicTasks[menuId] = sortedTasks;

      // Re-render the tasks
      renderSortedTasks(menuId, sortedTasks, sortMode);

      // Enable/disable dragging based on sort mode
      updateDragState(menuId, sortMode === 'custom');
    }

    /**
     * Update drag state for a menu
     * @param {string} menuId - The menu ID
     * @param {boolean} enabled - Whether dragging should be enabled
     */
    function updateDragState(menuId, enabled) {
      const sortableInstance = window.taskSortables?.[menuId];
      if (sortableInstance) {
        sortableInstance.option('disabled', !enabled);

        // Update visual feedback
        const container = $(`#dynamic-menu-tasks-container`);
        if (container) {
          container.classList.toggle('draggable-disabled', !enabled);
          container.setAttribute('data-draggable', enabled ? 'true' : 'false');
        }
      }
    }

    /**
     * Render sorted tasks
     * @param {string} menuId - The menu ID
     * @param {Array} tasks - Sorted tasks array
     * @param {string} sortMode - Current sort mode
     */
    function renderSortedTasks(menuId, tasks, sortMode) {
      const tasksContainer = $('#dynamic-menu-tasks-container');
      if (!tasksContainer) return;

      if (tasks.length === 0) {
        tasksContainer.innerHTML = `
          <div class="card-section text-center py-8">
            <p class="text-gray-500">Ch∆∞a c√≥ task n√†o. ${isAdmin ? 'V√†o Qu·∫£n L√Ω K·∫ø Ho·∫°ch ƒë·ªÉ th√™m task.' : ''}</p>
          </div>
        `;
        return;
      }

      // Render tasks
      tasksContainer.innerHTML = tasks.map(task => {
        const assignee = assignees.find(a => a.id === task.assigneeId);
        const assigneeName = assignee ? assignee.name : 'Ch∆∞a g√°n';
        const isCompleted = isTaskComplete(task);
        const startDateStr = task.startDate ? formatDateFromISO(task.startDate) : 'Ch∆∞a ƒë·∫∑t';
        const endDateStr = task.endDate ? formatDateFromISO(task.endDate) : 'Ch∆∞a ƒë·∫∑t';

        // Calculate remaining time
        let remainingTimeHtml = '';
        if (task.endDate && !isCompleted) {
          const deadlineInfo = evaluateDeadline(formatDateFromISO(task.endDate), false);
          if (deadlineInfo) {
            remainingTimeHtml = `<span class="${deadlineInfo.className}">${deadlineInfo.text}</span>`;
          }
        } else if (isCompleted) {
          remainingTimeHtml = '<span class="text-green-600">‚úÖ ƒê√£ ho√†n th√†nh</span>';
        } else {
          remainingTimeHtml = '<span class="text-gray-500">Ch∆∞a c√≥ deadline</span>';
        }

        return `
          <div class="task-card ${isCompleted ? 'completed' : ''}" id="dynamic-task-${task.id}" data-task-id="${task.id}">
            <div class="task-header" ${sortMode === 'custom' ? 'style="cursor: move;"' : ''}>
              <h4 class="task-title">${sortMode === 'custom' ? '‚†ø ' : ''}${escapeHtml(task.title || task.name || 'Untitled')}</h4>
              <span class="task-status ${isCompleted ? 'status-completed' : 'status-pending'}">
                ${isCompleted ? 'HO√ÄN TH√ÄNH' : 'CH∆ØA XONG'}
              </span>
            </div>
            ${task.description ? `
              <div class="task-details">
                <div class="task-details-label">Chi ti·∫øt:</div>
                <p class="task-description">${escapeHtml(task.description)}</p>
              </div>
            ` : ''}
            <div class="task-meta">
              <span>üë§ ${escapeHtml(assigneeName)}</span>
              <span>|</span>
              <span>üìÖ ${startDateStr} ‚Üí ${endDateStr}</span>
              <span>|</span>
              ${remainingTimeHtml}
            </div>
            <div class="task-action-area">
              ${!isCompleted ? `
                <div class="task-input-group" data-input-group="${task.id}">
                  <input
                    type="url"
                    class="task-link-input"
                    id="task-input-${task.id}"
                    data-task-id="${task.id}"
                    data-menu-id="${menuId}"
                    placeholder="D√°n link (Google Drive, Canva, Facebook post...)"
                    value="${escapeHtml(task.completionLink || '')}"
                  />
                  <button
                    type="button"
                    class="task-btn btn-complete task-complete-btn"
                    data-task-id="${task.id}"
                    data-menu-id="${menuId}"
                    ${!task.completionLink ? 'disabled' : ''}
                  >
                    Ho√†n Th√†nh
                  </button>
                </div>
              ` : `
                <div class="task-completed-actions" data-completed-actions="${task.id}">
                  <button
                    type="button"
                    class="task-btn btn-view task-view-btn"
                    data-task-id="${task.id}"
                    data-menu-id="${menuId}"
                    ${!task.completionLink ? 'disabled' : ''}
                  >
                    üîó View
                  </button>
                  <button
                    type="button"
                    class="task-btn btn-secondary task-edit-btn"
                    data-task-id="${task.id}"
                    data-menu-id="${menuId}"
                  >
                    ‚úèÔ∏è Edit
                  </button>
                </div>
              `}
              <div class="task-link-feedback" id="task-feedback-${task.id}"></div>
            </div>
          </div>
        `;
      }).join('');

      // Re-attach event listeners for task actions
      attachTaskEventListeners(menuId);

      // Re-initialize Sortable if in custom mode
      if (sortMode === 'custom') {
        initializeSortableForMenu(menuId);
      }
    }

    /**
     * Attach event listeners to task buttons
     * @param {string} menuId - The menu ID
     */
    function attachTaskEventListeners(menuId) {
      // Complete buttons
      $$('.task-complete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const taskId = btn.dataset.taskId;
          const menuIdFromBtn = btn.dataset.menuId;
          await handleTaskCompletionNew(taskId, menuIdFromBtn);
        });
      });

      // View buttons
      $$('.task-view-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const taskId = btn.dataset.taskId;
          const task = (dynamicTasks[menuId] || []).find(t => t.id === taskId);
          if (task?.completionLink) {
            window.open(task.completionLink, '_blank', 'noopener,noreferrer');
          }
        });
      });

      // Edit buttons (reopen task)
      $$('.task-edit-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const taskId = btn.dataset.taskId;
          const menuIdFromBtn = btn.dataset.menuId;
          await handleTaskReopenNew(taskId, menuIdFromBtn);
        });
      });

      // Input change listeners
      $$('.task-link-input').forEach(input => {
        input.addEventListener('input', (e) => {
          const taskId = input.dataset.taskId;
          const completeBtn = document.querySelector(`.task-complete-btn[data-task-id="${taskId}"]`);
          if (completeBtn) {
            completeBtn.disabled = !e.target.value.trim();
          }
        });
      });
    }

    /**
     * Initialize Sortable.js for a menu
     * @param {string} menuId - The menu ID
     */
    function initializeSortableForMenu(menuId) {
      const container = $('#dynamic-menu-tasks-container');
      if (!container || typeof Sortable === 'undefined') {
        console.warn('‚ö†Ô∏è [SORTABLE] Container or Sortable.js not available');
        return;
      }

      // Destroy existing sortable instance
      if (window.taskSortables?.[menuId]) {
        window.taskSortables[menuId].destroy();
      }

      // Initialize Sortable.js
      if (!window.taskSortables) {
        window.taskSortables = {};
      }

      window.taskSortables[menuId] = new Sortable(container, {
        animation: 150,
        handle: '.task-header',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        onEnd: async (evt) => {
          if (evt.oldIndex === evt.newIndex) return;

          console.log('üîÑ [DRAG] Task reordered:', { oldIndex: evt.oldIndex, newIndex: evt.newIndex });

          // Update task order in dynamicTasks array
          const tasks = dynamicTasks[menuId] || [];
          const [movedTask] = tasks.splice(evt.oldIndex, 1);
          tasks.splice(evt.newIndex, 0, movedTask);

          // Update order field for all tasks
          tasks.forEach((task, index) => {
            task.order = index;
          });

          // Optimistic UI update (already done by Sortable.js)
          dynamicTasks[menuId] = tasks;

          // Save to Firebase
          await handleReorder(menuId, tasks);
        }
      });

      console.log('‚úÖ [SORTABLE] Initialized for menu:', menuId);
    }

    /**
     * Handle task reorder - update Firebase
     * @param {string} menuId - The menu ID
     * @param {Array} tasks - Reordered tasks array with updated order fields
     */
    async function handleReorder(menuId, tasks) {
      if (!db || !isProjectReady) {
        console.error('‚ùå [REORDER] Database not ready');
        showToast('Kh√¥ng th·ªÉ l∆∞u th·ª© t·ª± task', 'error');
        return;
      }

      try {
        const projectId = ensureProjectId();
        const batch = writeBatch(db);

        // Update order field for each task
        tasks.forEach((task, index) => {
          const taskRef = doc(db, 'projects', projectId, 'menus', menuId, 'tasks', task.id);
          batch.update(taskRef, { order: index });
        });

        await batch.commit();
        console.log('‚úÖ [REORDER] Task order saved to Firebase');
        showToast('ƒê√£ l∆∞u th·ª© t·ª± task', 'success');

      } catch (error) {
        console.error('‚ùå [REORDER] Failed to save task order:', error);
        showToast('L·ªói khi l∆∞u th·ª© t·ª± task', 'error');

        // Reload tasks to restore correct order
        await loadMenuTasks(menuId);
      }
    }

    // ========= RENDER =========
    function createTaskCard(t, slug='tongquan'){
      // Use the new TaskItem component
      const taskState = ensureTaskEntry(t.id);

      const card = createTaskItem({
        task: t,
        taskState: taskState,
        slug: slug,
        onComplete: ({taskId, slug}) => {
          const inputEl = document.getElementById(`task-input-${taskId}`);
          if(inputEl && inputEl.value.trim()){
            const link = inputEl.value.trim();
            taskState.link = link;
            taskState.completed = true;
            taskState.completedAt = new Date().toISOString();
            taskState.updatedAt = new Date().toISOString();
            recordTaskActivity(taskId, 'completed', taskState.completedAt);
            updateUI();
            renderActivityLog();
            syncTaskState();
          }
        },
        onView: ({taskId, slug}) => {
          handleViewLink(taskId);
        },
        onEdit: ({taskId, slug}) => {
          handleEditTask(taskId);
        },
        onComment: ({taskId, slug}) => {
          if(!openCommentSections.has(taskId)){
            openCommentSections.add(taskId);
          } else {
            openCommentSections.delete(taskId);
          }
          updateUI();
        },
        isAdmin: isAdmin
      });

      console.log(`üì¶ [CREATE] Created task card for "${t.title}" (${t.id}) using TaskItem component`);
      return card;
    }

    function renderTasks(){
      const mounts = {
        'gd1-week1-2': $('#gd1-week1-2'),
        'gd1-week3-4': $('#gd1-week3-4'),
        'gd2-week5-8': $('#gd2-week5-8'),
        'gd2-week9-11': $('#gd2-week9-11'),
        'gd2-week12-13': $('#gd2-week12-13'),
        'gd3-week14-15': $('#gd3-week14-15'),
        'gd3-week16-17': $('#gd3-week16-17'),
        'gd4-week18': $('#gd4-week18'),
      };
      Object.values(mounts).forEach(n => { if(n) n.innerHTML = ''; });
      tasksData.forEach(t => {
        ensureTaskEntry(t.id);
        const m = mounts[t.week];
        if(m) m.appendChild(createTaskCard(t, 'tongquan')); // Pass default slug for static tasks
      });

      allTasks = $$('.task-link-input').map(input => {
        const card = input.closest('.task-card');
        const deadlineSpan = card ? card.querySelector('.deadline-countdown') : null;
        return {
          id: input.dataset.taskId,
          phase: input.dataset.phase,
          deadline: deadlineSpan ? deadlineSpan.dataset.deadline : null,
          title: card ? card.querySelector('.task-title').textContent : '',
          startDate: card ? card.dataset.start : null,
          endDate: card ? card.dataset.end : null,
        };
      });
    }

    function updateShareLink(){
      const shareInfo = $('#project-share-info');
      const shareUrlEl = $('#project-share-url');
      const idLabel = $('#project-id-label');
      if(shareUrlEl) shareUrlEl.textContent = '';
      if(idLabel) idLabel.textContent = '';
      if(shareInfo){
        shareInfo.classList.add('hidden');
      }
    }

    function ensureProjectReady(showAlert = true){
      if(isProjectReady) return true;
      if(showAlert && !hasShownSyncWarning){
        alert('H·ªá th·ªëng ƒëang k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau √≠t ph√∫t.');
        hasShownSyncWarning = true;
      }
      return false;
    }

    function handleViewLink(id){
      if(!ensureProjectReady(false)) return;
      const state = taskState[id];
      if(state && state.link){
        window.open(state.link, '_blank', 'noopener');
      } else {
        alert('Ch∆∞a c√≥ link ƒë·ªÉ xem cho task n√†y.');
      }
    }

    // ========= UI / LOGIC =========
    const deleteTaskModal = $('#delete-task-modal');
    const confirmDeleteTaskBtn = $('#confirm-delete-task-btn');
    const cancelDeleteTaskBtn = $('#cancel-delete-task-btn');
    const editOptionsModal = $('#edit-options-modal');
    const btnEditLinkOption = $('#btn-edit-link-option');
    const btnDeleteResultOption = $('#btn-delete-result-option');
    const cancelEditOptionsBtn = $('#cancel-edit-options-btn');
    const editLinkModal = $('#edit-link-modal');
    const confirmEditLinkBtn = $('#confirm-edit-link-btn');
    const cancelEditLinkBtn = $('#cancel-edit-link-btn');
    const editLinkInput = $('#edit-link-input');
    const deleteNoteModal = $('#delete-note-modal');
    const confirmDeleteNoteBtn = $('#confirm-delete-note-btn');
    const cancelDeleteNoteBtn = $('#cancel-delete-note-btn');
    noteDetailModal = $('#note-detail-modal');
    noteModalContent = $('#note-modal-content');
    noteModalAttachment = $('#note-modal-attachment');
    noteModalCloseBtn = $('#note-modal-close');

    let currentDeleteTaskId = null;
    let currentEditLinkTaskId = null;
    let currentDeleteNoteId = null;

    function bindTaskEvents(){
      taskInputs = $$('.task-link-input');
      completeButtons = $$('.task-complete-btn');
      viewButtons = $$('.task-view-btn');

      taskInputs.forEach(inp => {
        const taskId = inp.dataset.taskId;
        ensureTaskEntry(taskId);
        updateCompleteButtonState(taskId);
        inp.addEventListener('input', e => {
          const id = e.target.dataset.taskId;
          const link = e.target.value.trim();
          const state = ensureTaskEntry(id);
          const previous = state.link || '';
          state.link = link;
          showLinkFeedback(id, '');
          updateCompleteButtonState(id);
          if(previous !== link){
            state.updatedAt = new Date().toISOString();
            if(isProjectReady) debouncedSyncTaskState();
            renderActivityLog();
          }
        });
        inp.addEventListener('blur', e => {
          const id = e.target.dataset.taskId;
          const value = e.target.value.trim();
          if(value && !isValidUrl(value)){
            showLinkFeedback(id, 'Link ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng http:// ho·∫∑c https://', 'error');
          }
        });
      });

      completeButtons.forEach(btn => {
        btn.addEventListener('click', e => {
          if(!ensureProjectReady()) return;
          const id = e.currentTarget.dataset.taskId;
          const state = ensureTaskEntry(id);
          if(!hasValidCompletionLink(state)){
            showLinkFeedback(id, 'C·∫ßn nh·∫≠p link h·ª£p l·ªá (http:// ho·∫∑c https://) tr∆∞·ªõc khi ho√†n th√†nh.', 'error');
            return;
          }
          const nowIso = new Date().toISOString();
          state.completed = true;
          state.completedAt = nowIso;
          state.updatedAt = nowIso;
          taskState[id] = state;
          recordTaskActivity(id, 'completed', nowIso);
          updateUI();
          syncTaskState();
          showLinkFeedback(id, '');
        });
      });

      viewButtons.forEach(btn => {
        btn.addEventListener('click', e => {
          const id = e.currentTarget.dataset.viewBtn;
          handleViewLink(id);
        });
      });

      // Edit link buttons
      $$('[data-edit-link]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.editLink;
          handleEditLink(id);
        });
      });

      // Toggle comment sections
      $$('[data-comment-toggle]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.commentToggle;
          if(!id) return;
          if(openCommentSections.has(id)){
            openCommentSections.delete(id);
          } else {
            openCommentSections.add(id);
          }
          updateUI();
          if(openCommentSections.has(id)){
            setTimeout(() => {
              const input = document.querySelector(`[data-comment-input="${id}"]`);
              if(input){ input.focus(); }
            }, 80);
          }
        });
      });

    }

    function handleEditTask(id){
      if(!ensureProjectReady()) return;
      const state = ensureTaskEntry(id);
      state.completed = false;
      state.completedAt = null;
      const nowIso = new Date().toISOString();
      state.updatedAt = nowIso;
      openCommentSections.delete(id);
      autoOpenedCommentSections.delete(id);
      recordTaskActivity(id, 'reopened', nowIso);
      updateUI();
      renderActivityLog();
      syncTaskState();
      showLinkFeedback(id, '');
      setTimeout(() => {
        const input = document.querySelector(`[data-task-id="${id}"]`);
        if(input){ input.disabled = false; input.focus(); input.select(); }
      }, 80);
    }
    function handleEditLink(id){
      if(!ensureProjectReady()) return;
      currentEditLinkTaskId = id;
      // Show the edit options modal first
      if(editOptionsModal){
        editOptionsModal.classList.add('active');
        editOptionsModal.setAttribute('aria-hidden','false');
      }
    }
    function showEditLinkModal(){
      const id = currentEditLinkTaskId;
      if(!id) return;
      // Close edit options modal
      if(editOptionsModal){
        editOptionsModal.classList.remove('active');
        editOptionsModal.setAttribute('aria-hidden','true');
      }
      const state = ensureTaskEntry(id);
      if(editLinkInput){
        editLinkInput.value = state.link || '';
        // Add Enter key support
        const enterHandler = (e) => {
          if(e.key === 'Enter' && !e.shiftKey){
            e.preventDefault();
            confirmEditLink();
            editLinkInput.removeEventListener('keydown', enterHandler);
          }
        };
        editLinkInput.addEventListener('keydown', enterHandler);
      }
      if(editLinkModal){
        editLinkModal.classList.add('active');
        editLinkModal.setAttribute('aria-hidden','false');
        setTimeout(() => {
          if(editLinkInput){ editLinkInput.focus(); editLinkInput.select(); }
        }, 100);
      }
    }
    function showDeleteResultModal(){
      const id = currentEditLinkTaskId;
      if(!id) return;
      // Close edit options modal
      if(editOptionsModal){
        editOptionsModal.classList.remove('active');
        editOptionsModal.setAttribute('aria-hidden','true');
      }
      // Use browser confirm() dialog instead of modal
      const confirmed = confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a k·∫øt qu·∫£ n√†y kh√¥ng?\n(Are you sure you want to delete this result?)');
      if(confirmed){
        deleteTaskResult(id);
      }
      // Clear the edit link task ID
      currentEditLinkTaskId = null;
    }
    function cancelEditOptions(){
      currentEditLinkTaskId = null;
      if(editOptionsModal){
        editOptionsModal.classList.remove('active');
        editOptionsModal.setAttribute('aria-hidden','true');
      }
    }
    function confirmEditLink(){
      const id = currentEditLinkTaskId;
      if(!id) return;
      const state = ensureTaskEntry(id);
      const newLink = editLinkInput ? editLinkInput.value.trim() : '';
      if(!newLink){
        alert('Vui l√≤ng nh·∫≠p link.');
        return;
      }
      state.link = newLink;
      const nowIso = new Date().toISOString();
      state.updatedAt = nowIso;
      recordTaskActivity(id, 'link_edited', nowIso);
      updateUI();
      renderActivityLog();
      syncTaskState();
      currentEditLinkTaskId = null;
      if(editLinkModal){
        editLinkModal.classList.remove('active');
        editLinkModal.setAttribute('aria-hidden','true');
      }
      showToast('Link ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');
    }
    function cancelEditLink(){
      currentEditLinkTaskId = null;
      if(editLinkModal){
        editLinkModal.classList.remove('active');
        editLinkModal.setAttribute('aria-hidden','true');
      }
    }
    function handleDeleteTaskClick(id){
      if(!ensureProjectReady()) return;
      currentDeleteTaskId = id;
      if(deleteTaskModal){
        deleteTaskModal.classList.add('active');
        deleteTaskModal.setAttribute('aria-hidden','false');
      }
    }
    function deleteTaskResult(id){
      if(!ensureProjectReady()) return;
      if(!id) return;
      const state = ensureTaskEntry(id);
      state.completed = false;
      state.link = '';
      state.completedAt = null;
      const nowIso = new Date().toISOString();
      state.updatedAt = nowIso;
      openCommentSections.delete(id);
      autoOpenedCommentSections.delete(id);
      recordTaskActivity(id, 'deleted', nowIso);
      updateUI();
      renderActivityLog();
      syncTaskState();
      showLinkFeedback(id, '');
      showToast('ƒê√£ x√≥a k·∫øt qu·∫£', 'success');
    }
    function confirmDeleteTask(){
      const id = currentDeleteTaskId;
      if(!id) return;
      deleteTaskResult(id);
      currentDeleteTaskId = null;
      if(deleteTaskModal){
        deleteTaskModal.classList.remove('active');
        deleteTaskModal.setAttribute('aria-hidden','true');
      }
    }
    function cancelDeleteTask(){
      currentDeleteTaskId = null;
      if(deleteTaskModal){
        deleteTaskModal.classList.remove('active');
        deleteTaskModal.setAttribute('aria-hidden','true');
      }
    }

    function initChart(){
      const canvas = document.getElementById('progressChart');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      progressChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels:['Ho√†n Th√†nh','Ch∆∞a Xong'], datasets:[{ data:[0,0], backgroundColor:['#10b981','#e5e7eb'], hoverOffset:4 }] },
        options: { responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{ legend:{ position:'bottom' } } }
      });
    }

    function calculateDeadlines(){
      const upcomingList = $('#upcoming-deadlines-list');
      const upcomingContainer = $('#upcoming-deadlines-container');
      const overdueList = $('#overdue-tasks-list');
      const overdueContainer = $('#overdue-tasks-container');
      if(!upcomingList || !overdueList) return;

      upcomingList.innerHTML = '';
      overdueList.innerHTML = '';
      let upcomingCount = 0, overdueCount = 0;

      allTasks.forEach(task => {
        const state = ensureTaskEntry(task.id);
        if(!task.deadline) return;
        if(state.completed) return;
        const info = evaluateDeadline(task.deadline, false);
        if(!info) return;
        if(info.status === 'danger'){
          const li = document.createElement('li');
          li.innerHTML = `<b>${task.title}</b>: ${task.deadline} <span class="text-red-600 font-semibold">(${info.text})</span>`;
          overdueList.appendChild(li);
          overdueCount++;
        } else if(info.status === 'warning'){
          const li = document.createElement('li');
          li.innerHTML = `<b>${task.title}</b>: ${task.deadline} <span class="text-orange-600 font-semibold">(${info.text})</span>`;
          upcomingList.appendChild(li);
          upcomingCount++;
        }
      });

      if(upcomingContainer) upcomingContainer.classList.toggle('hidden', upcomingCount === 0);
      if(overdueContainer) overdueContainer.classList.toggle('hidden', overdueCount === 0);
    }

    function renderActivityLog(){
      const tbody = $('#activity-log-body');
      const countLabel = $('#activity-log-count');
      const toggleBtn = $('#activity-log-toggle');
      if(!tbody) return;

      const entries = Array.isArray(activityLogs)
        ? activityLogs.slice().sort((a, b) => {
            const aTime = new Date(a.updatedAt || 0).getTime();
            const bTime = new Date(b.updatedAt || 0).getTime();
            return bTime - aTime;
          })
        : [];

      const total = entries.length;
      const visibleEntries = activityLogShowAll ? entries : entries.slice(0, 10);

      tbody.innerHTML = '';
      if(visibleEntries.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-6">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.</td></tr>';
      } else {
        const statusMap = {
          completed: { text: 'Ho√†n th√†nh', className: 'text-green-600 font-semibold' },
          updated: { text: 'ƒêang c·∫≠p nh·∫≠t', className: 'text-orange-500 font-semibold' },
          reopened: { text: 'ƒê√£ m·ªü l·∫°i', className: 'text-amber-600 font-semibold' },
          edited: { text: 'ƒê√£ ch·ªânh s·ª≠a', className: 'text-blue-600 font-semibold' },
          deleted: { text: 'ƒê√£ x√≥a', className: 'text-red-600 font-semibold' },
        };
        visibleEntries.forEach(entry => {
          const statusConfig = statusMap[entry.status] || { text: 'Ho·∫°t ƒë·ªông', className: 'text-blue-600 font-semibold' };
          const performer = entry.performedBy ? ` ‚Äì ${escapeHtml(entry.performedBy)}` : '';
          const tr = document.createElement('tr');
          const menuIdAttr = entry.menuId ? ` data-menu-id="${escapeHtml(entry.menuId)}"` : '';
          tr.innerHTML = `
            <td>${phaseLabels[entry.phase] || entry.phase || '-'}</td>
            <td><span class="${statusConfig.className}">${statusConfig.text}${performer}</span></td>
            <td><button type="button" class="task-log-link" data-jump-task="${entry.taskId}"${menuIdAttr}>${escapeHtml(entry.taskName || `Task ${entry.taskId}`)}</button></td>
            <td>${entry.completedAt ? formatDateTime(entry.completedAt) : '-'}</td>
            <td>${entry.updatedAt ? formatDateTime(entry.updatedAt) : '-'}</td>`;
          tbody.appendChild(tr);
        });
      }

      if(countLabel){
        if(total === 0){
          countLabel.textContent = 'Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o';
        } else {
          const shown = visibleEntries.length;
          countLabel.textContent = activityLogShowAll ? `ƒêang hi·ªÉn th·ªã ${shown} ho·∫°t ƒë·ªông` : `Hi·ªÉn th·ªã ${shown}/${total} ho·∫°t ƒë·ªông g·∫ßn nh·∫•t`;
        }
      }

      if(toggleBtn){
        if(total > 10 && !activityLogShowAll){
          toggleBtn.classList.remove('hidden');
        } else {
          toggleBtn.classList.add('hidden');
        }
      }
    }

    function updateUI(){
      let total = 0, done = 0;
      const phaseCounts = { gd1:{total:0,completed:0}, gd2:{total:0,completed:0}, gd3:{total:0,completed:0}, gd4:{total:0,completed:0} };

      console.log('üîç [DEBUG] updateUI() called. Total tasks:', allTasks.length);
      console.log('üîç [DEBUG] taskState object:', taskState);

      allTasks.forEach(task => {
        const state = ensureTaskEntry(task.id);
        total++;
        if(phaseCounts[task.phase]) phaseCounts[task.phase].total++;

        console.log(`üîç [DEBUG] Task ${task.id} - Title: "${task.title}", Completed: ${state.completed}, Link: "${state.link}"`);
        console.log('Current Task Status:', task.status); // CRITICAL DEBUG

        const card = document.getElementById('task-card-'+task.id);
        const statusBadge = document.getElementById('task-status-'+task.id);
        const input = document.querySelector(`[data-task-id="${task.id}"]`);
        const inputGroup = document.querySelector(`[data-input-group="${task.id}"]`);
        const actions = document.querySelector(`[data-completed-actions="${task.id}"]`);
        const viewBtn = actions ? actions.querySelector('[data-view-btn]') : null;
        const countdownSpan = card ? card.querySelector('.deadline-countdown') : null;

        // Use robust status checking from TaskItem component
        const taskIsCompleted = isTaskCompleted(task, state);

        const deadlineInfo = evaluateDeadline(task.deadline, taskIsCompleted);
        const isOverdueTask = deadlineInfo && deadlineInfo.status === 'danger';

        if(input) input.value = state.link || '';

        if(taskIsCompleted){
          console.log(`‚úÖ [DEBUG] Task ${task.id} IS COMPLETED - Showing footer`);
          if(!actions){
            console.error(`‚ùå [ERROR] Task ${task.id} - Footer element NOT FOUND in DOM!`);
          }
          done++;
          if(phaseCounts[task.phase]) phaseCounts[task.phase].completed++;
          if(card){ card.classList.add('completed'); card.classList.remove('overdue'); }
          if(statusBadge){ statusBadge.className = 'task-status status-completed'; statusBadge.textContent = 'HO√ÄN TH√ÄNH'; }
          if(inputGroup) inputGroup.classList.add('hidden');
          if(actions) actions.classList.remove('hidden');
          if(input) input.disabled = true;
          if(viewBtn){
            const disabled = !isProjectReady || !hasValidCompletionLink(state);
            viewBtn.disabled = disabled;
            viewBtn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
          }
          if(countdownSpan){
            const completedText = formatDateFromISO(state.completedAt);
            countdownSpan.className = 'deadline-countdown deadline-safe';
            countdownSpan.textContent = completedText ? `Ho√†n th√†nh: ${completedText}` : 'ƒê√£ ho√†n th√†nh';
          }

          // Show comment section for completed tasks
          initializeCommentSection(task.id);
          const commentSection = document.querySelector(`[data-comment-section="${task.id}"]`);
          const commentsList = document.querySelector(`[data-comments-list="${task.id}"]`);
          const commentToggleBtn = document.querySelector(`[data-comment-toggle="${task.id}"]`);
          const commentCount = Array.isArray(state.comments) ? state.comments.length : 0;
          if(commentCount > 0 && !openCommentSections.has(task.id) && !autoOpenedCommentSections.has(task.id)){
            openCommentSections.add(task.id);
            autoOpenedCommentSections.add(task.id);
          }
          const shouldShowComments = openCommentSections.has(task.id);

          if(commentSection){
            commentSection.classList.toggle('hidden', !shouldShowComments);
            commentSection.setAttribute('aria-hidden', shouldShowComments ? 'false' : 'true');
          }
          if(commentToggleBtn){
            let toggleLabel = 'üí¨ Comment';
            if(shouldShowComments){
              toggleLabel = '·∫®n comment';
            } else if(commentCount > 0){
              toggleLabel = `Xem comment (${commentCount})`;
            }
            commentToggleBtn.textContent = toggleLabel;
            commentToggleBtn.setAttribute('aria-expanded', shouldShowComments ? 'true' : 'false');
          }

          // Display all comments with user names
          if(commentsList){
            commentsList.innerHTML = '';
            if(Array.isArray(state.comments) && state.comments.length > 0){
              state.comments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'bg-gray-50 p-3 rounded border border-gray-200';
                const timestamp = comment.timestamp ? new Date(comment.timestamp).toLocaleString('vi-VN') : '';
                commentDiv.innerHTML = `
                  <div class="flex items-start justify-between mb-1">
                    <span class="font-semibold text-sm text-gray-800">${escapeHtml(comment.userName || 'Ng∆∞·ªùi d√πng')}</span>
                    <span class="text-xs text-gray-500">${timestamp}</span>
                  </div>
                  <div class="text-sm text-gray-700 whitespace-pre-wrap">${escapeHtml(comment.text)}</div>
                `;
                commentsList.appendChild(commentDiv);
              });
            }
          }
        } else {
          if(card){
            card.classList.remove('completed');
            if(isOverdueTask) card.classList.add('overdue'); else card.classList.remove('overdue');
          }
          if(statusBadge){
            const statusClass = isOverdueTask ? 'status-overdue' : 'status-pending';
            statusBadge.className = 'task-status ' + statusClass;
            statusBadge.textContent = isOverdueTask ? 'QU√Å H·∫†N' : 'CH∆ØA XONG';
          }
          if(inputGroup) inputGroup.classList.remove('hidden');
          if(actions) actions.classList.add('hidden');
          if(input) input.disabled = false;
          const btn = inputGroup ? inputGroup.querySelector('.task-complete-btn') : null;
          if(btn) btn.disabled = !(isProjectReady && hasValidCompletionLink(state));
          if(viewBtn){
            viewBtn.disabled = true;
            viewBtn.setAttribute('aria-disabled','true');
          }
          if(countdownSpan){
            countdownSpan.className = 'deadline-countdown' + (deadlineInfo ? ` ${deadlineInfo.className}` : '');
            countdownSpan.textContent = deadlineInfo && deadlineInfo.text ? deadlineInfo.text : '';
          }

          // Hide comment section for non-completed tasks
          const commentSection = document.querySelector(`[data-comment-section="${task.id}"]`);
          const commentToggleBtn = document.querySelector(`[data-comment-toggle="${task.id}"]`);
          openCommentSections.delete(task.id);
          if(commentSection){
            commentSection.classList.add('hidden');
            commentSection.setAttribute('aria-hidden', 'true');
          }
          if(commentToggleBtn){
            commentToggleBtn.textContent = 'üí¨ Comment';
            commentToggleBtn.setAttribute('aria-expanded', 'false');
          }
          autoOpenedCommentSections.delete(task.id);
        }
        updateCompleteButtonState(task.id);
      });

      const totalText = $('#total-progress-text');
      const totalBar = $('#total-progress-bar');
      // üîß FIX: Use the NEW dynamic system instead of old hardcoded allTasks
      // The old system counted 80 hardcoded tasks, but we should use dynamicTasks (44 tasks)
      updateTotalProgress(); // Delegate to function that uses dynamicTasks

      ['gd1','gd2','gd3','gd4'].forEach(ph => {
        const d = phaseCounts[ph];
        const pct = d.total > 0 ? (d.completed/d.total)*100 : 0;
        const t = document.getElementById(`${ph}-progress-text`);
        const b = document.getElementById(`${ph}-progress-bar`);
        if(t) t.textContent = `${d.completed} / ${d.total} (${Math.round(pct)}%)`;
        if(b) b.style.width = pct + '%';
      });

      // üîß FIX: Progress chart and total percent are now updated by updateTotalProgress()
      // which uses the NEW dynamic system (dynamicTasks) instead of old allTasks
      if(progressChart){
        // Calculate from dynamicTasks instead of allTasks
        let totalTasksForChart = 0;
        let completedTasksForChart = 0;
        dynamicMenus.forEach(menu => {
          if(menu.type === 'task-list'){
            const tasks = dynamicTasks[menu.id] || [];
            totalTasksForChart += tasks.length;
            completedTasksForChart += tasks.filter(t => t.completed).length;
          }
        });
        progressChart.data.datasets[0].data = [completedTasksForChart, Math.max(0, totalTasksForChart - completedTasksForChart)];
        progressChart.update();
      }

      // Total percent is already updated by updateTotalProgress() above

      calculateDeadlines();
      renderActivityLog();
      renderNoteStatistics();
      refreshNotifications();
    }

    function findCompletionPerformer(taskId){
      if(!Array.isArray(activityLogs)) return null;
      const entry = activityLogs.find(log => log.taskId === taskId && log.status === 'completed');
      return entry && entry.performedBy ? entry.performedBy : null;
    }

    function pushNotification(type, task, userName){
      if(!task) return;
      const now = new Date();
      const owner = (task.owner || '').trim();
      const taskTitle = (task.title || task.name || 'Task').trim();
      const performedBy = userName || findCompletionPerformer(task.id) || (currentUserData ? (currentUserData.displayName || currentUserData.email) : null) || 'Ng∆∞·ªùi d√πng';
      const message = type === 'completed'
        ? `${performedBy} ƒë√£ ho√†n th√†nh task: ${taskTitle}.`
        : `Task: ${taskTitle} hi·ªán ƒë√£ qu√° h·∫°n (Ph·ª• tr√°ch: ${owner || 'Ch∆∞a g√°n'}).`;
      notifications.unshift({
        id: `${type}-${task.id}-${now.getTime()}`,
        taskId: task.id,
        type,
        message,
        timestamp: now.toISOString(),
        read: false,
      });
      if(notifications.length > 30){
        notifications = notifications.slice(0, 30);
      }
    }

    function renderNotifications(){
      const list = $('#notification-list');
      const emptyState = $('#notification-empty');
      const badge = $('#notification-badge');
      if(!list || !emptyState || !badge) return;

      list.innerHTML = '';
      if(notifications.length === 0){
        emptyState.style.display = 'block';
      } else {
        emptyState.style.display = 'none';
        notifications.forEach((item, index) => {
          const li = document.createElement('li');
          li.className = 'notification-item' + (item.read ? '' : ' unread');
          li.setAttribute('data-notification-index', index);
          li.innerHTML = `<div class="text-sm text-gray-700">${escapeHtml(item.message)}</div><div class="notification-time">${formatDateTime(item.timestamp)}</div>`;
          list.appendChild(li);
        });
      }

      const unreadCount = notifications.filter(item => !item.read).length;
      if(unreadCount > 0){
        badge.textContent = unreadCount > 9 ? '9+' : String(unreadCount);
        badge.classList.add('show');
      } else {
        badge.textContent = '0';
        badge.classList.remove('show');
      }
    }

    function refreshNotifications(){
      const silent = !notificationsInitialized;
      tasksData.forEach(task => {
        const state = ensureTaskEntry(task.id);
        const prev = notificationState[task.id] || { completed:false, overdue:false };
        const nowCompleted = !!state.completed;
        const deadlineInfo = evaluateDeadline(task.deadline, nowCompleted);
        const nowOverdue = !nowCompleted && deadlineInfo && deadlineInfo.status === 'danger';
        if(nowCompleted && !prev.completed && !silent){
          pushNotification('completed', task, findCompletionPerformer(task.id));
        }
        if(nowOverdue && !prev.overdue && !silent){
          pushNotification('overdue', task);
        }
        notificationState[task.id] = { completed: nowCompleted, overdue: nowOverdue };
      });
      notificationsInitialized = true;
      renderNotifications();
    }

    function closeNotificationDropdown(){
      const dropdown = $('#notification-dropdown');
      const bell = $('#notification-bell');
      if(!dropdown || !bell) return;
      dropdown.classList.remove('show');
      dropdown.setAttribute('aria-hidden', 'true');
      bell.setAttribute('aria-expanded', 'false');
    }

    // ========= NOTES =========
    function renderNoteStatistics(){
      const totalEl = $('#note-stats-total');
      if(totalEl) totalEl.textContent = `T·ªïng s·ªë ghi ch√∫: ${notes.length}`;

      const counts = notes.reduce((acc, note) => {
        const type = (note.type || '').trim() || 'Kh√°c';
        acc[type] = (acc[type] || 0) + 1;
        return acc;
      }, {});

      const labels = Object.keys(counts).sort((a, b) => a.localeCompare(b, 'vi'));
      const data = labels.map(label => counts[label]);
      const hasData = labels.length > 0;

      // Update text column
      const textContainer = $('#note-stats-text');
      if(textContainer){
        if(!hasData){
          textContainer.innerHTML = '<div class="text-gray-500 italic">Ch∆∞a c√≥ ghi ch√∫ n√†o.</div>';
        } else {
          textContainer.innerHTML = labels.map((label, index) => {
            const count = data[index];
            return `<div class="flex items-center justify-between py-1.5 px-3 bg-gray-50 rounded-lg hover:bg-blue-50 transition-colors">
              <span class="font-medium text-gray-800">${escapeHtml(label)}</span>
              <span class="text-blue-600 font-semibold">${count}</span>
            </div>`;
          }).join('');
        }
      }

      // Update chart
      const canvas = document.getElementById('note-stats-chart');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const colors = labels.map(() => '#2563eb');

      if(!noteStatsChart){
        noteStatsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'S·ªë ghi ch√∫',
              data,
              backgroundColor: colors,
              borderRadius: 6,
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, ticks: { precision: 0 } },
            },
            plugins: { legend: { display: false } },
          },
        });
      } else {
        noteStatsChart.data.labels = labels;
        noteStatsChart.data.datasets[0].data = data;
        noteStatsChart.data.datasets[0].backgroundColor = colors;
        noteStatsChart.update();
      }
    }

    function renderNotes(){
      const tbody = $('#notes-list-container'); if(!tbody) return;
      tbody.innerHTML = '';
      if(filteredNotes.length === 0){
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-8">Ch∆∞a c√≥ ghi ch√∫ n√†o.</td></tr>';
        return;
      }
      filteredNotes.slice().reverse().forEach(n => {
        const noteId = String(n.id);
        const tr = document.createElement('tr');

        const dateTd = document.createElement('td');
        dateTd.textContent = n.date || '';

        const typeTd = document.createElement('td');
        const typeBadge = document.createElement('span');
        typeBadge.className = 'custom-type-item';
        typeBadge.textContent = n.type || 'Kh√°c';
        typeTd.appendChild(typeBadge);

        const contentTd = document.createElement('td');
        const contentDiv = document.createElement('div');
        contentDiv.className = 'note-content-clamp text-gray-700';
        contentDiv.textContent = n.content || '';
        contentTd.appendChild(contentDiv);

        const hasAttachment = !!(n.attachmentUrl);
        if(hasAttachment){
          const chip = document.createElement('div');
          chip.className = 'note-attachment-chip';
          chip.innerHTML = `<span>üìé</span><span class="font-medium">${escapeHtml(n.attachmentName || 'T·ªáp ƒë√≠nh k√®m')}</span>`;
          contentTd.appendChild(chip);
        }

        const requiresReadMore = (n.content || '').length > NOTE_TRUNCATE_LIMIT || hasAttachment;
        if(requiresReadMore){
          const moreBtn = document.createElement('button');
          moreBtn.type = 'button';
          moreBtn.className = 'note-read-more-btn';
          moreBtn.dataset.noteId = noteId;
          moreBtn.innerHTML = '<span>üîé</span><span>Xem th√™m</span>';
          contentTd.appendChild(moreBtn);
        }

        const deleteTd = document.createElement('td');
        deleteTd.style.textAlign = 'center';
        const deleteBtn = document.createElement('span');
        deleteBtn.className = 'note-delete-btn cursor-pointer';
        deleteBtn.dataset.noteId = noteId;
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteTd.appendChild(deleteBtn);

        tr.appendChild(dateTd);
        tr.appendChild(typeTd);
        tr.appendChild(contentTd);
        tr.appendChild(deleteTd);
        tbody.appendChild(tr);
      });

      $$('.note-delete-btn').forEach(btn => btn.addEventListener('click', e => {
        e.preventDefault();
        currentDeleteNoteId = e.currentTarget.dataset.noteId;
        if(deleteNoteModal){
          deleteNoteModal.classList.add('active');
          deleteNoteModal.setAttribute('aria-hidden','false');
        }
      }));

      $$('.note-read-more-btn').forEach(btn => btn.addEventListener('click', e => {
        e.preventDefault();
        const noteId = e.currentTarget.dataset.noteId;
        const note = notes.find(item => String(item.id) === String(noteId));
        if(note){
          openNoteDetailModal(note);
        }
      }));
    }

    function startOfDayDate(date){
      const d = new Date(date);
      d.setHours(0,0,0,0);
      return d;
    }
    function endOfDayDate(date){
      const d = new Date(date);
      d.setHours(23,59,59,999);
      return d;
    }
    function getTimeRangeDates(range){
      if(!range || range === 'all' || range === 'custom') return null;
      const today = new Date();
      today.setHours(0,0,0,0);
      switch(range){
        case 'today':
          return { from: startOfDayDate(today), to: endOfDayDate(today) };
        case 'yesterday': {
          const y = new Date(today);
          y.setDate(y.getDate() - 1);
          return { from: startOfDayDate(y), to: endOfDayDate(y) };
        }
        case '7days': {
          const start = new Date(today);
          start.setDate(start.getDate() - 6);
          return { from: startOfDayDate(start), to: endOfDayDate(today) };
        }
        case '14days': {
          const start = new Date(today);
          start.setDate(start.getDate() - 13);
          return { from: startOfDayDate(start), to: endOfDayDate(today) };
        }
        case 'thisMonth': {
          const first = new Date(today.getFullYear(), today.getMonth(), 1);
          const last = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          return { from: startOfDayDate(first), to: endOfDayDate(last) };
        }
        case 'lastMonth': {
          const first = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          const last = new Date(today.getFullYear(), today.getMonth(), 0);
          return { from: startOfDayDate(first), to: endOfDayDate(last) };
        }
        default:
          return null;
      }
    }
    function parseDateInput(value, isEnd=false){
      if(!value) return null;
      const date = new Date(value);
      if(Number.isNaN(date.getTime())) return null;
      return isEnd ? endOfDayDate(date) : startOfDayDate(date);
    }
    function toggleCustomDateInputs(){
      const popover = $('#custom-date-popover');
      const fromInput = $('#filter-date-from');
      const toInput = $('#filter-date-to');
      const show = selectedTimeFilter === 'custom';
      if(popover){
        popover.classList.toggle('hidden', !show);
        popover.setAttribute('aria-hidden', show ? 'false' : 'true');
      }
      if(!show){
        if(fromInput) fromInput.value = '';
        if(toInput) toInput.value = '';
      }
    }

    function applyFilters(){
      const type = $('#filter-type');
      const keywordInput = $('#filter-keyword');
      const keywordValue = keywordInput && keywordInput.value ? keywordInput.value.trim() : '';
      const keyword = keywordValue.length >= 4 ? keywordValue.toLowerCase() : '';

      let fromDate = null;
      let toDate = null;
      if(selectedTimeFilter === 'custom'){
        const fromInput = $('#filter-date-from');
        const toInput = $('#filter-date-to');
        fromDate = parseDateInput(fromInput ? fromInput.value : '', false);
        toDate = parseDateInput(toInput ? toInput.value : '', true);
      } else {
        const quickRange = getTimeRangeDates(selectedTimeFilter);
        if(quickRange){
          fromDate = quickRange.from;
          toDate = quickRange.to;
        }
      }

      filteredNotes = notes.filter(n => {
        let noteDate = null;
        if(typeof n.date === 'string'){
          const datePart = n.date.split(' ')[0];
          const parts = datePart.split('/').map(Number);
          if(parts.length === 3 && parts.every(Number.isFinite)){
            const [d, m, y] = parts;
            if(d && m && y){
              noteDate = new Date(y, m - 1, d);
              noteDate.setHours(0,0,0,0);
            }
          }
        }
        if(fromDate && (!noteDate || noteDate < fromDate)) return false;
        if(toDate && (!noteDate || noteDate > toDate)) return false;
        if(type && type.value && n.type !== type.value) return false;
        const content = (n.content || '').toLowerCase();
        if(keyword && !content.includes(keyword)) return false;
        return true;
      });
      renderNotes();
      renderNoteStatistics();
    }
    function resetFilters(){
      const from = $('#filter-date-from'), to = $('#filter-date-to'), type = $('#filter-type'), keywordInput = $('#filter-keyword');
      if(from) from.value = '';
      if(to) to.value = '';
      if(type) type.value = '';
      if(keywordInput) keywordInput.value = '';
      const timeSelect = $('#filter-time');
      selectedTimeFilter = 'all';
      if(timeSelect) timeSelect.value = 'all';
      toggleCustomDateInputs();
      applyFilters();
    }

    async function saveNewNote(){
      if(!ensureProjectReady()) return;
      const textarea = $('#notes-textarea'); if(!textarea) return;
      const content = textarea.value.trim();
      if(!content){ alert('Vui l√≤ng nh·∫≠p n·ªôi dung ghi ch√∫'); return; }
      if(!selectedNoteType){ alert('Vui l√≤ng ch·ªçn lo·∫°i ghi ch√∫'); return; }

      const fileInput = $('#note-file-upload');
      const file = fileInput && fileInput.files ? fileInput.files[0] : null;

      let attachmentUrl = null;
      let attachmentStoragePath = '';
      let attachmentName = '';
      let attachmentMime = '';

      if(file){
        attachmentName = file.name;
        attachmentMime = file.type || '';
        const uploadResult = await uploadAsset(file, 'notes_attachments');
        if(uploadResult.url){
          attachmentUrl = uploadResult.url;
          attachmentStoragePath = uploadResult.storagePath || '';
        }
      }

      const now = new Date();
      const id = now.getTime();
      const date = now.toLocaleString('vi-VN',{ day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });

      notes.push({
        id,
        date,
        type: selectedNoteType,
        content,
        attachmentUrl: attachmentUrl || null,
        attachmentName: attachmentName,
        attachmentMime,
        attachmentStoragePath,
      });

      textarea.value = '';
      if(fileInput) fileInput.value = '';
      applyFilters();
      await updateProjectData({ notes });
      showToast('ƒê√£ l∆∞u ghi ch√∫ th√†nh c√¥ng', 'success');
    }

    async function confirmDeleteNote(){
      if(!currentDeleteNoteId) return;
      const idToRemove = currentDeleteNoteId;
      notes = notes.filter(n => String(n.id) !== String(idToRemove));
      currentDeleteNoteId = null;
      if(deleteNoteModal){
        deleteNoteModal.classList.remove('active');
        deleteNoteModal.setAttribute('aria-hidden','true');
      }
      closeNoteDetailModal();
      applyFilters();
      if(isProjectReady) await updateProjectData({ notes });
    }
    function cancelDeleteNote(){
      currentDeleteNoteId = null;
      if(deleteNoteModal){
        deleteNoteModal.classList.remove('active');
        deleteNoteModal.setAttribute('aria-hidden','true');
      }
    }

    // ========= NOTE TYPE DROPDOWN =========
    function renderNoteTypeDropdown(){
      const dropdown = $('#note-type-dropdown');
      const triggerLabel = $('#note-type-trigger-label');
      const optionsContainer = $('#note-type-options');
      const input = $('#note-type-new-input');
      const createBtn = $('#note-type-create-btn');

      if(triggerLabel){
        triggerLabel.textContent = selectedNoteType ? `Lo·∫°i: ${selectedNoteType}` : 'Ch·ªçn lo·∫°i ghi ch√∫';
      }

      if(optionsContainer){
        optionsContainer.innerHTML = '';
        if(customTypes.length === 0){
          const empty = document.createElement('div');
          empty.className = 'text-sm text-gray-500 py-2';
          empty.textContent = 'Ch∆∞a c√≥ lo·∫°i ghi ch√∫.';
          optionsContainer.appendChild(empty);
        } else {
          customTypes.forEach(type => {
            const option = document.createElement('div');
            option.className = 'note-type-option' + (selectedNoteType === type ? ' active' : '');
            option.setAttribute('data-note-type-option', type);
            option.setAttribute('role','option');
            option.tabIndex = 0;
            option.innerHTML = `<span>${type}</span><button type="button" class="note-type-remove" data-remove-type="${type}" title="X√≥a ${type}">üóëÔ∏è</button>`;
            optionsContainer.appendChild(option);
          });
        }
      }

      const atLimit = customTypes.length >= 10;
      const currentValue = input ? input.value.trim() : '';
      if(input){
        input.disabled = atLimit;
        if(atLimit) input.value = '';
        input.placeholder = atLimit ? 'ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 10 lo·∫°i' : 'Th√™m lo·∫°i m·ªõi...';
      }
      if(createBtn) createBtn.disabled = atLimit || currentValue === '';

      if(atLimit){
        showNoteTypeFeedback('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 10 lo·∫°i ghi ch√∫', 'error');
      } else if(currentValue === ''){
        showNoteTypeFeedback('');
      }

      if(dropdown){
        const trigger = $('#note-type-trigger');
        if(trigger) trigger.setAttribute('aria-expanded', dropdown.classList.contains('open') ? 'true' : 'false');
      }
    }

    function updateTypeFilterOptions(){
      const filterSel = $('#filter-type');
      if(!filterSel) return;
      const previous = filterSel.value;
      filterSel.innerHTML = '<option value="">T·∫•t c·∫£ lo·∫°i</option>';
      customTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        filterSel.appendChild(option);
      });
      if(previous && customTypes.includes(previous)){
        filterSel.value = previous;
      }
    }

    function closeNoteTypeDropdown(){
      const dropdown = $('#note-type-dropdown');
      const trigger = $('#note-type-trigger');
      if(dropdown) dropdown.classList.remove('open');
      if(trigger) trigger.setAttribute('aria-expanded','false');
    }

    async function setSelectedNoteType(type){
      if(!type || !customTypes.includes(type)) return;
      if(selectedNoteType === type) return;
      selectedNoteType = type;
      renderNoteTypeDropdown();
      if(isProjectReady) await updateProjectData({ selectedNoteType });
    }

    async function addNewNoteType(value){
      const name = (value || '').trim();
      if(!name){
        showNoteTypeFeedback('Vui l√≤ng nh·∫≠p t√™n lo·∫°i ghi ch√∫', 'error');
        return;
      }
      const exists = customTypes.some(t => t.toLowerCase() === name.toLowerCase());
      if(exists){
        showNoteTypeFeedback('Lo·∫°i ƒë√£ t·ªìn t·∫°i', 'error');
        return;
      }
      if(customTypes.length >= 10){
        showNoteTypeFeedback('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 10 lo·∫°i ghi ch√∫', 'error');
        return;
      }
      customTypes.push(name);
      selectedNoteType = name;
      renderNoteTypeDropdown();
      updateTypeFilterOptions();
      closeNoteTypeDropdown();
      const input = $('#note-type-new-input');
      if(input){
        input.value = '';
        const createBtnEl = $('#note-type-create-btn');
        if(createBtnEl) createBtnEl.disabled = true;
      }
      showNoteTypeFeedback(`ƒê√£ th√™m "${name}"`, 'success');
      if(isProjectReady) await updateProjectData({ customTypes, selectedNoteType });
    }

    async function removeNoteType(type){
      if(!customTypes.includes(type)) return;
      if(customTypes.length <= 1){
        alert('C·∫ßn √≠t nh·∫•t 1 lo·∫°i ghi ch√∫');
        return;
      }
      customTypes = customTypes.filter(t => t !== type);
      const fallback = customTypes[0] || defaultCustomTypes[0] || 'Kh√°c';
      notes = notes.map(note => note.type === type ? { ...note, type: fallback } : note);
      if(selectedNoteType === type) selectedNoteType = fallback;
      renderNoteTypeDropdown();
      updateTypeFilterOptions();
      applyFilters();
      showNoteTypeFeedback(`ƒê√£ x√≥a "${type}"`, 'info');
      if(isProjectReady) await updateProjectData({ customTypes, notes, selectedNoteType });
    }

    function bindNoteTypeDropdown(){
      const dropdown = $('#note-type-dropdown');
      const trigger = $('#note-type-trigger');
      const optionsContainer = $('#note-type-options');
      const input = $('#note-type-new-input');
      const createBtn = $('#note-type-create-btn');

      if(trigger){
        trigger.addEventListener('click', e => {
          e.preventDefault();
          if(!dropdown) return;
          dropdown.classList.toggle('open');
          trigger.setAttribute('aria-expanded', dropdown.classList.contains('open') ? 'true' : 'false');
        });
      }

      if(optionsContainer){
        optionsContainer.addEventListener('click', e => {
          const removeBtn = e.target.closest('[data-remove-type]');
          const option = e.target.closest('[data-note-type-option]');
          if(removeBtn){
            e.stopPropagation();
            if(!ensureProjectReady()) return;
            removeNoteType(removeBtn.getAttribute('data-remove-type'));
          } else if(option){
            const type = option.getAttribute('data-note-type-option');
            setSelectedNoteType(type);
            closeNoteTypeDropdown();
          }
        });
      }

      if(createBtn && input){
        createBtn.addEventListener('click', () => {
          if(!ensureProjectReady()) return;
          addNewNoteType(input.value);
        });
        input.addEventListener('input', () => {
          if(createBtn) createBtn.disabled = customTypes.length >= 10 || input.value.trim() === '';
          if(input.value.trim() !== '') showNoteTypeFeedback('');
        });
        input.addEventListener('keypress', e => {
          if(e.key === 'Enter'){
            e.preventDefault();
            if(!ensureProjectReady()) return;
            addNewNoteType(input.value);
          }
        });
      }

      document.addEventListener('click', e => {
        if(dropdown && !dropdown.contains(e.target)){
          closeNoteTypeDropdown();
        }
      });

      document.addEventListener('keydown', e => {
        if(e.key === 'Escape') closeNoteTypeDropdown();
      });
    }

    // ========= NAV =========
    const sectionToPath = {
      overview: '/tongquan',
      gd1: '/giaidoan1',
      gd2: '/giaidoan2',
      gd3: '/giaidoan3',
      gd4: '/giaidoan4',
      notes: '/ghichu',
      'user-management': '/quan-ly-nguoi-dung',
      'plan-manager': '/quan-ly-ke-hoach',
      settings: '/cai-dat',
    };
    const sectionTitles = {
      overview: 'T·ªïng Quan',
      gd1: 'Giai ƒêo·∫°n 1: N·ªÅn T·∫£ng & Chi·∫øn L∆∞·ª£c',
      gd2: 'Giai ƒêo·∫°n 2: X√¢y D·ª±ng H·∫° T·∫ßng & T√†i S·∫£n',
      gd3: 'Giai ƒêo·∫°n 3: V·∫≠n H√†nh & T·ªëi ∆Øu',
      gd4: 'Giai ƒêo·∫°n 4: Ra M·∫Øt',
      notes: 'Ghi Ch√∫ D·ª± √Ån',
      'user-management': 'Qu·∫£n L√Ω Ng∆∞·ªùi D√πng',
      'plan-manager': 'Qu·∫£n L√Ω K·∫ø Ho·∫°ch',
      settings: 'C√†i ƒê·∫∑t D·ª± √Ån',
    };
    const DEFAULT_NAV_HREF = sectionToPath.overview;
    const routeConfig = {
      '/': { layout: 'cover', section: null, navHref: null },
      '/login': { layout: 'login', section: null, navHref: null },
      '/tongquan': { layout: 'app', section: 'overview', navHref: DEFAULT_NAV_HREF },
      // NOTE: Phase routes (giaidoan1-4) are now DYNAMIC and handled by the router's resolve() function
      // They are loaded from Firestore menus collection and use the slug field
      // DO NOT add hardcoded phase routes here - they will cause conflicts with dynamic slugs
      '/ghichu': { layout: 'app', section: 'notes', navHref: sectionToPath.notes },
      '/quan-ly-nguoi-dung': { layout: 'app', section: 'user-management', navHref: sectionToPath['user-management'] },
      '/quan-ly-ke-hoach': { layout: 'app', section: 'plan-manager', navHref: sectionToPath['plan-manager'] },
      '/cai-dat': { layout: 'app', section: 'settings', navHref: sectionToPath.settings },
    };
    let router = null;

    function showSection(id){
      $$('.content-section').forEach(s => s.classList.toggle('hidden', s.id !== id));
      const main = document.querySelector('main');
      if(main) main.scrollTop = 0;
      const header = $('#current-section-title');
      const title = sectionTitles[id] || '';
      if(header){
        if(title){
          header.textContent = title;
          header.classList.remove('hidden');
        } else {
          header.textContent = '';
          header.classList.add('hidden');
        }
      }

      // Reload data when showing specific sections
      if(id === 'user-management' && isAdmin){
        loadUsers();
      }
    }

    // ========= TASK COMPLETION HELPER =========
    /**
     * Check if a task is completed with comprehensive fallback logic
     * Handles all variations of completion status indicators
     * @param {Object} task - The task object from Firestore
     * @returns {boolean} - True if task is completed
     */
    function isTaskComplete(task){
      if(!task){
        console.warn('‚ö†Ô∏è [isTaskComplete] Task is null or undefined');
        return false;
      }

      // ‚úÖ FIX ISSUE 2: Add comprehensive debug logging
      console.group(`üîç [isTaskComplete] Checking task: ${task.id || task.name}`);
      console.log('üì¶ Full task object:', task);
      console.log('üìä Completion indicators:', {
        'task.completed': task.completed,
        'task.isCompleted': task.isCompleted,
        'task.status': task.status,
        'task.completedAt': task.completedAt,
        'task.completedLink': task.completedLink,
        'task.completionLink': task.completionLink
      });

      // Primary check: Boolean 'completed' field
      if(task.completed === true){
        console.log('‚úÖ MATCH: task.completed === true');
        console.groupEnd();
        return true;
      }

      // Fallback 1: Boolean 'isCompleted' field (alternative naming)
      if(task.isCompleted === true){
        console.log('‚úÖ MATCH: task.isCompleted === true');
        console.groupEnd();
        return true;
      }

      // Fallback 2: Check status string (case-insensitive)
      if(task.status){
        const normalizedStatus = task.status.toLowerCase().trim();
        console.log(`üî§ Normalized status: "${normalizedStatus}"`);

        const completedVariants = [
          'completed',
          'ho√†n th√†nh',
          'ƒë√£ ho√†n th√†nh',
          'done',
          'xong',
          'complete',
          'success',
          'finished'
        ];

        if(completedVariants.includes(normalizedStatus)){
          console.log(`‚úÖ MATCH: status "${normalizedStatus}" is in completed variants`);
          console.groupEnd();
          return true;
        } else {
          console.log(`‚ùå NO MATCH: status "${normalizedStatus}" not in ${JSON.stringify(completedVariants)}`);
        }
      } else {
        console.log('‚ùå NO STATUS: task.status is empty/null');
      }

      // Fallback 3: Check for completion indicators (link or timestamp)
      if(task.completedAt || task.completedLink || task.completionLink){
        console.log('‚úÖ MATCH: Found completion indicators (timestamp or link)');
        console.groupEnd();
        return true;
      }

      console.log('‚ùå FINAL RESULT: Task is NOT completed (no indicators matched)');
      console.groupEnd();
      return false;
    }

    async function showDynamicMenuSection(menuId){
      console.log('üìÑ [MENU] Showing dynamic menu section for ID:', menuId);

      // Show the dynamic-menu section
      $$('.content-section').forEach(s => s.classList.toggle('hidden', s.id !== 'dynamic-menu'));
      const main = document.querySelector('main');
      if(main) main.scrollTop = 0;

      // Find the menu
      const menu = dynamicMenus.find(m => m.id === menuId);
      if(!menu) {
        console.error('‚ùå [MENU] Menu not found:', menuId, {
          availableMenus: dynamicMenus.map(m => ({id: m.id, slug: m.slug, name: m.name}))
        });

        // Show 404 error message
        const tasksContainer = $('#dynamic-menu-tasks-container');
        if(tasksContainer){
          tasksContainer.innerHTML = `
            <div class="card-section text-center py-12">
              <div class="text-6xl mb-4">üîç</div>
              <h3 class="text-xl font-bold text-gray-700 mb-2">Kh√¥ng t√¨m th·∫•y menu</h3>
              <p class="text-gray-500 mb-6">Menu n√†y c√≥ th·ªÉ ƒë√£ b·ªã x√≥a ho·∫∑c URL kh√¥ng ch√≠nh x√°c.</p>
              <a href="/tongquan" class="task-btn btn-complete">V·ªÅ trang T·ªïng Quan</a>
            </div>
          `;
        }
        return;
      }

      console.log('‚úÖ [MENU] Loaded menu:', menu.name);

      // Update page title
      const header = $('#current-section-title');
      if(header){
        header.textContent = menu.name;
        header.classList.remove('hidden');
      }

      // Update menu title container with Sort By dropdown
      const titleContainer = $('#dynamic-menu-title-container');
      if(titleContainer){
        titleContainer.innerHTML = `
          <div class="flex justify-between items-center mb-4">
            <p class="section-subtitle">Danh s√°ch c√¥ng vi·ªác cho ${menu.name}</p>
            <div class="flex items-center gap-2">
              <label for="task-sort-${menuId}" class="text-sm font-medium text-gray-700">S·∫Øp x·∫øp:</label>
              <select
                id="task-sort-${menuId}"
                class="task-sort-dropdown px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                data-menu-id="${menuId}"
              >
                <option value="custom">T√πy ch·ªânh (K√©o th·∫£)</option>
                <option value="name">T√™n (A-Z)</option>
                <option value="duedate">Ng√†y h·∫øt h·∫°n</option>
              </select>
            </div>
          </div>
        `;
      }

      // ‚úÖ FIX ISSUE A: Load tasks from Firestore if not already loaded
      const tasksContainer = $('#dynamic-menu-tasks-container');
      if(!dynamicTasks[menuId]){
        console.log('‚è≥ [MENU] Tasks not loaded yet, fetching from Firestore...');
        if(tasksContainer){
          tasksContainer.innerHTML = `
            <div class="card-section text-center py-8">
              <div class="text-gray-500">
                <div style="display:inline-block;width:20px;height:20px;border:3px solid #ddd;border-top-color:#333;border-radius:50%;animation:spin 0.8s linear infinite;"></div>
                <p class="mt-4">ƒêang t·∫£i tasks...</p>
              </div>
            </div>
          `;
        }
        await loadMenuTasks(menuId);
      }

      // Attach event listener to sort dropdown
      const sortDropdown = $(`#task-sort-${menuId}`);
      if (sortDropdown) {
        sortDropdown.addEventListener('change', (e) => {
          handleSortChange(menuId, e.target.value);
        });
      }

      // Render tasks for this menu using the new drag-and-drop enabled renderer
      const tasks = dynamicTasks[menuId] || [];
      renderSortedTasks(menuId, tasks, 'custom'); // Default to custom (drag-and-drop) mode

      // Initialize Sortable.js for drag-and-drop
      initializeSortableForMenu(menuId);
    }

    // Keep the old task rendering code below for reference (can be removed later)
    async function showDynamicMenuSection_OLD(menuId){
      const tasksContainer = $('#dynamic-menu-tasks-container');
      if(tasksContainer){
        const tasks_old = dynamicTasks[menuId] || [];
        if(tasks_old.length === 0){
          tasksContainer.innerHTML = `
            <div class="card-section text-center py-8">
              <p class="text-gray-500">Ch∆∞a c√≥ task n√†o. ${isAdmin ? 'V√†o Qu·∫£n L√Ω K·∫ø Ho·∫°ch ƒë·ªÉ th√™m task.' : ''}</p>
            </div>
          `;
        } else {
          // OLD RENDERING - NOT USED ANYMORE
          console.log(`üìã [RENDER OLD] This code is deprecated`);
          tasksContainer.innerHTML = tasks_old.map(task => {
            const assignee = assignees.find(a => a.id === task.assigneeId);
            const assigneeName = assignee ? assignee.name : 'Ch∆∞a g√°n';
            // ‚úÖ FIX ISSUE B: Use comprehensive completion check helper function
            const isCompleted = isTaskComplete(task);
            console.log(`üìù [RENDER] Task ${task.id} - isCompleted: ${isCompleted}, will render: ${isCompleted ? 'ACTION BUTTONS' : 'INPUT FIELD'}`);
            const startDateStr = task.startDate ? formatDateFromISO(task.startDate) : 'Ch∆∞a ƒë·∫∑t';
            const endDateStr = task.endDate ? formatDateFromISO(task.endDate) : 'Ch∆∞a ƒë·∫∑t';

            // Calculate remaining time with color coding
            let remainingTimeHtml = '';
            if(task.endDate && !isCompleted){
              const deadlineInfo = evaluateDeadline(formatDateFromISO(task.endDate), false);
              if(deadlineInfo){
                remainingTimeHtml = `<span class="${deadlineInfo.className}">${deadlineInfo.text}</span>`;
              }
            } else if(isCompleted){
              remainingTimeHtml = '<span class="text-green-600">‚úÖ ƒê√£ ho√†n th√†nh</span>';
            } else {
              remainingTimeHtml = '<span class="text-gray-500">Ch∆∞a c√≥ deadline</span>';
            }

            return `
              <div class="task-card ${isCompleted ? 'completed' : ''}" id="dynamic-task-${task.id}">
                <div class="task-header">
                  <div class="task-title">${escapeHtml(task.name)}</div>
                  <span class="task-status status-${isCompleted ? 'completed' : 'pending'}">${isCompleted ? 'Ho√†n th√†nh' : 'Ch∆∞a xong'}</span>
                </div>
                ${task.description ? `
                  <div class="task-details">
                    <div class="text-sm text-gray-700 whitespace-pre-wrap">${escapeHtml(task.description)}</div>
                  </div>
                ` : ''}
                <div class="task-meta">
                  <span>üìÖ B·∫Øt ƒë·∫ßu: ${startDateStr}</span>
                  <span>üìÖ K·∫øt th√∫c: ${endDateStr}</span>
                  <span>üë§ Ph·ª• tr√°ch: ${assigneeName}</span>
                  <span>‚è∞ C√≤n l·∫°i: ${remainingTimeHtml}</span>
                </div>
                <div class="task-action-area">
                  ${!isCompleted ? `
                    <div class="task-input-group">
                      <input type="url"
                        class="task-link-input"
                        id="dynamic-task-input-${task.id}"
                        placeholder="D√°n link (t√†i li·ªáu, file, trang k·∫øt qu·∫£...)" />
                      <button type="button"
                        class="task-btn btn-complete task-complete-btn"
                        onclick="completeDynamicTask('${menuId}', '${task.id}')"
                        id="dynamic-task-btn-${task.id}">
                        Ho√†n Th√†nh
                      </button>
                    </div>
                  ` : `
                    <!-- ‚úÖ REFACTORED COMPLETED TASK UI - 3 COLUMN LAYOUT -->
                    <div class="task-completed-section" style="display:block !important; visibility:visible !important;">

                      <!-- Completion Status Badge -->
                      <div style="margin-bottom:16px; padding:8px 12px; background:#f0fdf4; border:1px solid #86efac; border-radius:6px;">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                          <span style="color:#166534; font-weight:600; font-size:0.875rem;">‚úÖ ƒê√£ ho√†n th√†nh</span>
                          ${task.completedAt ? `<span style="color:#6b7280; font-size:0.75rem;">${formatTimestamp(task.completedAt)}</span>` : ''}
                        </div>
                        ${task.completedLink ? `
                          <a href="${task.completedLink}" target="_blank" rel="noopener noreferrer"
                             style="display:inline-block; margin-top:4px; color:#2563eb; font-size:0.75rem; text-decoration:none; word-break:break-all;">
                            üîó ${task.completedLink}
                          </a>
                        ` : ''}
                      </div>

                      <!-- ‚úÖ 3-COLUMN ACTION BAR (View | Comment | Edit) -->
                      <div class="task-action-bar"
                           style="display:grid !important; grid-template-columns:auto 1fr auto; gap:8px; align-items:stretch; visibility:visible !important;">

                        <!-- LEFT: View Result Button -->
                        <button type="button"
                                class="action-btn-view"
                                style="display:flex; align-items:center; justify-content:center; gap:6px; padding:10px 16px; background:#3b82f6; color:#fff; border:none; border-radius:8px; font-weight:500; font-size:0.875rem; cursor:pointer; transition:background 0.2s; white-space:nowrap;"
                                onclick="openTaskResult('${menuId}', '${task.id}', '${task.completedLink || ''}')"
                                onmouseover="this.style.background='#2563eb'"
                                onmouseout="this.style.background='#3b82f6'"
                                ${!task.completedLink ? 'disabled style="opacity:0.5; cursor:not-allowed;"' : ''}>
                          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                          </svg>
                          Xem K·∫øt Qu·∫£
                        </button>

                        <!-- CENTER: Comment Button with Count -->
                        <button type="button"
                                class="action-btn-comment"
                                id="comment-toggle-${task.id}"
                                style="display:flex; align-items:center; justify-content:center; gap:8px; padding:10px 16px; background:#f3f4f6; color:#1f2937; border:1px solid #d1d5db; border-radius:8px; font-weight:500; font-size:0.875rem; cursor:pointer; transition:all 0.2s;"
                                onclick="toggleTaskComments('${menuId}', '${task.id}')"
                                onmouseover="this.style.background='#e5e7eb'"
                                onmouseout="this.style.background='#f3f4f6'">
                          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                          </svg>
                          <span>B√¨nh lu·∫≠n</span>
                          <span class="comment-count-badge"
                                id="comment-count-${task.id}"
                                style="display:inline-flex; align-items:center; justify-content:center; min-width:20px; height:20px; padding:0 6px; background:#ef4444; color:#fff; border-radius:10px; font-size:0.75rem; font-weight:700;">
                            ${(task.comments && task.comments.length) || 0}
                          </span>
                        </button>

                        <!-- RIGHT: Edit Dropdown Button -->
                        <div style="position:relative;">
                          <button type="button"
                                  class="action-btn-edit"
                                  id="edit-toggle-${task.id}"
                                  style="display:flex; align-items:center; justify-content:center; gap:6px; padding:10px 16px; background:#fff; color:#1f2937; border:1px solid #d1d5db; border-radius:8px; font-weight:500; font-size:0.875rem; cursor:pointer; transition:all 0.2s; white-space:nowrap;"
                                  onclick="toggleEditMenu('${task.id}')"
                                  onmouseover="this.style.background='#f9fafb'"
                                  onmouseout="this.style.background='#fff'">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                              <path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207l6.5-6.5zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11l.178-.178z"/>
                            </svg>
                            Ch·ªânh s·ª≠a
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="margin-left:4px;">
                              <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                            </svg>
                          </button>

                          <!-- Edit Dropdown Menu -->
                          <div id="edit-menu-${task.id}"
                               class="edit-dropdown-menu"
                               style="display:none; position:absolute; top:calc(100% + 4px); right:0; min-width:200px; background:#fff; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 10px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); z-index:50; overflow:hidden;">
                            <button type="button"
                                    style="display:flex; align-items:center; gap:10px; width:100%; padding:12px 16px; background:#fff; border:none; text-align:left; cursor:pointer; transition:background 0.15s; color:#1f2937; font-size:0.875rem;"
                                    onclick="openUpdateLinkModal('${menuId}', '${task.id}', '${task.completedLink || ''}'); toggleEditMenu('${task.id}')"
                                    onmouseover="this.style.background='#f3f4f6'"
                                    onmouseout="this.style.background='#fff'">
                              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M6.354 5.5H4a3 3 0 0 0 0 6h3a3 3 0 0 0 2.83-4H9c-.086 0-.17.01-.25.031A2 2 0 0 1 7 10.5H4a2 2 0 1 1 0-4h1.535c.218-.376.495-.714.82-1z"/>
                                <path d="M9 5.5a3 3 0 0 0-2.83 4h1.098A2 2 0 0 1 9 6.5h3a2 2 0 1 1 0 4h-1.535a4.02 4.02 0 0 1-.82 1H12a3 3 0 1 0 0-6H9z"/>
                              </svg>
                              C·∫≠p nh·∫≠t Link
                            </button>
                            <button type="button"
                                    style="display:flex; align-items:center; gap:10px; width:100%; padding:12px 16px; background:#fff; border:none; border-top:1px solid #f3f4f6; text-align:left; cursor:pointer; transition:background 0.15s; color:#f59e0b; font-size:0.875rem;"
                                    onclick="handleRemoveResult('${menuId}', '${task.id}', '${task.name}'); toggleEditMenu('${task.id}')"
                                    onmouseover="this.style.background='#fffbeb'"
                                    onmouseout="this.style.background='#fff'">
                              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                              </svg>
                              G·ª° k·∫øt qu·∫£
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- ‚úÖ COMMENT SECTION (Toggle Visibility) -->
                      <div id="comment-section-${task.id}"
                           class="task-comment-section"
                           style="display:none; margin-top:20px; padding:16px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px;">

                        <!-- Comments List -->
                        <div id="comments-list-${task.id}" style="margin-bottom:16px;">
                          ${(task.comments && task.comments.length > 0) ?
                            task.comments.map(comment => `
                              <div class="comment-item" data-comment-id="${comment.id || ''}" style="padding:12px; background:#fff; border:1px solid #e5e7eb; border-radius:6px; margin-bottom:8px;">
                                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                                  <div style="display:flex; align-items:center; gap:8px;">
                                    <div style="width:32px; height:32px; background:#3b82f6; color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:0.875rem;">
                                      ${(comment.userName || 'U').charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                      <div style="font-weight:600; font-size:0.875rem; color:#1f2937;">${comment.userName || 'Anonymous'}</div>
                                      <div style="font-size:0.75rem; color:#6b7280;">${comment.createdAt ? formatTimestamp(comment.createdAt) : ''}</div>
                                    </div>
                                  </div>
                                  ${comment.userId === (currentUser?.uid || '') ? `
                                    <div style="display:flex; gap:4px;">
                                      <button onclick="editComment('${menuId}', '${task.id}', '${comment.id}')" style="padding:4px 8px; font-size:0.75rem; color:#6b7280; background:none; border:none; cursor:pointer;">‚úèÔ∏è</button>
                                      <button onclick="deleteComment('${menuId}', '${task.id}', '${comment.id}')" style="padding:4px 8px; font-size:0.75rem; color:#ef4444; background:none; border:none; cursor:pointer;">üóëÔ∏è</button>
                                    </div>
                                  ` : ''}
                                </div>
                                <div style="color:#374151; font-size:0.875rem; line-height:1.5; white-space:pre-wrap;">${comment.text || ''}</div>
                              </div>
                            `).join('')
                            : '<p style="text-align:center; color:#9ca3af; font-size:0.875rem; padding:20px;">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</p>'}
                        </div>

                        <!-- Add Comment Form -->
                        <div style="display:flex; flex-direction:column; gap:8px;">
                          <textarea id="comment-input-${task.id}"
                                    placeholder="Nh·∫≠p b√¨nh lu·∫≠n c·ªßa b·∫°n... (Enter ƒë·ªÉ g·ª≠i, Shift+Enter ƒë·ªÉ xu·ªëng d√≤ng)"
                                    rows="3"
                                    onkeydown="handleCommentKeyPress(event, '${menuId}', '${task.id}')"
                                    style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:0.875rem; resize:vertical; font-family:inherit;"></textarea>
                          <div style="display:flex; justify-content:flex-end; gap:8px;">
                            <button type="button"
                                    onclick="toggleTaskComments('${menuId}', '${task.id}')"
                                    style="padding:8px 16px; background:#e5e7eb; color:#1f2937; border:none; border-radius:6px; font-size:0.875rem; font-weight:500; cursor:pointer;">
                              H·ªßy
                            </button>
                            <button type="button"
                                    onclick="submitComment('${menuId}', '${task.id}')"
                                    style="padding:8px 16px; background:#3b82f6; color:#fff; border:none; border-radius:6px; font-size:0.875rem; font-weight:500; cursor:pointer;">
                              G·ª≠i b√¨nh lu·∫≠n
                            </button>
                          </div>
                        </div>
                      </div>

                    </div>
                  `}
                </div>
              </div>
            `;
          }).join('');
        }
      }
    }

    async function completeDynamicTask(menuId, taskId){
      if(!ensureProjectReady()) return;
      const inputEl = $(`#dynamic-task-input-${taskId}`);
      const link = inputEl ? inputEl.value.trim() : '';

      if(!link){
        showToast('Vui l√≤ng nh·∫≠p link tr∆∞·ªõc khi ho√†n th√†nh task', 'error');
        return;
      }

      // Validate URL format
      try {
        new URL(link);
      } catch(e){
        showToast('Link kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p URL ƒë·∫ßy ƒë·ªß (b·∫Øt ƒë·∫ßu b·∫±ng http:// ho·∫∑c https://)', 'error');
        return;
      }

      try {
        const tasks = dynamicTasks[menuId] || [];
        const task = tasks.find(t => t.id === taskId);
        const assignee = task ? assignees.find(a => a.id === task.assigneeId) : null;
        const assigneeName = assignee ? assignee.name : '';
        const performer = getCurrentUserName();
        const menu = dynamicMenus.find(m => m.id === menuId);
        const phaseLabel = menu ? menu.name : menuId;
        const timestamp = new Date().toISOString();
        const projectId = ensureProjectId();
        const updateData = {
          completed: true,
          completedLink: link,
          completedAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        await updateDoc(doc(db, 'projects', projectId, 'menus', menuId, 'tasks', taskId), updateData);

        showToast('Ho√†n th√†nh task th√†nh c√¥ng!', 'success');
        recordActivityEntry({
          taskId: `dynamic-${taskId}`,
          taskName: task ? task.name : taskId,
          phase: phaseLabel,
          status: 'completed',
          timestamp,
          completedAt: timestamp,
          performedBy: performer,
          menuId: menuId, // Store menu ID for navigation
        });
        renderActivityLog();
        syncTaskState();

        pushNotification('completed', {
          id: `dynamic-${taskId}`,
          title: task ? task.name : taskId,
          name: task ? task.name : taskId,
          owner: assigneeName,
        }, performer);
        renderNotifications();
        if(inputEl) inputEl.value = '';
        await loadMenuTasks(menuId);
        showDynamicMenuSection(menuId);
        renderDynamicOverview(); // Update overview
      } catch(error){
        console.error('Error completing task:', error);
        showToast('L·ªói khi ho√†n th√†nh task', 'error');
      }
    }

    function formatTimestamp(timestamp){
      if(!timestamp) return '';
      // Handle Firestore Timestamp object
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    }

    window.completeDynamicTask = completeDynamicTask;

    function toggleDynamicComment(menuId, taskId){
      const section = document.getElementById(`dynamic-comment-${taskId}`);
      const toggleBtn = document.getElementById(`dynamic-comment-toggle-${taskId}`);
      if(!section || !toggleBtn) return;
      const willShow = section.classList.contains('hidden');
      section.classList.toggle('hidden');
      toggleBtn.textContent = willShow ? '·∫®n b√¨nh lu·∫≠n' : 'üí¨ B√¨nh lu·∫≠n';
      if(willShow){
        const textarea = document.getElementById(`dynamic-comment-input-${taskId}`);
        if(textarea){
          textarea.focus();
          textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }
      }
    }

    async function saveDynamicComment(menuId, taskId){
      if(!ensureProjectReady()) return;
      const textarea = document.getElementById(`dynamic-comment-input-${taskId}`);
      if(!textarea) return;
      const comment = textarea.value.trim();

      try {
        const tasks = dynamicTasks[menuId] || [];
        const task = tasks.find(t => t.id === taskId);
        const performer = getCurrentUserName();
        const menu = dynamicMenus.find(m => m.id === menuId);
        const phaseLabel = menu ? menu.name : menuId;
        const timestamp = new Date().toISOString();
        const projectId = ensureProjectId();

        await updateDoc(doc(db, 'projects', projectId, 'menus', menuId, 'tasks', taskId), {
          completedComment: comment,
          updatedAt: serverTimestamp()
        });

        showToast('ƒê√£ l∆∞u b√¨nh lu·∫≠n', 'success');
        recordActivityEntry({
          taskId: `dynamic-${taskId}`,
          taskName: task ? task.name : taskId,
          phase: phaseLabel,
          status: 'edited',
          timestamp,
          performedBy: performer,
          menuId: menuId, // Store menu ID for navigation
        });
        renderActivityLog();
        syncTaskState();

        cancelDynamicComment(taskId);
        await loadMenuTasks(menuId);
        showDynamicMenuSection(menuId);
      } catch(error){
        console.error('Error saving comment:', error);
        showToast('L·ªói khi l∆∞u b√¨nh lu·∫≠n', 'error');
      }
    }

    function cancelDynamicComment(taskId){
      const section = document.getElementById(`dynamic-comment-${taskId}`);
      const toggleBtn = document.getElementById(`dynamic-comment-toggle-${taskId}`);
      if(section) section.classList.add('hidden');
      if(toggleBtn) toggleBtn.textContent = 'üí¨ B√¨nh lu·∫≠n';
      const textarea = document.getElementById(`dynamic-comment-input-${taskId}`);
      const preview = document.querySelector(`[data-dynamic-comment-preview="${taskId}"]`);
      if(textarea){
        textarea.value = preview ? preview.textContent.trim() : '';
      }
    }

    window.toggleDynamicComment = toggleDynamicComment;
    window.saveDynamicComment = saveDynamicComment;
    window.cancelDynamicComment = cancelDynamicComment;

    // View completed task details
    async function viewCompletedTask(menuId, taskId){
      const tasks = dynamicTasks[menuId] || [];
      const task = tasks.find(t => t.id === taskId);
      if(!task) return;

      const assignee = assignees.find(a => a.id === task.assigneeId);
      const assigneeName = assignee ? assignee.name : 'Ch∆∞a g√°n';

      const details = `
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìã Chi Ti·∫øt Task
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

T√™n: ${task.name}

M√¥ t·∫£: ${task.description || 'Kh√¥ng c√≥'}

üìÖ Ng√†y b·∫Øt ƒë·∫ßu: ${task.startDate ? formatDateFromISO(task.startDate) : 'Ch∆∞a ƒë·∫∑t'}
üìÖ Ng√†y k·∫øt th√∫c: ${task.endDate ? formatDateFromISO(task.endDate) : 'Ch∆∞a ƒë·∫∑t'}

üë§ Ph·ª• tr√°ch: ${assigneeName}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚úÖ TH√îNG TIN HO√ÄN TH√ÄNH
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîó Link: ${task.completedLink || 'Kh√¥ng c√≥'}

üí¨ Ghi ch√∫: ${task.completedComment || 'Kh√¥ng c√≥'}

‚è∞ Ho√†n th√†nh l√∫c: ${task.completedAt ? formatTimestamp(task.completedAt) : 'Kh√¥ng r√µ'}
      `.trim();

      alert(details);
    }

    // Edit completed task
    async function editCompletedTask(menuId, taskId){
      if(!ensureProjectReady()) return;
      const tasks = dynamicTasks[menuId] || [];
      const task = tasks.find(t => t.id === taskId);
      if(!task) return;

      const newLink = prompt('üìé C·∫≠p nh·∫≠t Link:', task.completedLink || '');
      if(newLink === null) return; // User cancelled

      const trimmedLink = newLink.trim();
      if(trimmedLink){
        try {
          new URL(trimmedLink);
        } catch(e){
          showToast('Link kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p URL ƒë·∫ßy ƒë·ªß (b·∫Øt ƒë·∫ßu b·∫±ng http:// ho·∫∑c https://)', 'error');
          return;
        }
      }

      try {
        const projectId = ensureProjectId();
        await updateDoc(doc(db, 'projects', projectId, 'menus', menuId, 'tasks', taskId), {
          completedLink: trimmedLink,
          updatedAt: serverTimestamp()
        });

        const performer = getCurrentUserName();
        const menu = dynamicMenus.find(m => m.id === menuId);
        const phaseLabel = menu ? menu.name : menuId;
        const timestamp = new Date().toISOString();
        recordActivityEntry({
          taskId: `dynamic-${taskId}`,
          taskName: task.name,
          phase: phaseLabel,
          status: 'edited',
          timestamp,
          performedBy: performer,
          menuId: menuId, // Store menu ID for navigation
        });
        renderActivityLog();
        syncTaskState();

        showToast('C·∫≠p nh·∫≠t link th√†nh c√¥ng!', 'success');
        await loadMenuTasks(menuId);
        showDynamicMenuSection(menuId);
      } catch(error){
        console.error('Error updating task:', error);
        showToast('L·ªói khi c·∫≠p nh·∫≠t task', 'error');
      }
    }

    // Delete completed task content
    async function deleteCompletedTask(menuId, taskId){
      if(!ensureProjectReady()) return;
      if(!confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a n·ªôi dung ƒë√£ ho√†n th√†nh?\n\nH√†nh ƒë·ªông n√†y s·∫Ω:\n- X√≥a link ƒë√£ g·ª≠i\n- X√≥a ghi ch√∫\n- ƒê·∫∑t l·∫°i task v·ªÅ tr·∫°ng th√°i "Ch∆∞a xong"\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?')){
        return;
      }

      try {
        const tasks = dynamicTasks[menuId] || [];
        const task = tasks.find(t => t.id === taskId);
        const performer = getCurrentUserName();
        const menu = dynamicMenus.find(m => m.id === menuId);
        const phaseLabel = menu ? menu.name : menuId;
        const timestamp = new Date().toISOString();
        const projectId = ensureProjectId();
        const updateData = {
          completed: false,
          completedLink: '',
          completedComment: '',
          completedAt: null,
          updatedAt: serverTimestamp()
        };

        await updateDoc(doc(db, 'projects', projectId, 'menus', menuId, 'tasks', taskId), updateData);

        showToast('ƒê√£ x√≥a n·ªôi dung ho√†n th√†nh. Task quay l·∫°i tr·∫°ng th√°i "Ch∆∞a xong".', 'success');
        recordActivityEntry({
          taskId: `dynamic-${taskId}`,
          taskName: task ? task.name : taskId,
          phase: phaseLabel,
          status: 'deleted',
          timestamp,
          performedBy: performer,
          menuId: menuId, // Store menu ID for navigation
        });
        renderActivityLog();
        syncTaskState();
        await loadMenuTasks(menuId);
        showDynamicMenuSection(menuId);
        renderDynamicOverview(); // Update overview
      } catch(error){
        console.error('Error deleting completed task:', error);
        showToast('L·ªói khi x√≥a', 'error');
      }
    }

    // ========= NEW REFACTORED UI FUNCTIONS =========

    /**
     * Open task result link in new window
     */
    function openTaskResult(menuId, taskId, link){
      console.log('üëÅÔ∏è [VIEW RESULT] Opening task result:', { menuId, taskId, link });

      if(!link || link === ''){
        showToast('Kh√¥ng c√≥ link k·∫øt qu·∫£', 'error');
        return;
      }

      // Open the actual Google Sheet/Doc link
      window.open(link, '_blank', 'noopener,noreferrer');
    }

    /**
     * Toggle comment section visibility
     */
    function toggleTaskComments(menuId, taskId){
      console.log('üí¨ [COMMENTS] Toggling comments for task:', taskId);

      const commentSection = document.getElementById(`comment-section-${taskId}`);
      const commentToggle = document.getElementById(`comment-toggle-${taskId}`);

      if(!commentSection){
        console.error('‚ùå Comment section not found:', taskId);
        return;
      }

      const isHidden = commentSection.style.display === 'none';

      if(isHidden){
        commentSection.style.display = 'block';
        if(commentToggle){
          commentToggle.style.background = '#dbeafe';
          commentToggle.style.borderColor = '#3b82f6';
        }
      } else {
        commentSection.style.display = 'none';
        if(commentToggle){
          commentToggle.style.background = '#f3f4f6';
          commentToggle.style.borderColor = '#d1d5db';
        }
      }
    }

    /**
     * Toggle edit dropdown menu
     */
    function toggleEditMenu(taskId){
      console.log('üìù [EDIT MENU] Toggling edit menu for task:', taskId);

      const editMenu = document.getElementById(`edit-menu-${taskId}`);
      if(!editMenu) {
        console.error('‚ùå Edit menu not found:', taskId);
        return;
      }

      // Close all other edit menus first
      document.querySelectorAll('.edit-dropdown-menu').forEach(menu => {
        if(menu.id !== `edit-menu-${taskId}`){
          menu.style.display = 'none';
        }
      });

      // Toggle current menu
      editMenu.style.display = editMenu.style.display === 'none' ? 'block' : 'none';
    }

    /**
     * Close edit menu when clicking outside
     */
    document.addEventListener('click', function(e){
      if(!e.target.closest('.action-btn-edit') && !e.target.closest('.edit-dropdown-menu')){
        document.querySelectorAll('.edit-dropdown-menu').forEach(menu => {
          menu.style.display = 'none';
        });
      }
    });

    /**
     * Open modal to update task link
     */
    function openUpdateLinkModal(menuId, taskId, currentLink){
      console.log('üîó [UPDATE LINK] Opening modal:', { menuId, taskId, currentLink });

      const newLink = prompt('C·∫≠p nh·∫≠t Link k·∫øt qu·∫£:\n\nNh·∫≠p URL m·ªõi (Google Sheet/Doc):', currentLink || '');

      if(newLink === null) return; // User cancelled

      if(newLink.trim() === ''){
        showToast('Link kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'error');
        return;
      }

      // Validate URL
      try {
        new URL(newLink);
      } catch(e){
        showToast('URL kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p URL ƒë·∫ßy ƒë·ªß (b·∫Øt ƒë·∫ßu b·∫±ng http:// ho·∫∑c https://)', 'error');
        return;
      }

      // Update link in Firestore
      updateTaskLink(menuId, taskId, newLink);
    }

    /**
     * Update task link in Firestore
     */
    async function updateTaskLink(menuId, taskId, newLink){
      if(!ensureProjectReady()) return;

      try {
        const projectId = ensureProjectId();
        await updateDoc(doc(db, 'projects', projectId, 'menus', menuId, 'tasks', taskId), {
          completedLink: newLink,
          updatedAt: serverTimestamp()
        });

        showToast('C·∫≠p nh·∫≠t link th√†nh c√¥ng', 'success');
        await loadMenuTasks(menuId);
        await showDynamicMenuSection(menuId);
      } catch(error){
        console.error('‚ùå Error updating link:', error);
        showToast('L·ªói khi c·∫≠p nh·∫≠t link', 'error');
      }
    }

    /**
     * Confirm and delete task
     */
    function confirmDeleteTask(menuId, taskId, taskName){
      console.log('üóëÔ∏è [DELETE] Confirming deletion:', { menuId, taskId, taskName });

      const confirmed = confirm(`‚ö†Ô∏è X√ìA TASK\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a task n√†y?\n\n"${taskName}"\n\nH√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ HO√ÄN T√ÅC!`);

      if(!confirmed) return;

      deleteTask(menuId, taskId, taskName);
    }

    /**
     * Delete task from Firestore
     */
    async function deleteTask(menuId, taskId, taskName){
      if(!ensureProjectReady()) return;

      try {
        const projectId = ensureProjectId();
        const performer = getCurrentUserName();
        const menu = dynamicMenus.find(m => m.id === menuId);
        const phaseLabel = menu ? menu.name : menuId;
        const timestamp = new Date().toISOString();

        // Delete from Firestore
        await deleteDoc(doc(db, 'projects', projectId, 'menus', menuId, 'tasks', taskId));

        showToast('ƒê√£ x√≥a task th√†nh c√¥ng', 'success');

        // Record activity
        recordActivityEntry({
          taskId: `dynamic-${taskId}`,
          taskName: taskName,
          phase: phaseLabel,
          status: 'deleted',
          timestamp,
          performedBy: performer,
          menuId: menuId,
        });

        renderActivityLog();
        await loadMenuTasks(menuId);
        await showDynamicMenuSection(menuId);
        renderDynamicOverview();
      } catch(error){
        console.error('‚ùå Error deleting task:', error);
        showToast('L·ªói khi x√≥a task', 'error');
      }
    }

    /**
     * Submit a new comment
     */
    async function submitComment(menuId, taskId){
      if(!ensureProjectReady()) return;

      const commentInput = document.getElementById(`comment-input-${taskId}`);
      if(!commentInput){
        console.error('‚ùå Comment input not found:', taskId);
        return;
      }

      const commentText = commentInput.value.trim();

      if(!commentText){
        showToast('Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n', 'error');
        return;
      }

      console.log('üí¨ [SUBMIT COMMENT] Submitting comment:', { menuId, taskId, commentText });

      try {
        const projectId = ensureProjectId();
        const tasks = dynamicTasks[menuId] || [];
        const task = tasks.find(t => t.id === taskId);

        // Get current comments
        const currentComments = task.comments || [];

        // Create new comment object
        const newComment = {
          id: `comment-${Date.now()}`,
          text: commentText,
          userId: currentUser?.uid || 'anonymous',
          userName: getCurrentUserName(),
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };

        // Add to comments array
        const updatedComments = [...currentComments, newComment];

        // Update Firestore
        await updateDoc(doc(db, 'projects', projectId, 'menus', menuId, 'tasks', taskId), {
          comments: updatedComments,
          updatedAt: serverTimestamp()
        });

        showToast('ƒê√£ th√™m b√¨nh lu·∫≠n', 'success');

        // Clear input
        commentInput.value = '';

        // Reload tasks
        await loadMenuTasks(menuId);
        await showDynamicMenuSection(menuId);

        // Reopen comment section
        setTimeout(() => {
          const commentSection = document.getElementById(`comment-section-${taskId}`);
          if(commentSection) commentSection.style.display = 'block';
        }, 100);

      } catch(error){
        console.error('‚ùå Error submitting comment:', error);
        showToast('L·ªói khi g·ª≠i b√¨nh lu·∫≠n', 'error');
      }
    }

    /**
     * Edit a comment - Uses prompt for simplicity
     */
    async function editComment(menuId, taskId, commentId){
      if(!ensureProjectReady()) return;

      console.log('‚úèÔ∏è [EDIT COMMENT] Editing comment:', { menuId, taskId, commentId });

      try {
        const projectId = ensureProjectId();
        const tasks = dynamicTasks[menuId] || [];
        const task = tasks.find(t => t.id === taskId);

        if(!task || !task.comments){
          showToast('Kh√¥ng t√¨m th·∫•y b√¨nh lu·∫≠n', 'error');
          return;
        }

        // Find the comment to edit
        const comment = task.comments.find(c => c.id === commentId);
        if(!comment){
          showToast('Kh√¥ng t√¨m th·∫•y b√¨nh lu·∫≠n', 'error');
          return;
        }

        // Check ownership
        if(comment.userId !== (currentUser?.uid || '')){
          showToast('B·∫°n ch·ªâ c√≥ th·ªÉ ch·ªânh s·ª≠a b√¨nh lu·∫≠n c·ªßa m√¨nh', 'error');
          return;
        }

        // Prompt for new text
        const newText = prompt('Ch·ªânh s·ª≠a b√¨nh lu·∫≠n:', comment.text);

        if(newText === null) return; // User cancelled

        if(newText.trim() === ''){
          showToast('B√¨nh lu·∫≠n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', 'error');
          return;
        }

        // Update the comment
        const updatedComments = task.comments.map(c => {
          if(c.id === commentId){
            return {
              ...c,
              text: newText.trim(),
              updatedAt: new Date().toISOString(),
              edited: true
            };
          }
          return c;
        });

        // Update Firestore
        await updateDoc(doc(db, 'projects', projectId, 'menus', menuId, 'tasks', taskId), {
          comments: updatedComments,
          updatedAt: serverTimestamp()
        });

        showToast('ƒê√£ c·∫≠p nh·∫≠t b√¨nh lu·∫≠n', 'success');

        // Reload tasks
        await loadMenuTasks(menuId);
        await showDynamicMenuSection(menuId);

        // Reopen comment section
        setTimeout(() => {
          const commentSection = document.getElementById(`comment-section-${taskId}`);
          if(commentSection) commentSection.style.display = 'block';
        }, 100);

      } catch(error){
        console.error('‚ùå Error editing comment:', error);
        showToast('L·ªói khi ch·ªânh s·ª≠a b√¨nh lu·∫≠n', 'error');
      }
    }

    /**
     * Delete a comment
     */
    async function deleteComment(menuId, taskId, commentId){
      if(!ensureProjectReady()) return;

      const confirmed = confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?');
      if(!confirmed) return;

      console.log('üóëÔ∏è [DELETE COMMENT] Deleting comment:', { menuId, taskId, commentId });

      try {
        const projectId = ensureProjectId();
        const tasks = dynamicTasks[menuId] || [];
        const task = tasks.find(t => t.id === taskId);

        if(!task || !task.comments){
          showToast('Kh√¥ng t√¨m th·∫•y b√¨nh lu·∫≠n', 'error');
          return;
        }

        // Filter out the comment to delete
        const updatedComments = task.comments.filter(c => c.id !== commentId);

        // Update Firestore
        await updateDoc(doc(db, 'projects', projectId, 'menus', menuId, 'tasks', taskId), {
          comments: updatedComments,
          updatedAt: serverTimestamp()
        });

        showToast('ƒê√£ x√≥a b√¨nh lu·∫≠n', 'success');

        // Reload tasks
        await loadMenuTasks(menuId);
        await showDynamicMenuSection(menuId);

        // Reopen comment section
        setTimeout(() => {
          const commentSection = document.getElementById(`comment-section-${taskId}`);
          if(commentSection) commentSection.style.display = 'block';
        }, 100);

      } catch(error){
        console.error('‚ùå Error deleting comment:', error);
        showToast('L·ªói khi x√≥a b√¨nh lu·∫≠n', 'error');
      }
    }

    /**
     * Handle keyboard shortcuts in comment textarea
     * Enter: Submit comment
     * Shift+Enter: New line
     */
    function handleCommentKeyPress(event, menuId, taskId){
      // Check if Enter key pressed without Shift
      if(event.key === 'Enter' && !event.shiftKey){
        event.preventDefault(); // Prevent default new line
        submitComment(menuId, taskId); // Submit comment immediately
      }
      // If Shift+Enter, allow default behavior (new line)
    }

    /**
     * Handle removing task result (revert to incomplete state)
     * This does NOT delete the task - it just clears the completion data
     */
    async function handleRemoveResult(menuId, taskId, taskName){
      if(!ensureProjectReady()) return;

      const confirmed = confirm(`‚ö†Ô∏è G·ª† K·∫æT QU·∫¢\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën g·ª° k·∫øt qu·∫£ c·ªßa task n√†y?\n\n"${taskName}"\n\nTask s·∫Ω quay v·ªÅ tr·∫°ng th√°i "Ch∆∞a xong" v√† b·∫°n c√≥ th·ªÉ n·ªôp l·∫°i k·∫øt qu·∫£.`);

      if(!confirmed) return;

      console.log('üîÑ [REMOVE RESULT] Reverting task to incomplete:', { menuId, taskId });

      try {
        const projectId = ensureProjectId();

        // Update task to incomplete state
        await updateDoc(doc(db, 'projects', projectId, 'menus', menuId, 'tasks', taskId), {
          completed: false,
          completedLink: '',
          completedComment: '',
          completedAt: null,
          updatedAt: serverTimestamp()
        });

        showToast('ƒê√£ g·ª° k·∫øt qu·∫£. Task quay v·ªÅ tr·∫°ng th√°i "Ch∆∞a xong".', 'success');

        // Reload and re-render
        await loadMenuTasks(menuId);
        await showDynamicMenuSection(menuId);
        renderDynamicOverview();
      } catch(error){
        console.error('‚ùå Error removing result:', error);
        showToast('L·ªói khi g·ª° k·∫øt qu·∫£', 'error');
      }
    }

    // ========= END NEW REFACTORED UI FUNCTIONS =========

    // ‚úÖ EXPOSE ALL NEW FUNCTIONS TO GLOBAL SCOPE
    window.openTaskResult = openTaskResult;
    window.toggleTaskComments = toggleTaskComments;
    window.toggleEditMenu = toggleEditMenu;
    window.openUpdateLinkModal = openUpdateLinkModal;
    window.updateTaskLink = updateTaskLink;
    window.confirmDeleteTask = confirmDeleteTask;
    window.deleteTask = deleteTask;
    window.submitComment = submitComment;
    window.editComment = editComment;
    window.deleteComment = deleteComment;
    window.handleCommentKeyPress = handleCommentKeyPress;
    window.handleRemoveResult = handleRemoveResult;

    // Old function exports (keep for backward compatibility)
    window.viewCompletedTask = viewCompletedTask;
    window.editCompletedTask = editCompletedTask;
    window.deleteCompletedTask = deleteCompletedTask;

    function setLayoutMode(mode){
      const cover = $('#cover-page');
      const login = $('#login-page');
      const app = $('#app-layout');
      const showCover = mode === 'cover';
      const showLogin = mode === 'login';
      const showApp = mode === 'app';

      if(cover) cover.classList.toggle('hidden', !showCover);
      if(login) login.classList.toggle('hidden', !showLogin);
      if(app) app.classList.toggle('hidden', !showApp);

      const header = $('#current-section-title');
      if(header){
        if(showCover || showLogin){
          header.textContent = '';
          header.classList.add('hidden');
        }
      }
    }

    function setActiveNavByHref(href){
      const links = $$('.nav-link');
      links.forEach(link => {
        if(href && link.getAttribute('href') === href){
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    }

    function normalizeRoutePath(pathname){
      if(!pathname) return '/';
      let normalized = pathname;
      const indexSuffix = '/index.html';
      if(normalized.endsWith(indexSuffix)){
        normalized = normalized.slice(0, -indexSuffix.length) || '/';
      }
      if(normalized.length > 1 && normalized.endsWith('/')){
        normalized = normalized.slice(0, -1);
      }
      return normalized || '/';
    }

    function createRouter(config){
      const defaultRoute = config['/'];
      function resolve(pathname){
        const normalized = normalizeRoutePath(pathname);
        console.log('üîÄ [ROUTER] Resolving path:', normalized);

        // Check static routes first
        if(config[normalized]){
          console.log('‚úÖ [ROUTER] Found static route:', normalized);
          return { path: normalized, route: config[normalized] };
        }

        // Check dynamic menu routes
        const pathWithoutSlash = normalized.startsWith('/') ? normalized.slice(1) : normalized;
        console.log('üîç [ROUTER] Checking dynamic menus for slug:', pathWithoutSlash, {
          availableMenus: dynamicMenus.length,
          slugs: dynamicMenus.map(m => m.slug || `no-slug-${m.id}`)
        });

        const dynamicMenu = dynamicMenus.find(m =>
          m.type === 'task-list' && (m.slug === pathWithoutSlash || `dynamic-menu/${m.id}` === pathWithoutSlash)
        );

        if(dynamicMenu){
          console.log('‚úÖ [ROUTER] Found dynamic menu:', {
            menuId: dynamicMenu.id,
            slug: dynamicMenu.slug,
            name: dynamicMenu.name
          });
          return {
            path: normalized,
            route: {
              layout: 'app',
              section: 'dynamic-menu',
              navHref: normalized,
              menuId: dynamicMenu.id,
              menuName: dynamicMenu.name
            }
          };
        }

        // 404 - Route not found
        console.warn('‚ö†Ô∏è [ROUTER] Route not found, redirecting to home:', normalized);
        return { path: '/', route: defaultRoute, notFound: true };
      }
      async function handle(pathname){
        const { path, route } = resolve(pathname);
        if(!route) return path;
        setLayoutMode(route.layout === 'cover' ? 'cover' : route.layout === 'login' ? 'login' : 'app');
        if(route.layout === 'app' && route.section){
          if(route.section === 'dynamic-menu' && route.menuId){
            // Show dynamic menu content (now async)
            await showDynamicMenuSection(route.menuId);
          } else {
            showSection(route.section);
          }
        }
        setActiveNavByHref(route.navHref || path);
        return path;
      }
      async function navigate(pathname){
        const { path, route } = resolve(pathname);
        if(!route) return;
        const currentPath = normalizeRoutePath(window.location.pathname);
        if(currentPath !== path){
          window.history.pushState({}, '', path);
        }
        await handle(path);
      }
      window.addEventListener('popstate', () => handle(window.location.pathname));
      return {
        navigate,
        handleCurrent: () => handle(window.location.pathname),
      };
    }

    function navigateToTask(taskId, menuId = null){
      if(!taskId) return;
      console.log('üîó [NAV] Navigating to task:', taskId, menuId ? `(menu: ${menuId})` : '');

      // Check if this is a dynamic task (from dynamic menus)
      if(taskId.startsWith('dynamic-')){
        // Extract actual task ID
        const actualTaskId = taskId.substring(8); // Remove "dynamic-" prefix

        // If menuId is provided (from activity log), use it directly
        let foundMenu = null;
        if(menuId){
          foundMenu = dynamicMenus.find(m => m.id === menuId);
          if(foundMenu){
            console.log('‚úÖ [NAV] Using provided menu ID:', menuId);
          }
        }

        // If not found or not provided, search through all menus
        if(!foundMenu){
          console.log('üîç [NAV] Searching for task in all menus...');
          for(const searchMenuId in dynamicTasks){
            const tasks = dynamicTasks[searchMenuId] || [];
            const task = tasks.find(t => t.id === actualTaskId);
            if(task){
              foundMenu = dynamicMenus.find(m => m.id === searchMenuId);
              break;
            }
          }
        }

        if(foundMenu){
          // Use the CURRENT slug from the database (Single Source of Truth)
          const targetPath = getMenuPath(foundMenu.id);
          console.log('‚úÖ [NAV] Found dynamic task in menu:', {
            menuId: foundMenu.id,
            menuName: foundMenu.name,
            currentPath: targetPath
          });

          if(router){
            router.navigate(targetPath);
          }

          // Scroll to the task card after navigation
          setTimeout(() => {
            const card = document.getElementById('dynamic-task-' + actualTaskId);
            if(card){
              card.scrollIntoView({ behavior:'smooth', block:'center' });
              card.classList.add('ring-2','ring-offset-2','ring-blue-400');
              setTimeout(() => {
                card.classList.remove('ring-2','ring-offset-2','ring-blue-400');
              }, 2000);
            } else {
              console.warn('‚ö†Ô∏è [NAV] Task card not found in DOM:', 'dynamic-task-' + actualTaskId);
            }
          }, 300); // Wait for page to render
          return;
        } else {
          console.error('‚ùå [NAV] Dynamic task not found in any menu:', actualTaskId);
          return;
        }
      }

      // Handle static tasks (legacy gd1-4 tasks)
      const meta = taskMap[taskId];
      const sectionId = meta ? meta.phase : null;
      if(sectionId){
        const targetPath = sectionToPath[sectionId] || DEFAULT_NAV_HREF;
        if(router){
          router.navigate(targetPath);
        } else {
          setActiveNavByHref(targetPath);
          showSection(sectionId);
        }
      }

      const card = document.getElementById('task-card-' + taskId);
      if(card){
        card.scrollIntoView({ behavior:'smooth', block:'center' });
        card.classList.add('ring-2','ring-offset-2','ring-blue-400');
        setTimeout(() => {
          card.classList.remove('ring-2','ring-offset-2','ring-blue-400');
        }, 2000);
      }
    }

    function bindNav(){
      $$('.nav-link').forEach(link => link.addEventListener('click', e => {
        e.preventDefault();
        const targetPath = link.getAttribute('href');
        if(router && targetPath){
          router.navigate(targetPath);
        }
        if(window.innerWidth < 1024){
          const sidebar = $('#sidebar');
          if(sidebar) sidebar.classList.remove('open');
        }
      }));
      const openBtn = $('#open-menu'), closeBtn = $('#close-menu'), sidebar = $('#sidebar');
      if(openBtn) openBtn.addEventListener('click', e => { e.stopPropagation(); if(sidebar) sidebar.classList.add('open'); });
      if(closeBtn) closeBtn.addEventListener('click', () => { if(sidebar) sidebar.classList.remove('open'); });
      document.addEventListener('click', e => {
        if(window.innerWidth < 1024 && sidebar){
          if(!sidebar.contains(e.target) && e.target !== openBtn && !(openBtn && openBtn.contains(e.target))){
            sidebar.classList.remove('open');
          }
        }
      });
    }

    function ensureProjectId(){
      return STATIC_PROJECT_ID;
    }

    async function updateProjectData(partial){
      if(!projectRef) return;
      try {
        await updateDoc(projectRef, { ...partial, updatedAt: serverTimestamp() });
      } catch(error){
        console.error('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu d·ª± √°n:', error);
      }
    }

    async function syncTaskState(){
      if(!isProjectReady) return;
      await updateProjectData({
        taskState: sanitizeTaskState(),
        activityLogs: sanitizeActivityLogs(),
      });
    }

    async function ensureProjectDocument(projectId){
      if(!projectRef) return;
      const snapshot = await getDoc(projectRef);
      if(!snapshot.exists()){
        await setDoc(projectRef, {
          taskState: buildDefaultTaskState(),
          activityLogs: [],
          notes: [],
          customTypes: defaultCustomTypes,
          selectedNoteType: defaultCustomTypes[0] || '',
          settings: defaultSettings,
          meta: {
            projectId,
            projectStart: formatDate(projectPlanStart),
            launchDate: formatDate(projectLaunchDate),
            createdAt: serverTimestamp(),
          },
          updatedAt: serverTimestamp(),
        }, { merge:true });
      } else {
        const data = snapshot.data() || {};
        const normalized = normalizeTaskState(data.taskState || {});
        const existing = data.taskState || {};
        let needsUpdate = Object.keys(existing).length !== Object.keys(normalized).length;
        if(!needsUpdate){
          needsUpdate = Object.keys(normalized).some(id => {
            const prev = existing[id] || {};
            const norm = normalized[id];
            return prev.completed !== norm.completed ||
                   (prev.link || '').trim() !== norm.link ||
                   normalizeTimestamp(prev.completedAt) !== norm.completedAt ||
                   normalizeTimestamp(prev.updatedAt) !== norm.updatedAt;
          });
        }
        const updates = {};
        if(needsUpdate){
          updates.taskState = normalized;
        }
        if(!data.settings){
          updates.settings = defaultSettings;
        }
        if(!Array.isArray(data.activityLogs)){
          updates.activityLogs = [];
        }
        if(Object.keys(updates).length > 0){
          updates.updatedAt = serverTimestamp();
          await updateDoc(projectRef, updates);
        }
      }
    }

    // ========= AUTHENTICATION & USER MANAGEMENT =========
    async function initializeAuthentication(){
      const firebaseConfig = window.FIREBASE_CONFIG;
      if(!firebaseConfig){
        console.error('Thi·∫øu c·∫•u h√¨nh Firebase.');
        return;
      }

      const app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      storage = getStorage(app);

      // Listen to auth state changes
      onAuthStateChanged(auth, async (user) => {
        if(user){
          // User is logged in
          currentUser = user;
          await loadUserData(user.uid);
          showApp();

          // Navigate to cover page after login
          const currentPath = normalizeRoutePath(window.location.pathname);
          if(currentPath === '/login'){
            setTimeout(() => {
              if(router) router.navigate('/');
            }, 100);
          } else if(router) {
            // Handle current route
            router.handleCurrent();
          }
        } else {
          // User is logged out
          currentUser = null;
          currentUserData = null;
          isAdmin = false;
          showLoginPage();
        }
      });

      // Seed default admin user (Task 10)
      await seedDefaultAdmin();
    }

    // ========= TASK 10: SEED DEFAULT ADMIN (ENHANCED) =========
    async function seedDefaultAdmin(){
      const DEFAULT_ADMIN_EMAIL = 'xuanthuongqtkd@gmail.com';
      const DEFAULT_ADMIN_PASSWORD = 'Vincent1809$$';
      const DEFAULT_ADMIN_NAME = 'Xuan Thuong';

      console.log('üîç Checking for default admin user...');

      try {
        // Step 1: Check if admin exists in Firestore
        const usersSnapshot = await getDocs(collection(db, 'users'));
        let adminFirestoreDoc = null;
        let adminExistsInFirestore = false;

        usersSnapshot.forEach(docSnap => {
          const userData = docSnap.data();
          if(userData.email === DEFAULT_ADMIN_EMAIL){
            adminExistsInFirestore = true;
            adminFirestoreDoc = { id: docSnap.id, ...userData };
          }
        });

        if(adminExistsInFirestore){
          console.log('‚úÖ Default admin user exists in Firestore.');
          console.log(`   Email: ${DEFAULT_ADMIN_EMAIL}`);
          console.log(`   Role: ${adminFirestoreDoc.role}`);
          console.log(`   Display Name: ${adminFirestoreDoc.displayName}`);
          return;
        }

        // Step 2: Admin doesn't exist in Firestore, try to create in Auth
        console.log('‚ö†Ô∏è Default admin not found in Firestore. Creating...');
        console.log(`   Email: ${DEFAULT_ADMIN_EMAIL}`);
        console.log(`   Password: Vincent1809$$ (auto-generated)`);

        let userCredential;
        try {
          // Try to create user in Firebase Auth
          userCredential = await createUserWithEmailAndPassword(auth, DEFAULT_ADMIN_EMAIL, DEFAULT_ADMIN_PASSWORD);
          console.log('‚úÖ Created user in Firebase Authentication');
        } catch(authError){
          if(authError.code === 'auth/email-already-in-use'){
            // User exists in Auth but not in Firestore - this is the problem!
            console.log('‚ö†Ô∏è User exists in Firebase Auth but not in Firestore!');
            console.log('   This causes login failures. Creating Firestore document...');

            // We need to get the UID from Firebase Auth
            // Sign in to get the user object
            try {
              userCredential = await signInWithEmailAndPassword(auth, DEFAULT_ADMIN_EMAIL, DEFAULT_ADMIN_PASSWORD);
              console.log('‚úÖ Signed in successfully to get UID');
            } catch(signInError){
              console.error('‚ùå Cannot sign in with default password:', signInError);
              console.log('üí° SOLUTION: Run resetAdminPassword() in console to reset password');
              throw signInError;
            }
          } else {
            throw authError;
          }
        }

        // Step 3: Create the user document in Firestore
        const uid = userCredential.user.uid;
        await setDoc(doc(db, 'users', uid), {
          email: DEFAULT_ADMIN_EMAIL,
          displayName: DEFAULT_ADMIN_NAME,
          role: 'admin',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        console.log('‚úÖ Default admin user created successfully!');
        console.log(`   UID: ${uid}`);
        console.log(`   Email: ${DEFAULT_ADMIN_EMAIL}`);
        console.log(`   Password: Vincent1809$$`);
        console.log(`   Role: admin`);
        console.log('');
        console.log('üéâ You can now log in with these credentials!');

      } catch(error){
        console.error('‚ùå Error seeding default admin:', error);
        console.log('');
        console.log('üìã TROUBLESHOOTING:');
        console.log('   1. Check Firebase Console > Authentication to see if user exists');
        console.log('   2. Check Firestore > users collection');
        console.log('   3. Run createAdminUser() in console to force creation');
        console.log('   4. Run resetAdminPassword() to send password reset email');
      }
    }

    // ========= CONSOLE UTILITY: FORCE CREATE ADMIN USER =========
    // Call this from console if seedDefaultAdmin fails
    window.createAdminUser = async function(){
      const DEFAULT_ADMIN_EMAIL = 'xuanthuongqtkd@gmail.com';
      const DEFAULT_ADMIN_PASSWORD = 'Vincent1809$$';
      const DEFAULT_ADMIN_NAME = 'Xuan Thuong';

      console.log('üîß FORCE CREATING admin user...');

      try {
        // Try to create in Firebase Auth
        let userCredential;
        try {
          userCredential = await createUserWithEmailAndPassword(auth, DEFAULT_ADMIN_EMAIL, DEFAULT_ADMIN_PASSWORD);
          console.log('‚úÖ Created in Firebase Auth');
        } catch(error){
          if(error.code === 'auth/email-already-in-use'){
            console.log('‚ö†Ô∏è User already exists in Auth, signing in...');
            userCredential = await signInWithEmailAndPassword(auth, DEFAULT_ADMIN_EMAIL, DEFAULT_ADMIN_PASSWORD);
          } else {
            throw error;
          }
        }

        // Create/update Firestore document
        const uid = userCredential.user.uid;
        await setDoc(doc(db, 'users', uid), {
          email: DEFAULT_ADMIN_EMAIL,
          displayName: DEFAULT_ADMIN_NAME,
          role: 'admin',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        console.log('‚úÖ Admin user created/updated successfully!');
        console.log(`   UID: ${uid}`);
        console.log(`   Email: ${DEFAULT_ADMIN_EMAIL}`);
        console.log(`   Password: Vincent1809$$`);
        console.log('');
        console.log('üéâ Try logging in now!');
        return 'Success!';

      } catch(error){
        console.error('‚ùå Error:', error);
        console.log('üí° Try resetAdminPassword() instead');
        return 'Error: ' + error.message;
      }
    };

    // ========= GLOBAL UTILITY: CREATE OWNER ACCOUNT =========
    // Global function to create the owner account (can be called from console)
    window.createOwnerAccount = async function(){
      const OWNER_EMAIL = 'xuanthuongqtkd@gmail.com';
      const OWNER_PASSWORD = 'Vincent1809$$';
      const OWNER_NAME = 'Xuan Thuong';

      console.log('üîß Creating owner account...');
      console.log(`   Email: ${OWNER_EMAIL}`);
      console.log(`   Password: ${OWNER_PASSWORD}`);

      try {
        // Try to create in Firebase Auth
        let userCredential;
        try {
          userCredential = await createUserWithEmailAndPassword(auth, OWNER_EMAIL, OWNER_PASSWORD);
          console.log('‚úÖ Created user in Firebase Authentication');
        } catch(error){
          if(error.code === 'auth/email-already-in-use'){
            console.log('‚ö†Ô∏è User already exists in Firebase Auth');
            console.log('   Attempting to sign in to get UID...');
            userCredential = await signInWithEmailAndPassword(auth, OWNER_EMAIL, OWNER_PASSWORD);
            console.log('‚úÖ Signed in successfully');
          } else {
            throw error;
          }
        }

        // Create/update Firestore document with admin role
        const uid = userCredential.user.uid;
        await setDoc(doc(db, 'users', uid), {
          email: OWNER_EMAIL,
          displayName: OWNER_NAME,
          role: 'admin',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });

        console.log('‚úÖ Created/updated user in Firestore (users collection)');
        console.log('');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('‚úÖ OWNER ACCOUNT CREATED SUCCESSFULLY!');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log(`   UID: ${uid}`);
        console.log(`   Email: ${OWNER_EMAIL}`);
        console.log(`   Password: ${OWNER_PASSWORD}`);
        console.log(`   Role: admin`);
        console.log('');
        console.log('üéâ You can now log in with these credentials!');
        console.log('');

        return {
          success: true,
          uid: uid,
          email: OWNER_EMAIL,
          message: 'Owner account created successfully!'
        };
      } catch(error){
        console.error('‚ùå Error creating owner account:', error);
        console.log('');
        console.log('üìã TROUBLESHOOTING:');
        console.log('   1. Check Firebase Console > Authentication');
        console.log('   2. Check Firestore Security Rules (see instructions below)');
        console.log('   3. Error details:', error.message);
        console.log('');

        return {
          success: false,
          error: error.message
        };
      }
    };

    // ========= CONSOLE UTILITY: RESET ADMIN PASSWORD =========
    // Call this function from browser console if you need to reset the admin password
    window.resetAdminPassword = async function(){
      const DEFAULT_ADMIN_EMAIL = 'xuanthuongqtkd@gmail.com';

      try {
        console.log('Sending password reset email to:', DEFAULT_ADMIN_EMAIL);

        const actionCodeSettings = {
          url: window.location.origin,
          handleCodeInApp: false
        };

        await sendPasswordResetEmail(auth, DEFAULT_ADMIN_EMAIL, actionCodeSettings);
        console.log('‚úÖ Password reset email sent successfully!');
        console.log('üìß Check your inbox at:', DEFAULT_ADMIN_EMAIL);
        console.log('üîó Click the link in the email to set a new password.');
        return 'Success! Check your email.';
      } catch(error){
        console.error('‚ùå Error sending password reset email:', error);
        if(error.code === 'auth/user-not-found'){
          console.log('‚ö†Ô∏è User not found. The admin account may not have been created yet.');
          console.log('üí° Refresh the page to trigger auto-creation of the default admin.');
        }
        return 'Error: ' + error.message;
      }
    };

    async function loadUserData(uid){
      try {
        const userDoc = await getDoc(doc(db, 'users', uid));
        if(userDoc.exists()){
          currentUserData = { id: uid, ...userDoc.data() };
          isAdmin = currentUserData.role === 'admin';

          // Update sidebar user profile
          const sidebarUserNameEl = $('#sidebar-current-user-name');
          const sidebarUserRoleEl = $('#sidebar-current-user-role');
          const sidebarLogoutBtn = $('#sidebar-logout-btn');

          if(sidebarUserNameEl) sidebarUserNameEl.textContent = currentUserData.displayName || currentUserData.email;
          if(sidebarUserRoleEl) sidebarUserRoleEl.textContent = isAdmin ? 'Admin' : 'Employee';
          if(sidebarLogoutBtn) sidebarLogoutBtn.classList.remove('hidden');

          // Show/hide admin sections
          const adminNavSection = $('#admin-nav-section');

          if(isAdmin){
            if(adminNavSection) adminNavSection.classList.remove('hidden');
          } else {
            if(adminNavSection) adminNavSection.classList.add('hidden');
          }

          // Render user's avatar
          renderAvatar(currentUserData.avatarUrl || '');

          // Initialize dynamic data
          await initializeRealtimePersistence();
          await loadUsers();
          await loadDynamicMenus();
          await loadAssignees();
        } else {
          // User not found in database, sign out
          await signOut(auth);
          showToast('Ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng', 'error');
        }
      } catch(error){
        console.error('Error loading user data:', error);
        await signOut(auth);
      }
    }

    function showLoginPage(){
      $('#cover-page')?.classList.add('hidden');
      $('#login-page')?.classList.remove('hidden');
      $('#app-layout')?.classList.add('hidden');
    }

    function showCoverPage(){
      $('#cover-page')?.classList.remove('hidden');
      $('#login-page')?.classList.add('hidden');
      $('#app-layout')?.classList.add('hidden');
    }

    function showApp(){
      $('#cover-page')?.classList.add('hidden');
      $('#login-page')?.classList.add('hidden');
      $('#app-layout')?.classList.remove('hidden');
    }

    async function handleLogin(e){
      e.preventDefault();
      const email = $('#login-email').value.trim();
      const password = $('#login-password').value;
      const errorEl = $('#login-error');
      const loginBtn = $('#login-btn');

      if(!email || !password){
        errorEl.textContent = 'Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u';
        errorEl.classList.remove('hidden');
        return;
      }

      try {
        loginBtn.disabled = true;
        loginBtn.textContent = 'ƒêang ƒëƒÉng nh·∫≠p...';
        errorEl.classList.add('hidden');

        await signInWithEmailAndPassword(auth, email, password);
        // Show success message
        showToast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng', 'success');
        // Auth state listener will handle showing the app and redirecting to dashboard
      } catch(error){
        console.error('‚ùå Login error:', error);
        console.log('Error code:', error.code);
        console.log('Error message:', error.message);

        let errorMessage = 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i';
        let consoleTroubleshooting = '';

        if(error.code === 'auth/user-not-found'){
          errorMessage = 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng';
          consoleTroubleshooting = 'üí° SOLUTION: Run createAdminUser() in console to create the default admin user\n   Email: xuanthuongqtkd@gmail.com\n   Password: Vincent1809$$';
        } else if(error.code === 'auth/wrong-password'){
          errorMessage = 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng';
          consoleTroubleshooting = 'üí° SOLUTION: Run resetAdminPassword() in console to reset your password\n   Or click "Forgot Password?" link';
        } else if(error.code === 'auth/invalid-email'){
          errorMessage = 'Email kh√¥ng h·ª£p l·ªá';
          consoleTroubleshooting = 'üí° Check email format';
        } else if(error.code === 'auth/too-many-requests'){
          errorMessage = 'Qu√° nhi·ªÅu l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i sau';
          consoleTroubleshooting = 'üí° Wait a few minutes, or click "Forgot Password?" to reset';
        } else if(error.code === 'auth/network-request-failed'){
          errorMessage = 'L·ªói k·∫øt n·ªëi m·∫°ng';
          consoleTroubleshooting = 'üí° Check your internet connection';
        } else {
          consoleTroubleshooting = 'üí° Unknown error. Check Firebase Console > Authentication';
        }

        console.log('');
        console.log('üìã TROUBLESHOOTING:');
        console.log(consoleTroubleshooting);

        errorEl.textContent = errorMessage;
        errorEl.classList.remove('hidden');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'ƒêƒÉng Nh·∫≠p';
      }
    }

    async function handleLogout(){
      try {
        await signOut(auth);
        showToast('ƒê√£ ƒëƒÉng xu·∫•t', 'success');
      } catch(error){
        console.error('Logout error:', error);
        showToast('L·ªói ƒëƒÉng xu·∫•t', 'error');
      }
    }

    // ========= TASK 11: CHANGE PASSWORD =========
    async function handleChangePassword(e){
      e.preventDefault();

      const currentPassword = $('#current-password').value;
      const newPassword = $('#new-password').value;
      const confirmPassword = $('#confirm-new-password').value;
      const errorEl = $('#change-password-error');
      const successEl = $('#change-password-success');
      const submitBtn = $('#change-password-btn');

      // Hide previous messages
      errorEl.classList.add('hidden');
      successEl.classList.add('hidden');

      // Validate passwords match
      if(newPassword !== confirmPassword){
        errorEl.textContent = 'M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n kh√¥ng kh·ªõp';
        errorEl.classList.remove('hidden');
        return;
      }

      // Validate password length
      if(newPassword.length < 6){
        errorEl.textContent = 'M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±';
        errorEl.classList.remove('hidden');
        return;
      }

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ƒêang ƒë·ªïi m·∫≠t kh·∫©u...';

        // Reauthenticate user with current password
        const credential = EmailAuthProvider.credential(
          currentUser.email,
          currentPassword
        );

        await reauthenticateWithCredential(currentUser, credential);

        // Update to new password
        await updatePassword(currentUser, newPassword);

        // Success
        successEl.textContent = 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!';
        successEl.classList.remove('hidden');
        showToast('M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success');

        // Clear form
        $('#change-password-form').reset();

      } catch(error){
        console.error('Change password error:', error);
        let errorMessage = 'L·ªói khi ƒë·ªïi m·∫≠t kh·∫©u';

        if(error.code === 'auth/wrong-password'){
          errorMessage = 'M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng';
        } else if(error.code === 'auth/weak-password'){
          errorMessage = 'M·∫≠t kh·∫©u m·ªõi qu√° y·∫øu';
        } else if(error.code === 'auth/requires-recent-login'){
          errorMessage = 'Vui l√≤ng ƒëƒÉng xu·∫•t v√† ƒëƒÉng nh·∫≠p l·∫°i tr∆∞·ªõc khi ƒë·ªïi m·∫≠t kh·∫©u';
        }

        errorEl.textContent = errorMessage;
        errorEl.classList.remove('hidden');
        showToast(errorMessage, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'üîí ƒê·ªïi M·∫≠t Kh·∫©u';
      }
    }

    // ========= TASK 12 & 14: FORGOT PASSWORD & EMAIL CONFIGURATION =========
    //
    // ‚ö†Ô∏è IMPORTANT NOTE ABOUT TASK 14 (Nodemailer/Gmail):
    // ====================================================
    // This is a CLIENT-SIDE ONLY application (pure HTML/JavaScript).
    // Nodemailer is a NODE.JS SERVER-SIDE library and CANNOT be used here.
    //
    // Using Nodemailer would require:
    // 1. Creating a separate Node.js backend server
    // 2. Deploying it to a hosting service (Vercel, Railway, etc.)
    // 3. Creating API endpoints for password reset
    // 4. Storing GMAIL_USER and GMAIL_APP_PASSWORD on the server
    // 5. Completely rewriting the authentication architecture
    //
    // RECOMMENDED SOLUTION: Use Firebase Authentication's built-in email system
    // =========================================================================
    //
    // üìß HOW TO CONFIGURE FIREBASE AUTH EMAILS (TASK 14 ALTERNATIVE):
    //
    // STEP 1: Go to Firebase Console
    // - Navigate to: https://console.firebase.google.com/
    // - Select your project
    // - Go to "Authentication" > "Templates" tab
    //
    // STEP 2: Customize Email Templates
    // - Click "Password reset" template
    // - Edit the email subject and body
    // - Customize the sender name (e.g., "Xuan Thuong" or your company name)
    //
    // STEP 3: Enable Email Provider
    // - Go to "Authentication" > "Sign-in method"
    // - Make sure "Email/Password" is ENABLED
    //
    // STEP 4: (OPTIONAL) Custom Email Domain
    // - For emails from xuanthuongqtkd@gmail.com instead of noreply@*.firebaseapp.com:
    // - Upgrade to Firebase Blaze plan (pay-as-you-go)
    // - Go to "Authentication" > "Templates"
    // - Click "Customize action URL"
    // - Set up custom SMTP (requires domain ownership verification)
    //
    // DEFAULT BEHAVIOR:
    // - Emails sent from: noreply@<your-project-id>.firebaseapp.com
    // - Subject: "Reset your password"
    // - Contains a link to reset password
    //
    // üîß TROUBLESHOOTING "Error sending email":
    // ========================================
    // 1. Check Firebase Console > Authentication > Sign-in method
    //    ‚Üí Make sure Email/Password is ENABLED
    //
    // 2. Check Firebase Console > Authentication > Users
    //    ‚Üí Verify the user exists (xuanthuongqtkd@gmail.com)
    //
    // 3. Check browser console for detailed error codes:
    //    - auth/user-not-found: User doesn't exist (run createAdminUser())
    //    - auth/invalid-email: Email format is wrong
    //    - auth/too-many-requests: Rate limited, wait a few minutes
    //
    // 4. Check your Firebase project quota:
    //    ‚Üí Free plan: 100 emails/day limit
    //    ‚Üí If exceeded, upgrade to Blaze plan or wait 24 hours
    //
    // 5. Verify Firebase SDK is initialized correctly:
    //    ‚Üí Check window.FIREBASE_CONFIG is set
    //    ‚Üí Check browser console for initialization errors
    //
    // üìù ENVIRONMENT VARIABLES (For server-side implementation only):
    // ===============================================================
    // If you decide to build a Node.js backend in the future, use:
    // - GMAIL_USER: Your Gmail address (e.g., xuanthuongqtkd@gmail.com)
    // - GMAIL_APP_PASSWORD: 16-character app password from Google
    //   (Generate at: https://myaccount.google.com/apppasswords)
    //
    // But for THIS client-side app, Firebase Auth handles everything automatically.
    //
    async function handleForgotPassword(e){
      e.preventDefault();

      const email = $('#forgot-password-email').value.trim();
      const errorEl = $('#forgot-password-error');
      const successEl = $('#forgot-password-success');
      const submitBtn = $('#forgot-password-btn');

      if(!email){
        errorEl.textContent = 'Vui l√≤ng nh·∫≠p email';
        errorEl.classList.remove('hidden');
        return;
      }

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ƒêang g·ª≠i...';
        errorEl.classList.add('hidden');
        successEl.classList.add('hidden');

        // Action code settings for email customization
        const actionCodeSettings = {
          // URL you want to redirect back to after password reset
          url: window.location.origin,
          handleCodeInApp: false
        };

        await sendPasswordResetEmail(auth, email, actionCodeSettings);

        successEl.textContent = 'Email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c g·ª≠i! Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞ c·ªßa b·∫°n.';
        successEl.classList.remove('hidden');
        showToast('ƒê√£ g·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u', 'success');

        // Clear form
        $('#forgot-password-email').value = '';

        // Optionally close modal after a delay
        setTimeout(() => {
          $('#forgot-password-modal').classList.remove('active');
        }, 3000);

      } catch(error){
        console.error('‚ùå Forgot password error:', error);
        console.log('Error code:', error.code);
        console.log('Error message:', error.message);

        let errorMessage = 'L·ªói khi g·ª≠i email';
        let consoleTroubleshooting = '';

        if(error.code === 'auth/user-not-found'){
          errorMessage = 'Email kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng';
          consoleTroubleshooting = 'üí° SOLUTION: Run createAdminUser() in console to create the admin user';
        } else if(error.code === 'auth/invalid-email'){
          errorMessage = 'Email kh√¥ng h·ª£p l·ªá';
          consoleTroubleshooting = 'üí° Check email format';
        } else if(error.code === 'auth/too-many-requests'){
          errorMessage = 'Qu√° nhi·ªÅu y√™u c·∫ßu. Vui l√≤ng th·ª≠ l·∫°i sau';
          consoleTroubleshooting = 'üí° Wait a few minutes before trying again';
        } else if(error.code === 'auth/network-request-failed'){
          errorMessage = 'L·ªói k·∫øt n·ªëi m·∫°ng';
          consoleTroubleshooting = 'üí° Check your internet connection';
        } else if(error.code === 'auth/invalid-api-key'){
          errorMessage = 'L·ªói c·∫•u h√¨nh Firebase';
          consoleTroubleshooting = 'üí° Check Firebase configuration in window.FIREBASE_CONFIG';
        } else {
          consoleTroubleshooting = 'üí° Check Firebase Console > Authentication > Sign-in method\n   Make sure Email/Password is ENABLED';
        }

        console.log('');
        console.log('üìã TROUBLESHOOTING:');
        console.log(consoleTroubleshooting);
        console.log('   Or check the detailed documentation above handleForgotPassword()');

        errorEl.textContent = errorMessage;
        errorEl.classList.remove('hidden');
        showToast(errorMessage, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'G·ª≠i Email ƒê·∫∑t L·∫°i';
      }
    }

    // User Management Functions
    async function loadUsers(){
      if(!isAdmin) return;

      try {
        const usersSnapshot = await getDocs(collection(db, 'users'));
        allUsers = [];
        usersSnapshot.forEach(doc => {
          allUsers.push({ id: doc.id, ...doc.data() });
        });
        renderUsersTable();
      } catch(error){
        console.error('Error loading users:', error);
      }
    }

    function renderUsersTable(){
      const tbody = $('#users-table-body');
      if(!tbody) return;

      if(allUsers.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o</td></tr>';
        return;
      }

      tbody.innerHTML = allUsers.map(user => `
        <tr>
          <td>${user.email}</td>
          <td>${user.displayName || '-'}</td>
          <td>
            <span class="inline-block px-2 py-1 text-xs font-semibold rounded ${user.role === 'admin' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
              ${user.role === 'admin' ? 'Admin' : 'Employee'}
            </span>
          </td>
          <td>${user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : '-'}</td>
          <td class="text-center">
            <button onclick="editUser('${user.id}')" class="text-blue-600 hover:underline text-sm mr-2">S·ª≠a</button>
            ${user.id !== currentUser.uid ? `<button onclick="deleteUser('${user.id}')" class="text-red-600 hover:underline text-sm">X√≥a</button>` : ''}
          </td>
        </tr>
      `).join('');
    }

    async function showAddUserModal(){
      if(!checkAdminPermission()) return;

      currentEditingUserId = null;
      $('#user-modal-title').textContent = 'Th√™m Ng∆∞·ªùi D√πng';
      $('#user-email').value = '';
      $('#user-email').disabled = false;
      $('#user-display-name').value = '';
      $('#user-password').value = '';
      $('#user-password').parentElement.classList.remove('hidden');
      $('#user-role').value = 'employee';
      $('#user-error-message').classList.add('hidden');
      $('#user-error-message').textContent = '';
      $('#user-modal').classList.add('active');
    }

    async function editUser(userId){
      const user = allUsers.find(u => u.id === userId);
      if(!user) return;

      currentEditingUserId = userId;
      $('#user-modal-title').textContent = 'Ch·ªânh S·ª≠a Ng∆∞·ªùi D√πng';
      $('#user-email').value = user.email;
      $('#user-email').disabled = true;
      $('#user-display-name').value = user.displayName || '';
      $('#user-password').parentElement.classList.add('hidden'); // Hide password field when editing
      $('#user-role').value = user.role;
      $('#user-error-message').classList.add('hidden');
      $('#user-modal').classList.add('active');
    }

    async function handleUserFormSubmit(e){
      e.preventDefault();

      const email = $('#user-email').value.trim();
      const displayName = $('#user-display-name').value.trim();
      const password = $('#user-password').value;
      const role = $('#user-role').value;
      const errorEl = $('#user-error-message');
      const submitBtn = $('#user-submit-btn');

      // Clear previous errors
      errorEl.classList.add('hidden');
      errorEl.textContent = '';

      try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ƒêang l∆∞u...';

        if(currentEditingUserId){
          // Update existing user
          await updateDoc(doc(db, 'users', currentEditingUserId), {
            displayName,
            role,
            updatedAt: serverTimestamp()
          });
          showToast('C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng th√†nh c√¥ng', 'success');
          $('#user-modal').classList.remove('active');
          await loadUsers();
        } else {
          // Create new user - validate password first
          if(!password || password.length < 6){
            throw new Error('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±');
          }

          // Save admin email for re-login
          const adminEmail = currentUserData.email;

          // Create auth user (this will automatically sign in the new user)
          let userCredential;
          let newUserId;
          try {
            userCredential = await createUserWithEmailAndPassword(auth, email, password);
            newUserId = userCredential.user.uid;
          } catch(authError){
            // If auth creation fails, throw with clear message
            throw authError;
          }

          // Add to Firestore (we're now signed in as the new user)
          try {
            await setDoc(doc(db, 'users', newUserId), {
              email,
              displayName,
              role,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
          } catch(firestoreError){
            // Firestore creation failed - auth user exists but Firestore doc doesn't
            await signOut(auth);
            throw new Error(`‚ö†Ô∏è T√†i kho·∫£n ƒë√£ t·∫°o trong Firebase Auth nh∆∞ng l∆∞u th√¥ng tin th·∫•t b·∫°i.\n\nEmail: ${email}\nB·∫°n c·∫ßn x√≥a user n√†y trong Firebase Console > Authentication.\n\nL·ªói: ${firestoreError.message}`);
          }

          // User created successfully - sign out the new user
          await signOut(auth);

          // Show success message and prompt admin to log back in
          showToast('‚úÖ Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'success');
          $('#user-modal').classList.remove('active');

          // Pre-fill admin email on login page for convenience
          setTimeout(() => {
            const loginEmailInput = $('#login-email');
            if(loginEmailInput) loginEmailInput.value = adminEmail;
          }, 100);
        }
      } catch(error){
        console.error('Error saving user:', error);
        let errorMessage = 'L·ªói khi l∆∞u ng∆∞·ªùi d√πng';

        // Handle specific error codes
        if(error.code === 'auth/email-already-in-use'){
          errorMessage = 'Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng. Vui l√≤ng ch·ªçn email kh√°c.';
        } else if(error.code === 'auth/invalid-email'){
          errorMessage = 'Email kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.';
        } else if(error.code === 'auth/weak-password'){
          errorMessage = 'M·∫≠t kh·∫©u qu√° y·∫øu. Vui l√≤ng ch·ªçn m·∫≠t kh·∫©u m·∫°nh h∆°n.';
        } else if(error.code === 'auth/wrong-password'){
          errorMessage = 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng ƒë√∫ng.';
        } else if(error.message){
          errorMessage = error.message;
        }

        // Display error in modal and keep it open
        errorEl.textContent = errorMessage;
        errorEl.classList.remove('hidden');
        showToast(errorMessage, 'error');

        // Do NOT close the modal - let user correct the error
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'L∆∞u';
      }
    }

    let userToDelete = null;
    async function deleteUser(userId){
      userToDelete = userId;
      $('#delete-user-modal').classList.add('active');
    }

    async function confirmDeleteUser(){
      if(!userToDelete) return;

      try {
        // Note: This only deletes from Firestore, not from Auth
        // To delete from Auth, you would need Cloud Functions or Admin SDK
        await deleteDoc(doc(db, 'users', userToDelete));
        showToast('X√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng', 'success');
        $('#delete-user-modal').classList.remove('active');
        await loadUsers();
        userToDelete = null;
      } catch(error){
        console.error('Error deleting user:', error);
        showToast('L·ªói khi x√≥a ng∆∞·ªùi d√πng', 'error');
      }
    }

    function checkAdminPermission(){
      if(!isAdmin){
        showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán h√†nh ƒë·ªông n√†y', 'error');
        return false;
      }
      return true;
    }

    // ========= MENU MANAGEMENT =========
    async function loadDynamicMenus(){
      if(!db) return;
      try {
        const projectId = ensureProjectId();
        const menusRef = collection(db, 'projects', projectId, 'menus');

        // Use real-time listener instead of one-time fetch
        console.log('üì° [MENU SYNC] Setting up real-time menu listener');
        onSnapshot(query(menusRef, orderBy('order')), snapshot => {
          const oldMenuSlugs = dynamicMenus.map(m => m.slug || m.id).join(',');
          dynamicMenus = [];
          snapshot.forEach(doc => {
            dynamicMenus.push({ id: doc.id, ...doc.data() });
          });
          const newMenuSlugs = dynamicMenus.map(m => m.slug || m.id).join(',');

          console.log('üì° [MENU SYNC] Menus updated:', {
            count: dynamicMenus.length,
            slugs: dynamicMenus.map(m => m.slug || m.id),
            changed: oldMenuSlugs !== newMenuSlugs
          });

          // Re-render sidebar and overview when menus change
          renderDynamicMenus();
          renderSidebarDynamic();
          renderDynamicOverview();

          // If we're on a dynamic menu page and slug changed, re-route
          if(router && window.location.pathname !== '/' && window.location.pathname !== '/login'){
            const currentPath = window.location.pathname;
            console.log('üì° [MENU SYNC] Re-evaluating current route:', currentPath);
            router.handleCurrent();
          }
        }, error => {
          console.error('‚ùå [MENU SYNC] Error listening to menus:', error);
        });
      } catch(error){
        console.error('‚ùå [MENU SYNC] Error setting up menu listener:', error);
      }
    }

    // ========= DYNAMIC OVERVIEW (TASK 5) =========
    function renderDynamicOverview(){
      const container = $('#phase-progress-container');
      if(!container) return;

      // Calculate progress for each dynamic menu
      const colors = ['blue', 'green', 'yellow', 'red', 'purple', 'indigo', 'pink', 'orange'];
      let html = '';

      dynamicMenus.forEach((menu, index) => {
        if(menu.type !== 'task-list') return;

        const tasks = dynamicTasks[menu.id] || [];
        const total = tasks.length;
        const completed = tasks.filter(t => t.completed).length;
        const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
        const color = colors[index % colors.length];

        html += `
          <div>
            <div class="flex justify-between mb-1.5">
              <span class="text-sm font-medium text-${color}-700">${escapeHtml(menu.icon || 'üìã')} ${escapeHtml(menu.name)}</span>
              <span class="text-sm font-medium text-${color}-700">${completed} / ${total} (${percent}%)</span>
            </div>
            <div class="progress-bar">
              <div class="progress-bar-inner bg-${color}-600" style="width:${percent}%"></div>
            </div>
          </div>
        `;
      });

      if(html) {
        container.innerHTML = html;
      } else {
        container.innerHTML = '<p class="text-sm text-gray-500">Ch∆∞a c√≥ giai ƒëo·∫°n n√†o. Th√™m menu trong Qu·∫£n L√Ω K·∫ø Ho·∫°ch.</p>';
      }

      // Also update total progress
      updateTotalProgress();
    }

    function updateTotalProgress(){
      let totalTasks = 0;
      let completedTasks = 0;

      dynamicMenus.forEach(menu => {
        if(menu.type === 'task-list'){
          const tasks = dynamicTasks[menu.id] || [];
          totalTasks += tasks.length;
          completedTasks += tasks.filter(t => t.completed).length;
        }
      });

      const percent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

      const progressText = $('#total-progress-text');
      const progressPercent = $('#total-progress-percent');
      const progressBar = $('#total-progress-bar');

      if(progressText) progressText.textContent = `${completedTasks} / ${totalTasks} Tasks`;
      if(progressPercent) progressPercent.textContent = `${percent}%`;
      if(progressBar) progressBar.style.width = `${percent}%`;
    }

    async function renderDynamicMenus(){
      const container = $('#menus-container');
      const noMenusMessage = $('#no-menus-message');
      if(!container) return;

      if(dynamicMenus.length === 0){
        container.innerHTML = '';
        if(noMenusMessage) noMenusMessage.classList.remove('hidden');
        return;
      }

      if(noMenusMessage) noMenusMessage.classList.add('hidden');

      container.innerHTML = dynamicMenus.map((menu, index) => `
        <div class="menu-item" draggable="${isAdmin}" data-menu-id="${menu.id}" data-order="${menu.order}">
          <div class="menu-item-header">
            <div class="menu-item-left">
              ${isAdmin ? '<span class="drag-handle">‚ò∞</span>' : ''}
              <span class="menu-item-icon">${menu.icon}</span>
              <div>
                <div class="menu-item-name">${menu.name}</div>
                <span class="menu-item-type">${menu.type === 'external-link' ? 'External Link' : 'Task List'}</span>
                ${menu.type === 'external-link' ? `<div class="text-xs text-gray-500 mt-1">${menu.link}</div>` : ''}
              </div>
            </div>
            <div class="menu-item-actions">
              ${menu.type === 'task-list' ? `
                <button class="menu-item-btn" onclick="toggleMenuTasks('${menu.id}')">
                  <span id="toggle-icon-${menu.id}">‚ñº</span> Tasks
                </button>
              ` : ''}
              ${isAdmin ? `
                ${menu.type === 'task-list' ? `<button class="menu-item-btn" onclick="showAddTaskModal('${menu.id}')">+ Task</button>` : ''}
                <button class="menu-item-btn" onclick="editMenu('${menu.id}')">‚úèÔ∏è S·ª≠a</button>
                <button class="menu-item-btn danger" onclick="deleteMenu('${menu.id}')">üóëÔ∏è X√≥a</button>
              ` : ''}
            </div>
          </div>
          ${menu.type === 'task-list' ? `
            <div class="tasks-list" id="tasks-${menu.id}">
              <div id="tasks-loading-${menu.id}" class="text-sm text-gray-500">ƒêang t·∫£i tasks...</div>
            </div>
          ` : ''}
        </div>
      `).join('');

      // Setup drag and drop if admin
      if(isAdmin){
        setupMenuDragAndDrop();
      }

      // Load tasks for each task-list menu
      for(const menu of dynamicMenus){
        if(menu.type === 'task-list'){
          await loadMenuTasks(menu.id);
        }
      }

      // Restore expanded state for menus that were previously expanded
      expandedMenus.forEach(menuId => {
        const container = $(`#tasks-${menuId}`);
        const icon = $(`#toggle-icon-${menuId}`);
        if(container){
          container.classList.add('expanded');
          if(icon) icon.textContent = '‚ñ≤';
        }
      });
    }

    async function showAddMenuModal(){
      if(!checkAdminPermission()) return;

      currentEditingMenuId = null;
      $('#menu-modal-title').textContent = 'Th√™m Menu M·ªõi';
      $('#menu-name').value = '';
      $('#menu-icon').value = '';
      $('#menu-type').value = 'task-list';
      $('#menu-slug').value = '';
      $('#menu-link').value = '';
      $('#menu-slug-field').classList.remove('hidden');
      $('#menu-link-field').classList.add('hidden');
      $('#menu-error-message').classList.add('hidden');
      $('#menu-modal').classList.add('active');
    }

    async function editMenu(menuId){
      if(!checkAdminPermission()) return;

      const menu = dynamicMenus.find(m => m.id === menuId);
      if(!menu) return;

      currentEditingMenuId = menuId;
      $('#menu-modal-title').textContent = 'Ch·ªânh S·ª≠a Menu';
      $('#menu-name').value = menu.name;
      $('#menu-icon').value = menu.icon;
      $('#menu-type').value = menu.type;
      $('#menu-slug').value = menu.slug || '';
      $('#menu-link').value = menu.link || '';

      if(menu.type === 'external-link'){
        $('#menu-slug-field').classList.add('hidden');
        $('#menu-link-field').classList.remove('hidden');
      } else {
        $('#menu-slug-field').classList.remove('hidden');
        $('#menu-link-field').classList.add('hidden');
      }

      $('#menu-error-message').classList.add('hidden');
      $('#menu-modal').classList.add('active');
    }

    async function handleMenuFormSubmit(e){
      e.preventDefault();
      if(!checkAdminPermission()) return;

      const name = $('#menu-name').value.trim();
      const icon = $('#menu-icon').value.trim();
      const type = $('#menu-type').value;
      const slug = $('#menu-slug').value.trim().toLowerCase();
      const link = $('#menu-link').value.trim();
      const errorEl = $('#menu-error-message');
      const submitBtn = $('#menu-submit-btn');

      if(!name || !icon){
        errorEl.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin';
        errorEl.classList.remove('hidden');
        return;
      }

      if(type === 'task-list' && slug){
        // Validate slug format
        if(!/^[a-z0-9\-]+$/.test(slug)){
          errorEl.textContent = 'URL Slug ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ th∆∞·ªùng, s·ªë v√† d·∫•u g·∫°ch ngang';
          errorEl.classList.remove('hidden');
          return;
        }

        // ‚úÖ FIX ISSUE 1: Enhanced slug validation with Firestore check
        try {
          const projectId = ensureProjectId();
          const menusRef = collection(db, 'projects', projectId, 'menus');

          // Get current menu data if editing
          let currentMenuSlug = null;
          if(currentEditingMenuId){
            const currentMenu = dynamicMenus.find(m => m.id === currentEditingMenuId);
            currentMenuSlug = currentMenu?.slug;
            console.log('üîç [SLUG UPDATE] Current menu:', {
              id: currentEditingMenuId,
              oldSlug: currentMenuSlug,
              newSlug: slug
            });
          }

          // Skip validation if slug hasn't changed
          if(currentEditingMenuId && currentMenuSlug === slug){
            console.log('‚úÖ [SLUG UPDATE] Slug unchanged, skipping validation');
          } else {
            // Query Firestore directly to check for duplicate slugs
            const slugQuery = query(menusRef, where('slug', '==', slug));
            const slugSnapshot = await getDocs(slugQuery);

            // Check if slug exists on a DIFFERENT menu
            const conflictingMenus = [];
            slugSnapshot.forEach(doc => {
              if(doc.id !== currentEditingMenuId){
                conflictingMenus.push({ id: doc.id, ...doc.data() });
              }
            });

            if(conflictingMenus.length > 0){
              console.error('‚ùå [SLUG UPDATE] Slug conflict detected:', conflictingMenus);
              errorEl.textContent = `URL Slug "${slug}" ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi menu "${conflictingMenus[0].name}". Vui l√≤ng ch·ªçn slug kh√°c.`;
              errorEl.classList.remove('hidden');
              return;
            }

            console.log('‚úÖ [SLUG UPDATE] No conflicts found, slug is available');
          }
        } catch(validationError){
          console.error('‚ùå [SLUG UPDATE] Validation error:', validationError);
          errorEl.textContent = 'L·ªói khi ki·ªÉm tra slug. Vui l√≤ng th·ª≠ l·∫°i.';
          errorEl.classList.remove('hidden');
          return;
        }

        // Check if slug conflicts with reserved routes
        const reservedSlugs = ['tongquan', 'ghichu', 'quan-ly-ke-hoach', 'cai-dat', 'login', 'giaidoan1', 'giaidoan2', 'giaidoan3', 'giaidoan4'];
        if(reservedSlugs.includes(slug)){
          errorEl.textContent = 'URL Slug n√†y ƒë√£ ƒë∆∞·ª£c h·ªá th·ªëng s·ª≠ d·ª•ng. Vui l√≤ng ch·ªçn slug kh√°c.';
          errorEl.classList.remove('hidden');
          return;
        }
      }

      if(type === 'external-link' && !link){
        errorEl.textContent = 'Vui l√≤ng nh·∫≠p URL cho External Link';
        errorEl.classList.remove('hidden');
        return;
      }

      try {
        submitBtn.disabled = true;
        errorEl.classList.add('hidden');

        const projectId = ensureProjectId();
        const menuData = {
          name,
          icon,
          type,
          slug: type === 'task-list' ? (slug || null) : null,
          link: type === 'external-link' ? link : null,
          updatedAt: serverTimestamp()
        };

        if(currentEditingMenuId){
          // Update existing menu
          console.log('üìù [MENU UPDATE] Updating menu:', currentEditingMenuId, menuData);
          await updateDoc(doc(db, 'projects', projectId, 'menus', currentEditingMenuId), menuData);
          showToast('C·∫≠p nh·∫≠t menu th√†nh c√¥ng', 'success');

          // ‚úÖ Force router refresh to update slug routes
          console.log('üîÑ [MENU UPDATE] Forcing router refresh...');
          setTimeout(() => {
            if(router){
              router.handleCurrent();
            }
          }, 500);
        } else {
          // Create new menu
          const maxOrder = dynamicMenus.length > 0 ? Math.max(...dynamicMenus.map(m => m.order || 0)) : 0;
          menuData.order = maxOrder + 1;
          menuData.createdAt = serverTimestamp();

          console.log('‚ûï [MENU CREATE] Creating new menu:', menuData);
          await addDoc(collection(db, 'projects', projectId, 'menus'), menuData);
          showToast('Th√™m menu th√†nh c√¥ng', 'success');
        }

        $('#menu-modal').classList.remove('active');
        await loadDynamicMenus();
      } catch(error){
        console.error('‚ùå [MENU SAVE] Error saving menu:', error);
        errorEl.textContent = 'L·ªói khi l∆∞u menu: ' + (error.message || 'Unknown error');
        errorEl.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
      }
    }

    let menuToDelete = null;
    async function deleteMenu(menuId){
      if(!checkAdminPermission()) return;

      menuToDelete = menuId;
      $('#delete-menu-modal').classList.add('active');
    }

    async function confirmDeleteMenu(){
      if(!menuToDelete || !checkAdminPermission()) return;

      try {
        const projectId = ensureProjectId();

        // Delete all tasks in this menu first
        const tasksSnapshot = await getDocs(collection(db, 'projects', projectId, 'menus', menuToDelete, 'tasks'));
        const batch = writeBatch(db);
        tasksSnapshot.forEach(taskDoc => {
          batch.delete(taskDoc.ref);
        });
        await batch.commit();

        // Delete the menu
        await deleteDoc(doc(db, 'projects', projectId, 'menus', menuToDelete));

        showToast('X√≥a menu th√†nh c√¥ng', 'success');
        $('#delete-menu-modal').classList.remove('active');
        await loadDynamicMenus();
        menuToDelete = null;
      } catch(error){
        console.error('Error deleting menu:', error);
        showToast('L·ªói khi x√≥a menu', 'error');
      }
    }

    function setupMenuDragAndDrop(){
      const menuItems = $$('.menu-item');
      let draggedItem = null;

      menuItems.forEach(item => {
        item.addEventListener('dragstart', (e) => {
          draggedItem = item;
          item.classList.add('dragging');
        });

        item.addEventListener('dragend', (e) => {
          item.classList.remove('dragging');
        });

        item.addEventListener('dragover', (e) => {
          e.preventDefault();
          const afterElement = getDragAfterElement(e.clientY);
          const container = $('#menus-container');
          if(afterElement == null){
            container.appendChild(draggedItem);
          } else {
            container.insertBefore(draggedItem, afterElement);
          }
        });

        item.addEventListener('drop', async (e) => {
          e.preventDefault();
          await saveMenuOrder();
        });
      });
    }

    function getDragAfterElement(y){
      const draggableElements = [...$$('.menu-item:not(.dragging)')];

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;

        if(offset < 0 && offset > closest.offset){
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    async function saveMenuOrder(){
      if(!checkAdminPermission()) return;

      try {
        const projectId = ensureProjectId();
        const menuItems = $$('.menu-item');
        const batch = writeBatch(db);

        menuItems.forEach((item, index) => {
          const menuId = item.dataset.menuId;
          const menuRef = doc(db, 'projects', projectId, 'menus', menuId);
          batch.update(menuRef, { order: index + 1 });
        });

        await batch.commit();
        showToast('C·∫≠p nh·∫≠t th·ª© t·ª± th√†nh c√¥ng', 'success');
        await loadDynamicMenus();
      } catch(error){
        console.error('Error saving menu order:', error);
        showToast('L·ªói khi l∆∞u th·ª© t·ª±', 'error');
      }
    }

    // ========= TASK MANAGEMENT =========
    async function loadMenuTasks(menuId){
      if(!db) return;

      try {
        const projectId = ensureProjectId();
        const tasksSnapshot = await getDocs(query(
          collection(db, 'projects', projectId, 'menus', menuId, 'tasks'),
          orderBy('order')
        ));

        const tasks = [];
        tasksSnapshot.forEach(doc => {
          tasks.push({ id: doc.id, menuId, ...doc.data() });
        });

        dynamicTasks[menuId] = tasks;
        renderMenuTasks(menuId);
        renderDynamicOverview(); // Update overview when tasks change (Task 5)
      } catch(error){
        console.error('Error loading tasks:', error);
        const container = $(`#tasks-${menuId}`);
        if(container){
          container.innerHTML = '<p class="text-sm text-red-500">L·ªói t·∫£i tasks</p>';
        }
      }
    }

    function renderMenuTasks(menuId){
      const container = $(`#tasks-${menuId}`);
      if(!container) return;

      const tasks = dynamicTasks[menuId] || [];

      if(tasks.length === 0){
        container.innerHTML = '<p class="text-sm text-gray-500 py-2">Ch∆∞a c√≥ task n√†o</p>';
        return;
      }

      container.innerHTML = tasks.map(task => {
        const assignee = assignees.find(a => a.id === task.assigneeId);
        const assigneeName = assignee ? assignee.name : 'Ch∆∞a g√°n';

        // Calculate deadline countdown
        let deadlineHtml = '';
        if(task.endDate){
          const endDateFormatted = formatDateFromISO(task.endDate);
          const deadlineInfo = evaluateDeadline(endDateFormatted, task.completed);
          const deadlineClass = deadlineInfo ? deadlineInfo.className : '';
          const deadlineText = deadlineInfo && deadlineInfo.text ? ` <strong class="${deadlineClass}" style="font-weight: 700;">(${deadlineInfo.text})</strong>` : '';
          deadlineHtml = endDateFormatted + deadlineText;
        } else {
          deadlineHtml = 'Ch∆∞a ƒë·∫∑t';
        }

        return `
          <div class="task-item">
            <div class="task-item-header">
              <div class="task-item-title">${task.name}</div>
              <div class="task-item-actions">
                ${isAdmin ? `
                  <button class="task-item-btn" onclick="editTask('${menuId}', '${task.id}')">‚úèÔ∏è</button>
                  <button class="task-item-btn danger" onclick="deletePlanTask('${menuId}', '${task.id}')">üóëÔ∏è</button>
                ` : ''}
              </div>
            </div>
            <div class="task-item-meta">
              ${task.description ? `<div class="mb-1" style="white-space: pre-wrap;">${task.description}</div>` : ''}
              ${task.startDate ? `<div>üìÖ Ng√†y b·∫Øt ƒë·∫ßu: ${formatDateFromISO(task.startDate)}</div>` : ''}
              <div>üìÖ Ng√†y k·∫øt th√∫c: ${deadlineHtml}</div>
              <div>üë§ Ph·ª• tr√°ch: ${assigneeName}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleMenuTasks(menuId){
      const container = $(`#tasks-${menuId}`);
      const icon = $(`#toggle-icon-${menuId}`);

      if(!container) return;

      const targetId = `tasks-${menuId}`;
      const wasExpanded = container.classList.contains('expanded');

      $$('.tasks-list').forEach(list => {
        if(list.id !== targetId){
          list.classList.remove('expanded');
          const otherIcon = $(`#toggle-icon-${list.id.replace('tasks-','')}`);
          if(otherIcon) otherIcon.textContent = '‚ñº';
        }
      });

      expandedMenus.clear();

      if(wasExpanded){
        container.classList.remove('expanded');
        if(icon) icon.textContent = '‚ñº';
      } else {
        container.classList.add('expanded');
        expandedMenus.add(menuId);
        if(icon) icon.textContent = '‚ñ≤';
      }
    }

    async function showAddTaskModal(menuId){
      if(!checkAdminPermission()) return;

      currentMenuIdForTask = menuId;
      currentEditingTaskId = null;

      $('#task-modal-title').textContent = 'Th√™m Task M·ªõi';
      $('#task-name').value = '';
      $('#task-description').value = '';
      $('#task-start-date').value = '';
      $('#task-end-date').value = '';
      $('#task-assignee').value = '';
      $('#task-error-message').classList.add('hidden');

      populateAssigneeDropdown();
      $('#task-modal').classList.add('active');
    }

    async function editTask(menuId, taskId){
      if(!checkAdminPermission()) return;

      const tasks = dynamicTasks[menuId] || [];
      const task = tasks.find(t => t.id === taskId);
      if(!task) return;

      currentMenuIdForTask = menuId;
      currentEditingTaskId = taskId;

      $('#task-modal-title').textContent = 'Ch·ªânh S·ª≠a Task';
      $('#task-name').value = task.name;
      $('#task-description').value = task.description || '';
      $('#task-start-date').value = task.startDate || '';
      $('#task-end-date').value = task.endDate || '';
      $('#task-assignee').value = task.assigneeId || '';
      $('#task-error-message').classList.add('hidden');

      populateAssigneeDropdown();
      $('#task-modal').classList.add('active');
    }

    async function handleTaskFormSubmit(e){
      e.preventDefault();
      if(!checkAdminPermission()) return;

      const name = $('#task-name').value.trim();
      const description = $('#task-description').value.trim();
      const startDate = $('#task-start-date').value;
      const endDate = $('#task-end-date').value;
      const assigneeId = $('#task-assignee').value;
      const errorEl = $('#task-error-message');
      const submitBtn = $('#task-submit-btn');

      if(!name || !endDate || !assigneeId){
        errorEl.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc';
        errorEl.classList.remove('hidden');
        return;
      }

      try {
        submitBtn.disabled = true;
        errorEl.classList.add('hidden');

        const projectId = ensureProjectId();
        const taskData = {
          name,
          description,
          startDate,
          endDate,
          assigneeId,
          updatedAt: serverTimestamp()
        };

        if(currentEditingTaskId){
          // Update
          await updateDoc(doc(db, 'projects', projectId, 'menus', currentMenuIdForTask, 'tasks', currentEditingTaskId), taskData);
          showToast('C·∫≠p nh·∫≠t task th√†nh c√¥ng', 'success');
        } else {
          // Create
          const existingTasks = dynamicTasks[currentMenuIdForTask] || [];
          const maxOrder = existingTasks.length > 0 ? Math.max(...existingTasks.map(t => t.order || 0)) : 0;
          taskData.order = maxOrder + 1;
          taskData.createdAt = serverTimestamp();

          await addDoc(collection(db, 'projects', projectId, 'menus', currentMenuIdForTask, 'tasks'), taskData);
          showToast('Th√™m task th√†nh c√¥ng', 'success');
        }

        $('#task-modal').classList.remove('active');
        await loadMenuTasks(currentMenuIdForTask);
        await renderDynamicMenus();
      } catch(error){
        console.error('Error saving task:', error);
        errorEl.textContent = 'L·ªói khi l∆∞u task';
        errorEl.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
      }
    }

    let taskToDelete = { menuId: null, taskId: null };
    async function deletePlanTask(menuId, taskId){
      if(!checkAdminPermission()) return;

      taskToDelete = { menuId, taskId };
      $('#delete-plan-task-modal').classList.add('active');
    }

    async function confirmDeletePlanTask(){
      if(!taskToDelete.menuId || !taskToDelete.taskId || !checkAdminPermission()) return;

      try {
        const projectId = ensureProjectId();
        await deleteDoc(doc(db, 'projects', projectId, 'menus', taskToDelete.menuId, 'tasks', taskToDelete.taskId));

        showToast('X√≥a task th√†nh c√¥ng', 'success');
        $('#delete-plan-task-modal').classList.remove('active');
        await loadMenuTasks(taskToDelete.menuId);
        await renderDynamicMenus();
        taskToDelete = { menuId: null, taskId: null };
      } catch(error){
        console.error('Error deleting task:', error);
        showToast('L·ªói khi x√≥a task', 'error');
      }
    }

    function formatDateFromISO(isoDate){
      if(!isoDate) return '';
      const date = new Date(isoDate);
      return formatDate(date);
    }

    function renderSidebarDynamic(){
      const nav = $('#main-navigation');
      if(!nav) return;

      // Keep Overview at the top
      let html = '<a class="nav-link" href="/tongquan"><span class="emoji">üìä</span><span>T·ªïng Quan</span></a>';

      // Add dynamic menus
      dynamicMenus.forEach(menu => {
        if(menu.type === 'task-list'){
          // Use slug if available, otherwise fall back to /dynamic-menu/{id}
          const menuPath = menu.slug ? `/${menu.slug}` : `/dynamic-menu/${menu.id}`;
          html += `<a class="nav-link" href="${menuPath}"><span class="emoji">${menu.icon}</span><span>${menu.name}</span></a>`;
        } else if(menu.type === 'external-link'){
          html += `<a class="nav-link" href="${menu.link}" target="_blank" rel="noopener noreferrer"><span class="emoji">${menu.icon}</span><span>${menu.name} ‚Üó</span></a>`;
        }
      });

      // Keep Notes and Admin sections at the bottom
      html += '<a class="nav-link" href="/ghichu"><span class="emoji">üìù</span><span>Ghi Ch√∫ D·ª± √Ån</span></a>';

      // Admin-only sections
      if(isAdmin){
        html += `
          <div class="border-t border-gray-300 pt-2 mt-2">
            <a class="nav-link" href="/quan-ly-nguoi-dung" id="nav-user-management"><span class="emoji">üë•</span><span>Qu·∫£n L√Ω Ng∆∞·ªùi D√πng</span></a>
            <a class="nav-link" href="/quan-ly-ke-hoach" id="nav-plan-manager"><span class="emoji">üóÇÔ∏è</span><span>Qu·∫£n L√Ω K·∫ø Ho·∫°ch</span></a>
            <a class="nav-link" href="/cai-dat"><span class="emoji">üîß</span><span>C√†i ƒê·∫∑t</span></a>
          </div>
        `;
      } else {
        html += '<a class="nav-link" href="/cai-dat"><span class="emoji">üîß</span><span>C√†i ƒê·∫∑t</span></a>';
      }

      nav.innerHTML = html;

      // Re-bind navigation
      bindNav();
      // Set active nav based on current route
      if(router) setActiveNavByHref(window.location.pathname);
    }

    // ========= DATA MIGRATION (IDEMPOTENT) =========
    async function migrateStaticData(){
      if(!checkAdminPermission()) return;

      if(!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën migrate d·ªØ li·ªáu tƒ©nh sang Firestore?\n\nH√†nh ƒë·ªông n√†y s·∫Ω:\n1. T·∫°o 4 menus (Gƒê 1-4) - n·∫øu ch∆∞a c√≥\n2. Migrate 60+ tasks hi·ªán c√≥ - n·∫øu ch∆∞a c√≥\n3. T·∫°o c√°c assignees (BOD, Marketing, v.v.) - n·∫øu ch∆∞a c√≥\n\nH√†m n√†y an to√†n ƒë·ªÉ ch·∫°y nhi·ªÅu l·∫ßn (idempotent).')){
        return;
      }

      try {
        showToast('ƒêang b·∫Øt ƒë·∫ßu migration...', 'success');

        const projectId = ensureProjectId();

        // Step 1: Create assignees (only if they don't exist)
        const uniqueOwners = new Set();
        tasksData.forEach(task => {
          if(task.owner){
            task.owner.split(',').forEach(owner => {
              uniqueOwners.add(owner.trim());
            });
          }
        });

        // Check existing assignees
        await loadAssignees();
        const existingAssigneeNames = new Set(assignees.map(a => a.name));

        const batch = writeBatch(db);
        let newAssigneesCount = 0;
        const assigneeMap = {};

        for(const ownerName of uniqueOwners){
          const existing = assignees.find(a => a.name === ownerName);
          if(existing){
            assigneeMap[ownerName] = existing.id;
          } else {
            // Create new assignee
            const assigneeRef = doc(collection(db, 'projects', projectId, 'assignees'));
            batch.set(assigneeRef, {
              name: ownerName,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            assigneeMap[ownerName] = assigneeRef.id;
            newAssigneesCount++;
          }
        }

        if(newAssigneesCount > 0){
          await batch.commit();
          showToast(`ƒê√£ t·∫°o ${newAssigneesCount} assignees m·ªõi...`, 'success');
          // Reload assignees to get IDs
          await loadAssignees();
        } else {
          showToast('T·∫•t c·∫£ assignees ƒë√£ t·ªìn t·∫°i, b·ªè qua...', 'success');
        }

        // Step 2: Create menus for each phase (only if they don't exist)
        const phaseMenus = [
          { phase: 'gd1', name: 'Gƒê 1: N·ªÅn T·∫£ng', icon: 'üéØ', slug: 'giaidoan1', order: 1 },
          { phase: 'gd2', name: 'Gƒê 2: X√¢y D·ª±ng', icon: 'üèóÔ∏è', slug: 'giaidoan2', order: 2 },
          { phase: 'gd3', name: 'Gƒê 3: V·∫≠n H√†nh & T·ªëi ∆Øu', icon: '‚öôÔ∏è', slug: 'giaidoan3', order: 3 },
          { phase: 'gd4', name: 'Gƒê 4: Ra M·∫Øt', icon: 'üöÄ', slug: 'giaidoan4', order: 4 }
        ];

        // Check existing menus
        await loadDynamicMenus();
        const existingMenuNames = new Set(dynamicMenus.map(m => m.name));

        const menuMap = {};
        let newMenusCount = 0;

        for(const phaseMenu of phaseMenus){
          const existing = dynamicMenus.find(m => m.name === phaseMenu.name);
          if(existing){
            menuMap[phaseMenu.phase] = existing.id;
          } else {
            // Create new menu
            const menuRef = await addDoc(collection(db, 'projects', projectId, 'menus'), {
              name: phaseMenu.name,
              icon: phaseMenu.icon,
              type: 'task-list',
              slug: phaseMenu.slug,
              link: null,
              order: phaseMenu.order,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            });
            menuMap[phaseMenu.phase] = menuRef.id;
            newMenusCount++;
          }
        }

        if(newMenusCount > 0){
          showToast(`ƒê√£ t·∫°o ${newMenusCount} menus m·ªõi...`, 'success');
          // Reload menus
          await loadDynamicMenus();
        } else {
          showToast('T·∫•t c·∫£ menus ƒë√£ t·ªìn t·∫°i, b·ªè qua...', 'success');
        }

        // Step 3: Migrate tasks (only if they don't exist)
        let migratedCount = 0;
        let skippedCount = 0;

        for(const task of tasksData){
          const menuId = menuMap[task.phase];
          if(!menuId) continue;

          // Load existing tasks for this menu
          await loadMenuTasks(menuId);
          const existingTasks = dynamicTasks[menuId] || [];

          // Check if task already exists (by name)
          const taskExists = existingTasks.some(t => t.name === task.title);
          if(taskExists){
            skippedCount++;
            continue;
          }

          // Find assignee ID
          let assigneeId = '';
          if(task.owner && assignees.length > 0){
            const ownerName = task.owner.split(',')[0].trim();
            const assignee = assignees.find(a => a.name === ownerName);
            if(assignee) assigneeId = assignee.id;
          }

          // Parse deadline to ISO date
          let endDate = '';
          if(task.deadline){
            const parts = task.deadline.split('/');
            if(parts.length === 3){
              endDate = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
            }
          }

          // Create description from details
          const description = task.details ? task.details.join('\n') : '';

          await addDoc(collection(db, 'projects', projectId, 'menus', menuId, 'tasks'), {
            name: task.title,
            description,
            startDate: '',
            endDate,
            assigneeId,
            order: parseInt(task.id.split('.')[1]) || 0,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });

          migratedCount++;
        }

        // Show summary
        let summaryMessage = `Migration ho√†n t·∫•t!\n`;
        summaryMessage += `- ƒê√£ t·∫°o ${migratedCount} tasks m·ªõi\n`;
        if(skippedCount > 0){
          summaryMessage += `- ƒê√£ b·ªè qua ${skippedCount} tasks (ƒë√£ t·ªìn t·∫°i)`;
        }
        showToast(summaryMessage, 'success');

        console.log('üìä MIGRATION SUMMARY:');
        console.log(`   ‚úÖ Assignees: ${newAssigneesCount} m·ªõi, ${assignees.length - newAssigneesCount} ƒë√£ t·ªìn t·∫°i`);
        console.log(`   ‚úÖ Menus: ${newMenusCount} m·ªõi, ${dynamicMenus.length - newMenusCount} ƒë√£ t·ªìn t·∫°i`);
        console.log(`   ‚úÖ Tasks: ${migratedCount} m·ªõi, ${skippedCount} ƒë√£ t·ªìn t·∫°i`);
        console.log('   üéâ Migration an to√†n - c√≥ th·ªÉ ch·∫°y l·∫°i b·∫•t c·ª© l√∫c n√†o!');

        // Reload all data
        await loadDynamicMenus();
        await loadAssignees();

      } catch(error){
        console.error('Migration error:', error);
        showToast('L·ªói khi migration: ' + error.message, 'error');
      }
    }

    // ========= ASSIGNEE MANAGEMENT =========
    async function loadAssignees(){
      if(!db) return;
      try {
        const assigneesSnapshot = await getDocs(collection(db, 'projects', ensureProjectId(), 'assignees'));
        assignees = [];
        assigneesSnapshot.forEach(doc => {
          assignees.push({ id: doc.id, ...doc.data() });
        });
        renderAssigneesList();
        populateAssigneeDropdown();
      } catch(error){
        console.error('Error loading assignees:', error);
      }
    }

    function renderAssigneesList(){
      const container = $('#assignees-list');
      if(!container) return;

      if(assignees.length === 0){
        container.innerHTML = '<p class="text-sm text-gray-500">Ch∆∞a c√≥ ph·ª• tr√°ch n√†o. Nh·∫•n "Th√™m Ph·ª• Tr√°ch" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>';
        return;
      }

      container.innerHTML = assignees.map(assignee => `
        <div class="assignee-chip">
          <span>${assignee.name}</span>
          ${isAdmin ? `<button onclick="deleteAssignee('${assignee.id}')" title="X√≥a">&times;</button>` : ''}
        </div>
      `).join('');
    }

    function populateAssigneeDropdown(){
      const dropdown = $('#task-assignee');
      if(!dropdown) return;

      const currentValue = dropdown.value;

      dropdown.innerHTML = '<option value="">-- Ch·ªçn ph·ª• tr√°ch --</option>' +
        assignees.map(a => `<option value="${a.id}">${a.name}</option>`).join('');

      if(currentValue) dropdown.value = currentValue;
    }

    async function showAddAssigneeModal(){
      if(!checkAdminPermission()) return;

      currentEditingAssigneeId = null;
      $('#assignee-name').value = '';
      $('#assignee-error-message').classList.add('hidden');
      $('#assignee-modal').classList.add('active');
    }

    async function handleAssigneeFormSubmit(e){
      e.preventDefault();
      if(!checkAdminPermission()) return;

      const name = $('#assignee-name').value.trim();
      const errorEl = $('#assignee-error-message');
      const submitBtn = $('#assignee-submit-btn');

      if(!name){
        errorEl.textContent = 'Vui l√≤ng nh·∫≠p t√™n ph·ª• tr√°ch';
        errorEl.classList.remove('hidden');
        return;
      }

      try {
        submitBtn.disabled = true;
        errorEl.classList.add('hidden');

        const projectId = ensureProjectId();

        await addDoc(collection(db, 'projects', projectId, 'assignees'), {
          name,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        showToast('Th√™m ph·ª• tr√°ch th√†nh c√¥ng', 'success');
        $('#assignee-modal').classList.remove('active');
        await loadAssignees();
      } catch(error){
        console.error('Error saving assignee:', error);
        errorEl.textContent = 'L·ªói khi l∆∞u ph·ª• tr√°ch';
        errorEl.classList.remove('hidden');
      } finally {
        submitBtn.disabled = false;
      }
    }

    let assigneeToDelete = null;
    async function deleteAssignee(assigneeId){
      if(!checkAdminPermission()) return;

      assigneeToDelete = assigneeId;
      $('#delete-assignee-modal').classList.add('active');
    }

    async function confirmDeleteAssignee(){
      if(!assigneeToDelete || !checkAdminPermission()) return;

      try {
        const projectId = ensureProjectId();
        await deleteDoc(doc(db, 'projects', projectId, 'assignees', assigneeToDelete));
        showToast('X√≥a ph·ª• tr√°ch th√†nh c√¥ng', 'success');
        $('#delete-assignee-modal').classList.remove('active');
        await loadAssignees();
        assigneeToDelete = null;
      } catch(error){
        console.error('Error deleting assignee:', error);
        showToast('L·ªói khi x√≥a ph·ª• tr√°ch', 'error');
      }
    }

    async function initializeRealtimePersistence(){
      // Firebase already initialized in initializeAuthentication
      if(!db || !storage){
        console.error('Firebase not initialized');
        return;
      }

      const projectId = ensureProjectId();
      projectRef = doc(db, 'projects', projectId);
      await ensureProjectDocument(projectId);

      onSnapshot(projectRef, snapshot => {
        console.log('üî• [FIRESTORE] Snapshot received');
        if(!snapshot.exists()){
          console.warn('‚ö†Ô∏è [FIRESTORE] Project document does not exist');
          return;
        }
        const data = snapshot.data() || {};
        console.log('üî• [FIRESTORE] Project data loaded:', {
          hasTaskState: !!data.taskState,
          taskStateKeys: data.taskState ? Object.keys(data.taskState).length : 0,
          hasSettings: !!data.settings
        });

        if(!isProjectReady){
          notifications = [];
          notificationState = {};
          notificationsInitialized = false;
        }
        taskState = normalizeTaskState(data.taskState || {});
        console.log('üî• [FIRESTORE] taskState after normalize:', taskState);

        activityLogs = normalizeActivityLogs(data.activityLogs || []);
        notes = Array.isArray(data.notes) ? data.notes.map(note => ({ ...note })) : [];
        customTypes = Array.isArray(data.customTypes) && data.customTypes.length ? data.customTypes.slice(0,10) : defaultCustomTypes.slice();
        if(customTypes.length === 0) customTypes = defaultCustomTypes.slice();
        selectedNoteType = data.selectedNoteType && customTypes.includes(data.selectedNoteType) ? data.selectedNoteType : (customTypes[0] || '');
        filteredNotes = notes.slice();
        currentSettings = { ...defaultSettings, ...(data.settings || {}) };
        isProjectReady = true;
        debouncedSyncTaskState = debounce(syncTaskState, 400);
        renderNoteTypeDropdown();
        updateTypeFilterOptions();
        applyFilters();
        renderCoverPage(currentSettings);
        renderSidebar(currentSettings);
        renderLoginPage(currentSettings);
        applyFavicon(currentSettings.faviconUrl || '');
        renderAvatar(currentSettings.avatarUrl || '');
        populateSettingsForm(currentSettings);
        console.log('üî• [FIRESTORE] Calling updateUI() to refresh task display');
        updateUI();
        updateShareLink();
      }, error => {
        console.error('L·ªói ƒë·ªìng b·ªô d·ªØ li·ªáu th·ªùi gian th·ª±c:', error);
      });
    }

    // ========= MODALS WIRING =========
    if(confirmDeleteTaskBtn) confirmDeleteTaskBtn.addEventListener('click', confirmDeleteTask);
    if(cancelDeleteTaskBtn) cancelDeleteTaskBtn.addEventListener('click', cancelDeleteTask);
    if(btnEditLinkOption) btnEditLinkOption.addEventListener('click', showEditLinkModal);
    if(btnDeleteResultOption) btnDeleteResultOption.addEventListener('click', showDeleteResultModal);
    if(cancelEditOptionsBtn) cancelEditOptionsBtn.addEventListener('click', cancelEditOptions);
    if(confirmEditLinkBtn) confirmEditLinkBtn.addEventListener('click', confirmEditLink);
    if(cancelEditLinkBtn) cancelEditLinkBtn.addEventListener('click', cancelEditLink);
    if(confirmDeleteNoteBtn) confirmDeleteNoteBtn.addEventListener('click', confirmDeleteNote);
    if(cancelDeleteNoteBtn) cancelDeleteNoteBtn.addEventListener('click', cancelDeleteNote);
    const deleteTaskModalEl = $('#delete-task-modal');
    const editOptionsModalEl = $('#edit-options-modal');
    const editLinkModalEl = $('#edit-link-modal');
    const deleteNoteModalEl = $('#delete-note-modal');
    if(deleteTaskModalEl) deleteTaskModalEl.addEventListener('click', e => { if(e.target === deleteTaskModalEl) cancelDeleteTask(); });
    if(editOptionsModalEl) editOptionsModalEl.addEventListener('click', e => { if(e.target === editOptionsModalEl) cancelEditOptions(); });
    if(editLinkModalEl) editLinkModalEl.addEventListener('click', e => { if(e.target === editLinkModalEl) cancelEditLink(); });
    if(deleteNoteModalEl) deleteNoteModalEl.addEventListener('click', e => { if(e.target === deleteNoteModalEl) cancelDeleteNote(); });
    if(noteModalCloseBtn) noteModalCloseBtn.addEventListener('click', e => { e.preventDefault(); closeNoteDetailModal(); });
    if(noteDetailModal) noteDetailModal.addEventListener('click', e => { if(e.target === noteDetailModal) closeNoteDetailModal(); });
    document.addEventListener('keydown', e => { if(e.key === 'Escape') { closeNoteDetailModal(); cancelEditOptions(); cancelEditLink(); } });

    // ========= BOOT =========
    console.log('üöÄ [BOOT] Starting application boot sequence');
    router = createRouter(routeConfig);
    console.log('üöÄ [BOOT] Rendering tasks...');
    renderTasks();
    console.log('üöÄ [BOOT] Binding task events...');
    bindTaskEvents();
    bindNav();
    initChart();
    console.log('üöÄ [BOOT] Calling initial updateUI() (before Firestore data loads)');
    updateUI();

    filteredNotes = notes.slice();
    renderNotes();
    renderNoteStatistics();
    renderNoteTypeDropdown();
    bindNoteTypeDropdown();
    updateTypeFilterOptions();
    renderCoverPage(currentSettings);
    renderSidebar(currentSettings);
    applyFavicon(currentSettings.faviconUrl || '');
    renderAvatar(currentSettings.avatarUrl || '');
    populateSettingsForm(currentSettings);

    if(router) router.handleCurrent();

    selectedTimeFilter = 'all';
    toggleCustomDateInputs();
    applyFilters();

    const startPlanBtn = $('#start-plan-btn');
    if(startPlanBtn) startPlanBtn.addEventListener('click', e => {
      e.preventDefault();
      if(router) router.navigate('/tongquan');
    });

    ['#cover-logo-link', '#sidebar-logo-link'].forEach(sel => {
      const link = $(sel);
      if(link){
        link.addEventListener('click', e => {
          e.preventDefault();
          if(router) router.navigate('/');
          if(window.innerWidth < 1024){
            const sidebarEl = $('#sidebar');
            if(sidebarEl) sidebarEl.classList.remove('open');
          }
        });
      }
    });

    const saveNoteBtn = $('#save-note-btn'); if(saveNoteBtn) saveNoteBtn.addEventListener('click', saveNewNote);
    const resetFilterBtn = $('#reset-filter-btn'); if(resetFilterBtn) resetFilterBtn.addEventListener('click', e => { e.preventDefault(); resetFilters(); });
    const filterTypeSelect = $('#filter-type'); if(filterTypeSelect) filterTypeSelect.addEventListener('change', applyFilters);
    const filterTimeSelect = $('#filter-time');
    if(filterTimeSelect){
      filterTimeSelect.addEventListener('change', () => {
        selectedTimeFilter = filterTimeSelect.value || 'all';
        toggleCustomDateInputs();
        applyFilters();
      });
    }
    const keywordInputEl = $('#filter-keyword');
    if(keywordInputEl){
      const triggerKeywordFilter = debounce(() => applyFilters(), 250);
      keywordInputEl.addEventListener('input', () => {
        const value = keywordInputEl.value.trim();
        if(value.length === 0 || value.length >= 4){
          triggerKeywordFilter();
        }
      });
    }
    const filterDateFrom = $('#filter-date-from'); if(filterDateFrom) filterDateFrom.addEventListener('change', () => { if(selectedTimeFilter === 'custom') applyFilters(); });
    const filterDateTo = $('#filter-date-to'); if(filterDateTo) filterDateTo.addEventListener('change', () => { if(selectedTimeFilter === 'custom') applyFilters(); });
    const saveSettingsBtn = $('#save-settings-btn'); if(saveSettingsBtn) saveSettingsBtn.addEventListener('click', async e => { e.preventDefault(); await saveSettings(); });
    const logoUploadInput = $('#setting-logo-upload');
    const logoDefaultWrapper = $('#setting-logo-default');
    const logoActiveWrapper = $('#setting-logo-active');
    const logoFilenameLabel = $('#setting-logo-filename');
    const logoSelectedLabel = $('#setting-logo-selected-name');
    const logoPreviewEl = $('#logo-preview');
    const logoChooseBtn = $('#setting-logo-choose');
    const logoChangeBtn = $('#setting-logo-change');
    const logoRemoveBtn = $('#setting-logo-remove');
    const faviconUploadInput = $('#setting-favicon-upload');
    const faviconDefaultWrapper = $('#setting-favicon-default');
    const faviconActiveWrapper = $('#setting-favicon-active');
    const faviconFilenameLabel = $('#setting-favicon-filename');
    const faviconSelectedLabel = $('#setting-favicon-selected-name');
    const faviconPreviewEl = $('#favicon-preview');
    const faviconChooseBtn = $('#setting-favicon-choose');
    const faviconChangeBtn = $('#setting-favicon-change');
    const faviconRemoveBtn = $('#setting-favicon-remove');
    const coverImageUploadInput = $('#setting-cover-image-upload');
    const coverImageDefaultWrapper = $('#setting-cover-image-default');
    const coverImageActiveWrapper = $('#setting-cover-image-active');
    const coverImageFilenameLabel = $('#setting-cover-image-filename');
    const coverImageSelectedLabel = $('#setting-cover-image-selected-name');
    const coverImagePreviewEl = $('#cover-image-preview');
    const coverImageChooseBtn = $('#setting-cover-image-choose');
    const coverImageChangeBtn = $('#setting-cover-image-change');
    const coverImageRemoveBtn = $('#setting-cover-image-remove');
    const avatarUploadInput = $('#setting-avatar-upload');
    const avatarDefaultWrapper = $('#setting-avatar-default');
    const avatarActiveWrapper = $('#setting-avatar-active');
    const avatarFilenameLabel = $('#setting-avatar-filename');
    const avatarSelectedLabel = $('#setting-avatar-selected-name');
    const avatarPreviewEl = $('#avatar-preview');
    const avatarChooseBtn = $('#setting-avatar-choose');
    const avatarChangeBtn = $('#setting-avatar-change');
    const avatarRemoveBtn = $('#setting-avatar-remove');
    const loginBgUploadInput = $('#setting-login-bg-upload');
    const loginBgDefaultWrapper = $('#setting-login-bg-default');
    const loginBgActiveWrapper = $('#setting-login-bg-active');
    const loginBgFilenameLabel = $('#setting-login-bg-filename');
    const loginBgSelectedLabel = $('#setting-login-bg-selected-name');
    const loginBgPreviewEl = $('#login-bg-preview');
    const loginBgChooseBtn = $('#setting-login-bg-choose');
    const loginBgChangeBtn = $('#setting-login-bg-change');
    const loginBgRemoveBtn = $('#setting-login-bg-remove');
    const coverColorInput = $('#setting-cover-color');
    const computePreviewSettings = (extra = {}) => {
      const previewSettings = { ...currentSettings };
      if(pendingFileRemovals.logo){
        previewSettings.logoUrl = '';
      } else if(logoUploadInput && logoUploadInput.files && logoUploadInput.files[0] && logoPreviewEl && logoPreviewEl.src){
        previewSettings.logoUrl = logoPreviewEl.src;
      }
      if(pendingFileRemovals.coverImage){
        previewSettings.coverImageUrl = '';
      } else if(coverImageUploadInput && coverImageUploadInput.files && coverImageUploadInput.files[0] && coverImagePreviewEl && coverImagePreviewEl.src){
        previewSettings.coverImageUrl = coverImagePreviewEl.src;
      }
      if(pendingFileRemovals.loginBg){
        previewSettings.loginBgUrl = '';
      } else if(loginBgUploadInput && loginBgUploadInput.files && loginBgUploadInput.files[0] && loginBgPreviewEl && loginBgPreviewEl.src){
        previewSettings.loginBgUrl = loginBgPreviewEl.src;
      }
      return { ...previewSettings, ...extra };
    };
    const getPreviewCoverColor = () => (coverColorInput ? coverColorInput.value || '' : currentSettings.coverColor || '');
    logoFileControl = createSettingsFileControl({
      key: 'logo',
      input: logoUploadInput,
      defaultWrapper: logoDefaultWrapper,
      activeWrapper: logoActiveWrapper,
      defaultLabel: logoFilenameLabel,
      selectedLabel: logoSelectedLabel,
      preview: logoPreviewEl,
      chooseBtn: logoChooseBtn,
      changeBtn: logoChangeBtn,
      removeBtn: logoRemoveBtn,
      onPreviewChange: () => {
        renderCoverPage(computePreviewSettings({ coverColor: getPreviewCoverColor() }));
        renderSidebar(computePreviewSettings());
        renderLoginPage(computePreviewSettings());
      },
    });
    faviconFileControl = createSettingsFileControl({
      key: 'favicon',
      input: faviconUploadInput,
      defaultWrapper: faviconDefaultWrapper,
      activeWrapper: faviconActiveWrapper,
      defaultLabel: faviconFilenameLabel,
      selectedLabel: faviconSelectedLabel,
      preview: faviconPreviewEl,
      chooseBtn: faviconChooseBtn,
      changeBtn: faviconChangeBtn,
      removeBtn: faviconRemoveBtn,
      onPreviewChange: value => {
        applyFavicon(value || '');
      },
    });
    coverImageFileControl = createSettingsFileControl({
      key: 'coverImage',
      input: coverImageUploadInput,
      defaultWrapper: coverImageDefaultWrapper,
      activeWrapper: coverImageActiveWrapper,
      defaultLabel: coverImageFilenameLabel,
      selectedLabel: coverImageSelectedLabel,
      preview: coverImagePreviewEl,
      chooseBtn: coverImageChooseBtn,
      changeBtn: coverImageChangeBtn,
      removeBtn: coverImageRemoveBtn,
      onPreviewChange: () => {
        renderCoverPage(computePreviewSettings({ coverColor: getPreviewCoverColor() }));
      },
    });
    avatarFileControl = createSettingsFileControl({
      key: 'avatar',
      input: avatarUploadInput,
      defaultWrapper: avatarDefaultWrapper,
      activeWrapper: avatarActiveWrapper,
      defaultLabel: avatarFilenameLabel,
      selectedLabel: avatarSelectedLabel,
      preview: avatarPreviewEl,
      chooseBtn: avatarChooseBtn,
      changeBtn: avatarChangeBtn,
      removeBtn: avatarRemoveBtn,
      onPreviewChange: (value) => {
        renderAvatar(value || '');
      },
    });
    loginBgFileControl = createSettingsFileControl({
      key: 'loginBg',
      input: loginBgUploadInput,
      defaultWrapper: loginBgDefaultWrapper,
      activeWrapper: loginBgActiveWrapper,
      defaultLabel: loginBgFilenameLabel,
      selectedLabel: loginBgSelectedLabel,
      preview: loginBgPreviewEl,
      chooseBtn: loginBgChooseBtn,
      changeBtn: loginBgChangeBtn,
      removeBtn: loginBgRemoveBtn,
      onPreviewChange: () => {
        renderLoginPage(computePreviewSettings());
      },
    });
    if(coverColorInput){
      coverColorInput.addEventListener('input', () => {
        renderCoverPage(computePreviewSettings({ coverColor: getPreviewCoverColor() }));
      });
    }
    const activityLogToggleBtn = $('#activity-log-toggle'); if(activityLogToggleBtn) activityLogToggleBtn.addEventListener('click', () => { activityLogShowAll = true; renderActivityLog(); });
    const activityLogBody = $('#activity-log-body'); if(activityLogBody) activityLogBody.addEventListener('click', e => {
      const trigger = e.target.closest('[data-jump-task]');
      if(trigger){
        e.preventDefault();
        const taskId = trigger.getAttribute('data-jump-task');
        const menuId = trigger.getAttribute('data-menu-id');
        navigateToTask(taskId, menuId);
      }
    });
    const notificationBell = $('#notification-bell');
    const notificationDropdown = $('#notification-dropdown');
    if(notificationBell && notificationDropdown){
      notificationBell.addEventListener('click', e => {
        e.preventDefault();
        const isOpen = notificationDropdown.classList.toggle('show');
        notificationDropdown.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
        notificationBell.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      });
    }
    const notificationList = $('#notification-list');
    if(notificationList){
      notificationList.addEventListener('click', e => {
        const item = e.target.closest('[data-notification-index]');
        if(!item) return;
        const index = parseInt(item.getAttribute('data-notification-index'), 10);
        if(isNaN(index) || index < 0 || index >= notifications.length) return;
        const notification = notifications[index];
        if(!notification) return;
        if(!notification.read){
          notification.read = true;
          renderNotifications();
        }
        if(notification.taskId){
          navigateToTask(notification.taskId);
        }
        closeNotificationDropdown();
      });
    }
    document.addEventListener('click', e => {
      if(!notificationDropdown || !notificationBell) return;
      if(!notificationDropdown.classList.contains('show')) return;
      if(notificationDropdown.contains(e.target) || notificationBell.contains(e.target)) return;
      closeNotificationDropdown();
    });
    document.addEventListener('keydown', e => {
      if(e.key === 'Escape') closeNotificationDropdown();
    });

    renderNotifications();

    // ========= AUTH & USER MANAGEMENT EVENT LISTENERS =========
    const loginForm = $('#login-form');
    const addUserBtn = $('#add-user-btn');
    const userForm = $('#user-form');
    const userCancelBtn = $('#user-cancel-btn');
    const userModal = $('#user-modal');
    const deleteUserModal = $('#delete-user-modal');
    const cancelDeleteUserBtn = $('#cancel-delete-user-btn');
    const confirmDeleteUserBtn = $('#confirm-delete-user-btn');

    if(loginForm) loginForm.addEventListener('submit', handleLogin);

    // Sidebar logout button
    const sidebarLogoutBtn = $('#sidebar-logout-btn');
    if(sidebarLogoutBtn) sidebarLogoutBtn.addEventListener('click', handleLogout);

    // Helper function to check if user form has data
    function hasUserFormData(){
      const email = $('#user-email').value.trim();
      const displayName = $('#user-display-name').value.trim();
      const password = $('#user-password').value.trim();
      return email || displayName || password;
    }

    // Helper function to close user modal with confirmation
    function closeUserModalWithConfirm(){
      if(hasUserFormData()){
        if(confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy? Th√¥ng tin ƒë√£ nh·∫≠p s·∫Ω b·ªã m·∫•t.')){
          $('#user-modal').classList.remove('active');
          // Clear form
          $('#user-email').value = '';
          $('#user-display-name').value = '';
          $('#user-password').value = '';
          $('#user-error-message').classList.add('hidden');
        }
      } else {
        $('#user-modal').classList.remove('active');
      }
    }

    if(addUserBtn) addUserBtn.addEventListener('click', showAddUserModal);
    if(userForm) userForm.addEventListener('submit', handleUserFormSubmit);
    if(userCancelBtn) userCancelBtn.addEventListener('click', closeUserModalWithConfirm);

    // X close button
    const userModalCloseBtn = $('#user-modal-close');
    if(userModalCloseBtn) userModalCloseBtn.addEventListener('click', closeUserModalWithConfirm);

    if(userModal) userModal.addEventListener('click', e => {
      if(e.target === userModal) closeUserModalWithConfirm();
    });
    if(cancelDeleteUserBtn) cancelDeleteUserBtn.addEventListener('click', () => {
      $('#delete-user-modal').classList.remove('active');
      userToDelete = null;
    });
    if(confirmDeleteUserBtn) confirmDeleteUserBtn.addEventListener('click', confirmDeleteUser);
    if(deleteUserModal) deleteUserModal.addEventListener('click', e => {
      if(e.target === deleteUserModal){
        $('#delete-user-modal').classList.remove('active');
        userToDelete = null;
      }
    });

    // TASK 11 & 12: Password Management Event Listeners
    const changePasswordForm = $('#change-password-form');
    const forgotPasswordLink = $('#forgot-password-link');
    const forgotPasswordForm = $('#forgot-password-form');
    const forgotPasswordModal = $('#forgot-password-modal');

    if(changePasswordForm) changePasswordForm.addEventListener('submit', handleChangePassword);
    if(forgotPasswordLink) forgotPasswordLink.addEventListener('click', () => {
      $('#forgot-password-modal').classList.add('active');
    });
    if(forgotPasswordForm) forgotPasswordForm.addEventListener('submit', handleForgotPassword);
    if(forgotPasswordModal) forgotPasswordModal.addEventListener('click', e => {
      if(e.target === forgotPasswordModal) $('#forgot-password-modal').classList.remove('active');
    });

    // Modal close buttons for forgot password
    const forgotPasswordCloseBtn = document.querySelector('#forgot-password-modal .modal-close');
    const forgotPasswordCancelBtn = document.querySelector('#forgot-password-modal button[data-modal="forgot-password-modal"]');
    if(forgotPasswordCloseBtn) forgotPasswordCloseBtn.addEventListener('click', () => {
      $('#forgot-password-modal').classList.remove('active');
    });
    if(forgotPasswordCancelBtn) forgotPasswordCancelBtn.addEventListener('click', () => {
      $('#forgot-password-modal').classList.remove('active');
    });

    // TASK 13: Password Toggle Visibility
    document.querySelectorAll('.password-toggle').forEach(toggleBtn => {
      toggleBtn.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const passwordInput = document.getElementById(targetId);
        const eyeOpen = this.querySelectorAll('.eye-open');
        const eyeClosed = this.querySelectorAll('.eye-closed');

        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          eyeOpen.forEach(el => el.classList.add('hidden'));
          eyeClosed.forEach(el => el.classList.remove('hidden'));
        } else {
          passwordInput.type = 'password';
          eyeOpen.forEach(el => el.classList.remove('hidden'));
          eyeClosed.forEach(el => el.classList.add('hidden'));
        }
      });
    });

    // ========= PLAN MANAGER EVENT LISTENERS =========
    const addMenuBtn = $('#add-menu-btn');
    const menuForm = $('#menu-form');
    const menuCancelBtn = $('#menu-cancel-btn');
    const menuModal = $('#menu-modal');
    const deleteMenuModal = $('#delete-menu-modal');
    const cancelDeleteMenuBtn = $('#cancel-delete-menu-btn');
    const confirmDeleteMenuBtn = $('#confirm-delete-menu-btn');

    const addTaskBtn = $('#add-task-btn'); // This won't exist, tasks are added via menu-specific buttons
    const taskForm = $('#task-form');
    const taskCancelBtn = $('#task-cancel-btn');
    const taskModal = $('#task-modal');
    const deletePlanTaskModal = $('#delete-plan-task-modal');
    const cancelDeletePlanTaskBtn = $('#cancel-delete-plan-task-btn');
    const confirmDeletePlanTaskBtn = $('#confirm-delete-plan-task-btn');

    const addAssigneeBtn = $('#add-assignee-btn');
    const assigneeForm = $('#assignee-form');
    const assigneeCancelBtn = $('#assignee-cancel-btn');
    const assigneeModal = $('#assignee-modal');
    const deleteAssigneeModal = $('#delete-assignee-modal');
    const cancelDeleteAssigneeBtn = $('#cancel-delete-assignee-btn');
    const confirmDeleteAssigneeBtn = $('#confirm-delete-assignee-btn');

    // Menu events
    if(addMenuBtn) addMenuBtn.addEventListener('click', showAddMenuModal);
    if(menuForm) menuForm.addEventListener('submit', handleMenuFormSubmit);
    if(menuCancelBtn) menuCancelBtn.addEventListener('click', () => {
      $('#menu-modal').classList.remove('active');
    });
    if(menuModal) menuModal.addEventListener('click', e => {
      if(e.target === menuModal) $('#menu-modal').classList.remove('active');
    });
    if(cancelDeleteMenuBtn) cancelDeleteMenuBtn.addEventListener('click', () => {
      $('#delete-menu-modal').classList.remove('active');
      menuToDelete = null;
    });
    if(confirmDeleteMenuBtn) confirmDeleteMenuBtn.addEventListener('click', confirmDeleteMenu);
    if(deleteMenuModal) deleteMenuModal.addEventListener('click', e => {
      if(e.target === deleteMenuModal){
        $('#delete-menu-modal').classList.remove('active');
        menuToDelete = null;
      }
    });

    // Menu type change event (show/hide slug and link fields)
    const menuTypeSelect = $('#menu-type');
    if(menuTypeSelect){
      menuTypeSelect.addEventListener('change', (e) => {
        const slugField = $('#menu-slug-field');
        const linkField = $('#menu-link-field');
        if(e.target.value === 'external-link'){
          if(slugField) slugField.classList.add('hidden');
          if(linkField) linkField.classList.remove('hidden');
        } else {
          if(slugField) slugField.classList.remove('hidden');
          if(linkField) linkField.classList.add('hidden');
        }
      });
    }

    // Emoji picker
    const emojiPickerBtn = $('#emoji-picker-btn');
    const emojiPicker = $('#emoji-picker');
    if(emojiPickerBtn){
      emojiPickerBtn.addEventListener('click', () => {
        emojiPicker.classList.toggle('hidden');
      });
    }
    if(emojiPicker){
      const emojiOptions = $$('.emoji-option', emojiPicker);
      emojiOptions.forEach(btn => {
        btn.addEventListener('click', (e) => {
          const emoji = e.target.textContent;
          $('#menu-icon').value = emoji;
          emojiPicker.classList.add('hidden');
        });
      });
    }

    // Task events
    if(taskForm) taskForm.addEventListener('submit', handleTaskFormSubmit);
    if(taskCancelBtn) taskCancelBtn.addEventListener('click', () => {
      $('#task-modal').classList.remove('active');
    });
    if(taskModal) taskModal.addEventListener('click', e => {
      if(e.target === taskModal) $('#task-modal').classList.remove('active');
    });
    if(cancelDeletePlanTaskBtn) cancelDeletePlanTaskBtn.addEventListener('click', () => {
      $('#delete-plan-task-modal').classList.remove('active');
      taskToDelete = { menuId: null, taskId: null };
    });
    if(confirmDeletePlanTaskBtn) confirmDeletePlanTaskBtn.addEventListener('click', confirmDeletePlanTask);
    if(deletePlanTaskModal) deletePlanTaskModal.addEventListener('click', e => {
      if(e.target === deletePlanTaskModal){
        $('#delete-plan-task-modal').classList.remove('active');
        taskToDelete = { menuId: null, taskId: null };
      }
    });

    // Assignee events
    if(addAssigneeBtn) addAssigneeBtn.addEventListener('click', showAddAssigneeModal);
    if(assigneeForm) assigneeForm.addEventListener('submit', handleAssigneeFormSubmit);
    if(assigneeCancelBtn) assigneeCancelBtn.addEventListener('click', () => {
      $('#assignee-modal').classList.remove('active');
    });
    if(assigneeModal) assigneeModal.addEventListener('click', e => {
      if(e.target === assigneeModal) $('#assignee-modal').classList.remove('active');
    });
    if(cancelDeleteAssigneeBtn) cancelDeleteAssigneeBtn.addEventListener('click', () => {
      $('#delete-assignee-modal').classList.remove('active');
      assigneeToDelete = null;
    });
    if(confirmDeleteAssigneeBtn) confirmDeleteAssigneeBtn.addEventListener('click', confirmDeleteAssignee);
    if(deleteAssigneeModal) deleteAssigneeModal.addEventListener('click', e => {
      if(e.target === deleteAssigneeModal){
        $('#delete-assignee-modal').classList.remove('active');
        assigneeToDelete = null;
      }
    });

    // Expose functions to global scope for onclick handlers
    window.editUser = editUser;
    window.deleteUser = deleteUser;
    window.editMenu = editMenu;
    window.deleteMenu = deleteMenu;
    window.toggleMenuTasks = toggleMenuTasks;
    window.showAddTaskModal = showAddTaskModal;
    window.editTask = editTask;
    window.deletePlanTask = deletePlanTask;
    window.deleteAssignee = deleteAssignee;

    // Initialize authentication
    initializeAuthentication();
  });
  </script>
</body>
</html>


