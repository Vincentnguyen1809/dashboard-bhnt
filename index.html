<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Master Plan: D·ªãch V·ª• Marketing BHNT ‚Äî Final</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f5f5f5; }
    .chart-container { position: relative; width:100%; max-width:350px; margin:0 auto; height:300px; max-height:350px; }
    .nav-link { display:flex; align-items:center; padding:0.625rem 1rem; border-radius:0.375rem; color:#374151; font-weight:500; font-size:0.9375rem; transition:all .15s; cursor:pointer; margin-bottom:0.25rem; }
    .nav-link:hover{ background:#e5e7eb; }
    .nav-link.active{ background:#dbeafe; color:#1e40af; }
    .nav-link .emoji{ font-size:1.25rem; margin-right:0.75rem; }
    .sidebar{ transform:translateX(-100%); transition: transform .3s; position:fixed; inset:0 auto 0 0; z-index:30; background:#fafafa; border-right:1px solid #e5e7eb; width:16rem; }
    .sidebar.open{ transform:translateX(0); }
    @media (min-width:1024px){ .sidebar{ transform:none; position:static; } }
    .task-card{ background:#fff; border-radius:0.5rem; padding:1.25rem; margin-bottom:1rem; border:1px solid #e5e7eb; transition:box-shadow .2s; }
    .task-card:hover{ box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .task-card.completed{ background:#f0fdf4; border-color:#86efac; }
    .task-card.overdue{ background:#fef2f2; border-color:#fca5a5; }
    .task-header{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.75rem; }
    .task-title{ font-size:1rem; font-weight:600; color:#111827; flex:1; padding-right:1rem; }
    .task-status{ font-size:0.6875rem; font-weight:600; padding:0.25rem 0.625rem; border-radius:0.25rem; text-transform:uppercase; letter-spacing:.025em; white-space:nowrap; }
    .status-pending{ background:#f3f4f6; color:#6b7280; }
    .status-completed{ background:#dcfce7; color:#166534; }
    .status-overdue{ background:#fee2e2; color:#991b1b; }
    .task-details{ margin-top:0.75rem; }
    .task-details-label{ font-weight:600; font-size:0.875rem; color:#374151; margin-bottom:0.5rem; }
    .task-detail-list{ list-style:disc; margin-left:1.25rem; font-size:0.875rem; color:#6b7280; line-height:1.6; }
    .task-detail-list li{ margin-bottom:0.375rem; }
    .task-meta{ font-size:0.8125rem; color:#9ca3af; margin-top:0.75rem; display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; }
    .deadline-countdown{ font-weight:600; margin-left:0.25rem; display:inline-flex; align-items:center; gap:0.25rem; }
    .deadline-safe{ color:#0f766e; }
    .deadline-warning{ color:#b45309; }
    .deadline-danger{ color:#b91c1c; }
    .task-action-area{ margin-top:1rem; padding-top:1rem; border-top:1px solid #f3f4f6; }
    .task-input-group{ display:flex; gap:0.5rem; }
    .task-link-input{ flex:1; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.5rem 0.75rem; font-size:0.875rem; color:#374151; transition:.2s; }
    .task-link-input:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .task-link-input:disabled{ background:#f9fafb; color:#9ca3af; cursor:not-allowed; }
    .task-btn{ padding:0.5rem 1rem; font-size:0.875rem; font-weight:500; border-radius:0.375rem; transition:.2s; cursor:pointer; border:none; white-space:nowrap; }
    .task-btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn-complete{ background:#10b981; color:#fff; }
    .btn-complete:hover:not(:disabled){ background:#059669; }
    .btn-view{ background:#0ea5e9; color:#fff; }
    .btn-view:hover:not(:disabled){ background:#0284c7; }
    .task-completed-actions{ display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
    .task-icon-btn{ width:2.5rem; height:2.5rem; border-radius:0.375rem; border:1px solid #d1d5db; background:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.2s; }
    .task-icon-btn:hover{ background:#e5e7eb; }
    .task-icon-btn:disabled{ cursor:not-allowed; opacity:.5; }
    .task-icon-btn svg{ width:1.1rem; height:1.1rem; color:#374151; }
    .edit-dropdown-wrapper{ position:relative; display:inline-block; }
    .edit-dropdown-menu{ display:none; position:absolute; top:100%; right:0; margin-top:0.25rem; background:#fff; border:1px solid #e5e7eb; border-radius:0.375rem; box-shadow:0 4px 6px -1px rgba(0,0,0,.1); min-width:150px; z-index:10; }
    .edit-dropdown-menu.show{ display:block; }
    .dropdown-item{ padding:0.625rem 1rem; font-size:0.875rem; color:#374151; cursor:pointer; display:flex; align-items:center; gap:0.5rem; }
    .dropdown-item:hover{ background:#f3f4f6; }
    .dropdown-item.delete{ color:#dc2626; }
    .dropdown-item.delete:hover{ background:#fef2f2; }
    .btn-cancel{ background:#e5e7eb; color:#374151; }
    .btn-cancel:hover{ background:#d1d5db; }
    .progress-bar{ background:#e5e7eb; border-radius:9999px; overflow:hidden; height:0.75rem; }
    .progress-bar-inner{ background:#3b82f6; height:100%; transition:width .5s; }
    .section-title{ font-size:1.875rem; font-weight:700; color:#111827; margin-bottom:0.75rem; }
    .section-subtitle{ font-size:1rem; color:#6b7280; margin-bottom:2rem; line-height:1.5; }
    .phase-title{ font-size:1.25rem; font-weight:600; color:#1e40af; margin-top:2rem; margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:2px solid #dbeafe; }
    .notes-textarea{ width:100%; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.75rem; font-size:0.875rem; resize:none; min-height:120px; font-family:inherit; }
    .notes-textarea:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .notes-table{ width:100%; border-collapse:collapse; font-size:0.875rem; }
    .notes-table th{ background:#f9fafb; padding:0.75rem; text-align:left; font-weight:600; color:#374151; border-bottom:2px solid #e5e7eb; }
    .notes-table td{ padding:0.75rem; border-bottom:1px solid #f3f4f6; color:#6b7280; }
    .notes-table tr:hover{ background:#f9fafb; }
    .custom-type-item{ display:inline-flex; align-items:center; gap:0.375rem; padding:0.25rem 0.75rem; background:#dbeafe; border-radius:9999px; margin:0.25rem; font-size:0.8125rem; color:#1e40af; }
    .note-type-dropdown{ position:relative; margin-top:0.75rem; }
    .note-type-trigger{ width:100%; display:flex; justify-content:space-between; align-items:center; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.6rem 0.75rem; background:#fff; font-size:0.875rem; color:#374151; cursor:pointer; transition:.2s; }
    .note-type-trigger:hover{ border-color:#3b82f6; }
    .note-type-trigger svg{ width:1rem; height:1rem; color:#6b7280; transition:transform .2s; }
    .note-type-dropdown.open .note-type-trigger svg{ transform:rotate(180deg); }
    .note-type-panel{ position:absolute; inset:calc(100% + 0.25rem) 0 auto 0; background:#fff; border:1px solid #e5e7eb; border-radius:0.5rem; box-shadow:0 10px 25px -10px rgba(15,23,42,.35); padding:0.75rem; z-index:30; display:none; }
    .note-type-dropdown.open .note-type-panel{ display:block; }
    .note-type-new{ display:flex; gap:0.5rem; margin-bottom:0.75rem; }
    .note-type-new input{ flex:1; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.45rem 0.6rem; font-size:0.875rem; }
    .note-type-new input:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.12); }
    .note-type-options{ max-height:220px; overflow-y:auto; display:flex; flex-direction:column; gap:0.35rem; }
    .note-type-option{ display:flex; justify-content:space-between; align-items:center; padding:0.45rem 0.6rem; border-radius:0.375rem; background:#f9fafb; font-size:0.875rem; cursor:pointer; transition:background .2s, color .2s, box-shadow .2s; outline:none; }
    .note-type-option:hover, .note-type-option:focus{ background:#e0f2fe; color:#1d4ed8; box-shadow:inset 0 0 0 1px #bfdbfe; }
    .note-type-option.active{ background:#dbeafe; color:#1d4ed8; font-weight:600; }
    .note-type-option span{ pointer-events:none; }
    .note-type-remove{ border:none; background:none; color:#ef4444; font-size:1rem; cursor:pointer; padding:0.125rem; line-height:1; }
    .note-type-remove:hover{ color:#b91c1c; }
    .note-type-feedback{ min-height:1rem; margin-top:0.25rem; font-size:0.75rem; display:block; }
    .note-type-feedback.hidden{ display:none; }
    .task-link-feedback{ font-size:0.75rem; margin-top:0.35rem; color:#b91c1c; display:none; }
    .task-link-feedback.show{ display:block; }
    .task-log-link{ color:#2563eb; font-weight:600; text-decoration:none; }
    .task-log-link:hover{ text-decoration:underline; }
    .activity-table th{ white-space:nowrap; }
    .filter-container{ display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-bottom:1.5rem; }
    .filter-input, .form-select{ width:100%; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.5rem 0.75rem; font-size:0.875rem; background:#fff; }
    .filter-input:focus, .form-select:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .modal-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; align-items:center; justify-content:center; backdrop-filter: blur(2px); }
    .modal-overlay.active{ display:flex; }
    .modal-content{ background:#fff; padding:1.75rem; border-radius:0.75rem; max-width:420px; width:90%; box-shadow:0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04); }
    .modal-title{ font-size:1.25rem; font-weight:700; color:#111827; margin-bottom:0.75rem; }
    .modal-message{ color:#6b7280; margin-bottom:1.5rem; line-height:1.5; }
    .modal-buttons{ display:flex; gap:0.75rem; justify-content:flex-end; }
  </style>
</head>
<body class="text-gray-800">
  <!-- Delete Task Modal -->
  <div id="delete-task-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="delete-task-title">
      <h3 id="delete-task-title" class="modal-title">X√°c nh·∫≠n x√≥a</h3>
      <p class="modal-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a task n√†y kh√¥ng? Link ƒë√£ nh·∫≠p s·∫Ω b·ªã x√≥a v√† task s·∫Ω tr·ªü v·ªÅ tr·∫°ng th√°i ch∆∞a ho√†n th√†nh.</p>
      <div class="modal-buttons">
        <button id="cancel-delete-task-btn" class="task-btn btn-cancel">Kh√¥ng</button>
        <button id="confirm-delete-task-btn" class="task-btn" style="background-color:#ef4444; color:#fff;">C√≥</button>
      </div>
    </div>
  </div>

  <!-- Delete Note Modal -->
  <div id="delete-note-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="delete-note-title">
      <h3 id="delete-note-title" class="modal-title">X√°c nh·∫≠n x√≥a ghi ch√∫</h3>
      <p class="modal-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ghi ch√∫ n√†y kh√¥ng?</p>
      <div class="modal-buttons">
        <button id="cancel-delete-note-btn" class="task-btn btn-cancel">Kh√¥ng</button>
        <button id="confirm-delete-note-btn" class="task-btn" style="background-color:#ef4444; color:#fff;">C√≥</button>
      </div>
    </div>
  </div>

  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar lg:static" aria-label="Thanh ƒëi·ªÅu h∆∞·ªõng">
      <div class="flex h-full flex-col">
        <div class="flex items-center h-16 px-5 border-b border-gray-200">
          <h1 class="text-base font-bold text-gray-900">Master Plan (A-Z+)</h1>
          <button id="close-menu" class="lg:hidden ml-auto text-gray-600 hover:text-gray-900 text-2xl" aria-label="ƒê√≥ng menu">&times;</button>
        </div>
        <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
          <a class="nav-link active" data-target="overview"><span class="emoji">üìä</span><span>T·ªïng Quan</span></a>
          <a class="nav-link" data-target="gd1"><span class="emoji">üéØ</span><span>Gƒê 1: N·ªÅn T·∫£ng</span></a>
          <a class="nav-link" data-target="gd2"><span class="emoji">üèóÔ∏è</span><span>Gƒê 2: X√¢y D·ª±ng</span></a>
          <a class="nav-link" data-target="gd3"><span class="emoji">‚öôÔ∏è</span><span>Gƒê 3: V·∫≠n H√†nh & T·ªëi ∆Øu</span></a>
          <a class="nav-link" data-target="gd4"><span class="emoji">üöÄ</span><span>Gƒê 4: Ra M·∫Øt</span></a>
          <a class="nav-link" data-target="notes"><span class="emoji">üìù</span><span>Ghi Ch√∫ D·ª± √Ån</span></a>
        </nav>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 relative overflow-y-auto bg-gray-50">
      <!-- Top bar -->
      <header class="sticky top-0 z-20 flex items-center justify-between px-6 py-3 bg-white border-b border-gray-200">
        <button id="open-menu" class="mobile-menu-button lg:hidden text-gray-600 hover:text-gray-900" aria-label="M·ªü menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
        <div class="ml-auto flex flex-col items-end gap-1 text-right">
          <div class="text-sm font-medium text-gray-700">Ng√†y Ra M·∫Øt (D-Day)</div>
          <div class="text-base font-bold text-red-600">15/03/2026</div>
          <div id="project-share-info" class="text-xs text-gray-500 hidden leading-snug max-w-xs">
            <span class="font-medium text-gray-600 block">Chia s·∫ª d·ª± √°n</span>
            <span id="project-id-label" class="block text-gray-600"></span>
            <span id="project-share-url" class="block text-blue-600 break-words"></span>
          </div>
        </div>
      </header>

      <div class="p-6 max-w-7xl mx-auto">
        <div id="content-sections">
          <!-- Overview -->
          <section id="overview" class="content-section">
            <h2 class="section-title">T·ªïng Quan Ti·∫øn ƒê·ªô D·ª± √Ån</h2>
            <p class="section-subtitle">D√°n link k·∫øt qu·∫£ cho t·ª´ng task r·ªìi b·∫•m ‚ÄúHo√†n Th√†nh‚Äù. H·ªá th·ªëng t·ª± c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô, bi·ªÉu ƒë·ªì, v√† c·∫£nh b√°o deadline.</p>

            <div class="card-section">
              <h3 class="card-title">T·ªïng Ti·∫øn ƒê·ªô (To√†n D·ª± √Ån)</h3>
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-600">Ti·∫øn ƒë·ªô</span>
                <span id="total-progress-text" class="text-sm font-bold text-blue-600">0 / 0 Tasks</span>
              </div>
              <div class="progress-bar"><div id="total-progress-bar" class="progress-bar-inner" style="width:0%"></div></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="stat-card">
                <h3 class="card-title text-center">T·ª∑ L·ªá Ho√†n Th√†nh</h3>
                <div class="chart-container"><canvas id="progressChart"></canvas></div>
              </div>
              <div class="stat-card">
                <h3 class="card-title">Ti·∫øn ƒê·ªô Theo Giai ƒêo·∫°n</h3>
                <div class="space-y-4">
                  <div>
                    <div class="flex justify-between mb-1.5"><span class="text-sm font-medium text-blue-700">Gƒê 1: N·ªÅn T·∫£ng</span><span id="gd1-progress-text" class="text-sm font-medium text-blue-700">0 / 0</span></div>
                    <div class="progress-bar"><div id="gd1-progress-bar" class="progress-bar-inner" style="width:0%"></div></div>
                  </div>
                  <div>
                    <div class="flex justify-between mb-1.5"><span class="text-sm font-medium text-green-700">Gƒê 2: X√¢y D·ª±ng</span><span id="gd2-progress-text" class="text-sm font-medium text-green-700">0 / 0</span></div>
                    <div class="progress-bar"><div id="gd2-progress-bar" class="progress-bar-inner bg-green-600" style="width:0%"></div></div>
                  </div>
                  <div>
                    <div class="flex justify-between mb-1.5"><span class="text-sm font-medium text-yellow-700">Gƒê 3: V·∫≠n H√†nh</span><span id="gd3-progress-text" class="text-sm font-medium text-yellow-700">0 / 0</span></div>
                    <div class="progress-bar"><div id="gd3-progress-bar" class="progress-bar-inner bg-yellow-500" style="width:0%"></div></div>
                  </div>
                  <div>
                    <div class="flex justify-between mb-1.5"><span class="text-sm font-medium text-red-700">Gƒê 4: Ra M·∫Øt</span><span id="gd4-progress-text" class="text-sm font-medium text-red-700">0 / 0</span></div>
                    <div class="progress-bar"><div id="gd4-progress-bar" class="progress-bar-inner bg-red-600" style="width:0%"></div></div>
                  </div>
                </div>
              </div>
            </div>

            <div id="activity-log-section" class="card-section">
              <div class="flex items-center justify-between mb-3 flex-wrap gap-3">
                <h3 class="card-title">T·ªïng Quan Ho·∫°t ƒê·ªông</h3>
                <span id="activity-log-count" class="text-sm text-gray-500"></span>
              </div>
              <div class="overflow-x-auto">
                <table class="notes-table activity-table">
                  <thead>
                    <tr>
                      <th style="width:20%">Th·ªùi Gian Ho√†n Th√†nh</th>
                      <th style="width:20%">Th·ªùi Gian C·∫≠p nh·∫≠t</th>
                      <th style="width:40%">T√™n Task</th>
                      <th style="width:20%">Giai ƒêo·∫°n</th>
                    </tr>
                  </thead>
                  <tbody id="activity-log-body"></tbody>
                </table>
              </div>
              <button id="activity-log-toggle" class="task-btn btn-view mt-3 hidden">Xem th√™m</button>
            </div>

            <div id="upcoming-deadlines-container" class="card-section hidden">
              <h3 class="card-title text-orange-600">‚ö†Ô∏è Deadline S·∫Øp T·ªõi (Trong 7 ng√†y)</h3>
              <ul id="upcoming-deadlines-list" class="list-disc list-inside space-y-1.5 text-gray-700"></ul>
            </div>
            <div id="overdue-tasks-container" class="card-section hidden">
              <h3 class="card-title text-red-600">üö® Tasks Qu√° H·∫°n</h3>
              <ul id="overdue-tasks-list" class="list-disc list-inside space-y-1.5 text-gray-700"></ul>
            </div>
          </section>

          <!-- Gƒê1 -->
          <section id="gd1" class="content-section hidden">
            <h2 class="section-title">Giai ƒêo·∫°n 1: N·ªÅn T·∫£ng & Chi·∫øn L∆∞·ª£c</h2>
            <p class="section-subtitle">M·ª•c ti√™u: ƒê·ªãnh h√¨nh r√µ ch√∫ng ta l√† ai, b√°n g√¨, b√°n cho ai.</p>
            <h3 class="phase-title">Tu·∫ßn 1-2: Nghi√™n C·ª©u & ƒê·ªãnh V·ªã</h3>
            <div id="gd1-week1-2" class="space-y-4"></div>
            <h3 class="phase-title">Tu·∫ßn 3-4: Thi·∫øt K·∫ø D·ªãch V·ª• & Gi√°</h3>
            <div id="gd1-week3-4" class="space-y-4"></div>
          </section>

          <!-- Gƒê2 -->
          <section id="gd2" class="content-section hidden">
            <h2 class="section-title">Giai ƒêo·∫°n 2: X√¢y D·ª±ng H·∫° T·∫ßng & T√†i S·∫£n</h2>
            <p class="section-subtitle">Website, Funnel, Social, Portfolio, Sales Kit, H·ª£p ƒë·ªìng, N·ªôi dung & Nh√¢n s·ª±.</p>
            <h3 class="phase-title">Tu·∫ßn 5-8: H·∫° T·∫ßng K·ªπ Thu·∫≠t</h3>
            <div id="gd2-week5-8" class="space-y-4"></div>
            <h3 class="phase-title">Tu·∫ßn 9-11: Portfolio & Sales Kit</h3>
            <div id="gd2-week9-11" class="space-y-4"></div>
            <h3 class="phase-title">Tu·∫ßn 12-13: N·ªôi dung & V·∫≠n h√†nh</h3>
            <div id="gd2-week12-13" class="space-y-4"></div>
          </section>

          <!-- Gƒê3 -->
          <section id="gd3" class="content-section hidden">
            <h2 class="section-title">Giai ƒêo·∫°n 3: V·∫≠n H√†nh & T·ªëi ∆Øu (A-Z+)</h2>
            <p class="section-subtitle">Nh√¢n s·ª±, SOPs, Sales scripts, CSKH, r·ªßi ro, test & k·∫ø ho·∫°ch ra m·∫Øt.</p>
            <h3 class="phase-title">Tu·∫ßn 14-15: Nh√¢n S·ª± & SOPs</h3>
            <div id="gd3-week14-15" class="space-y-4"></div>
            <h3 class="phase-title">Tu·∫ßn 16-17: K·ªãch B·∫£n & R·ªßi Ro</h3>
            <div id="gd3-week16-17" class="space-y-4"></div>
          </section>

          <!-- Gƒê4 -->
          <section id="gd4" class="content-section hidden">
            <h2 class="section-title">Giai ƒêo·∫°n 4: Ra M·∫Øt (D-Day)</h2>
            <p class="section-subtitle">Build hype, ki·ªÉm tra k·ªπ thu·∫≠t, ra m·∫Øt & t·ªïng k·∫øt.</p>
            <div id="gd4-week18" class="space-y-4"></div>
          </section>

          <!-- Notes -->
          <section id="notes" class="content-section hidden">
            <h2 class="section-title">Ghi Ch√∫ D·ª± √Ån</h2>
            <div class="card-section">
              <h3 class="card-title">Ghi Ch√∫ M·ªõi</h3>
              <textarea id="notes-textarea" class="notes-textarea" placeholder="Nh·∫≠p ghi ch√∫ c·ªßa b·∫°n h√¥m nay..."></textarea>
              <div class="note-type-dropdown" id="note-type-dropdown">
                <button type="button" class="note-type-trigger" id="note-type-trigger" aria-haspopup="true" aria-expanded="false">
                  <span id="note-type-trigger-label">Ch·ªçn lo·∫°i ghi ch√∫</span>
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div class="note-type-panel" id="note-type-panel" role="menu">
                  <div class="note-type-new">
                    <input type="text" id="note-type-new-input" placeholder="Th√™m lo·∫°i m·ªõi..."/>
                    <button type="button" id="note-type-create-btn" class="task-btn btn-complete">Th√™m</button>
                  </div>
                  <div class="note-type-options" id="note-type-options"></div>
                  <p id="note-type-feedback" class="note-type-feedback hidden"></p>
                  <p class="text-xs text-gray-500 mt-2">T·ªëi ƒëa 10 lo·∫°i ghi ch√∫. X√≥a ho·∫∑c t·∫°o lo·∫°i m·ªõi tr·ª±c ti·∫øp t·∫°i ƒë√¢y.</p>
                </div>
              </div>
              <p class="text-xs text-gray-500 mt-2">Ch·ªçn lo·∫°i ghi ch√∫ ho·∫∑c t·∫°o m·ªõi ngay trong danh s√°ch.</p>
              <button id="save-note-btn" class="task-btn btn-complete w-full mt-3">üíæ L∆∞u Ghi Ch√∫</button>
            </div>

            <div class="card-section">
              <h3 class="card-title">L·ªçc Ghi Ch√∫</h3>
              <div class="filter-container">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">T·ª´ ng√†y</label>
                  <input type="date" id="filter-date-from" class="filter-input"/>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">ƒê·∫øn ng√†y</label>
                  <input type="date" id="filter-date-to" class="filter-input"/>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Lo·∫°i</label>
                  <select id="filter-type" class="filter-input"><option value="">T·∫•t c·∫£ lo·∫°i</option></select>
                </div>
              </div>
              <div class="flex gap-2 mt-3">
                <button id="apply-filter-btn" class="task-btn btn-complete">üîç L·ªçc</button>
                <button id="reset-filter-btn" class="task-btn btn-cancel">üîÑ Reset</button>
              </div>
            </div>

            <div class="card-section">
              <h3 class="card-title">Ghi Ch√∫ ƒê√£ L∆∞u</h3>
              <div class="overflow-x-auto">
                <table class="notes-table">
                  <thead>
                    <tr>
                      <th style="width:15%">Ng√†y Gi·ªù</th>
                      <th style="width:15%">Lo·∫°i</th>
                      <th style="width:60%">N·ªôi Dung</th>
                      <th style="width:10%; text-align:center;">X√≥a</th>
                    </tr>
                  </thead>
                  <tbody id="notes-list-container"></tbody>
                </table>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  document.addEventListener('DOMContentLoaded', () => {
    // ========= CONSTANTS =========
    const DAY_MS = 24 * 60 * 60 * 1000;
    const projectPlanStart = new Date(2025, 10, 10);
    const projectLaunchDate = new Date(2026, 2, 15);
    const timelineSegments = [
      { week:'gd1-week1-2', duration:14 },
      { week:'gd1-week3-4', duration:14 },
      { week:'gd2-week5-8', duration:28 },
      { week:'gd2-week9-11', duration:21 },
      { week:'gd2-week12-13', duration:14 },
      { week:'gd3-week14-15', duration:14 },
      { week:'gd3-week16-17', duration:14 },
      { week:'gd4-week18', duration:7 },
    ];
    const defaultCustomTypes = ['√ù t∆∞·ªüng','Vi·ªác c·∫ßn l√†m','R·ªßi ro','Kh√°c'];

    // ========= DATA =========
    const tasksData = [
      // Gƒê1 ‚Äì Tu·∫ßn 1-2
      { id:'1.1', phase:'gd1', week:'gd1-week1-2', title:'Task 1.1: Nghi√™n c·ª©u th·ªã tr∆∞·ªùng & ƒê·ªëi th·ªß', deadline:'12/11/2025', owner:'BOD, Marketing', details:[
        'Ph√¢n t√≠ch website, fanpage c·ªßa 5-10 ƒë·ªëi th·ªß (c·∫£ tr·ª±c ti·∫øp v√† gi√°n ti·∫øp).',
        'L·∫≠p file Excel so s√°nh: g√≥i, gi√°, ƒëi·ªÉm m·∫°nh/y·∫øu.',
        'T√¨m kho·∫£ng tr·ªëng th·ªã tr∆∞·ªùng.'
      ]},
      { id:'1.2', phase:'gd1', week:'gd1-week1-2', title:'Task 1.2: Ch·ªët T√™n Th∆∞∆°ng Hi·ªáu & Domain', deadline:'13/11/2025', owner:'BOD, Marketing', details:[
        'Brainstorm 20+ t√™n (d·ªÖ nh·ªõ, chuy√™n nghi·ªáp).',
        'Ki·ªÉm tra domain .vn/.com v√† t√™n tr√™n MXH.',
        'Ch·ªët t√™n v√† mua domain.'
      ]},
      { id:'1.3', phase:'gd1', week:'gd1-week1-2', title:'Task 1.3: Ch·ªët Ch√¢n dung Kh√°ch h√†ng (Target Audience)', deadline:'19/11/2025', owner:'BOD, Marketing', details:[
        'Nh·∫Øm ƒë·∫øn ai (TVV m·ªõi, Leader, GA...)',
        'N·ªói ƒëau ch√≠nh; m·ª•c ti√™u.',
        'V·∫Ω 2-3 persona chi ti·∫øt.'
      ]},
      { id:'1.4', phase:'gd1', week:'gd1-week1-2', title:'Task 1.4: Ph√°t tri·ªÉn B·ªô Nh·∫≠n Di·ªán Th∆∞∆°ng Hi·ªáu (Brand Kit)', deadline:'19/11/2025', owner:'Marketing, Design', details:[
        'Thi·∫øt k·∫ø Logo (ƒë·ªß + icon).',
        'Ch·ªët 3-5 m√†u (m√£ hex).',
        'Ch·ªët font ti√™u ƒë·ªÅ & n·ªôi dung.',
        'L√†m Brand Guideline PDF c∆° b·∫£n.'
      ]},
      // Gƒê1 ‚Äì Tu·∫ßn 3-4
      { id:'1.5', phase:'gd1', week:'gd1-week3-4', title:'Task 1.5: Thi·∫øt k·∫ø G√≥i D·ªãch V·ª•', deadline:'27/11/2025', owner:'Product, Sales', details:[
        'X√¢y 3 g√≥i: C∆° b·∫£n/Chuy√™n nghi·ªáp/Cao c·∫•p.',
        'B·∫£ng so s√°nh h·∫°ng m·ª•c (Fanpage, Web, Video AI, Ads, B√°o c√°o...).',
        'Li·ªát k√™ r√µ "Kh√¥ng bao g·ªìm".'
      ]},
      { id:'1.6', phase:'gd1', week:'gd1-week3-4', title:'Task 1.6: X√¢y d·ª±ng Ch√≠nh S√°ch Gi√° (Pricing)', deadline:'28/11/2025', owner:'Product, Sales, Finance', details:[
        'ƒê·ªãnh gi√° cho 3 g√≥i (li√™n quan 1.5).',
        'File Excel t√≠nh COGS.',
        'M·ª•c ti√™u l·ª£i nhu·∫≠n g·ªôp 30-50%.'
      ]},
      { id:'1.7', phase:'gd1', week:'gd1-week3-4', title:'Task 1.7: X√¢y d·ª±ng Ch√≠nh S√°ch B√°n H√†ng', deadline:'04/12/2025', owner:'Sales', details:[
        'Ch√≠nh s√°ch hoa h·ªìng (Sales/CTV).',
        'Ch√≠nh s√°ch thanh to√°n.',
        'ƒêi·ªÅu kho·∫£n cam k·∫øt/ho√†n ti·ªÅn (ch·∫∑t ch·∫Ω).'
      ]},
      { id:'1.8', phase:'gd1', week:'gd1-week3-4', title:'Task 1.8: Ph√°c th·∫£o Quy tr√¨nh l√†m vi·ªác (Client Workflow)', deadline:'04/12/2025', owner:'Product, Ops', details:[
        'V·∫Ω flowchart Miro/Figma.',
        '5 b∆∞·ªõc: Sales ch·ªët ‚Üí B√†n giao Ops ‚Üí Onboarding ‚Üí Tri·ªÉn khai h·∫±ng th√°ng ‚Üí B√°o c√°o & Gia h·∫°n.'
      ]},

      // Gƒê2 ‚Äì Tu·∫ßn 5-8
      { id:'2.1', phase:'gd2', week:'gd2-week5-8', title:'Task 2.1: X√¢y d·ª±ng Website Ch√≠nh', deadline:'08/01/2026', owner:'Marketing, IT/Dev', details:[
        'Trang: Home, About, D·ªãch v·ª•, B·∫£ng gi√°, Case Studies, Blog, Li√™n h·ªá.',
        'ƒê·∫πp, chuy√™n nghi·ªáp, mobile-first.'
      ]},
      { id:'2.2', phase:'gd2', week:'gd2-week5-8', title:'Task 2.2: X√¢y d·ª±ng Ph·ªÖu Thu Lead (Sales Funnel)', deadline:'15/01/2026', owner:'Marketing', details:[
        'Thi·∫øt k·∫ø Lead Magnet.',
        'Landing Page t·∫∑ng t√†i li·ªáu.',
        'Email t·ª± ƒë·ªông g·ª≠i qu√† & nu√¥i d∆∞·ª°ng.'
      ]},
      { id:'2.3', phase:'gd2', week:'gd2-week5-8', title:'Task 2.3: X√¢y d·ª±ng K√™nh Social Media', deadline:'16/01/2026', owner:'Marketing', details:[
        'T·∫°o & t·ªëi ∆∞u Fanpage/LinkedIn/YouTube.',
        'ƒêƒÉng 3-5 b√†i m·ªìi m·ªói k√™nh.'
      ]},

      // Gƒê2 ‚Äì Tu·∫ßn 9-11
      { id:'2.4A', phase:'gd2', week:'gd2-week9-11', title:'Task 2.4.A: Ch·∫°y d·ª± √°n "Beta" (L·∫•y Case Study TH·∫¨T)', deadline:'29/01/2026', owner:'Marketing, Sales', details:[
        'L√†m th·ª≠ cho 2-3 TVV (mi·ªÖn ph√≠/gi√° r·∫ª).',
        'Thu 3 case Before-After + 1 video testimonial 30-60s.'
      ]},
      { id:'2.4B', phase:'gd2', week:'gd2-week9-11', title:'Task 2.4.B: X√¢y d·ª±ng "G√≥i Demo" (T√†i s·∫£n M·∫´u)', deadline:'29/01/2026', owner:'Marketing, Design', details:[
        'Website m·∫´u cho TVV t∆∞·ªüng t∆∞·ª£ng.',
        'B·ªô 4 b√†i content m·∫´u.',
        '1-2 video AI m·∫´u (HeyGen).',
        'T·ªïng h·ª£p v√†o 1 folder GDrive.'
      ]},
      { id:'2.5', phase:'gd2', week:'gd2-week9-11', title:'Task 2.5: X√¢y d·ª±ng B·ªô T√†i Li·ªáu B√°n H√†ng (Sales Kit)', deadline:'05/02/2026', owner:'Sales, Marketing', details:[
        'Sales Deck: v·∫•n ƒë·ªÅ ‚Üí gi·∫£i ph√°p ‚Üí g√≥i ‚Üí case.',
        'Proposal template.',
        'Folder Sales Kit t·ªïng h·ª£p.'
      ]},
      { id:'2.5C', phase:'gd2', week:'gd2-week9-11', title:'Task 2.5.C: So·∫°n th·∫£o H·ª£p ƒë·ªìng m·∫´u (Ph√°p l√Ω)', deadline:'05/02/2026', owner:'BOD, Legal', details:[
        'Tham v·∫•n lu·∫≠t s∆∞/m·∫´u chu·∫©n.',
        'R√µ scope theo 3 g√≥i; s·ªë l·∫ßn s·ª≠a; mi·ªÖn tr·ª´; b·∫£o m·∫≠t.'
      ]},

      // Gƒê2 ‚Äì Tu·∫ßn 12-13
      { id:'2.6', phase:'gd2', week:'gd2-week12-13', title:'Task 2.6: Vi·∫øt K·ªãch B·∫£n Video B√°n H√†ng', deadline:'12/02/2026', owner:'Marketing', details:[
        'Script (60s) v·∫•n ƒë·ªÅ-gi·∫£i ph√°p.',
        'Script (2-3p) gi·ªõi thi·ªáu d·ªãch v·ª•.',
        'Script (60s) testimonial.',
        'C√≥ l·ªùi tho·∫°i & m√¥ t·∫£ h√¨nh ·∫£nh.'
      ]},
      { id:'2.7', phase:'gd2', week:'gd2-week12-13', title:'Task 2.7: Quay & D·ª±ng 3 Video B√°n H√†ng', deadline:'26/02/2026', owner:'Marketing', details:[
        'S·∫£n xu·∫•t theo k·ªãch b·∫£n 2.6.',
        '∆Øu ti√™n ch·∫•t l∆∞·ª£ng/AI.',
        'Ph·ª• ƒë·ªÅ, nh·∫°c n·ªÅn, CTA r√µ.'
      ]},
      { id:'2.8', phase:'gd2', week:'gd2-week12-13', title:'Task 2.8: X√¢y d·ª±ng K·∫ø ho·∫°ch Tuy·ªÉn d·ª•ng', deadline:'12/02/2026', owner:'HR', details:[
        'X√°c ƒë·ªãnh v·ªã tr√≠ c·ªët l√µi (1 Content, 1 Account).',
        'JD chi ti·∫øt, ƒëƒÉng tin.',
        'Danh s√°ch 3-5 freelancer d·ª± ph√≤ng.'
      ]},
      { id:'2.9', phase:'gd2', week:'gd2-week12-13', title:'Task 2.9: Chu·∫©n b·ªã T√†i s·∫£n Qu·∫£ng c√°o (Ads)', deadline:'12/02/2026', owner:'Marketing, Ads', details:[
        'T·∫°o 3-5 BM d·ª± ph√≤ng.',
        'Pixel + c√†i l√™n Web/Funnel.',
        'X√°c minh domain FB.',
        'Chu·∫©n b·ªã 1-2 t√†i kho·∫£n Ads c√° nh√¢n.'
      ]},
      { id:'2.10', phase:'gd2', week:'gd2-week12-13', title:'Task 2.10: X√¢y d·ª±ng Template V·∫≠n h√†nh (Internal)', deadline:'12/02/2026', owner:'Ops', details:[
        'Folder Template cho KH m·ªõi.',
        'Project Template (Trello/Base).',
        'Template b√°o c√°o th√°ng (Slides).'
      ]},

      // Gƒê3 ‚Äì Tu·∫ßn 14-15
      { id:'3.1', phase:'gd3', week:'gd3-week14-15', title:'Task 3.1: Ho√†n t·∫•t Ph·ªèng v·∫•n & Ch·ªët nh√¢n s·ª±', deadline:'19/02/2026', owner:'HR', details:[
        'Ph·ªèng v·∫•n, ch·ªët Offer.',
        'K√Ω Hƒê lao ƒë·ªông/d·ªãch v·ª•.'
      ]},
      { id:'3.2A', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.A: Thi·∫øt k·∫ø Client Briefing Form', deadline:'19/02/2026', owner:'Ops, Marketing', details:[
        'Google Form l·∫•y th√¥ng tin.',
        'C√¢u h·ªèi: link, TOV, 3 ƒë·ªëi th·ªß, tu·ª≥ ch·ªçn clone AI...'
      ]},
      { id:'3.2.1', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.1: SOP - Onboarding Kh√°ch H√†ng M·ªõi', deadline:'26/02/2026', owner:'Ops', details:[
        'B√†n giao Sales‚ÜíAM; email ch√†o; h·∫πn kick-off; t·∫°o project (2.10); kick-off.'
      ]},
      { id:'3.2.2', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.2: SOP - D·ªãch V·ª• Qu·∫£n l√Ω Content/Website', deadline:'26/02/2026', owner:'Ops, Content', details:[
        'Content plan th√°ng ‚Üí s·∫£n xu·∫•t ‚Üí duy·ªát (‚â§2 l·∫ßn s·ª≠a/b√†i) ‚Üí l√™n l·ªãch ‚Üí b√°o c√°o.'
      ]},
      { id:'3.2.3', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.3: SOP - D·ªãch V·ª• AI Video (HeyGen/ElevenLabs)', deadline:'26/02/2026', owner:'Ops, Media', details:[
        'Nh·∫≠n brief ‚Üí duy·ªát k·ªãch b·∫£n ‚Üí nh√°p (watermark) ‚Üí duy·ªát (ch·ªâ l·ªói) ‚Üí b√†n giao full HD.'
      ]},
      { id:'3.2B', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.B: Quy tr√¨nh H∆∞·ªõng d·∫´n KH d√πng AI Tools', deadline:'26/02/2026', owner:'Ops, Media', details:[
        '2 video h∆∞·ªõng d·∫´n: quay m·∫´u cho HeyGen; x√°c th·ª±c voice ElevenLabs.'
      ]},
      { id:'3.3', phase:'gd3', week:'gd3-week14-15', title:'Task 3.3: ƒê√†o t·∫°o Nh√¢n s·ª± m·ªõi', deadline:'27/02/2026', owner:'HR, Ops', details:[
        'Training 1 bu·ªïi: 3 g√≥i (1.5), SOPs (3.2.x), k·ªãch b·∫£n sales (3.9).'
      ]},

      // Gƒê3 ‚Äì Tu·∫ßn 16-17
      { id:'3.8A', phase:'gd3', week:'gd3-week16-17', title:'Task 3.8.A: Vi·∫øt Ebook Lead Magnet', deadline:'01/03/2026', owner:'Marketing, Content', details:[
        'Ebook 10-15 trang PDF, ch·ªß ƒë·ªÅ ph√π h·ª£p ph·ªÖu (2.2).'
      ]},
      { id:'3.9', phase:'gd3', week:'gd3-week16-17', title:'Task 3.9: So·∫°n K·ªãch B·∫£n B√°n H√†ng (Sales Scripts)', deadline:'01/03/2026', owner:'Sales', details:[
        'Telesales; email l·∫°nh; x·ª≠ l√Ω t·ª´ ch·ªëi; follow-up 3 l·∫ßn.'
      ]},
      { id:'3.10', phase:'gd3', week:'gd3-week16-17', title:'Task 3.10: So·∫°n B·ªô FAQ', deadline:'01/03/2026', owner:'Marketing, Sales', details:[
        'T·ªëi thi·ªÉu 10 c√¢u: cam k·∫øt lead, ng√¢n s√°ch ads, duy·ªát n·ªôi dung, Hƒê t·ªëi thi·ªÉu...'
      ]},
      { id:'3.11', phase:'gd3', week:'gd3-week16-17', title:'Task 3.11: Thi·∫øt l·∫≠p H·ªá th·ªëng CSKH & SLA', deadline:'05/03/2026', owner:'Ops', details:[
        'Ch·ªët k√™nh h·ªó tr·ª£; so·∫°n SLA; Form ƒëo CSAT h√†ng th√°ng.'
      ]},
      { id:'3.12', phase:'gd3', week:'gd3-week16-17', title:'Task 3.12: K·∫ø ho·∫°ch Qu·∫£n Tr·ªã R·ªßi Ro', deadline:'05/03/2026', owner:'BOD, Ops', details:[
        'Ph∆∞∆°ng √°n cho 5 r·ªßi ro: k·ª≥ v·ªçng, nh√¢n s·ª± ngh·ªâ, ch·∫≠m duy·ªát, tool tƒÉng gi√°, h·∫øt kh√°ch.'
      ]},
      { id:'3.4', phase:'gd3', week:'gd3-week16-17', title:'Task 3.4: Test To√†n b·ªô H·ªá th·ªëng (Internal Testing)', deadline:'06/03/2026', owner:'To√†n ƒë·ªôi', details:[
        'Test Web (2.1), Funnel (2.2), Form li√™n h·ªá, checklist l·ªói.'
      ]},
      { id:'3.5', phase:'gd3', week:'gd3-week16-17', title:'Task 3.5: L√™n K·∫ø Ho·∫°ch N·ªôi Dung Tu·∫ßn L·ªÖ Ra M·∫Øt', deadline:'06/03/2026', owner:'Marketing', details:[
        'L·ªãch 09/03-15/03: k√™nh, n·ªôi dung, media; vi·∫øt s·∫µn 100%.'
      ]},
      { id:'3.6', phase:'gd3', week:'gd3-week16-17', title:'Task 3.6: Chu·∫©n b·ªã Ch∆∞∆°ng tr√¨nh Khuy·∫øn M√£i Ra M·∫Øt', deadline:'06/03/2026', owner:'Sales, Marketing', details:[
        'Ch·ªçn 1 ∆∞u ƒë√£i (v√≠ d·ª• -20% cho 10 KH ƒë·∫ßu); thi·∫øt k·∫ø banner.'
      ]},
      { id:'3.7', phase:'gd3', week:'gd3-week16-17', title:'Task 3.7: R√† so√°t T·ªïng th·ªÉ (Final Check)', deadline:'08/03/2026', owner:'BOD', details:[
        'CEO check: Sales Kit, Hƒê, Website, Ph·ªÖu, Video, Nh√¢n s·ª±, Content ra m·∫Øt.'
      ]},

      // Gƒê4 ‚Äì Tu·∫ßn 18
      { id:'4.1', phase:'gd4', week:'gd4-week18', title:'Task 4.1: Build Hype (tr∆∞·ªõc D-Day)', deadline:'14/03/2026', owner:'Marketing, Sales', details:[
        'Teaser + ƒë·∫øm ng∆∞·ª£c; Sales nh·∫Øn 20 KH ti·ªÅm nƒÉng v·ªÅ ∆∞u ƒë√£i.'
      ]},
      { id:'4.2', phase:'gd4', week:'gd4-week18', title:'Task 4.2: Ki·ªÉm tra K·ªπ thu·∫≠t L·∫ßn Cu·ªëi', deadline:'14/03/2026', owner:'IT, Marketing', details:[
        'Server, website, form ho·∫°t ƒë·ªông; t√†i kho·∫£n Ads & n·∫°p ti·ªÅn s·∫µn s√†ng.'
      ]},
      { id:'4.3', phase:'gd4', week:'gd4-week18', title:'Task 4.3 (D-DAY): Ra M·∫Øt Ch√≠nh Th·ª©c', deadline:'15/03/2026', owner:'To√†n ƒë·ªôi', details:[
        '08:00 g·ª≠i Email Launch; 09:00 ƒëƒÉng b√†i ƒë·ªìng lo·∫°t; 09:01 c·∫£ team chia s·∫ª; tr·ª±c chi·∫øn c·∫£ ng√†y.'
      ]},
      { id:'4.4', phase:'gd4', week:'gd4-week18', title:'Task 4.4: H·ªçp nhanh Cu·ªëi ng√†y', deadline:'15/03/2026', owner:'To√†n ƒë·ªôi', details:[
        '17:00 h·ªçp 30 ph√∫t: t·ªïng k·∫øt lead, KH ch·ªët, v·∫•n ƒë·ªÅ ph√°t sinh.'
      ]},
    ];

    const phaseLabels = {
      gd1: 'Giai ƒêo·∫°n 1: N·ªÅn T·∫£ng & Chi·∫øn L∆∞·ª£c',
      gd2: 'Giai ƒêo·∫°n 2: X√¢y D·ª±ng H·∫° T·∫ßng & T√†i S·∫£n',
      gd3: 'Giai ƒêo·∫°n 3: V·∫≠n H√†nh & T·ªëi ∆Øu',
      gd4: 'Giai ƒêo·∫°n 4: Ra M·∫Øt',
    };

    const taskMap = tasksData.reduce((acc, task) => {
      acc[task.id] = task;
      return acc;
    }, {});

    // ========= STATE =========
    let taskState = {};
    let allTasks = [];
    let notes = [];
    let filteredNotes = [];
    let customTypes = defaultCustomTypes.slice();
    let selectedNoteType = customTypes[0] || '';
    let db = null;
    let projectRef = null;
    let isProjectReady = false;
    let hasShownSyncWarning = false;
    let progressChart;
    let taskInputs = [];
    let completeButtons = [];
    let viewButtons = [];
    let debouncedSyncTaskState = () => {};
    let activityLogShowAll = false;
    const linkFeedbackTimers = {};
    let noteTypeFeedbackTimer = null;

    // ========= HELPERS =========
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

    function formatDate(date){
      const d = String(date.getDate()).padStart(2,'0');
      const m = String(date.getMonth()+1).padStart(2,'0');
      const y = date.getFullYear();
      return `${d}/${m}/${y}`;
    }
    function parseDate(ddmmyyyy){
      if(!ddmmyyyy) return null;
      const [d,m,y] = ddmmyyyy.split('/').map(Number);
      if(!d||!m||!y) return null;
      return new Date(y, m-1, d);
    }
    function normalizeTimestamp(value){
      if(!value) return null;
      if(typeof value === 'string') return value;
      if(value instanceof Date) return value.toISOString();
      if(typeof value === 'number') return new Date(value).toISOString();
      if(typeof value.toDate === 'function'){ return value.toDate().toISOString(); }
      if(typeof value.seconds === 'number'){ return new Date(value.seconds * 1000).toISOString(); }
      return null;
    }
    function formatDateTime(iso){
      if(!iso) return '-';
      const date = new Date(iso);
      if(Number.isNaN(date.getTime())) return '-';
      const d = String(date.getDate()).padStart(2,'0');
      const m = String(date.getMonth()+1).padStart(2,'0');
      const y = date.getFullYear();
      const h = String(date.getHours()).padStart(2,'0');
      const min = String(date.getMinutes()).padStart(2,'0');
      return `${d}/${m}/${y} ${h}:${min}`;
    }
    function formatDateFromISO(iso){
      if(!iso) return '';
      const date = new Date(iso);
      if(Number.isNaN(date.getTime())) return '';
      const d = String(date.getDate()).padStart(2,'0');
      const m = String(date.getMonth()+1).padStart(2,'0');
      const y = date.getFullYear();
      return `${d}/${m}/${y}`;
    }
    function isValidUrl(url){
      if(!url) return false;
      return /^https?:\/\//i.test(url.trim());
    }
    function debounce(fn, wait=300){
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(null, args), wait);
      };
    }
    function evaluateDeadline(deadline, completed){
      if(!deadline) return null;
      const target = parseDate(deadline);
      if(!target) return null;
      const today = new Date(); today.setHours(0,0,0,0);
      const diff = Math.ceil((target - today) / DAY_MS);
      if(completed){
        return { status:'completed', diffDays: diff, text:'', className:'' };
      }
      if(diff < 0){
        return { status:'danger', diffDays: diff, text:`Qu√° h·∫°n ${Math.abs(diff)} ng√†y`, className:'deadline-danger' };
      }
      if(diff <= 7){
        const text = diff === 0 ? 'H·∫°n h√¥m nay' : `C√≤n ${diff} ng√†y`;
        return { status:'warning', diffDays: diff, text, className:'deadline-warning' };
      }
      return { status:'safe', diffDays: diff, text:`C√≤n ${diff} ng√†y`, className:'deadline-safe' };
    }

    function sanitizeTaskState(){
      const sanitized = {};
      Object.keys(taskState).forEach(id => {
        const state = taskState[id] || {};
        sanitized[id] = {
          completed: !!state.completed,
          link: (state.link || '').trim(),
          completedAt: normalizeTimestamp(state.completedAt),
          updatedAt: normalizeTimestamp(state.updatedAt),
        };
      });
      return sanitized;
    }

    function ensureTaskEntry(id){
      if(!taskState[id]){
        taskState[id] = {
          completed: false,
          link: '',
          completedAt: null,
          updatedAt: null,
        };
      }
      return taskState[id];
    }

    function normalizeTaskState(rawState){
      const defaults = buildDefaultTaskState();
      const normalized = {};
      Object.keys(defaults).forEach(id => {
        const existing = rawState && rawState[id] ? rawState[id] : {};
        normalized[id] = {
          completed: !!existing.completed,
          link: (existing.link || '').trim(),
          completedAt: normalizeTimestamp(existing.completedAt),
          updatedAt: normalizeTimestamp(existing.updatedAt),
        };
      });
      return normalized;
    }

    function showLinkFeedback(taskId, message = '', type = 'error'){
      const feedbackEl = document.querySelector(`[data-link-feedback="${taskId}"]`);
      if(!feedbackEl) return;
      if(linkFeedbackTimers[taskId]){
        clearTimeout(linkFeedbackTimers[taskId]);
        delete linkFeedbackTimers[taskId];
      }
      if(!message){
        feedbackEl.textContent = '';
        feedbackEl.classList.remove('show');
        return;
      }
      feedbackEl.textContent = message;
      feedbackEl.classList.add('show');
      feedbackEl.style.color = type === 'success' ? '#047857' : '#b91c1c';
      linkFeedbackTimers[taskId] = setTimeout(() => {
        feedbackEl.classList.remove('show');
        feedbackEl.textContent = '';
        delete linkFeedbackTimers[taskId];
      }, 2500);
    }

    function showNoteTypeFeedback(message = '', type = 'info'){
      const feedbackEl = $('#note-type-feedback');
      if(!feedbackEl) return;
      if(noteTypeFeedbackTimer){
        clearTimeout(noteTypeFeedbackTimer);
        noteTypeFeedbackTimer = null;
      }
      if(!message){
        feedbackEl.textContent = '';
        feedbackEl.classList.add('hidden');
        return;
      }
      const color = type === 'error' ? '#dc2626' : type === 'success' ? '#047857' : '#1f2937';
      feedbackEl.style.color = color;
      feedbackEl.textContent = message;
      feedbackEl.classList.remove('hidden');
      noteTypeFeedbackTimer = setTimeout(() => {
        feedbackEl.classList.add('hidden');
        feedbackEl.textContent = '';
        noteTypeFeedbackTimer = null;
      }, 2500);
    }
    function computeTaskSchedule(){
      const segmentTimeline = {};
      let cursor = new Date(projectPlanStart);
      timelineSegments.forEach((segment, index) => {
        const start = new Date(cursor);
        let end = new Date(start);
        end.setDate(end.getDate() + segment.duration - 1);
        if(index === timelineSegments.length - 1){
          end = new Date(projectLaunchDate);
        }
        segmentTimeline[segment.week] = { start, end };
        cursor = new Date(end);
        cursor.setDate(cursor.getDate() + 1);
      });

      const tasksByWeek = tasksData.reduce((acc, task) => {
        if(!acc[task.week]) acc[task.week] = [];
        acc[task.week].push(task);
        return acc;
      }, {});

      Object.entries(tasksByWeek).forEach(([week, list]) => {
        const timeline = segmentTimeline[week];
        if(!timeline) return;
        const segmentStart = new Date(timeline.start);
        const segmentEnd = new Date(timeline.end);
        const segmentDuration = Math.max(1, Math.round((segmentEnd - segmentStart) / DAY_MS) + 1);
        const baseDuration = Math.max(1, Math.floor(segmentDuration / list.length));
        let remainder = segmentDuration - baseDuration * list.length;
        let currentStart = new Date(segmentStart);

        list.forEach((task, index) => {
          let duration = baseDuration;
          if(remainder > 0){
            duration += 1;
            remainder -= 1;
          }
          const taskStart = new Date(currentStart);
          let taskEnd = new Date(taskStart);
          if(index === list.length - 1){
            taskEnd = new Date(segmentEnd);
          } else {
            taskEnd.setDate(taskEnd.getDate() + duration - 1);
          }
          task.startDate = formatDate(taskStart);
          task.endDate = formatDate(taskEnd);
          task.deadline = task.endDate;
          task.durationDays = Math.max(1, Math.round((taskEnd - taskStart) / DAY_MS) + 1);
          currentStart = new Date(taskEnd);
          currentStart.setDate(currentStart.getDate() + 1);
        });
      });
    }

    computeTaskSchedule();

    function buildDefaultTaskState(){
      const state = {};
      tasksData.forEach(t => {
        state[t.id] = {
          completed: false,
          link: '',
          completedAt: null,
          updatedAt: null,
        };
      });
      return state;
    }

    taskState = buildDefaultTaskState();

    // ========= RENDER =========
    function createTaskCard(t){
      const card = document.createElement('div');
      card.className = 'task-card';
      card.id = 'task-card-' + t.id;
      card.dataset.phase = t.phase;
      card.dataset.start = t.startDate || '';
      card.dataset.end = t.endDate || '';
      card.innerHTML = `
        <div class="task-header">
          <h4 class="task-title">${t.title}</h4>
          <span id="task-status-${t.id}" class="task-status status-pending">CH∆ØA XONG</span>
        </div>
        <div class="task-details">
          <div class="task-details-label">Chi ti·∫øt:</div>
          <ul class="task-detail-list">${t.details.map(d=>`<li>${d}</li>`).join('')}</ul>
        </div>
        <div class="task-meta">
          <span>B·∫Øt ƒë·∫ßu: <strong>${t.startDate}</strong></span><span>|</span>
          <span>Ho√†n th√†nh d·ª± ki·∫øn: <strong>${t.endDate}</strong></span><span>|</span>
          <span>Th·ªùi l∆∞·ª£ng: ${t.durationDays || 1} ng√†y</span><span>|</span>
          <span>Ph·ª• tr√°ch: ${t.owner}</span>
          <span class="deadline-countdown" data-deadline="${t.deadline}"></span>
        </div>
        <div class="task-action-area">
          <div class="task-input-group" data-input-group="${t.id}">
            <input type="url" class="task-link-input" data-task-id="${t.id}" data-phase="${t.phase}" placeholder="D√°n link (t√†i li·ªáu, file, trang k·∫øt qu·∫£...)"/>
            <button type="button" class="task-btn btn-complete task-complete-btn" data-task-id="${t.id}" disabled>Ho√†n Th√†nh</button>
          </div>
          <div class="task-link-feedback" data-link-feedback="${t.id}"></div>
          <div class="task-completed-actions hidden" data-completed-actions="${t.id}">
            <button type="button" class="task-btn btn-view task-view-btn" data-view-btn="${t.id}" disabled>View</button>
            <div class="edit-dropdown-wrapper">
              <button type="button" class="task-icon-btn" data-dropdown-btn="${t.id}" aria-label="T√πy ch·ªçn ch·ªânh s·ª≠a task">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M16.768 3.768a2 2 0 112.828 2.828L7 19.192 3 21l1.808-4z"></path></svg>
              </button>
              <div class="edit-dropdown-menu" data-dropdown-menu="${t.id}">
                <div class="dropdown-item" data-action="edit" data-task-id="${t.id}"><span>‚úèÔ∏è</span><span>Ch·ªânh s·ª≠a</span></div>
                <div class="dropdown-item delete" data-action="delete" data-task-id="${t.id}"><span>üóëÔ∏è</span><span>X√≥a</span></div>
              </div>
            </div>
          </div>
        </div>`;
      return card;
    }

    function renderTasks(){
      const mounts = {
        'gd1-week1-2': $('#gd1-week1-2'),
        'gd1-week3-4': $('#gd1-week3-4'),
        'gd2-week5-8': $('#gd2-week5-8'),
        'gd2-week9-11': $('#gd2-week9-11'),
        'gd2-week12-13': $('#gd2-week12-13'),
        'gd3-week14-15': $('#gd3-week14-15'),
        'gd3-week16-17': $('#gd3-week16-17'),
        'gd4-week18': $('#gd4-week18'),
      };
      Object.values(mounts).forEach(n => { if(n) n.innerHTML = ''; });
      tasksData.forEach(t => {
        ensureTaskEntry(t.id);
        const m = mounts[t.week];
        if(m) m.appendChild(createTaskCard(t));
      });

      allTasks = $$('.task-link-input').map(input => {
        const card = input.closest('.task-card');
        const deadlineSpan = card ? card.querySelector('.deadline-countdown') : null;
        return {
          id: input.dataset.taskId,
          phase: input.dataset.phase,
          deadline: deadlineSpan ? deadlineSpan.dataset.deadline : null,
          title: card ? card.querySelector('.task-title').textContent : '',
          startDate: card ? card.dataset.start : null,
          endDate: card ? card.dataset.end : null,
        };
      });
    }

    function updateShareLink(projectId){
      const shareInfo = $('#project-share-info');
      const shareUrlEl = $('#project-share-url');
      const idLabel = $('#project-id-label');
      if(!shareInfo || !shareUrlEl || !idLabel) return;
      const url = new URL(window.location.href);
      url.searchParams.set('projectId', projectId);
      shareUrlEl.textContent = url.toString();
      idLabel.textContent = `M√£ d·ª± √°n: ${projectId}`;
      shareInfo.classList.remove('hidden');
    }

    function ensureProjectReady(showAlert = true){
      if(isProjectReady) return true;
      if(showAlert && !hasShownSyncWarning){
        alert('H·ªá th·ªëng ƒëang k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau √≠t ph√∫t.');
        hasShownSyncWarning = true;
      }
      return false;
    }

    function handleViewLink(id){
      if(!ensureProjectReady(false)) return;
      const state = taskState[id];
      if(state && state.link){
        window.open(state.link, '_blank', 'noopener');
      } else {
        alert('Ch∆∞a c√≥ link ƒë·ªÉ xem cho task n√†y.');
      }
    }

    // ========= UI / LOGIC =========
    const deleteTaskModal = $('#delete-task-modal');
    const confirmDeleteTaskBtn = $('#confirm-delete-task-btn');
    const cancelDeleteTaskBtn = $('#cancel-delete-task-btn');
    const deleteNoteModal = $('#delete-note-modal');
    const confirmDeleteNoteBtn = $('#confirm-delete-note-btn');
    const cancelDeleteNoteBtn = $('#cancel-delete-note-btn');

    let currentDeleteTaskId = null;
    let currentDeleteNoteId = null;

    function bindTaskEvents(){
      taskInputs = $$('.task-link-input');
      completeButtons = $$('.task-complete-btn');
      viewButtons = $$('.task-view-btn');

      taskInputs.forEach(inp => {
        const taskId = inp.dataset.taskId;
        ensureTaskEntry(taskId);
        inp.addEventListener('input', e => {
          const id = e.target.dataset.taskId;
          const link = e.target.value.trim();
          const state = ensureTaskEntry(id);
          const previous = state.link || '';
          state.link = link;
          showLinkFeedback(id, '');
          const group = document.querySelector(`[data-input-group="${id}"]`);
          const btn = group ? group.querySelector('.task-complete-btn') : null;
          if(btn) btn.disabled = !isProjectReady;
          if(previous !== link){
            state.updatedAt = new Date().toISOString();
            if(isProjectReady) debouncedSyncTaskState();
            renderActivityLog();
          }
        });
        inp.addEventListener('blur', e => {
          const id = e.target.dataset.taskId;
          const value = e.target.value.trim();
          if(value && !isValidUrl(value)){
            showLinkFeedback(id, 'Link ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng http:// ho·∫∑c https://', 'error');
          }
        });
      });

      completeButtons.forEach(btn => {
        btn.addEventListener('click', e => {
          if(!ensureProjectReady()) return;
          const id = e.currentTarget.dataset.taskId;
          const state = ensureTaskEntry(id);
          const link = (state.link || '').trim();
          if(link && !isValidUrl(link)){
            showLinkFeedback(id, 'Link ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng http:// ho·∫∑c https://', 'error');
            return;
          }
          const nowIso = new Date().toISOString();
          state.completed = true;
          state.completedAt = nowIso;
          state.updatedAt = nowIso;
          taskState[id] = state;
          updateUI();
          renderActivityLog();
          syncTaskState();
          showLinkFeedback(id, '');
        });
      });

      viewButtons.forEach(btn => {
        btn.addEventListener('click', e => {
          const id = e.currentTarget.dataset.viewBtn;
          handleViewLink(id);
        });
      });
    }

    function setupDropdowns(){
      $$('[data-dropdown-btn]').forEach(btn => {
        btn.addEventListener('click', function(e){
          e.stopPropagation();
          const id = this.dataset.dropdownBtn;
          const menu = document.querySelector(`[data-dropdown-menu="${id}"]`);
          $$('.edit-dropdown-menu').forEach(m => { if(m !== menu) m.classList.remove('show'); });
          if(menu) menu.classList.toggle('show');
        });
      });

      $$('.dropdown-item').forEach(item => {
        item.addEventListener('click', function(e){
          e.stopPropagation();
          const action = this.dataset.action;
          const id = this.dataset.taskId;
          const menu = this.closest('.edit-dropdown-menu');
          if(menu) menu.classList.remove('show');
          if(action === 'edit') handleEditTask(id);
          else if(action === 'delete') handleDeleteTaskClick(id);
        });
      });

      document.addEventListener('click', () => $$('.edit-dropdown-menu').forEach(m => m.classList.remove('show')));
      document.addEventListener('keydown', (e) => { if(e.key === 'Escape') $$('.edit-dropdown-menu').forEach(m => m.classList.remove('show')); });
    }

    function handleEditTask(id){
      if(!ensureProjectReady()) return;
      const state = ensureTaskEntry(id);
      state.completed = false;
      state.completedAt = null;
      state.updatedAt = new Date().toISOString();
      updateUI();
      renderActivityLog();
      syncTaskState();
      showLinkFeedback(id, '');
      setTimeout(() => {
        const input = document.querySelector(`[data-task-id="${id}"]`);
        if(input){ input.disabled = false; input.focus(); input.select(); }
      }, 80);
    }
    function handleDeleteTaskClick(id){
      if(!ensureProjectReady()) return;
      currentDeleteTaskId = id;
      if(deleteTaskModal){
        deleteTaskModal.classList.add('active');
        deleteTaskModal.setAttribute('aria-hidden','false');
      }
    }
    function confirmDeleteTask(){
      const id = currentDeleteTaskId;
      if(!id || !taskState[id]) return;
      taskState[id] = {
        completed:false,
        link:'',
        completedAt:null,
        updatedAt:new Date().toISOString(),
      };
      updateUI();
      renderActivityLog();
      syncTaskState();
      currentDeleteTaskId = null;
      if(deleteTaskModal){
        deleteTaskModal.classList.remove('active');
        deleteTaskModal.setAttribute('aria-hidden','true');
      }
      showLinkFeedback(id, '');
    }
    function cancelDeleteTask(){
      currentDeleteTaskId = null;
      if(deleteTaskModal){
        deleteTaskModal.classList.remove('active');
        deleteTaskModal.setAttribute('aria-hidden','true');
      }
    }

    function initChart(){
      const canvas = document.getElementById('progressChart');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      progressChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels:['Ho√†n Th√†nh','Ch∆∞a Xong'], datasets:[{ data:[0,0], backgroundColor:['#10b981','#e5e7eb'], hoverOffset:4 }] },
        options: { responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{ legend:{ position:'bottom' } } }
      });
    }

    function calculateDeadlines(){
      const upcomingList = $('#upcoming-deadlines-list');
      const upcomingContainer = $('#upcoming-deadlines-container');
      const overdueList = $('#overdue-tasks-list');
      const overdueContainer = $('#overdue-tasks-container');
      if(!upcomingList || !overdueList) return;

      upcomingList.innerHTML = '';
      overdueList.innerHTML = '';
      let upcomingCount = 0, overdueCount = 0;

      allTasks.forEach(task => {
        const state = ensureTaskEntry(task.id);
        if(!task.deadline) return;
        if(state.completed) return;
        const info = evaluateDeadline(task.deadline, false);
        if(!info) return;
        if(info.status === 'danger'){
          const li = document.createElement('li');
          li.innerHTML = `<b>${task.title}</b>: ${task.deadline} <span class="text-red-600 font-semibold">(${info.text})</span>`;
          overdueList.appendChild(li);
          overdueCount++;
        } else if(info.status === 'warning'){
          const li = document.createElement('li');
          li.innerHTML = `<b>${task.title}</b>: ${task.deadline} <span class="text-orange-600 font-semibold">(${info.text})</span>`;
          upcomingList.appendChild(li);
          upcomingCount++;
        }
      });

      if(upcomingContainer) upcomingContainer.classList.toggle('hidden', upcomingCount === 0);
      if(overdueContainer) overdueContainer.classList.toggle('hidden', overdueCount === 0);
    }

    function renderActivityLog(){
      const tbody = $('#activity-log-body');
      const countLabel = $('#activity-log-count');
      const toggleBtn = $('#activity-log-toggle');
      if(!tbody) return;

      const sanitized = sanitizeTaskState();
      const entries = Object.keys(sanitized).map(id => {
        const state = sanitized[id];
        const meta = taskMap[id] || {};
        const getTime = (iso) => {
          if(!iso) return 0;
          const time = new Date(iso).getTime();
          return Number.isFinite(time) ? time : 0;
        };
        const completedAt = state.completedAt || null;
        const updatedAt = state.updatedAt || null;
        const lastActivity = Math.max(getTime(completedAt), getTime(updatedAt));
        return {
          id,
          title: meta.title || `Task ${id}`,
          phase: meta.phase || '',
          completedAt,
          updatedAt,
          lastActivity,
        };
      }).filter(entry => entry.completedAt || entry.updatedAt).sort((a,b) => b.lastActivity - a.lastActivity);

      const total = entries.length;
      const visibleEntries = activityLogShowAll ? entries : entries.slice(0, 10);

      tbody.innerHTML = '';
      if(visibleEntries.length === 0){
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-6">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.</td></tr>';
      } else {
        visibleEntries.forEach(entry => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${entry.completedAt ? formatDateTime(entry.completedAt) : '-'}</td>
            <td>${entry.updatedAt ? formatDateTime(entry.updatedAt) : '-'}</td>
            <td><button type="button" class="task-log-link" data-jump-task="${entry.id}">${entry.title}</button></td>
            <td>${phaseLabels[entry.phase] || entry.phase || '-'}</td>`;
          tbody.appendChild(tr);
        });
      }

      if(countLabel){
        if(total === 0){
          countLabel.textContent = 'Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o';
        } else {
          const shown = visibleEntries.length;
          countLabel.textContent = activityLogShowAll ? `ƒêang hi·ªÉn th·ªã ${shown} ho·∫°t ƒë·ªông` : `Hi·ªÉn th·ªã ${shown}/${total} ho·∫°t ƒë·ªông g·∫ßn nh·∫•t`;
        }
      }

      if(toggleBtn){
        if(total > 10 && !activityLogShowAll){
          toggleBtn.classList.remove('hidden');
        } else {
          toggleBtn.classList.add('hidden');
        }
      }
    }

    function updateUI(){
      let total = 0, done = 0;
      const phaseCounts = { gd1:{total:0,completed:0}, gd2:{total:0,completed:0}, gd3:{total:0,completed:0}, gd4:{total:0,completed:0} };

      allTasks.forEach(task => {
        const state = ensureTaskEntry(task.id);
        total++;
        if(phaseCounts[task.phase]) phaseCounts[task.phase].total++;

        const card = document.getElementById('task-card-'+task.id);
        const statusBadge = document.getElementById('task-status-'+task.id);
        const input = document.querySelector(`[data-task-id="${task.id}"]`);
        const inputGroup = document.querySelector(`[data-input-group="${task.id}"]`);
        const actions = document.querySelector(`[data-completed-actions="${task.id}"]`);
        const viewBtn = actions ? actions.querySelector('[data-view-btn]') : null;
        const countdownSpan = card ? card.querySelector('.deadline-countdown') : null;
        const deadlineInfo = evaluateDeadline(task.deadline, state.completed);
        const isOverdueTask = deadlineInfo && deadlineInfo.status === 'danger';

        if(input) input.value = state.link || '';

        if(state.completed){
          done++;
          if(phaseCounts[task.phase]) phaseCounts[task.phase].completed++;
          if(card){ card.classList.add('completed'); card.classList.remove('overdue'); }
          if(statusBadge){ statusBadge.className = 'task-status status-completed'; statusBadge.textContent = 'HO√ÄN TH√ÄNH'; }
          if(inputGroup) inputGroup.classList.add('hidden');
          if(actions) actions.classList.remove('hidden');
          if(input) input.disabled = true;
          if(viewBtn){
            const disabled = !isProjectReady || (state.link || '').trim() === '';
            viewBtn.disabled = disabled;
            viewBtn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
          }
          if(countdownSpan){
            const completedText = formatDateFromISO(state.completedAt);
            countdownSpan.className = 'deadline-countdown deadline-safe';
            countdownSpan.textContent = completedText ? `Ho√†n th√†nh: ${completedText}` : 'ƒê√£ ho√†n th√†nh';
          }
        } else {
          if(card){
            card.classList.remove('completed');
            if(isOverdueTask) card.classList.add('overdue'); else card.classList.remove('overdue');
          }
          if(statusBadge){
            const statusClass = isOverdueTask ? 'status-overdue' : 'status-pending';
            statusBadge.className = 'task-status ' + statusClass;
            statusBadge.textContent = isOverdueTask ? 'QU√Å H·∫†N' : 'CH∆ØA XONG';
          }
          if(inputGroup) inputGroup.classList.remove('hidden');
          if(actions) actions.classList.add('hidden');
          if(input) input.disabled = false;
          const btn = inputGroup ? inputGroup.querySelector('.task-complete-btn') : null;
          if(btn) btn.disabled = !isProjectReady;
          if(viewBtn){
            viewBtn.disabled = true;
            viewBtn.setAttribute('aria-disabled','true');
          }
          if(countdownSpan){
            countdownSpan.className = 'deadline-countdown' + (deadlineInfo ? ` ${deadlineInfo.className}` : '');
            countdownSpan.textContent = deadlineInfo && deadlineInfo.text ? deadlineInfo.text : '';
          }
        }
      });

      const totalText = $('#total-progress-text');
      const totalBar = $('#total-progress-bar');
      if(totalText) totalText.textContent = `${done} / ${total} Tasks`;
      if(totalBar) totalBar.style.width = (total > 0 ? (done/total)*100 : 0) + '%';

      ['gd1','gd2','gd3','gd4'].forEach(ph => {
        const d = phaseCounts[ph];
        const pct = d.total > 0 ? (d.completed/d.total)*100 : 0;
        const t = document.getElementById(`${ph}-progress-text`);
        const b = document.getElementById(`${ph}-progress-bar`);
        if(t) t.textContent = `${d.completed} / ${d.total}`;
        if(b) b.style.width = pct + '%';
      });

      if(progressChart){
        progressChart.data.datasets[0].data = [done, Math.max(0, total - done)];
        progressChart.update();
      }

      calculateDeadlines();
      renderActivityLog();
    }

    // ========= NOTES =========
    function renderNotes(){
      const tbody = $('#notes-list-container'); if(!tbody) return;
      tbody.innerHTML = '';
      if(filteredNotes.length === 0){
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-8">Ch∆∞a c√≥ ghi ch√∫ n√†o.</td></tr>';
        return;
      }
      filteredNotes.slice().reverse().forEach(n => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${n.date}</td>
                        <td><span class="custom-type-item">${n.type}</span></td>
                        <td style="white-space:pre-wrap;">${n.content.replace(/\n/g,'<br>')}</td>
                        <td style="text-align:center;"><span class="note-delete-btn" data-note-id="${n.id}">üóëÔ∏è</span></td>`;
        tbody.appendChild(tr);
      });
      $$('.note-delete-btn').forEach(btn => btn.addEventListener('click', e => {
        currentDeleteNoteId = e.target.dataset.noteId;
        deleteNoteModal.classList.add('active');
        deleteNoteModal.setAttribute('aria-hidden','false');
      }));
    }

    function applyFilters(){
      const from = $('#filter-date-from'); const to = $('#filter-date-to'); const type = $('#filter-type');
      filteredNotes = notes.filter(n => {
        const [d,m,y] = n.date.split(' ')[0].split('/').map(Number);
        const nDate = new Date(y, m-1, d);
        if(from && from.value){ const f = new Date(from.value); if(nDate < f) return false; }
        if(to && to.value){ const t = new Date(to.value); if(nDate > t) return false; }
        if(type && type.value && n.type !== type.value) return false;
        return true;
      });
      renderNotes();
    }
    function resetFilters(){
      const from = $('#filter-date-from'), to = $('#filter-date-to'), type = $('#filter-type');
      if(from) from.value = ''; if(to) to.value = ''; if(type) type.value = '';
      filteredNotes = notes.slice(); renderNotes();
    }

    async function saveNewNote(){
      if(!ensureProjectReady()) return;
      const textarea = $('#notes-textarea'); if(!textarea) return;
      const content = textarea.value.trim();
      if(!content){ alert('Vui l√≤ng nh·∫≠p n·ªôi dung ghi ch√∫'); return; }
      if(!selectedNoteType){ alert('Vui l√≤ng ch·ªçn lo·∫°i ghi ch√∫'); return; }
      const now = new Date();
      const id = now.getTime();
      const date = now.toLocaleString('vi-VN',{ day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
      notes.push({ id, date, type:selectedNoteType, content });
      textarea.value = '';
      applyFilters();
      await updateProjectData({ notes });
    }

    async function confirmDeleteNote(){
      if(!currentDeleteNoteId) return;
      notes = notes.filter(n => String(n.id) !== String(currentDeleteNoteId));
      currentDeleteNoteId = null;
      if(deleteNoteModal){
        deleteNoteModal.classList.remove('active');
        deleteNoteModal.setAttribute('aria-hidden','true');
      }
      applyFilters();
      if(isProjectReady) await updateProjectData({ notes });
    }
    function cancelDeleteNote(){
      currentDeleteNoteId = null;
      deleteNoteModal.classList.remove('active');
      deleteNoteModal.setAttribute('aria-hidden','true');
    }

    // ========= NOTE TYPE DROPDOWN =========
    function renderNoteTypeDropdown(){
      const dropdown = $('#note-type-dropdown');
      const triggerLabel = $('#note-type-trigger-label');
      const optionsContainer = $('#note-type-options');
      const input = $('#note-type-new-input');
      const createBtn = $('#note-type-create-btn');

      if(triggerLabel){
        triggerLabel.textContent = selectedNoteType ? `Lo·∫°i: ${selectedNoteType}` : 'Ch·ªçn lo·∫°i ghi ch√∫';
      }

      if(optionsContainer){
        optionsContainer.innerHTML = '';
        if(customTypes.length === 0){
          const empty = document.createElement('div');
          empty.className = 'text-sm text-gray-500 py-2';
          empty.textContent = 'Ch∆∞a c√≥ lo·∫°i ghi ch√∫.';
          optionsContainer.appendChild(empty);
        } else {
          customTypes.forEach(type => {
            const option = document.createElement('div');
            option.className = 'note-type-option' + (selectedNoteType === type ? ' active' : '');
            option.setAttribute('data-note-type-option', type);
            option.setAttribute('role','option');
            option.tabIndex = 0;
            option.innerHTML = `<span>${type}</span><button type="button" class="note-type-remove" data-remove-type="${type}" title="X√≥a ${type}">üóëÔ∏è</button>`;
            optionsContainer.appendChild(option);
          });
        }
      }

      const atLimit = customTypes.length >= 10;
      const currentValue = input ? input.value.trim() : '';
      if(input){
        input.disabled = atLimit;
        if(atLimit) input.value = '';
        input.placeholder = atLimit ? 'ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 10 lo·∫°i' : 'Th√™m lo·∫°i m·ªõi...';
      }
      if(createBtn) createBtn.disabled = atLimit || currentValue === '';

      if(atLimit){
        showNoteTypeFeedback('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 10 lo·∫°i ghi ch√∫', 'error');
      } else if(currentValue === ''){
        showNoteTypeFeedback('');
      }

      if(dropdown){
        const trigger = $('#note-type-trigger');
        if(trigger) trigger.setAttribute('aria-expanded', dropdown.classList.contains('open') ? 'true' : 'false');
      }
    }

    function updateTypeFilterOptions(){
      const filterSel = $('#filter-type');
      if(!filterSel) return;
      const previous = filterSel.value;
      filterSel.innerHTML = '<option value="">T·∫•t c·∫£ lo·∫°i</option>';
      customTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        filterSel.appendChild(option);
      });
      if(previous && customTypes.includes(previous)){
        filterSel.value = previous;
      }
    }

    function closeNoteTypeDropdown(){
      const dropdown = $('#note-type-dropdown');
      const trigger = $('#note-type-trigger');
      if(dropdown) dropdown.classList.remove('open');
      if(trigger) trigger.setAttribute('aria-expanded','false');
    }

    async function setSelectedNoteType(type){
      if(!type || !customTypes.includes(type)) return;
      if(selectedNoteType === type) return;
      selectedNoteType = type;
      renderNoteTypeDropdown();
      if(isProjectReady) await updateProjectData({ selectedNoteType });
    }

    async function addNewNoteType(value){
      const name = (value || '').trim();
      if(!name){
        showNoteTypeFeedback('Vui l√≤ng nh·∫≠p t√™n lo·∫°i ghi ch√∫', 'error');
        return;
      }
      const exists = customTypes.some(t => t.toLowerCase() === name.toLowerCase());
      if(exists){
        showNoteTypeFeedback('Lo·∫°i ƒë√£ t·ªìn t·∫°i', 'error');
        return;
      }
      if(customTypes.length >= 10){
        showNoteTypeFeedback('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 10 lo·∫°i ghi ch√∫', 'error');
        return;
      }
      customTypes.push(name);
      selectedNoteType = name;
      renderNoteTypeDropdown();
      updateTypeFilterOptions();
      closeNoteTypeDropdown();
      const input = $('#note-type-new-input');
      if(input){
        input.value = '';
        const createBtnEl = $('#note-type-create-btn');
        if(createBtnEl) createBtnEl.disabled = true;
      }
      showNoteTypeFeedback(`ƒê√£ th√™m "${name}"`, 'success');
      if(isProjectReady) await updateProjectData({ customTypes, selectedNoteType });
    }

    async function removeNoteType(type){
      if(!customTypes.includes(type)) return;
      if(customTypes.length <= 1){
        alert('C·∫ßn √≠t nh·∫•t 1 lo·∫°i ghi ch√∫');
        return;
      }
      customTypes = customTypes.filter(t => t !== type);
      const fallback = customTypes[0] || defaultCustomTypes[0] || 'Kh√°c';
      notes = notes.map(note => note.type === type ? { ...note, type: fallback } : note);
      if(selectedNoteType === type) selectedNoteType = fallback;
      renderNoteTypeDropdown();
      updateTypeFilterOptions();
      applyFilters();
      showNoteTypeFeedback(`ƒê√£ x√≥a "${type}"`, 'info');
      if(isProjectReady) await updateProjectData({ customTypes, notes, selectedNoteType });
    }

    function bindNoteTypeDropdown(){
      const dropdown = $('#note-type-dropdown');
      const trigger = $('#note-type-trigger');
      const optionsContainer = $('#note-type-options');
      const input = $('#note-type-new-input');
      const createBtn = $('#note-type-create-btn');

      if(trigger){
        trigger.addEventListener('click', e => {
          e.preventDefault();
          if(!dropdown) return;
          dropdown.classList.toggle('open');
          trigger.setAttribute('aria-expanded', dropdown.classList.contains('open') ? 'true' : 'false');
        });
      }

      if(optionsContainer){
        optionsContainer.addEventListener('click', e => {
          const removeBtn = e.target.closest('[data-remove-type]');
          const option = e.target.closest('[data-note-type-option]');
          if(removeBtn){
            e.stopPropagation();
            if(!ensureProjectReady()) return;
            removeNoteType(removeBtn.getAttribute('data-remove-type'));
          } else if(option){
            const type = option.getAttribute('data-note-type-option');
            setSelectedNoteType(type);
            closeNoteTypeDropdown();
          }
        });
      }

      if(createBtn && input){
        createBtn.addEventListener('click', () => {
          if(!ensureProjectReady()) return;
          addNewNoteType(input.value);
        });
        input.addEventListener('input', () => {
          if(createBtn) createBtn.disabled = customTypes.length >= 10 || input.value.trim() === '';
          if(input.value.trim() !== '') showNoteTypeFeedback('');
        });
        input.addEventListener('keypress', e => {
          if(e.key === 'Enter'){
            e.preventDefault();
            if(!ensureProjectReady()) return;
            addNewNoteType(input.value);
          }
        });
      }

      document.addEventListener('click', e => {
        if(dropdown && !dropdown.contains(e.target)){
          closeNoteTypeDropdown();
        }
      });

      document.addEventListener('keydown', e => {
        if(e.key === 'Escape') closeNoteTypeDropdown();
      });
    }

    // ========= NAV =========
    function showSection(id){ $$('.content-section').forEach(s => s.classList.toggle('hidden', s.id !== id)); const main = document.querySelector('main'); if(main) main.scrollTop = 0; }
    function navigateToTask(taskId){
      if(!taskId) return;
      const meta = taskMap[taskId];
      const sectionId = meta ? meta.phase : null;
      if(sectionId){
        const navLink = document.querySelector(`.nav-link[data-target="${sectionId}"]`);
        if(navLink){
          $$('.nav-link').forEach(n => n.classList.remove('active'));
          navLink.classList.add('active');
        }
        showSection(sectionId);
      }
      const card = document.getElementById('task-card-' + taskId);
      if(card){
        card.scrollIntoView({ behavior:'smooth', block:'center' });
        card.classList.add('ring-2','ring-offset-2','ring-blue-400');
        setTimeout(() => {
          card.classList.remove('ring-2','ring-offset-2','ring-blue-400');
        }, 2000);
      }
    }
    function bindNav(){
      $$('.nav-link').forEach(link => link.addEventListener('click', e => {
        e.preventDefault();
        const targetId = link.getAttribute('data-target');
        $$('.nav-link').forEach(n => n.classList.remove('active'));
        link.classList.add('active');
        showSection(targetId);
        if(window.innerWidth < 1024){ const sidebar = $('#sidebar'); if(sidebar) sidebar.classList.remove('open'); }
      }));
      const openBtn = $('#open-menu'), closeBtn = $('#close-menu'), sidebar = $('#sidebar');
      if(openBtn) openBtn.addEventListener('click', e => { e.stopPropagation(); if(sidebar) sidebar.classList.add('open'); });
      if(closeBtn) closeBtn.addEventListener('click', () => { if(sidebar) sidebar.classList.remove('open'); });
      document.addEventListener('click', e => {
        if(window.innerWidth < 1024 && sidebar){
          if(!sidebar.contains(e.target) && e.target !== openBtn && !(openBtn && openBtn.contains(e.target))){
            sidebar.classList.remove('open');
          }
        }
      });
    }

    function ensureProjectId(){
      const params = new URLSearchParams(window.location.search);
      let id = params.get('projectId');
      if(!id){
        id = `proj-${Math.random().toString(36).slice(2,6)}${Date.now().toString(36)}`;
        params.set('projectId', id);
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.replaceState({}, '', newUrl);
      }
      return id;
    }

    async function updateProjectData(partial){
      if(!projectRef) return;
      try {
        await updateDoc(projectRef, { ...partial, updatedAt: serverTimestamp() });
      } catch(error){
        console.error('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu d·ª± √°n:', error);
      }
    }

    async function syncTaskState(){
      if(!isProjectReady) return;
      await updateProjectData({ taskState: sanitizeTaskState() });
    }

    async function ensureProjectDocument(projectId){
      if(!projectRef) return;
      const snapshot = await getDoc(projectRef);
      if(!snapshot.exists()){
        await setDoc(projectRef, {
          taskState: buildDefaultTaskState(),
          notes: [],
          customTypes: defaultCustomTypes,
          selectedNoteType: defaultCustomTypes[0] || '',
          meta: {
            projectId,
            projectStart: formatDate(projectPlanStart),
            launchDate: formatDate(projectLaunchDate),
            createdAt: serverTimestamp(),
          },
          updatedAt: serverTimestamp(),
        }, { merge:true });
      } else {
        const data = snapshot.data() || {};
        const normalized = normalizeTaskState(data.taskState || {});
        const existing = data.taskState || {};
        let needsUpdate = Object.keys(existing).length !== Object.keys(normalized).length;
        if(!needsUpdate){
          needsUpdate = Object.keys(normalized).some(id => {
            const prev = existing[id] || {};
            const norm = normalized[id];
            return prev.completed !== norm.completed ||
                   (prev.link || '').trim() !== norm.link ||
                   normalizeTimestamp(prev.completedAt) !== norm.completedAt ||
                   normalizeTimestamp(prev.updatedAt) !== norm.updatedAt;
          });
        }
        if(needsUpdate){
          await updateDoc(projectRef, { taskState: normalized, updatedAt: serverTimestamp() });
        }
      }
    }

    async function initializeRealtimePersistence(){
      const firebaseConfig = window.FIREBASE_CONFIG;
      if(!firebaseConfig){
        console.error('Thi·∫øu c·∫•u h√¨nh Firebase. Vui l√≤ng g√°n window.FIREBASE_CONFIG.');
        const shareInfo = $('#project-share-info');
        if(shareInfo){
          shareInfo.classList.remove('hidden');
          shareInfo.innerHTML = '<span class="text-red-500">Thi·∫øu c·∫•u h√¨nh Firebase (window.FIREBASE_CONFIG).</span>';
        }
        return;
      }

      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      const projectId = ensureProjectId();
      projectRef = doc(db, 'projects', projectId);
      await ensureProjectDocument(projectId);

      onSnapshot(projectRef, snapshot => {
        if(!snapshot.exists()) return;
        const data = snapshot.data() || {};
        taskState = normalizeTaskState(data.taskState || {});
        notes = Array.isArray(data.notes) ? data.notes.map(note => ({ ...note })) : [];
        customTypes = Array.isArray(data.customTypes) && data.customTypes.length ? data.customTypes.slice(0,10) : defaultCustomTypes.slice();
        if(customTypes.length === 0) customTypes = defaultCustomTypes.slice();
        selectedNoteType = data.selectedNoteType && customTypes.includes(data.selectedNoteType) ? data.selectedNoteType : (customTypes[0] || '');
        filteredNotes = notes.slice();
        isProjectReady = true;
        debouncedSyncTaskState = debounce(syncTaskState, 400);
        renderNoteTypeDropdown();
        updateTypeFilterOptions();
        applyFilters();
        updateUI();
        updateShareLink(projectId);
      }, error => {
        console.error('L·ªói ƒë·ªìng b·ªô d·ªØ li·ªáu th·ªùi gian th·ª±c:', error);
      });
    }

    // ========= MODALS WIRING =========
    if(confirmDeleteTaskBtn) confirmDeleteTaskBtn.addEventListener('click', confirmDeleteTask);
    if(cancelDeleteTaskBtn) cancelDeleteTaskBtn.addEventListener('click', cancelDeleteTask);
    if(confirmDeleteNoteBtn) confirmDeleteNoteBtn.addEventListener('click', confirmDeleteNote);
    if(cancelDeleteNoteBtn) cancelDeleteNoteBtn.addEventListener('click', cancelDeleteNote);
    const deleteTaskModalEl = $('#delete-task-modal');
    const deleteNoteModalEl = $('#delete-note-modal');
    if(deleteTaskModalEl) deleteTaskModalEl.addEventListener('click', e => { if(e.target === deleteTaskModalEl) cancelDeleteTask(); });
    if(deleteNoteModalEl) deleteNoteModalEl.addEventListener('click', e => { if(e.target === deleteNoteModalEl) cancelDeleteNote(); });

    // ========= BOOT =========
    renderTasks();
    bindTaskEvents();
    setupDropdowns();
    bindNav();
    initChart();
    updateUI();
    showSection('overview');

    filteredNotes = notes.slice();
    renderNotes();
    renderNoteTypeDropdown();
    bindNoteTypeDropdown();
    updateTypeFilterOptions();

    const saveNoteBtn = $('#save-note-btn'); if(saveNoteBtn) saveNoteBtn.addEventListener('click', saveNewNote);
    const applyFilterBtn = $('#apply-filter-btn'); if(applyFilterBtn) applyFilterBtn.addEventListener('click', applyFilters);
    const resetFilterBtn = $('#reset-filter-btn'); if(resetFilterBtn) resetFilterBtn.addEventListener('click', resetFilters);
    const activityLogToggleBtn = $('#activity-log-toggle'); if(activityLogToggleBtn) activityLogToggleBtn.addEventListener('click', () => { activityLogShowAll = true; renderActivityLog(); });
    const activityLogBody = $('#activity-log-body'); if(activityLogBody) activityLogBody.addEventListener('click', e => {
      const trigger = e.target.closest('[data-jump-task]');
      if(trigger){
        e.preventDefault();
        navigateToTask(trigger.getAttribute('data-jump-task'));
      }
    });

    initializeRealtimePersistence();
  });
  </script>
</body>
</html>
