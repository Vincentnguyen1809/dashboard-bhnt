<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Master Plan: D·ªãch V·ª• Marketing BHNT ‚Äî Final</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f5f5f5; }
    .chart-container { position: relative; width:100%; max-width:350px; margin:0 auto; height:300px; max-height:350px; }
    .nav-link { display:flex; align-items:center; padding:0.625rem 1rem; border-radius:0.375rem; color:#374151; font-weight:500; font-size:0.9375rem; transition:all .15s; cursor:pointer; margin-bottom:0.25rem; }
    .nav-link:hover{ background:#e5e7eb; }
    .nav-link.active{ background:#dbeafe; color:#1e40af; }
    .nav-link .emoji{ font-size:1.25rem; margin-right:0.75rem; }
    .sidebar{ transform:translateX(-100%); transition: transform .3s; position:fixed; inset:0 auto 0 0; z-index:30; background:#fafafa; border-right:1px solid #e5e7eb; width:16rem; }
    .sidebar.open{ transform:translateX(0); }
    @media (min-width:1024px){ .sidebar{ transform:none; position:static; } }
    .task-card{ background:#fff; border-radius:0.5rem; padding:1.25rem; margin-bottom:1rem; border:1px solid #e5e7eb; transition:box-shadow .2s; }
    .task-card:hover{ box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .task-card.completed{ background:#f0fdf4; border-color:#86efac; }
    .task-card.overdue{ background:#fef2f2; border-color:#fca5a5; }
    .task-header{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.75rem; }
    .task-title{ font-size:1rem; font-weight:600; color:#111827; flex:1; padding-right:1rem; }
    .task-status{ font-size:0.6875rem; font-weight:600; padding:0.25rem 0.625rem; border-radius:0.25rem; text-transform:uppercase; letter-spacing:.025em; white-space:nowrap; }
    .status-pending{ background:#f3f4f6; color:#6b7280; }
    .status-completed{ background:#dcfce7; color:#166534; }
    .status-overdue{ background:#fee2e2; color:#991b1b; }
    .task-details{ margin-top:0.75rem; }
    .task-details-label{ font-weight:600; font-size:0.875rem; color:#374151; margin-bottom:0.5rem; }
    .task-detail-list{ list-style:disc; margin-left:1.25rem; font-size:0.875rem; color:#6b7280; line-height:1.6; }
    .task-detail-list li{ margin-bottom:0.375rem; }
    .task-meta{ font-size:0.8125rem; color:#9ca3af; margin-top:0.75rem; display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; }
    .deadline-countdown{ font-weight:600; margin-left:0.25rem; display:inline-flex; align-items:center; gap:0.25rem; }
    .deadline-safe{ color:#0f766e; }
    .deadline-warning{ color:#b45309; }
    .deadline-danger{ color:#b91c1c; }
    .task-action-area{ margin-top:1rem; padding-top:1rem; border-top:1px solid #f3f4f6; }
    .task-input-group{ display:flex; gap:0.5rem; }
    .task-link-input{ flex:1; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.5rem 0.75rem; font-size:0.875rem; color:#374151; transition:.2s; }
    .task-link-input:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .task-link-input:disabled{ background:#f9fafb; color:#9ca3af; cursor:not-allowed; }
    .task-btn{ padding:0.5rem 1rem; font-size:0.875rem; font-weight:500; border-radius:0.375rem; transition:.2s; cursor:pointer; border:none; white-space:nowrap; }
    .task-btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn-complete{ background:#10b981; color:#fff; }
    .btn-complete:hover:not(:disabled){ background:#059669; }
    .btn-view{ background:#0ea5e9; color:#fff; }
    .btn-view:hover:not(:disabled){ background:#0284c7; }
    .task-completed-actions{ display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
    .task-icon-btn{ width:2.5rem; height:2.5rem; border-radius:0.375rem; border:1px solid #d1d5db; background:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.2s; }
    .task-icon-btn:hover{ background:#e5e7eb; }
    .task-icon-btn:disabled{ cursor:not-allowed; opacity:.5; }
    .task-icon-btn svg{ width:1.1rem; height:1.1rem; color:#374151; }
    .edit-dropdown-wrapper{ position:relative; display:inline-block; }
    .edit-dropdown-menu{ display:none; position:absolute; top:100%; right:0; margin-top:0.25rem; background:#fff; border:1px solid #e5e7eb; border-radius:0.375rem; box-shadow:0 4px 6px -1px rgba(0,0,0,.1); min-width:150px; z-index:10; }
    .edit-dropdown-menu.show{ display:block; }
    .dropdown-item{ padding:0.625rem 1rem; font-size:0.875rem; color:#374151; cursor:pointer; display:flex; align-items:center; gap:0.5rem; }
    .dropdown-item:hover{ background:#f3f4f6; }
    .dropdown-item.delete{ color:#dc2626; }
    .dropdown-item.delete:hover{ background:#fef2f2; }
    .btn-cancel{ background:#e5e7eb; color:#374151; }
    .btn-cancel:hover{ background:#d1d5db; }
    .progress-bar{ background:#e5e7eb; border-radius:9999px; overflow:hidden; height:0.75rem; }
    .progress-bar-inner{ background:#3b82f6; height:100%; transition:width .5s; }
    .section-title{ font-size:1.875rem; font-weight:700; color:#111827; margin-bottom:0.75rem; }
    .section-subtitle{ font-size:1rem; color:#6b7280; margin-bottom:2rem; line-height:1.5; }
    .phase-title{ font-size:1.25rem; font-weight:600; color:#1e40af; margin-top:2rem; margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:2px solid #dbeafe; }
    .notes-textarea{ width:100%; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.75rem; font-size:0.875rem; resize:none; min-height:120px; font-family:inherit; }
    .notes-textarea:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .notes-table{ width:100%; border-collapse:collapse; font-size:0.875rem; }
    .notes-table th{ background:#f9fafb; padding:0.75rem; text-align:left; font-weight:600; color:#374151; border-bottom:2px solid #e5e7eb; }
    .notes-table td{ padding:0.75rem; border-bottom:1px solid #f3f4f6; color:#6b7280; }
    .notes-table tr:hover{ background:#f9fafb; }
    .custom-type-item{ display:inline-flex; align-items:center; gap:0.375rem; padding:0.25rem 0.75rem; background:#dbeafe; border-radius:9999px; margin:0.25rem; font-size:0.8125rem; color:#1e40af; }
    .note-type-dropdown{ position:relative; margin-top:0.75rem; }
    .note-type-trigger{ width:100%; display:flex; justify-content:space-between; align-items:center; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.6rem 0.75rem; background:#fff; font-size:0.875rem; color:#374151; cursor:pointer; transition:.2s; }
    .note-type-trigger:hover{ border-color:#3b82f6; }
    .note-type-trigger svg{ width:1rem; height:1rem; color:#6b7280; transition:transform .2s; }
    .note-type-dropdown.open .note-type-trigger svg{ transform:rotate(180deg); }
    .note-type-panel{ position:absolute; inset:calc(100% + 0.25rem) 0 auto 0; background:#fff; border:1px solid #e5e7eb; border-radius:0.5rem; box-shadow:0 10px 25px -10px rgba(15,23,42,.35); padding:0.75rem; z-index:30; display:none; }
    .note-type-dropdown.open .note-type-panel{ display:block; }
    .note-type-new{ display:flex; gap:0.5rem; margin-bottom:0.75rem; }
    .note-type-new input{ flex:1; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.45rem 0.6rem; font-size:0.875rem; }
    .note-type-new input:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.12); }
    .note-type-options{ max-height:220px; overflow-y:auto; display:flex; flex-direction:column; gap:0.35rem; }
    .note-type-option{ display:flex; justify-content:space-between; align-items:center; padding:0.45rem 0.6rem; border-radius:0.375rem; background:#f9fafb; font-size:0.875rem; cursor:pointer; transition:background .2s, color .2s, box-shadow .2s; outline:none; }
    .note-type-option:hover, .note-type-option:focus{ background:#e0f2fe; color:#1d4ed8; box-shadow:inset 0 0 0 1px #bfdbfe; }
    .note-type-option.active{ background:#dbeafe; color:#1d4ed8; font-weight:600; }
    .note-type-option span{ pointer-events:none; }
    .note-type-remove{ border:none; background:none; color:#ef4444; font-size:1rem; cursor:pointer; padding:0.125rem; line-height:1; }
    .note-type-remove:hover{ color:#b91c1c; }
    .note-type-feedback{ min-height:1rem; margin-top:0.25rem; font-size:0.75rem; display:block; }
    .note-type-feedback.hidden{ display:none; }
    .task-link-feedback{ font-size:0.75rem; margin-top:0.35rem; color:#b91c1c; display:none; }
    .task-link-feedback.show{ display:block; }
    .task-log-link{ color:#2563eb; font-weight:600; text-decoration:none; }
    .task-log-link:hover{ text-decoration:underline; }
    .activity-table th{ white-space:nowrap; }
    #cover-page{ transition:background 0.3s ease-in-out; }
    #cover-page.cover-has-image{ background-color:transparent; }
    #cover-page.cover-has-color{ background-image:none !important; }
    .filter-container{ display:flex; flex-wrap:wrap; align-items:flex-end; gap:1rem; margin-bottom:1.5rem; }
    .filter-field{ display:flex; flex-direction:column; gap:0.35rem; }
    .filter-actions{ display:flex; align-items:flex-end; }
    .filter-input, .form-select{ width:100%; border:1px solid #d1d5db; border-radius:0.375rem; padding:0.5rem 0.75rem; font-size:0.875rem; background:#fff; }
    .filter-input:focus, .form-select:focus{ outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1); }
    .time-filter-wrapper{ position:relative; }
    .custom-date-popover{ position:absolute; inset:auto auto auto 0; top:calc(100% + 0.5rem); width:18rem; max-width:90vw; background:#fff; border:1px solid #e5e7eb; border-radius:0.5rem; padding:1rem; box-shadow:0 20px 25px -15px rgba(15,23,42,.4); z-index:40; }
    .custom-date-popover.hidden{ display:none; }
    .custom-date-popover .filter-field{ gap:0.25rem; }
    .note-content-clamp{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; white-space:pre-line; }
    .note-read-more-btn{ margin-top:0.5rem; display:inline-flex; align-items:center; gap:0.35rem; font-size:0.8125rem; color:#2563eb; font-weight:600; }
    .note-read-more-btn:hover{ text-decoration:underline; }
    .note-modal-overlay{ display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:60; justify-content:flex-end; }
    .note-modal-overlay.active{ display:flex; }
    .note-modal-panel{ background:#fff; width:100%; max-width:none; height:100%; overflow-y:auto; padding:2rem 1.75rem; box-shadow:-8px 0 30px rgba(15,23,42,.25); transform:translateX(100%); transition:transform .3s ease-in-out; }
    @media (min-width:768px){
      .note-modal-panel{ width:25vw; max-width:24rem; }
    }
    .note-modal-overlay.active .note-modal-panel{ transform:translateX(0); }
    .note-modal-close{ background:none; border:none; font-size:1.5rem; line-height:1; cursor:pointer; color:#4b5563; }
    .note-attachment-chip{ margin-top:0.5rem; display:inline-flex; align-items:center; gap:0.35rem; font-size:0.8125rem; color:#0f172a; background:#e0f2fe; border-radius:9999px; padding:0.25rem 0.75rem; }
    .sidebar-logo{ max-height:2.5rem; width:auto; }
    .modal-overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; align-items:center; justify-content:center; backdrop-filter: blur(2px); }
    .modal-overlay.active{ display:flex; }
    .modal-content{ background:#fff; padding:1.75rem; border-radius:0.75rem; max-width:420px; width:90%; box-shadow:0 20px 25px -5px rgba(0,0,0,.1), 0 10px 10px -5px rgba(0,0,0,.04); }
    .modal-title{ font-size:1.25rem; font-weight:700; color:#111827; margin-bottom:0.75rem; }
    .modal-message{ color:#6b7280; margin-bottom:1.5rem; line-height:1.5; }
    .modal-buttons{ display:flex; gap:0.75rem; justify-content:flex-end; }
    #toast-notification{ max-width:400px; min-width:280px; }
    #toast-notification.show{ display:block; animation:slideInRight 0.3s ease-out; }
    #toast-notification.hide{ animation:slideOutRight 0.3s ease-in; }
    @keyframes slideInRight{ from{ opacity:0; transform:translateX(100%); } to{ opacity:1; transform:translateX(0); } }
    @keyframes slideOutRight{ from{ opacity:1; transform:translateX(0); } to{ opacity:0; transform:translateX(100%); } }
    .toast-content{ display:flex; align-items:center; gap:0.75rem; padding:1rem 1.25rem; border-radius:0.5rem; box-shadow:0 10px 25px -5px rgba(0,0,0,.15); background:#fff; border-left:4px solid; }
    .toast-content.success{ border-left-color:#10b981; background:#f0fdf4; }
    .toast-content.error{ border-left-color:#ef4444; background:#fef2f2; }
    .toast-icon{ font-size:1.25rem; line-height:1; }
    .toast-message{ flex:1; font-size:0.875rem; font-weight:500; }
    .toast-content.success .toast-message{ color:#166534; }
    .toast-content.error .toast-message{ color:#991b1b; }
    .card-section{ background:#fff; border-radius:0.5rem; padding:1.5rem; margin-bottom:1.5rem; border:1px solid #e5e7eb; }
    .card-title{ font-size:1.125rem; font-weight:600; color:#111827; }
    .stat-card{ background:#fff; border-radius:0.5rem; padding:1.5rem; border:1px solid #e5e7eb; }
    .note-form-footer{ display:flex; flex-direction:column; gap:1rem; margin-top:1.5rem; }
    .note-form-meta{ display:flex; flex-direction:column; gap:1rem; width:100%; }
    .note-meta-group{ display:flex; flex-direction:column; gap:0.5rem; }
    @media (min-width:768px){
      .note-form-footer{ flex-direction:row; align-items:center; }
      .note-form-meta{ flex-direction:row; align-items:center; gap:1.5rem; }
      .note-meta-group{ min-width:220px; }
    }
    .content-header-right{ margin-left:auto; display:flex; align-items:flex-start; justify-content:flex-end; gap:1.5rem; flex-wrap:wrap; flex:1 1 auto; }
    .content-header-title{ min-width:180px; text-align:right; }
    .notification-wrapper{ position:relative; }
    .notification-bell{ position:relative; width:2.5rem; height:2.5rem; border-radius:9999px; border:1px solid #e5e7eb; background:#fff; display:inline-flex; align-items:center; justify-content:center; color:#1f2937; transition:background .2s, color .2s; }
    .notification-bell:hover{ background:#f3f4f6; color:#111827; }
    .notification-badge{ position:absolute; top:-0.15rem; right:-0.15rem; background:#ef4444; color:#fff; font-size:0.65rem; font-weight:700; border-radius:9999px; padding:0.15rem 0.4rem; display:none; }
    .notification-badge.show{ display:inline-flex; }
    .notification-dropdown{ position:absolute; right:0; margin-top:0.75rem; width:20rem; max-height:20rem; overflow-y:auto; background:#fff; border:1px solid #e5e7eb; border-radius:0.75rem; box-shadow:0 20px 30px -15px rgba(15,23,42,.35); z-index:60; display:none; }
    .notification-dropdown.show{ display:block; }
    .notification-header{ padding:0.75rem 1rem; border-bottom:1px solid #f3f4f6; display:flex; align-items:center; justify-content:space-between; }
    .notification-list{ list-style:none; margin:0; padding:0; }
    .notification-item{ padding:0.75rem 1rem; border-bottom:1px solid #f3f4f6; display:flex; flex-direction:column; gap:0.35rem; }
    .notification-item.unread{ background:#f8fafc; }
    .notification-item:last-child{ border-bottom:none; }
    .notification-time{ font-size:0.75rem; color:#9ca3af; }
    .mark-all-read{ font-size:0.75rem; font-weight:600; color:#2563eb; cursor:pointer; background:none; border:none; padding:0; }
    .mark-all-read:hover{ text-decoration:underline; }
    .notification-empty{ padding:1rem; text-align:center; color:#6b7280; font-size:0.875rem; display:none; }
    .settings-page-grid{ display:grid; grid-template-columns:1fr; gap:1.5rem; }
    .settings-group-card{ background:#f9fafb; border:1px solid #e5e7eb; border-radius:0.75rem; padding:1.25rem; display:flex; flex-direction:column; gap:1rem; }
    .settings-group-title{ font-size:1rem; font-weight:600; color:#1f2937; }
    .settings-file-control{ display:flex; flex-direction:column; gap:0.75rem; }
    .settings-file-default{ display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap; }
    .settings-file-active{ display:flex; }
    .settings-file-active.hidden{ display:none; }
    .settings-file-selected{ display:flex; align-items:center; gap:1rem; flex-wrap:wrap; }
    .settings-file-actions{ display:flex; align-items:center; gap:1rem; }
    .settings-file-action{ font-size:0.8125rem; font-weight:600; cursor:pointer; background:none; border:none; padding:0; }
    .settings-file-action.text-blue{ color:#2563eb; }
    .settings-file-action.text-red{ color:#dc2626; }
    .settings-file-action:hover{ text-decoration:underline; }
    .settings-selected-name{ font-size:0.875rem; font-weight:600; color:#1f2937; max-width:12rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    @media (min-width:1024px){
      .settings-page-grid{ grid-template-columns:1fr 1fr; }
    }
    @media (max-width:640px){
      .content-header-right{ width:100%; }
    }
    .settings-preview-box{ width:6rem; height:6rem; border:1px dashed #cbd5f5; border-radius:0.75rem; display:flex; align-items:center; justify-content:center; background:#f8fafc; overflow:hidden; }
    .settings-preview-box img{ width:100%; height:100%; object-fit:contain; }
    .settings-helper{ font-size:0.75rem; color:#6b7280; }
    @media (max-width:640px){
      .custom-date-popover{ width:100%; }
    }
    @media (max-width:768px){
      .card-section, .stat-card{ padding:1rem; }
      #toast-notification{ right:1rem; left:1rem; max-width:none; }
    }
  </style>
</head>
<body class="text-gray-800">
  <!-- Delete Task Modal -->
  <div id="delete-task-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="delete-task-title">
      <h3 id="delete-task-title" class="modal-title">X√°c nh·∫≠n x√≥a</h3>
      <p class="modal-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a task n√†y kh√¥ng? Link ƒë√£ nh·∫≠p s·∫Ω b·ªã x√≥a v√† task s·∫Ω tr·ªü v·ªÅ tr·∫°ng th√°i ch∆∞a ho√†n th√†nh.</p>
      <div class="modal-buttons">
        <button id="cancel-delete-task-btn" class="task-btn btn-cancel">Kh√¥ng</button>
        <button id="confirm-delete-task-btn" class="task-btn" style="background-color:#ef4444; color:#fff;">C√≥</button>
      </div>
    </div>
  </div>

  <!-- Delete Note Modal -->
  <div id="delete-note-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="delete-note-title">
      <h3 id="delete-note-title" class="modal-title">X√°c nh·∫≠n x√≥a ghi ch√∫</h3>
      <p class="modal-message">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ghi ch√∫ n√†y kh√¥ng?</p>
      <div class="modal-buttons">
        <button id="cancel-delete-note-btn" class="task-btn btn-cancel">Kh√¥ng</button>
        <button id="confirm-delete-note-btn" class="task-btn" style="background-color:#ef4444; color:#fff;">C√≥</button>
      </div>
    </div>
  </div>

  <div id="note-detail-modal" class="note-modal-overlay" aria-hidden="true">
    <div class="note-modal-panel" role="dialog" aria-modal="true" aria-labelledby="note-modal-title">
      <div class="flex items-start justify-between gap-6">
        <div>
          <h3 id="note-modal-title" class="text-xl font-semibold text-slate-900">Chi ti·∫øt ghi ch√∫</h3>
          <p class="text-sm text-slate-500 mt-1">Xem to√†n b·ªô n·ªôi dung v√† t·ªáp ƒë√≠nh k√®m.</p>
        </div>
        <button id="note-modal-close" class="note-modal-close" aria-label="ƒê√≥ng">&times;</button>
      </div>
      <div id="note-modal-content" class="mt-6 text-base leading-relaxed text-slate-700 whitespace-pre-line"></div>
      <div id="note-modal-attachment" class="mt-6"></div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast-notification" class="fixed top-4 right-4 z-50 hidden transition-all duration-300 transform translate-x-0"></div>

  <section id="cover-page" class="min-h-screen flex flex-col items-center justify-center bg-sky-100 text-center px-6 py-16">
    <div class="max-w-4xl mx-auto space-y-8">
      <div id="cover-logo-wrapper" class="flex justify-center">
        <a id="cover-logo-link" href="/" aria-label="Trang ch·ªß" class="inline-flex">
          <img id="cover-logo" class="h-24 w-auto hidden" alt="Logo d·ª± √°n" />
        </a>
      </div>
      <h2 id="cover-slogan" class="text-2xl md:text-3xl font-semibold text-blue-800 hidden"></h2>
      <div class="space-y-4">
        <h1 class="text-3xl md:text-4xl font-bold text-blue-900">D·ª± √°n K·∫ø ho·∫°ch D·ªãch v·ª• Marketing Assistant</h1>
        <p class="text-lg text-gray-700 leading-relaxed">Cung c·∫•p m·ªôt l·ªô tr√¨nh (master plan) chi ti·∫øt, A-Z, ƒë·ªÉ x√¢y d·ª±ng v√† ra m·∫Øt d·ªãch v·ª• Marketing Assistant.</p>
        <div class="space-y-1 text-gray-700" id="cover-contacts">
          <p>Qu·∫£n l√Ω d·ª± √°n / K·ªπ thu·∫≠t: <strong id="cover-contact-manager">[Ch∆∞a c·∫≠p nh·∫≠t]</strong></p>
          <p>V·∫≠n h√†nh: <strong id="cover-contact-ops">[Ch∆∞a c·∫≠p nh·∫≠t]</strong></p>
        </div>
      </div>
      <button id="start-plan-btn" class="task-btn btn-complete text-lg px-10 py-3">B·∫ÆT ƒê·∫¶U K·∫æ HO·∫†CH</button>
    </div>
  </section>

  <div id="app-layout" class="flex h-screen overflow-hidden hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar lg:static" aria-label="Thanh ƒëi·ªÅu h∆∞·ªõng">
      <div class="flex h-full flex-col">
        <div class="flex items-center h-16 px-5 border-b border-gray-200 gap-3">
          <a id="sidebar-logo-link" href="/" aria-label="Trang ch·ªß" class="flex-shrink-0 inline-flex">
            <img id="sidebar-logo" class="sidebar-logo hidden" alt="Logo sidebar" />
          </a>
          <button id="close-menu" class="lg:hidden ml-auto text-gray-600 hover:text-gray-900 text-2xl" aria-label="ƒê√≥ng menu">&times;</button>
        </div>
        <div class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-gray-500" id="sidebar-branding-title">Master Plan (A-Z+)</div>
        <nav class="flex-1 p-3 space-y-1 overflow-y-auto">
          <a class="nav-link" href="/tongquan"><span class="emoji">üìä</span><span>T·ªïng Quan</span></a>
          <a class="nav-link" href="/giaidoan1"><span class="emoji">üéØ</span><span>Gƒê 1: N·ªÅn T·∫£ng</span></a>
          <a class="nav-link" href="/giaidoan2"><span class="emoji">üèóÔ∏è</span><span>Gƒê 2: X√¢y D·ª±ng</span></a>
          <a class="nav-link" href="/giaidoan3"><span class="emoji">‚öôÔ∏è</span><span>Gƒê 3: V·∫≠n H√†nh & T·ªëi ∆Øu</span></a>
          <a class="nav-link" href="/giaidoan4"><span class="emoji">üöÄ</span><span>Gƒê 4: Ra M·∫Øt</span></a>
          <a class="nav-link" href="/ghichu"><span class="emoji">üìù</span><span>Ghi Ch√∫ D·ª± √Ån</span></a>
          <a class="nav-link" href="/cai-dat"><span class="emoji">üîß</span><span>C√†i ƒê·∫∑t</span></a>
        </nav>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 relative overflow-y-auto bg-gray-50">
      <!-- Top bar -->
      <header class="sticky top-0 z-20 flex flex-wrap items-center gap-4 px-6 py-3 bg-white border-b border-gray-200">
        <button id="open-menu" class="mobile-menu-button lg:hidden text-gray-600 hover:text-gray-900" aria-label="M·ªü menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
        <div class="content-header-right">
          <div id="notification-wrapper" class="notification-wrapper">
            <button id="notification-bell" class="notification-bell" aria-label="Th√¥ng b√°o" aria-haspopup="true" aria-expanded="false">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
              <span id="notification-badge" class="notification-badge" aria-hidden="true">0</span>
              <span class="sr-only">M·ªü danh s√°ch th√¥ng b√°o</span>
            </button>
            <div id="notification-dropdown" class="notification-dropdown" role="menu" aria-hidden="true">
              <div class="notification-header">
                <span class="text-sm font-semibold text-gray-700">Th√¥ng b√°o</span>
                <button type="button" id="notification-mark-read" class="mark-all-read">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</button>
              </div>
              <ul id="notification-list" class="notification-list" role="list"></ul>
              <div id="notification-empty" class="notification-empty">Kh√¥ng c√≥ th√¥ng b√°o quan tr·ªçng.</div>
            </div>
          </div>
          <div class="flex flex-col items-end gap-1 text-right">
            <div class="text-sm font-medium text-gray-700">Ng√†y Ra M·∫Øt (D-Day)</div>
            <div class="text-base font-bold text-red-600">15/03/2026</div>
            <div id="project-share-info" class="text-xs text-gray-500 hidden leading-snug max-w-xs">
              <span class="font-medium text-gray-600 block">Chia s·∫ª d·ª± √°n</span>
              <span id="project-id-label" class="block text-gray-600"></span>
              <span id="project-share-url" class="block text-blue-600 break-words"></span>
            </div>
          </div>
          <h2 id="current-section-title" class="content-header-title text-base sm:text-lg font-semibold text-gray-800 hidden"></h2>
        </div>
      </header>

      <div class="p-6 max-w-7xl mx-auto">
        <div id="content-sections">
          <!-- Overview -->
          <section id="overview" class="content-section">
            <h2 class="sr-only">T·ªïng Quan</h2>
            <p class="section-subtitle">D√°n link k·∫øt qu·∫£ cho t·ª´ng task r·ªìi b·∫•m ‚ÄúHo√†n Th√†nh‚Äù. H·ªá th·ªëng t·ª± c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô, bi·ªÉu ƒë·ªì, v√† c·∫£nh b√°o deadline.</p>

            <div id="upcoming-deadlines-container" class="card-section hidden">
              <h3 class="card-title text-orange-600">‚ö†Ô∏è Deadline S·∫Øp T·ªõi (Trong 7 ng√†y)</h3>
              <ul id="upcoming-deadlines-list" class="list-disc list-inside space-y-1.5 text-gray-700"></ul>
            </div>
            <div id="overdue-tasks-container" class="card-section hidden">
              <h3 class="card-title text-red-600">üö® Tasks Qu√° H·∫°n</h3>
              <ul id="overdue-tasks-list" class="list-disc list-inside space-y-1.5 text-gray-700"></ul>
            </div>

            <div class="card-section">
              <h3 class="card-title">T·ªïng Ti·∫øn ƒê·ªô (To√†n D·ª± √Ån)</h3>
              <div class="flex items-center justify-between mb-2">
                <div class="flex flex-col">
                  <span class="text-sm font-medium text-gray-600">Ti·∫øn ƒë·ªô</span>
                  <span id="total-progress-text" class="text-sm font-bold text-blue-600">0 / 0 Tasks</span>
                </div>
                <span id="total-progress-percent" class="text-2xl font-bold text-blue-600">0%</span>
              </div>
              <div class="progress-bar"><div id="total-progress-bar" class="progress-bar-inner" style="width:0%"></div></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="stat-card">
                <h3 class="card-title text-center">T·ª∑ L·ªá Ho√†n Th√†nh</h3>
                <div class="chart-container"><canvas id="progressChart"></canvas></div>
              </div>
              <div class="stat-card">
                <h3 class="card-title">Ti·∫øn ƒê·ªô Theo Giai ƒêo·∫°n</h3>
                <div class="space-y-4">
                  <div>
                    <div class="flex justify-between mb-1.5"><span class="text-sm font-medium text-blue-700">Gƒê 1: N·ªÅn T·∫£ng</span><span id="gd1-progress-text" class="text-sm font-medium text-blue-700">0 / 0 (0%)</span></div>
                    <div class="progress-bar"><div id="gd1-progress-bar" class="progress-bar-inner" style="width:0%"></div></div>
                  </div>
                  <div>
                    <div class="flex justify-between mb-1.5"><span class="text-sm font-medium text-green-700">Gƒê 2: X√¢y D·ª±ng</span><span id="gd2-progress-text" class="text-sm font-medium text-green-700">0 / 0 (0%)</span></div>
                    <div class="progress-bar"><div id="gd2-progress-bar" class="progress-bar-inner bg-green-600" style="width:0%"></div></div>
                  </div>
                  <div>
                    <div class="flex justify-between mb-1.5"><span class="text-sm font-medium text-yellow-700">Gƒê 3: V·∫≠n H√†nh</span><span id="gd3-progress-text" class="text-sm font-medium text-yellow-700">0 / 0 (0%)</span></div>
                    <div class="progress-bar"><div id="gd3-progress-bar" class="progress-bar-inner bg-yellow-500" style="width:0%"></div></div>
                  </div>
                  <div>
                    <div class="flex justify-between mb-1.5"><span class="text-sm font-medium text-red-700">Gƒê 4: Ra M·∫Øt</span><span id="gd4-progress-text" class="text-sm font-medium text-red-700">0 / 0 (0%)</span></div>
                    <div class="progress-bar"><div id="gd4-progress-bar" class="progress-bar-inner bg-red-600" style="width:0%"></div></div>
                  </div>
                </div>
              </div>
            </div>

            <div id="note-statistics-card" class="card-section mb-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="card-title">Ghi Ch√∫ Th·ªëng K√™</h3>
                <span id="note-stats-total" class="text-sm text-gray-600">T·ªïng s·ªë ghi ch√∫: 0</span>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <h4 class="text-sm font-semibold text-gray-700 mb-3">Ph√¢n lo·∫°i ghi ch√∫</h4>
                  <div id="note-stats-text" class="space-y-2 text-sm text-gray-600"></div>
                </div>
                <div>
                  <h4 class="text-sm font-semibold text-gray-700 mb-3">Bi·ªÉu ƒë·ªì c·ªôt</h4>
                  <div class="relative h-[350px] max-h-[350px]">
                    <canvas id="note-stats-chart" class="absolute inset-0 w-full h-full"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <div id="activity-log-section" class="card-section">
              <div class="flex items-center justify-between mb-3 flex-wrap gap-3">
                <h3 class="card-title">T·ªïng Quan Ho·∫°t ƒê·ªông</h3>
                <span id="activity-log-count" class="text-sm text-gray-500"></span>
              </div>
              <div class="overflow-x-auto">
                <table class="notes-table activity-table">
                  <thead>
                    <tr>
                      <th style="width:20%">Giai ƒëo·∫°n</th>
                      <th style="width:15%">Tr·∫°ng th√°i</th>
                      <th style="width:35%">T√™n Task</th>
                      <th style="width:15%">Th·ªùi gian ho√†n th√†nh</th>
                      <th style="width:15%">Th·ªùi gian c·∫≠p nh·∫≠t</th>
                    </tr>
                  </thead>
                  <tbody id="activity-log-body"></tbody>
                </table>
              </div>
              <button id="activity-log-toggle" class="task-btn btn-view mt-3 hidden">Xem th√™m</button>
            </div>
          </section>

          <!-- Gƒê1 -->
          <section id="gd1" class="content-section hidden">
            <h2 class="sr-only">Giai ƒêo·∫°n 1: N·ªÅn T·∫£ng &amp; Chi·∫øn L∆∞·ª£c</h2>
            <p class="section-subtitle">M·ª•c ti√™u: ƒê·ªãnh h√¨nh r√µ ch√∫ng ta l√† ai, b√°n g√¨, b√°n cho ai.</p>
            <h3 class="phase-title">Tu·∫ßn 1-2: Nghi√™n C·ª©u & ƒê·ªãnh V·ªã</h3>
            <div id="gd1-week1-2" class="space-y-4"></div>
            <h3 class="phase-title">Tu·∫ßn 3-4: Thi·∫øt K·∫ø D·ªãch V·ª• & Gi√°</h3>
            <div id="gd1-week3-4" class="space-y-4"></div>
          </section>

          <!-- Gƒê2 -->
          <section id="gd2" class="content-section hidden">
            <h2 class="sr-only">Giai ƒêo·∫°n 2: X√¢y D·ª±ng H·∫° T·∫ßng &amp; T√†i S·∫£n</h2>
            <p class="section-subtitle">Website, Funnel, Social, Portfolio, Sales Kit, H·ª£p ƒë·ªìng, N·ªôi dung & Nh√¢n s·ª±.</p>
            <h3 class="phase-title">Tu·∫ßn 5-8: H·∫° T·∫ßng K·ªπ Thu·∫≠t</h3>
            <div id="gd2-week5-8" class="space-y-4"></div>
            <h3 class="phase-title">Tu·∫ßn 9-11: Portfolio & Sales Kit</h3>
            <div id="gd2-week9-11" class="space-y-4"></div>
            <h3 class="phase-title">Tu·∫ßn 12-13: N·ªôi dung & V·∫≠n h√†nh</h3>
            <div id="gd2-week12-13" class="space-y-4"></div>
          </section>

          <!-- Gƒê3 -->
          <section id="gd3" class="content-section hidden">
            <h2 class="sr-only">Giai ƒêo·∫°n 3: V·∫≠n H√†nh &amp; T·ªëi ∆Øu (A-Z+)</h2>
            <p class="section-subtitle">Nh√¢n s·ª±, SOPs, Sales scripts, CSKH, r·ªßi ro, test & k·∫ø ho·∫°ch ra m·∫Øt.</p>
            <h3 class="phase-title">Tu·∫ßn 14-15: Nh√¢n S·ª± & SOPs</h3>
            <div id="gd3-week14-15" class="space-y-4"></div>
            <h3 class="phase-title">Tu·∫ßn 16-17: K·ªãch B·∫£n & R·ªßi Ro</h3>
            <div id="gd3-week16-17" class="space-y-4"></div>
          </section>

          <!-- Gƒê4 -->
          <section id="gd4" class="content-section hidden">
            <h2 class="sr-only">Giai ƒêo·∫°n 4: Ra M·∫Øt (D-Day)</h2>
            <p class="section-subtitle">Build hype, ki·ªÉm tra k·ªπ thu·∫≠t, ra m·∫Øt & t·ªïng k·∫øt.</p>
            <div id="gd4-week18" class="space-y-4"></div>
          </section>

          <!-- Notes -->
          <section id="notes" class="content-section hidden">
            <h2 class="sr-only">Ghi Ch√∫ D·ª± √Ån</h2>
            <div class="card-section">
              <h3 class="card-title">Ghi Ch√∫ M·ªõi</h3>
              <textarea id="notes-textarea" class="notes-textarea" placeholder="Nh·∫≠p ghi ch√∫ c·ªßa b·∫°n h√¥m nay..."></textarea>
              <div class="note-form-footer">
                <div class="note-form-meta">
                  <div class="note-meta-group flex-1">
                    <div class="note-type-dropdown" id="note-type-dropdown">
                      <button type="button" class="note-type-trigger" id="note-type-trigger" aria-haspopup="true" aria-expanded="false">
                        <span id="note-type-trigger-label">Ch·ªçn lo·∫°i ghi ch√∫</span>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                      </button>
                      <div class="note-type-panel" id="note-type-panel" role="menu">
                        <div class="note-type-new">
                          <input type="text" id="note-type-new-input" placeholder="Th√™m lo·∫°i m·ªõi..."/>
                          <button type="button" id="note-type-create-btn" class="task-btn btn-complete">Th√™m</button>
                        </div>
                        <div class="note-type-options" id="note-type-options"></div>
                        <p id="note-type-feedback" class="note-type-feedback hidden"></p>
                        <p class="text-xs text-gray-500 mt-2">T·ªëi ƒëa 10 lo·∫°i ghi ch√∫. X√≥a ho·∫∑c t·∫°o lo·∫°i m·ªõi tr·ª±c ti·∫øp t·∫°i ƒë√¢y.</p>
                      </div>
                    </div>
                    <p class="text-xs text-gray-500">Ch·ªçn lo·∫°i ghi ch√∫ ho·∫∑c t·∫°o m·ªõi ngay trong danh s√°ch.</p>
                  </div>
                  <div class="note-meta-group">
                    <label class="text-sm font-medium text-gray-700" for="note-file-upload">ƒê√≠nh k√®m t·ªáp (t√πy ch·ªçn)</label>
                    <input type="file" id="note-file-upload" class="w-full text-sm text-gray-600" />
                  </div>
                </div>
                <button id="save-note-btn" class="task-btn btn-complete w-full md:w-auto md:px-6 md:ml-auto">üíæ L∆∞u Ghi Ch√∫</button>
              </div>
            </div>

            <hr class="my-6"/>

            <div class="card-section">
              <h3 class="card-title">L·ªçc Ghi Ch√∫</h3>
              <div class="filter-container">
                <div class="filter-field flex-1 min-w-[220px] md:max-w-md">
                  <label class="text-sm font-medium text-gray-700" for="filter-keyword">T·ª´ kh√≥a</label>
                  <input type="text" id="filter-keyword" class="filter-input" placeholder="T√¨m theo n·ªôi dung..." />
                </div>
                <div class="filter-field w-full sm:w-auto min-w-[160px]">
                  <label class="text-sm font-medium text-gray-700" for="filter-type">Lo·∫°i</label>
                  <select id="filter-type" class="filter-input"><option value="">T·∫•t c·∫£ lo·∫°i</option></select>
                </div>
                <div class="filter-field w-full sm:w-auto min-w-[160px] time-filter-wrapper">
                  <label class="text-sm font-medium text-gray-700" for="filter-time">Th·ªùi gian</label>
                  <select id="filter-time" class="filter-input">
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="today">H√¥m nay</option>
                    <option value="yesterday">H√¥m qua</option>
                    <option value="7days">7 ng√†y qua</option>
                    <option value="14days">14 ng√†y qua</option>
                    <option value="thisMonth">Th√°ng n√†y</option>
                    <option value="lastMonth">Th√°ng tr∆∞·ªõc</option>
                    <option value="custom">T√πy ch·ªçn</option>
                  </select>
                  <div id="custom-date-popover" class="custom-date-popover hidden" aria-hidden="true">
                    <div class="filter-field">
                      <label class="text-xs font-medium text-gray-600" for="filter-date-from">T·ª´ ng√†y</label>
                      <input type="date" id="filter-date-from" class="filter-input" />
                    </div>
                    <div class="filter-field mt-3">
                      <label class="text-xs font-medium text-gray-600" for="filter-date-to">ƒê·∫øn ng√†y</label>
                      <input type="date" id="filter-date-to" class="filter-input" />
                    </div>
                  </div>
                </div>
                <div class="filter-actions w-full sm:w-auto">
                  <button id="reset-filter-btn" class="task-btn btn-cancel w-full sm:w-auto">üîÑ Reset</button>
                </div>
              </div>
            </div>

            <div class="card-section">
              <h3 class="card-title">Ghi Ch√∫ ƒê√£ L∆∞u</h3>
              <div class="overflow-x-auto">
                <table class="notes-table">
                  <thead>
                    <tr>
                      <th style="width:15%">Ng√†y Gi·ªù</th>
                      <th style="width:15%">Lo·∫°i</th>
                      <th style="width:60%">N·ªôi Dung</th>
                      <th style="width:10%; text-align:center;">X√≥a</th>
                    </tr>
                  </thead>
                  <tbody id="notes-list-container"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section id="settings" class="content-section hidden">
            <h2 class="sr-only">C√†i ƒê·∫∑t D·ª± √Ån</h2>
            <p class="section-subtitle">T√πy ch·ªânh giao di·ªán v√† th√¥ng tin hi·ªÉn th·ªã tr√™n trang ch·ªß, sidebar.</p>
            <div class="card-section space-y-8">
              <div class="settings-page-grid">
                <div class="space-y-6">
                  <div class="settings-group-card">
                    <h3 class="settings-group-title">Nh·∫≠n di·ªán th∆∞∆°ng hi·ªáu</h3>
                    <div class="settings-file-control">
                      <label class="text-sm font-medium text-gray-700" for="setting-logo-upload">Logo (hi·ªÉn th·ªã ·ªü Cover & Sidebar)</label>
                      <div class="settings-file-default" id="setting-logo-default">
                        <button type="button" id="setting-logo-choose" class="task-btn btn-view px-4 py-2">Ch·ªçn file</button>
                        <span id="setting-logo-filename" class="text-sm text-gray-500">Ch∆∞a ch·ªçn file</span>
                      </div>
                      <div class="settings-file-active hidden" id="setting-logo-active">
                        <div class="settings-file-selected">
                          <div class="settings-preview-box"><img id="logo-preview" alt="Xem tr∆∞·ªõc logo" class="hidden" /></div>
                          <div class="flex flex-col gap-2">
                            <span id="setting-logo-selected-name" class="settings-selected-name"></span>
                            <div class="settings-file-actions">
                              <button type="button" id="setting-logo-change" class="settings-file-action text-blue">ƒê·ªïi</button>
                              <button type="button" id="setting-logo-remove" class="settings-file-action text-red">G·ª°</button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <input type="file" id="setting-logo-upload" class="hidden" accept="image/*" />
                      <p class="settings-helper">T·∫£i logo PNG/SVG t·ªëi ƒëa 2MB.</p>
                      <p class="text-xs text-gray-500 mt-1">L∆∞u √Ω: N·∫øu upload file l·ªói, b·∫°n c·∫ßn c·∫•u h√¨nh CORS tr√™n Firebase Storage.</p>
                    </div>
                    <div class="settings-file-control">
                      <label class="text-sm font-medium text-gray-700" for="setting-favicon-upload">Favicon</label>
                      <div class="settings-file-default" id="setting-favicon-default">
                        <button type="button" id="setting-favicon-choose" class="task-btn btn-view px-4 py-2">Ch·ªçn file</button>
                        <span id="setting-favicon-filename" class="text-sm text-gray-500">Ch∆∞a ch·ªçn file</span>
                      </div>
                      <div class="settings-file-active hidden" id="setting-favicon-active">
                        <div class="settings-file-selected">
                          <div class="settings-preview-box"><img id="favicon-preview" alt="Xem tr∆∞·ªõc favicon" class="hidden" /></div>
                          <div class="flex flex-col gap-2">
                            <span id="setting-favicon-selected-name" class="settings-selected-name"></span>
                            <div class="settings-file-actions">
                              <button type="button" id="setting-favicon-change" class="settings-file-action text-blue">ƒê·ªïi</button>
                              <button type="button" id="setting-favicon-remove" class="settings-file-action text-red">G·ª°</button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <input type="file" id="setting-favicon-upload" class="hidden" accept="image/*" />
                      <p class="settings-helper">Khuy·∫øn ngh·ªã ·∫£nh vu√¥ng (512x512px).</p>
                      <p class="text-xs text-gray-500 mt-1">L∆∞u √Ω: N·∫øu upload file l·ªói, b·∫°n c·∫ßn c·∫•u h√¨nh CORS tr√™n Firebase Storage.</p>
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-700" for="setting-slogan">Slogan</label>
                      <input type="text" id="setting-slogan" class="filter-input" placeholder="V√≠ d·ª•: Think Smart - Grow Faster" />
                    </div>
                  </div>
                  <div class="settings-group-card">
                    <h3 class="settings-group-title">Qu·∫£n l√Ω d·ª± √°n</h3>
                    <div>
                      <label class="text-sm font-medium text-gray-700" for="setting-contact-manager">Qu·∫£n l√Ω d·ª± √°n / K·ªπ thu·∫≠t</label>
                      <input type="text" id="setting-contact-manager" class="filter-input" placeholder="Nh·∫≠p t√™n" />
                    </div>
                    <div>
                      <label class="text-sm font-medium text-gray-700" for="setting-contact-ops">V·∫≠n h√†nh</label>
                      <input type="text" id="setting-contact-ops" class="filter-input" placeholder="Nh·∫≠p t√™n" />
                    </div>
                  </div>
                </div>
                <div class="space-y-6">
                  <div class="settings-group-card">
                    <h3 class="settings-group-title">T√πy ch·ªânh Cover Page</h3>
                    <div class="settings-file-control">
                      <label class="text-sm font-medium text-gray-700" for="setting-cover-image-upload">·∫¢nh n·ªÅn Cover Page</label>
                      <div class="settings-file-default" id="setting-cover-image-default">
                        <button type="button" id="setting-cover-image-choose" class="task-btn btn-view px-4 py-2">Ch·ªçn file</button>
                        <span id="setting-cover-image-filename" class="text-sm text-gray-500">Ch∆∞a ch·ªçn file</span>
                      </div>
                      <div class="settings-file-active hidden" id="setting-cover-image-active">
                        <div class="settings-file-selected">
                          <div class="settings-preview-box"><img id="cover-image-preview" alt="Xem tr∆∞·ªõc ·∫£nh n·ªÅn" class="hidden" /></div>
                          <div class="flex flex-col gap-2">
                            <span id="setting-cover-image-selected-name" class="settings-selected-name"></span>
                            <div class="settings-file-actions">
                              <button type="button" id="setting-cover-image-change" class="settings-file-action text-blue">ƒê·ªïi</button>
                              <button type="button" id="setting-cover-image-remove" class="settings-file-action text-red">G·ª°</button>
                            </div>
                          </div>
                        </div>
                      </div>
                      <input type="file" id="setting-cover-image-upload" class="hidden" accept="image/*" />
                      <p class="settings-helper">·∫¢nh s·∫Ω hi·ªÉn th·ªã to√†n m√†n h√¨nh ·ªü trang Cover.</p>
                      <p class="text-xs text-gray-500 mt-1">L∆∞u √Ω: N·∫øu upload file l·ªói, b·∫°n c·∫ßn c·∫•u h√¨nh CORS tr√™n Firebase Storage.</p>
                    </div>
                    <div class="space-y-2">
                      <label class="text-sm font-medium text-gray-700" for="setting-cover-color">M√†u n·ªÅn Cover Page</label>
                      <input type="color" id="setting-cover-color" class="h-10 w-24 border border-gray-200 rounded" />
                      <p class="settings-helper">N·∫øu kh√¥ng c√≥ ·∫£nh n·ªÅn, m√†u n√†y s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng.</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex justify-end">
                <button id="save-settings-btn" class="task-btn btn-complete px-6">üíæ L∆∞u C√†i ƒê·∫∑t</button>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- =================================================== -->
<!-- CH√åA KH√ìA FIREBASE C·ª¶A B·∫†N ƒê·∫∂T ·ªû ƒê√ÇY -->
<!-- =================================================== -->
<script>
  // 1. D√°n const firebaseConfig c·ªßa b·∫°n v√†o ƒë√¢y
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyDX-XFXDgziXmsHkWHuUH5zlANYm0dehKY",
    authDomain: "vincent-nguyen.firebaseapp.com",
    projectId: "vincent-nguyen",
    storageBucket: "vincent-nguyen.firebasestorage.app",
    messagingSenderId: "15594526987",
    appId: "1:15594526987:web:50e4ecf8548302d598aa0e",
    measurementId: "G-CV6XDV7WSC"
  };

  // 2. Th√™m d√≤ng n√†y ƒë·ªÉ code ch√≠nh c·ªßa b·∫°n (·ªü d∆∞·ªõi) c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c
  window.FIREBASE_CONFIG = firebaseConfig;
</script>
<!-- =================================================== -->


<!-- Code ch√≠nh c·ªßa b·∫°n b·∫Øt ƒë·∫ßu t·ª´ ƒë√¢y (D√≤ng 357) -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

  document.addEventListener('DOMContentLoaded', () => {
    // ========= CONSTANTS =========
    const DAY_MS = 24 * 60 * 60 * 1000;
    const projectPlanStart = new Date(2025, 10, 10);
    const projectLaunchDate = new Date(2026, 2, 15);
    const timelineSegments = [
      { week:'gd1-week1-2', duration:14 },
      { week:'gd1-week3-4', duration:14 },
      { week:'gd2-week5-8', duration:28 },
      { week:'gd2-week9-11', duration:21 },
      { week:'gd2-week12-13', duration:14 },
      { week:'gd3-week14-15', duration:14 },
      { week:'gd3-week16-17', duration:14 },
      { week:'gd4-week18', duration:7 },
    ];
    const defaultCustomTypes = ['√ù t∆∞·ªüng','Vi·ªác c·∫ßn l√†m','R·ªßi ro','Kh√°c'];
    const STATIC_PROJECT_ID = 'thinksmart-main-plan';
    const defaultSettings = {
      slogan: '',
      contactManager: '',
      contactOps: '',
      logoUrl: '',
      logoStoragePath: '',
      faviconUrl: '',
      faviconStoragePath: '',
      coverImageUrl: '',
      coverImageStoragePath: '',
      coverColor: '',
    };
    const NOTE_TRUNCATE_LIMIT = 160;

    // ========= DATA =========
    const tasksData = [
      // Gƒê1 ‚Äì Tu·∫ßn 1-2
      { id:'1.1', phase:'gd1', week:'gd1-week1-2', title:'Task 1.1: Nghi√™n c·ª©u th·ªã tr∆∞·ªùng & ƒê·ªëi th·ªß', deadline:'12/11/2025', owner:'BOD, Marketing', details:[
        'Ph√¢n t√≠ch website, fanpage c·ªßa 5-10 ƒë·ªëi th·ªß (c·∫£ tr·ª±c ti·∫øp v√† gi√°n ti·∫øp).',
        'L·∫≠p file Excel so s√°nh: g√≥i, gi√°, ƒëi·ªÉm m·∫°nh/y·∫øu.',
        'T√¨m kho·∫£ng tr·ªëng th·ªã tr∆∞·ªùng.'
      ]},
      { id:'1.2', phase:'gd1', week:'gd1-week1-2', title:'Task 1.2: Ch·ªët T√™n Th∆∞∆°ng Hi·ªáu & Domain', deadline:'13/11/2025', owner:'BOD, Marketing', details:[
        'Brainstorm 20+ t√™n (d·ªÖ nh·ªõ, chuy√™n nghi·ªáp).',
        'Ki·ªÉm tra domain .vn/.com v√† t√™n tr√™n MXH.',
        'Ch·ªët t√™n v√† mua domain.'
      ]},
      { id:'1.3', phase:'gd1', week:'gd1-week1-2', title:'Task 1.3: Ch·ªët Ch√¢n dung Kh√°ch h√†ng (Target Audience)', deadline:'19/11/2025', owner:'BOD, Marketing', details:[
        'Nh·∫Øm ƒë·∫øn ai (TVV m·ªõi, Leader, GA...)',
        'N·ªói ƒëau ch√≠nh; m·ª•c ti√™u.',
        'V·∫Ω 2-3 persona chi ti·∫øt.'
      ]},
      { id:'1.4', phase:'gd1', week:'gd1-week1-2', title:'Task 1.4: Ph√°t tri·ªÉn B·ªô Nh·∫≠n Di·ªán Th∆∞∆°ng Hi·ªáu (Brand Kit)', deadline:'19/11/2025', owner:'Marketing, Design', details:[
        'Thi·∫øt k·∫ø Logo (ƒë·ªß + icon).',
        'Ch·ªët 3-5 m√†u (m√£ hex).',
        'Ch·ªët font ti√™u ƒë·ªÅ & n·ªôi dung.',
        'L√†m Brand Guideline PDF c∆° b·∫£n.'
      ]},
      // Gƒê1 ‚Äì Tu·∫ßn 3-4
      { id:'1.5', phase:'gd1', week:'gd1-week3-4', title:'Task 1.5: Thi·∫øt k·∫ø G√≥i D·ªãch V·ª•', deadline:'27/11/2025', owner:'Product, Sales', details:[
        'X√¢y 3 g√≥i: C∆° b·∫£n/Chuy√™n nghi·ªáp/Cao c·∫•p.',
        'B·∫£ng so s√°nh h·∫°ng m·ª•c (Fanpage, Web, Video AI, Ads, B√°o c√°o...).',
        'Li·ªát k√™ r√µ "Kh√¥ng bao g·ªìm".'
      ]},
      { id:'1.6', phase:'gd1', week:'gd1-week3-4', title:'Task 1.6: X√¢y d·ª±ng Ch√≠nh S√°ch Gi√° (Pricing)', deadline:'28/11/2025', owner:'Product, Sales, Finance', details:[
        'ƒê·ªãnh gi√° cho 3 g√≥i (li√™n quan 1.5).',
        'File Excel t√≠nh COGS.',
        'M·ª•c ti√™u l·ª£i nhu·∫≠n g·ªôp 30-50%.'
      ]},
      { id:'1.7', phase:'gd1', week:'gd1-week3-4', title:'Task 1.7: X√¢y d·ª±ng Ch√≠nh S√°ch B√°n H√†ng', deadline:'04/12/2025', owner:'Sales', details:[
        'Ch√≠nh s√°ch hoa h·ªìng (Sales/CTV).',
        'Ch√≠nh s√°ch thanh to√°n.',
        'ƒêi·ªÅu kho·∫£n cam k·∫øt/ho√†n ti·ªÅn (ch·∫∑t ch·∫Ω).'
      ]},
      { id:'1.8', phase:'gd1', week:'gd1-week3-4', title:'Task 1.8: Ph√°c th·∫£o Quy tr√¨nh l√†m vi·ªác (Client Workflow)', deadline:'04/12/2025', owner:'Product, Ops', details:[
        'V·∫Ω flowchart Miro/Figma.',
        '5 b∆∞·ªõc: Sales ch·ªët ‚Üí B√†n giao Ops ‚Üí Onboarding ‚Üí Tri·ªÉn khai h·∫±ng th√°ng ‚Üí B√°o c√°o & Gia h·∫°n.'
      ]},

      // Gƒê2 ‚Äì Tu·∫ßn 5-8
      { id:'2.1', phase:'gd2', week:'gd2-week5-8', title:'Task 2.1: X√¢y d·ª±ng Website Ch√≠nh', deadline:'08/01/2026', owner:'Marketing, IT/Dev', details:[
        'Trang: Home, About, D·ªãch v·ª•, B·∫£ng gi√°, Case Studies, Blog, Li√™n h·ªá.',
        'ƒê·∫πp, chuy√™n nghi·ªáp, mobile-first.'
      ]},
      { id:'2.2', phase:'gd2', week:'gd2-week5-8', title:'Task 2.2: X√¢y d·ª±ng Ph·ªÖu Thu Lead (Sales Funnel)', deadline:'15/01/2026', owner:'Marketing', details:[
        'Thi·∫øt k·∫ø Lead Magnet.',
        'Landing Page t·∫∑ng t√†i li·ªáu.',
        'Email t·ª± ƒë·ªông g·ª≠i qu√† & nu√¥i d∆∞·ª°ng.'
      ]},
      { id:'2.3', phase:'gd2', week:'gd2-week5-8', title:'Task 2.3: X√¢y d·ª±ng K√™nh Social Media', deadline:'16/01/2026', owner:'Marketing', details:[
        'T·∫°o & t·ªëi ∆∞u Fanpage/LinkedIn/YouTube.',
        'ƒêƒÉng 3-5 b√†i m·ªìi m·ªói k√™nh.'
      ]},

      // Gƒê2 ‚Äì Tu·∫ßn 9-11
      { id:'2.4A', phase:'gd2', week:'gd2-week9-11', title:'Task 2.4.A: Ch·∫°y d·ª± √°n "Beta" (L·∫•y Case Study TH·∫¨T)', deadline:'29/01/2026', owner:'Marketing, Sales', details:[
        'L√†m th·ª≠ cho 2-3 TVV (mi·ªÖn ph√≠/gi√° r·∫ª).',
        'Thu 3 case Before-After + 1 video testimonial 30-60s.'
      ]},
      { id:'2.4B', phase:'gd2', week:'gd2-week9-11', title:'Task 2.4.B: X√¢y d·ª±ng "G√≥i Demo" (T√†i s·∫£n M·∫´u)', deadline:'29/01/2026', owner:'Marketing, Design', details:[
        'Website m·∫´u cho TVV t∆∞·ªüng t∆∞·ª£ng.',
        'B·ªô 4 b√†i content m·∫´u.',
        '1-2 video AI m·∫´u (HeyGen).',
        'T·ªïng h·ª£p v√†o 1 folder GDrive.'
      ]},
      { id:'2.5', phase:'gd2', week:'gd2-week9-11', title:'Task 2.5: X√¢y d·ª±ng B·ªô T√†i Li·ªáu B√°n H√†ng (Sales Kit)', deadline:'05/02/2026', owner:'Sales, Marketing', details:[
        'Sales Deck: v·∫•n ƒë·ªÅ ‚Üí gi·∫£i ph√°p ‚Üí g√≥i ‚Üí case.',
        'Proposal template.',
        'Folder Sales Kit t·ªïng h·ª£p.'
      ]},
      { id:'2.5C', phase:'gd2', week:'gd2-week9-11', title:'Task 2.5.C: So·∫°n th·∫£o H·ª£p ƒë·ªìng m·∫´u (Ph√°p l√Ω)', deadline:'05/02/2026', owner:'BOD, Legal', details:[
        'Tham v·∫•n lu·∫≠t s∆∞/m·∫´u chu·∫©n.',
        'R√µ scope theo 3 g√≥i; s·ªë l·∫ßn s·ª≠a; mi·ªÖn tr·ª´; b·∫£o m·∫≠t.'
      ]},

      // Gƒê2 ‚Äì Tu·∫ßn 12-13
      { id:'2.6', phase:'gd2', week:'gd2-week12-13', title:'Task 2.6: Vi·∫øt K·ªãch B·∫£n Video B√°n H√†ng', deadline:'12/02/2026', owner:'Marketing', details:[
        'Script (60s) v·∫•n ƒë·ªÅ-gi·∫£i ph√°p.',
        'Script (2-3p) gi·ªõi thi·ªáu d·ªãch v·ª•.',
        'Script (60s) testimonial.',
        'C√≥ l·ªùi tho·∫°i & m√¥ t·∫£ h√¨nh ·∫£nh.'
      ]},
      { id:'2.7', phase:'gd2', week:'gd2-week12-13', title:'Task 2.7: Quay & D·ª±ng 3 Video B√°n H√†ng', deadline:'26/02/2026', owner:'Marketing', details:[
        'S·∫£n xu·∫•t theo k·ªãch b·∫£n 2.6.',
        '∆Øu ti√™n ch·∫•t l∆∞·ª£ng/AI.',
        'Ph·ª• ƒë·ªÅ, nh·∫°c n·ªÅn, CTA r√µ.'
      ]},
      { id:'2.8', phase:'gd2', week:'gd2-week12-13', title:'Task 2.8: X√¢y d·ª±ng K·∫ø ho·∫°ch Tuy·ªÉn d·ª•ng', deadline:'12/02/2026', owner:'HR', details:[
        'X√°c ƒë·ªãnh v·ªã tr√≠ c·ªët l√µi (1 Content, 1 Account).',
        'JD chi ti·∫øt, ƒëƒÉng tin.',
        'Danh s√°ch 3-5 freelancer d·ª± ph√≤ng.'
      ]},
      { id:'2.9', phase:'gd2', week:'gd2-week12-13', title:'Task 2.9: Chu·∫©n b·ªã T√†i s·∫£n Qu·∫£ng c√°o (Ads)', deadline:'12/02/2026', owner:'Marketing, Ads', details:[
        'T·∫°o 3-5 BM d·ª± ph√≤ng.',
        'Pixel + c√†i l√™n Web/Funnel.',
        'X√°c minh domain FB.',
        'Chu·∫©n b·ªã 1-2 t√†i kho·∫£n Ads c√° nh√¢n.'
      ]},
      { id:'2.10', phase:'gd2', week:'gd2-week12-13', title:'Task 2.10: X√¢y d·ª±ng Template V·∫≠n h√†nh (Internal)', deadline:'12/02/2026', owner:'Ops', details:[
        'Folder Template cho KH m·ªõi.',
        'Project Template (Trello/Base).',
        'Template b√°o c√°o th√°ng (Slides).'
      ]},

      // Gƒê3 ‚Äì Tu·∫ßn 14-15
      { id:'3.1', phase:'gd3', week:'gd3-week14-15', title:'Task 3.1: Ho√†n t·∫•t Ph·ªèng v·∫•n & Ch·ªët nh√¢n s·ª±', deadline:'19/02/2026', owner:'HR', details:[
        'Ph·ªèng v·∫•n, ch·ªët Offer.',
        'K√Ω Hƒê lao ƒë·ªông/d·ªãch v·ª•.'
      ]},
      { id:'3.2A', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.A: Thi·∫øt k·∫ø Client Briefing Form', deadline:'19/02/2026', owner:'Ops, Marketing', details:[
        'Google Form l·∫•y th√¥ng tin.',
        'C√¢u h·ªèi: link, TOV, 3 ƒë·ªëi th·ªß, tu·ª≥ ch·ªçn clone AI...'
      ]},
      { id:'3.2.1', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.1: SOP - Onboarding Kh√°ch H√†ng M·ªõi', deadline:'26/02/2026', owner:'Ops', details:[
        'B√†n giao Sales‚ÜíAM; email ch√†o; h·∫πn kick-off; t·∫°o project (2.10); kick-off.'
      ]},
      { id:'3.2.2', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.2: SOP - D·ªãch V·ª• Qu·∫£n l√Ω Content/Website', deadline:'26/02/2026', owner:'Ops, Content', details:[
        'Content plan th√°ng ‚Üí s·∫£n xu·∫•t ‚Üí duy·ªát (‚â§2 l·∫ßn s·ª≠a/b√†i) ‚Üí l√™n l·ªãch ‚Üí b√°o c√°o.'
      ]},
      { id:'3.2.3', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.3: SOP - D·ªãch V·ª• AI Video (HeyGen/ElevenLabs)', deadline:'26/02/2026', owner:'Ops, Media', details:[
        'Nh·∫≠n brief ‚Üí duy·ªát k·ªãch b·∫£n ‚Üí nh√°p (watermark) ‚Üí duy·ªát (ch·ªâ l·ªói) ‚Üí b√†n giao full HD.'
      ]},
      { id:'3.2B', phase:'gd3', week:'gd3-week14-15', title:'Task 3.2.B: Quy tr√¨nh H∆∞·ªõng d·∫´n KH d√πng AI Tools', deadline:'26/02/2026', owner:'Ops, Media', details:[
        '2 video h∆∞·ªõng d·∫´n: quay m·∫´u cho HeyGen; x√°c th·ª±c voice ElevenLabs.'
      ]},
      { id:'3.3', phase:'gd3', week:'gd3-week14-15', title:'Task 3.3: ƒê√†o t·∫°o Nh√¢n s·ª± m·ªõi', deadline:'27/02/2026', owner:'HR, Ops', details:[
        'Training 1 bu·ªïi: 3 g√≥i (1.5), SOPs (3.2.x), k·ªãch b·∫£n sales (3.9).'
      ]},

      // Gƒê3 ‚Äì Tu·∫ßn 16-17
      { id:'3.8A', phase:'gd3', week:'gd3-week16-17', title:'Task 3.8.A: Vi·∫øt Ebook Lead Magnet', deadline:'01/03/2026', owner:'Marketing, Content', details:[
        'Ebook 10-15 trang PDF, ch·ªß ƒë·ªÅ ph√π h·ª£p ph·ªÖu (2.2).'
      ]},
      { id:'3.9', phase:'gd3', week:'gd3-week16-17', title:'Task 3.9: So·∫°n K·ªãch B·∫£n B√°n H√†ng (Sales Scripts)', deadline:'01/03/2026', owner:'Sales', details:[
        'Telesales; email l·∫°nh; x·ª≠ l√Ω t·ª´ ch·ªëi; follow-up 3 l·∫ßn.'
      ]},
      { id:'3.10', phase:'gd3', week:'gd3-week16-17', title:'Task 3.10: So·∫°n B·ªô FAQ', deadline:'01/03/2026', owner:'Marketing, Sales', details:[
        'T·ªëi thi·ªÉu 10 c√¢u: cam k·∫øt lead, ng√¢n s√°ch ads, duy·ªát n·ªôi dung, Hƒê t·ªëi thi·ªÉu...'
      ]},
      { id:'3.11', phase:'gd3', week:'gd3-week16-17', title:'Task 3.11: Thi·∫øt l·∫≠p H·ªá th·ªëng CSKH & SLA', deadline:'05/03/2026', owner:'Ops', details:[
        'Ch·ªët k√™nh h·ªó tr·ª£; so·∫°n SLA; Form ƒëo CSAT h√†ng th√°ng.'
      ]},
      { id:'3.12', phase:'gd3', week:'gd3-week16-17', title:'Task 3.12: K·∫ø ho·∫°ch Qu·∫£n Tr·ªã R·ªßi Ro', deadline:'05/03/2026', owner:'BOD, Ops', details:[
        'Ph∆∞∆°ng √°n cho 5 r·ªßi ro: k·ª≥ v·ªçng, nh√¢n s·ª± ngh·ªâ, ch·∫≠m duy·ªát, tool tƒÉng gi√°, h·∫øt kh√°ch.'
      ]},
      { id:'3.4', phase:'gd3', week:'gd3-week16-17', title:'Task 3.4: Test To√†n b·ªô H·ªá th·ªëng (Internal Testing)', deadline:'06/03/2026', owner:'To√†n ƒë·ªôi', details:[
        'Test Web (2.1), Funnel (2.2), Form li√™n h·ªá, checklist l·ªói.'
      ]},
      { id:'3.5', phase:'gd3', week:'gd3-week16-17', title:'Task 3.5: L√™n K·∫ø Ho·∫°ch N·ªôi Dung Tu·∫ßn L·ªÖ Ra M·∫Øt', deadline:'06/03/2026', owner:'Marketing', details:[
        'L·ªãch 09/03-15/03: k√™nh, n·ªôi dung, media; vi·∫øt s·∫µn 100%.'
      ]},
      { id:'3.6', phase:'gd3', week:'gd3-week16-17', title:'Task 3.6: Chu·∫©n b·ªã Ch∆∞∆°ng tr√¨nh Khuy·∫øn M√£i Ra M·∫Øt', deadline:'06/03/2026', owner:'Sales, Marketing', details:[
        'Ch·ªçn 1 ∆∞u ƒë√£i (v√≠ d·ª• -20% cho 10 KH ƒë·∫ßu); thi·∫øt k·∫ø banner.'
      ]},
      { id:'3.7', phase:'gd3', week:'gd3-week16-17', title:'Task 3.7: R√† so√°t T·ªïng th·ªÉ (Final Check)', deadline:'08/03/2026', owner:'BOD', details:[
        'CEO check: Sales Kit, Hƒê, Website, Ph·ªÖu, Video, Nh√¢n s·ª±, Content ra m·∫Øt.'
      ]},

      // Gƒê4 ‚Äì Tu·∫ßn 18
      { id:'4.1', phase:'gd4', week:'gd4-week18', title:'Task 4.1: Build Hype (tr∆∞·ªõc D-Day)', deadline:'14/03/2026', owner:'Marketing, Sales', details:[
        'Teaser + ƒë·∫øm ng∆∞·ª£c; Sales nh·∫Øn 20 KH ti·ªÅm nƒÉng v·ªÅ ∆∞u ƒë√£i.'
      ]},
      { id:'4.2', phase:'gd4', week:'gd4-week18', title:'Task 4.2: Ki·ªÉm tra K·ªπ thu·∫≠t L·∫ßn Cu·ªëi', deadline:'14/03/2026', owner:'IT, Marketing', details:[
        'Server, website, form ho·∫°t ƒë·ªông; t√†i kho·∫£n Ads & n·∫°p ti·ªÅn s·∫µn s√†ng.'
      ]},
      { id:'4.3', phase:'gd4', week:'gd4-week18', title:'Task 4.3 (D-DAY): Ra M·∫Øt Ch√≠nh Th·ª©c', deadline:'15/03/2026', owner:'To√†n ƒë·ªôi', details:[
        '08:00 g·ª≠i Email Launch; 09:00 ƒëƒÉng b√†i ƒë·ªìng lo·∫°t; 09:01 c·∫£ team chia s·∫ª; tr·ª±c chi·∫øn c·∫£ ng√†y.'
      ]},
      { id:'4.4', phase:'gd4', week:'gd4-week18', title:'Task 4.4: H·ªçp nhanh Cu·ªëi ng√†y', deadline:'15/03/2026', owner:'To√†n ƒë·ªôi', details:[
        '17:00 h·ªçp 30 ph√∫t: t·ªïng k·∫øt lead, KH ch·ªët, v·∫•n ƒë·ªÅ ph√°t sinh.'
      ]},
    ];

    const phaseLabels = {
      gd1: 'Giai ƒêo·∫°n 1: N·ªÅn T·∫£ng & Chi·∫øn L∆∞·ª£c',
      gd2: 'Giai ƒêo·∫°n 2: X√¢y D·ª±ng H·∫° T·∫ßng & T√†i S·∫£n',
      gd3: 'Giai ƒêo·∫°n 3: V·∫≠n H√†nh & T·ªëi ∆Øu',
      gd4: 'Giai ƒêo·∫°n 4: Ra M·∫Øt',
    };

    const taskMap = tasksData.reduce((acc, task) => {
      acc[task.id] = task;
      return acc;
    }, {});

    // ========= STATE =========
    let taskState = {};
    let allTasks = [];
    let notes = [];
    let filteredNotes = [];
    let selectedTimeFilter = 'all';
    let customTypes = defaultCustomTypes.slice();
    let selectedNoteType = customTypes[0] || '';
    let db = null;
    let storage = null;
    let projectRef = null;
    let isProjectReady = false;
    let hasShownSyncWarning = false;
    let progressChart;
    let noteStatsChart = null;
    let taskInputs = [];
    let completeButtons = [];
    let viewButtons = [];
    let debouncedSyncTaskState = () => {};
    let activityLogShowAll = false;
    let currentSettings = { ...defaultSettings };
    let noteDetailModal = null;
    let noteModalContent = null;
    let noteModalAttachment = null;
    let noteModalCloseBtn = null;
    const linkFeedbackTimers = {};
    let noteTypeFeedbackTimer = null;
    const pendingFileRemovals = { logo:false, favicon:false, coverImage:false };
    let logoFileControl = null;
    let faviconFileControl = null;
    let coverImageFileControl = null;
    let notifications = [];
    let notificationState = {};
    let notificationsInitialized = false;

    // ========= HELPERS =========
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

    function formatDate(date){
      const d = String(date.getDate()).padStart(2,'0');
      const m = String(date.getMonth()+1).padStart(2,'0');
      const y = date.getFullYear();
      return `${d}/${m}/${y}`;
    }
    function parseDate(ddmmyyyy){
      if(!ddmmyyyy) return null;
      const [d,m,y] = ddmmyyyy.split('/').map(Number);
      if(!d||!m||!y) return null;
      return new Date(y, m-1, d);
    }
    function normalizeTimestamp(value){
      if(!value) return null;
      if(typeof value === 'string') return value;
      if(value instanceof Date) return value.toISOString();
      if(typeof value === 'number') return new Date(value).toISOString();
      if(typeof value.toDate === 'function'){ return value.toDate().toISOString(); }
      if(typeof value.seconds === 'number'){ return new Date(value.seconds * 1000).toISOString(); }
      return null;
    }
    function formatDateTime(iso){
      if(!iso) return '-';
      const date = new Date(iso);
      if(Number.isNaN(date.getTime())) return '-';
      const d = String(date.getDate()).padStart(2,'0');
      const m = String(date.getMonth()+1).padStart(2,'0');
      const y = date.getFullYear();
      const h = String(date.getHours()).padStart(2,'0');
      const min = String(date.getMinutes()).padStart(2,'0');
      return `${d}/${m}/${y} ${h}:${min}`;
    }
    function formatDateFromISO(iso){
      if(!iso) return '';
      const date = new Date(iso);
      if(Number.isNaN(date.getTime())) return '';
      const d = String(date.getDate()).padStart(2,'0');
      const m = String(date.getMonth()+1).padStart(2,'0');
      const y = date.getFullYear();
      return `${d}/${m}/${y}`;
    }
    function isValidUrl(url){
      if(!url) return false;
      return /^https?:\/\//i.test(url.trim());
    }
    function hasValidCompletionLink(state){
      if(!state) return false;
      const link = (state.link || '').trim();
      return link !== '' && isValidUrl(link);
    }
    function updateCompleteButtonState(taskId){
      const group = document.querySelector(`[data-input-group="${taskId}"]`);
      if(!group) return;
      const btn = group.querySelector('.task-complete-btn');
      if(!btn) return;
      const state = ensureTaskEntry(taskId);
      const enabled = isProjectReady && hasValidCompletionLink(state);
      btn.disabled = !enabled;
    }
    function debounce(fn, wait=300){
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(null, args), wait);
      };
    }
    function escapeHtml(value){
      if(value == null) return '';
      const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;' };
      map['"'] = '&quot;';
      map["'"] = '&#39;';
      return String(value).replace(/[&<>"']/g, ch => map[ch] || ch);
    }
    function getFileNameFromUrl(url){
      if(!url) return '';
      try {
        const parsed = new URL(url, window.location.origin);
        const segments = parsed.pathname.split('/').filter(Boolean);
        return segments.length ? decodeURIComponent(segments.pop()) : '';
      } catch(error){
        const sanitized = url.split('?')[0] || '';
        const parts = sanitized.split('/').filter(Boolean);
        return parts.length ? decodeURIComponent(parts.pop()) : '';
      }
    }
    function readFileAsDataURL(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error || new Error('Kh√¥ng th·ªÉ ƒë·ªçc file'));
        reader.readAsDataURL(file);
      });
    }
    function createSettingsFileControl({ key, input, defaultWrapper, activeWrapper, defaultLabel, selectedLabel, preview, chooseBtn, changeBtn, removeBtn, onPreviewChange }){
      if(!input) return null;

      const updateDefaultLabel = (text) => {
        if(defaultLabel) defaultLabel.textContent = text || 'Ch∆∞a ch·ªçn file';
      };

      const showDefaultState = () => {
        if(defaultWrapper) defaultWrapper.classList.remove('hidden');
        if(activeWrapper) activeWrapper.classList.add('hidden');
        if(preview){
          preview.src = '';
          preview.classList.add('hidden');
        }
        if(selectedLabel) selectedLabel.textContent = '';
      };

      const showActiveState = (name, url) => {
        if(defaultWrapper) defaultWrapper.classList.add('hidden');
        if(activeWrapper) activeWrapper.classList.remove('hidden');
        if(selectedLabel) selectedLabel.textContent = name || 'ƒê√£ ch·ªçn file';
        if(preview && url){
          preview.src = url;
          preview.classList.remove('hidden');
        }
      };

      const triggerPreviewChange = (value) => {
        if(typeof onPreviewChange === 'function') onPreviewChange(value);
      };

      const applyRemoval = () => {
        pendingFileRemovals[key] = true;
        input.value = '';
        updateDefaultLabel('Ch∆∞a ch·ªçn file');
        showDefaultState();
        triggerPreviewChange('');
      };

      const handleFileSelection = (file) => {
        if(!file){
          return;
        }
        const name = file.name || 'file';
        updateDefaultLabel(name);
        readFileAsDataURL(file).then(dataUrl => {
          pendingFileRemovals[key] = false;
          showActiveState(name, dataUrl);
          triggerPreviewChange(dataUrl);
        }).catch(error => {
          console.error('Kh√¥ng th·ªÉ xem tr∆∞·ªõc file:', error);
          applyRemoval();
        });
      };

      input.addEventListener('change', () => {
        const file = input.files && input.files[0];
        if(file){
          handleFileSelection(file);
        } else if(!selectedLabel || !selectedLabel.textContent){
          updateDefaultLabel('Ch∆∞a ch·ªçn file');
        }
      });

      const openPicker = (event) => {
        event.preventDefault();
        input.click();
      };

      if(chooseBtn) chooseBtn.addEventListener('click', openPicker);
      if(changeBtn) changeBtn.addEventListener('click', openPicker);
      if(removeBtn) removeBtn.addEventListener('click', (event) => {
        event.preventDefault();
        applyRemoval();
      });

      return {
        setFromUrl(url){
          const name = getFileNameFromUrl(url) || '';
          if(url){
            pendingFileRemovals[key] = false;
            updateDefaultLabel(name || 'ƒê√£ ch·ªçn file');
            showActiveState(name, url);
            triggerPreviewChange(url);
          } else {
            pendingFileRemovals[key] = false;
            updateDefaultLabel('Ch∆∞a ch·ªçn file');
            showDefaultState();
            triggerPreviewChange('');
          }
        },
        clear(){
          applyRemoval();
        },
      };
    }
    async function uploadAsset(file, folder){
      if(!file) return { url:null, storagePath:'' };
      const safeName = (file.name || `asset-${Date.now()}`).replace(/[^a-zA-Z0-9._-]/g, '_');
      const path = `${folder}/${Date.now()}-${safeName}`;
      if(storage){
        try {
          const ref = storageRef(storage, path);
          await uploadBytes(ref, file);
          const url = await getDownloadURL(ref);
          showToast('Upload successful!', 'success');
          return { url, storagePath: ref.fullPath };
        } catch(error){
          console.error('Upload asset th·∫•t b·∫°i, s·∫Ω d√πng ph∆∞∆°ng √°n d·ª± ph√≤ng.', error);
          showToast('Upload failed. Check permissions.', 'error');
        }
      }
      try {
        const base64 = await readFileAsDataURL(file);
        return { url: base64, storagePath: '' };
      } catch(error){
        console.error('Kh√¥ng th·ªÉ ƒë·ªçc file ƒë√≠nh k√®m:', error);
        showToast(`Kh√¥ng th·ªÉ ƒë·ªçc file "${file.name}"`, 'error');
        return { url:null, storagePath:'' };
      }
    }
    function applyFavicon(url){
      let link = document.querySelector('link[rel="icon"]');
      if(!link){
        link = document.createElement('link');
        link.rel = 'icon';
        document.head.appendChild(link);
      }
      if(url){
        link.href = url;
      } else if(link){
        link.removeAttribute('href');
      }
    }
    function showToast(message, type = 'success'){
      const toastContainer = $('#toast-notification');
      if(!toastContainer) return;
      const icon = type === 'success' ? '‚úÖ' : '‚ùå';
      toastContainer.innerHTML = `<div class="toast-content ${type}"><span class="toast-icon">${icon}</span><span class="toast-message">${escapeHtml(message)}</span></div>`;
      toastContainer.classList.remove('hidden', 'hide');
      toastContainer.classList.add('show');
      setTimeout(() => {
        toastContainer.classList.remove('show');
        toastContainer.classList.add('hide');
        setTimeout(() => {
          toastContainer.classList.add('hidden');
          toastContainer.classList.remove('hide');
          toastContainer.innerHTML = '';
        }, 300);
      }, 3000);
    }
    function renderCoverPage(settings = {}){
      const logoEl = $('#cover-logo');
      const logoWrapper = $('#cover-logo-wrapper');
      const logoLink = $('#cover-logo-link');
      const sloganEl = $('#cover-slogan');
      const managerEl = $('#cover-contact-manager');
      const opsEl = $('#cover-contact-ops');
      const coverSection = $('#cover-page');
      const logoUrl = (settings.logoUrl || '').trim();
      if(logoEl){
        if(logoUrl){
          logoEl.src = logoUrl;
          logoEl.classList.remove('hidden');
          if(logoWrapper) logoWrapper.classList.remove('hidden');
          if(logoLink) logoLink.classList.remove('hidden');
        } else {
          logoEl.src = '';
          logoEl.classList.add('hidden');
          if(logoWrapper) logoWrapper.classList.add('hidden');
          if(logoLink) logoLink.classList.add('hidden');
        }
      }
      if(sloganEl){
        const slogan = (settings.slogan || '').trim();
        if(slogan){
          sloganEl.textContent = slogan;
          sloganEl.classList.remove('hidden');
        } else {
          sloganEl.textContent = '';
          sloganEl.classList.add('hidden');
        }
      }
      if(managerEl){
        const manager = (settings.contactManager || '').trim() || '[Ch∆∞a c·∫≠p nh·∫≠t]';
        managerEl.textContent = manager;
      }
      if(opsEl){
        const ops = (settings.contactOps || '').trim() || '[Ch∆∞a c·∫≠p nh·∫≠t]';
        opsEl.textContent = ops;
      }
      if(coverSection){
        const imageUrl = (settings.coverImageUrl || '').trim();
        const color = (settings.coverColor || '').trim();
        coverSection.style.backgroundImage = '';
        coverSection.style.backgroundSize = '';
        coverSection.style.backgroundPosition = '';
        coverSection.style.backgroundColor = '';
        coverSection.style.backgroundRepeat = '';
        coverSection.classList.remove('cover-has-image','cover-has-color');
        if(imageUrl){
          coverSection.style.backgroundImage = `url('${imageUrl}')`;
          coverSection.style.backgroundSize = 'cover';
          coverSection.style.backgroundPosition = 'center';
          coverSection.style.backgroundRepeat = 'no-repeat';
          coverSection.classList.add('cover-has-image');
        } else if(color){
          coverSection.style.backgroundColor = color;
          coverSection.classList.add('cover-has-color');
        }
      }
    }
    function renderSidebar(settings = {}){
      const logoEl = $('#sidebar-logo');
      const logoLink = $('#sidebar-logo-link');
      const brandingTitle = $('#sidebar-branding-title');
      const logoUrl = (settings.logoUrl || '').trim();
      const hasLogo = !!logoUrl;
      if(logoEl){
        if(hasLogo){
          logoEl.src = logoUrl;
          logoEl.alt = settings.slogan ? `Logo - ${settings.slogan}` : 'Logo d·ª± √°n';
          logoEl.classList.remove('hidden');
        } else {
          logoEl.src = '';
          logoEl.classList.add('hidden');
        }
      }
      if(logoLink){
        logoLink.classList.toggle('hidden', !hasLogo);
      }
      if(brandingTitle){
        brandingTitle.textContent = 'Master Plan (A-Z+)';
      }
    }
    function populateSettingsForm(settings = {}){
      const sloganInput = $('#setting-slogan');
      const managerInput = $('#setting-contact-manager');
      const opsInput = $('#setting-contact-ops');
      const colorInput = $('#setting-cover-color');
      if(sloganInput) sloganInput.value = settings.slogan || '';
      if(managerInput) managerInput.value = settings.contactManager || '';
      if(opsInput) opsInput.value = settings.contactOps || '';
      if(colorInput){
        const color = (settings.coverColor || '').trim();
        colorInput.value = color && /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(color) ? color : '#bae6fd';
      }
      const logoInput = $('#setting-logo-upload'); if(logoInput) logoInput.value = '';
      const faviconInput = $('#setting-favicon-upload'); if(faviconInput) faviconInput.value = '';
      const coverImageInput = $('#setting-cover-image-upload'); if(coverImageInput) coverImageInput.value = '';
      if(logoFileControl) logoFileControl.setFromUrl((settings.logoUrl || '').trim());
      if(faviconFileControl) faviconFileControl.setFromUrl((settings.faviconUrl || '').trim());
      if(coverImageFileControl) coverImageFileControl.setFromUrl((settings.coverImageUrl || '').trim());
    }
    async function saveSettings(){
      if(!ensureProjectReady()) return;
      const sloganInput = $('#setting-slogan');
      const managerInput = $('#setting-contact-manager');
      const opsInput = $('#setting-contact-ops');
      const logoInput = $('#setting-logo-upload');
      const faviconInput = $('#setting-favicon-upload');
      const coverImageInput = $('#setting-cover-image-upload');
      const colorInput = $('#setting-cover-color');

      const nextSettings = { ...currentSettings };
      nextSettings.slogan = sloganInput ? sloganInput.value.trim() : '';
      nextSettings.contactManager = managerInput ? managerInput.value.trim() : '';
      nextSettings.contactOps = opsInput ? opsInput.value.trim() : '';
      const colorValue = colorInput ? (colorInput.value || '').trim() : '';
      nextSettings.coverColor = /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(colorValue) ? colorValue : '';

      if(pendingFileRemovals.logo){
        nextSettings.logoUrl = '';
        nextSettings.logoStoragePath = '';
      } else if(logoInput && logoInput.files && logoInput.files[0]){
        const uploadResult = await uploadAsset(logoInput.files[0], 'branding/logos');
        if(uploadResult.url){
          nextSettings.logoUrl = uploadResult.url;
          nextSettings.logoStoragePath = uploadResult.storagePath || '';
        }
      }

      if(pendingFileRemovals.favicon){
        nextSettings.faviconUrl = '';
        nextSettings.faviconStoragePath = '';
      } else if(faviconInput && faviconInput.files && faviconInput.files[0]){
        const uploadResult = await uploadAsset(faviconInput.files[0], 'branding/favicon');
        if(uploadResult.url){
          nextSettings.faviconUrl = uploadResult.url;
          nextSettings.faviconStoragePath = uploadResult.storagePath || '';
        }
      }

      if(pendingFileRemovals.coverImage){
        nextSettings.coverImageUrl = '';
        nextSettings.coverImageStoragePath = '';
      } else if(coverImageInput && coverImageInput.files && coverImageInput.files[0]){
        const uploadResult = await uploadAsset(coverImageInput.files[0], 'branding/cover');
        if(uploadResult.url){
          nextSettings.coverImageUrl = uploadResult.url;
          nextSettings.coverImageStoragePath = uploadResult.storagePath || '';
        }
      }

      try {
        await updateProjectData({ settings: nextSettings });
        currentSettings = { ...nextSettings };
        renderCoverPage(currentSettings);
        renderSidebar(currentSettings);
        applyFavicon(currentSettings.faviconUrl || '');
        populateSettingsForm(currentSettings);
        showToast('ƒê√£ l∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng', 'success');
      } catch(error){
        console.error('Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t:', error);
        showToast('Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
      }
    }
    function openNoteDetailModal(note){
      if(!noteDetailModal || !noteModalContent || !note) return;
      noteModalContent.textContent = note.content || '';
      if(noteModalAttachment){
        if(note.attachmentUrl){
          const isImage = (note.attachmentMime || '').startsWith('image/');
          const safeName = escapeHtml(note.attachmentName || 'T·ªáp ƒë√≠nh k√®m');
          if(isImage){
            noteModalAttachment.innerHTML = `<div class="space-y-2"><div class="text-sm font-medium text-slate-600">T·ªáp ƒë√≠nh k√®m:</div><img src="${note.attachmentUrl}" alt="${safeName}" class="w-full max-h-96 object-contain rounded-lg border border-slate-200" loading="lazy" /></div>`;
          } else {
            noteModalAttachment.innerHTML = `<div class="space-y-2"><div class="text-sm font-medium text-slate-600">T·ªáp ƒë√≠nh k√®m:</div><a href="${note.attachmentUrl}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 text-blue-600 font-semibold"><span>üìé</span><span>${safeName}</span></a></div>`;
          }
        } else {
          noteModalAttachment.innerHTML = '';
        }
      }
      noteDetailModal.classList.add('active');
      noteDetailModal.setAttribute('aria-hidden','false');
    }
    function closeNoteDetailModal(){
      if(!noteDetailModal) return;
      noteDetailModal.classList.remove('active');
      noteDetailModal.setAttribute('aria-hidden','true');
      if(noteModalContent) noteModalContent.textContent = '';
      if(noteModalAttachment) noteModalAttachment.innerHTML = '';
    }
    function evaluateDeadline(deadline, completed){
      if(!deadline) return null;
      const target = parseDate(deadline);
      if(!target) return null;
      const today = new Date(); today.setHours(0,0,0,0);
      const diff = Math.ceil((target - today) / DAY_MS);
      if(completed){
        return { status:'completed', diffDays: diff, text:'', className:'' };
      }
      if(diff < 0){
        return { status:'danger', diffDays: diff, text:`Qu√° h·∫°n ${Math.abs(diff)} ng√†y`, className:'deadline-danger' };
      }
      if(diff <= 7){
        const text = diff === 0 ? 'H·∫°n h√¥m nay' : `C√≤n ${diff} ng√†y`;
        return { status:'warning', diffDays: diff, text, className:'deadline-warning' };
      }
      return { status:'safe', diffDays: diff, text:`C√≤n ${diff} ng√†y`, className:'deadline-safe' };
    }

    function sanitizeTaskState(){
      const sanitized = {};
      Object.keys(taskState).forEach(id => {
        const state = taskState[id] || {};
        sanitized[id] = {
          completed: !!state.completed,
          link: (state.link || '').trim(),
          completedAt: normalizeTimestamp(state.completedAt),
          updatedAt: normalizeTimestamp(state.updatedAt),
        };
      });
      return sanitized;
    }

    function ensureTaskEntry(id){
      if(!taskState[id]){
        taskState[id] = {
          completed: false,
          link: '',
          completedAt: null,
          updatedAt: null,
        };
      }
      return taskState[id];
    }

    function normalizeTaskState(rawState){
      const defaults = buildDefaultTaskState();
      const normalized = {};
      Object.keys(defaults).forEach(id => {
        const existing = rawState && rawState[id] ? rawState[id] : {};
        normalized[id] = {
          completed: !!existing.completed,
          link: (existing.link || '').trim(),
          completedAt: normalizeTimestamp(existing.completedAt),
          updatedAt: normalizeTimestamp(existing.updatedAt),
        };
      });
      return normalized;
    }

    function showLinkFeedback(taskId, message = '', type = 'error'){
      const feedbackEl = document.querySelector(`[data-link-feedback="${taskId}"]`);
      if(!feedbackEl) return;
      if(linkFeedbackTimers[taskId]){
        clearTimeout(linkFeedbackTimers[taskId]);
        delete linkFeedbackTimers[taskId];
      }
      if(!message){
        feedbackEl.textContent = '';
        feedbackEl.classList.remove('show');
        return;
      }
      feedbackEl.textContent = message;
      feedbackEl.classList.add('show');
      feedbackEl.style.color = type === 'success' ? '#047857' : '#b91c1c';
      linkFeedbackTimers[taskId] = setTimeout(() => {
        feedbackEl.classList.remove('show');
        feedbackEl.textContent = '';
        delete linkFeedbackTimers[taskId];
      }, 2500);
    }

    function showNoteTypeFeedback(message = '', type = 'info'){
      const feedbackEl = $('#note-type-feedback');
      if(!feedbackEl) return;
      if(noteTypeFeedbackTimer){
        clearTimeout(noteTypeFeedbackTimer);
        noteTypeFeedbackTimer = null;
      }
      if(!message){
        feedbackEl.textContent = '';
        feedbackEl.classList.add('hidden');
        return;
      }
      const color = type === 'error' ? '#dc2626' : type === 'success' ? '#047857' : '#1f2937';
      feedbackEl.style.color = color;
      feedbackEl.textContent = message;
      feedbackEl.classList.remove('hidden');
      noteTypeFeedbackTimer = setTimeout(() => {
        feedbackEl.classList.add('hidden');
        feedbackEl.textContent = '';
        noteTypeFeedbackTimer = null;
      }, 2500);
    }
    function computeTaskSchedule(){
      const segmentTimeline = {};
      let cursor = new Date(projectPlanStart);
      timelineSegments.forEach((segment, index) => {
        const start = new Date(cursor);
        let end = new Date(start);
        end.setDate(end.getDate() + segment.duration - 1);
        if(index === timelineSegments.length - 1){
          end = new Date(projectLaunchDate);
        }
        segmentTimeline[segment.week] = { start, end };
        cursor = new Date(end);
        cursor.setDate(cursor.getDate() + 1);
      });

      const tasksByWeek = tasksData.reduce((acc, task) => {
        if(!acc[task.week]) acc[task.week] = [];
        acc[task.week].push(task);
        return acc;
      }, {});

      Object.entries(tasksByWeek).forEach(([week, list]) => {
        const timeline = segmentTimeline[week];
        if(!timeline) return;
        const segmentStart = new Date(timeline.start);
        const segmentEnd = new Date(timeline.end);
        const segmentDuration = Math.max(1, Math.round((segmentEnd - segmentStart) / DAY_MS) + 1);
        const baseDuration = Math.max(1, Math.floor(segmentDuration / list.length));
        let remainder = segmentDuration - baseDuration * list.length;
        let currentStart = new Date(segmentStart);

        list.forEach((task, index) => {
          let duration = baseDuration;
          if(remainder > 0){
            duration += 1;
            remainder -= 1;
          }
          const taskStart = new Date(currentStart);
          let taskEnd = new Date(taskStart);
          if(index === list.length - 1){
            taskEnd = new Date(segmentEnd);
          } else {
            taskEnd.setDate(taskEnd.getDate() + duration - 1);
          }
          task.startDate = formatDate(taskStart);
          task.endDate = formatDate(taskEnd);
          task.deadline = task.endDate;
          task.durationDays = Math.max(1, Math.round((taskEnd - taskStart) / DAY_MS) + 1);
          currentStart = new Date(taskEnd);
          currentStart.setDate(currentStart.getDate() + 1);
        });
      });
    }

    computeTaskSchedule();

    function buildDefaultTaskState(){
      const state = {};
      tasksData.forEach(t => {
        state[t.id] = {
          completed: false,
          link: '',
          completedAt: null,
          updatedAt: null,
        };
      });
      return state;
    }

    taskState = buildDefaultTaskState();

    // ========= RENDER =========
    function createTaskCard(t){
      const card = document.createElement('div');
      card.className = 'task-card';
      card.id = 'task-card-' + t.id;
      card.dataset.phase = t.phase;
      card.dataset.start = t.startDate || '';
      card.dataset.end = t.endDate || '';
      card.innerHTML = `
        <div class="task-header">
          <h4 class="task-title">${t.title}</h4>
          <span id="task-status-${t.id}" class="task-status status-pending">CH∆ØA XONG</span>
        </div>
        <div class="task-details">
          <div class="task-details-label">Chi ti·∫øt:</div>
          <ul class="task-detail-list">${t.details.map(d=>`<li>${d}</li>`).join('')}</ul>
        </div>
        <div class="task-meta">
          <span>B·∫Øt ƒë·∫ßu: <strong>${t.startDate}</strong></span><span>|</span>
          <span>Ho√†n th√†nh d·ª± ki·∫øn: <strong>${t.endDate}</strong></span><span>|</span>
          <span>Th·ªùi l∆∞·ª£ng: ${t.durationDays || 1} ng√†y</span><span>|</span>
          <span>Ph·ª• tr√°ch: ${t.owner}</span>
          <span class="deadline-countdown" data-deadline="${t.deadline}"></span>
        </div>
        <div class="task-action-area">
          <div class="task-input-group" data-input-group="${t.id}">
            <input type="url" class="task-link-input" data-task-id="${t.id}" data-phase="${t.phase}" placeholder="D√°n link (t√†i li·ªáu, file, trang k·∫øt qu·∫£...)"/>
            <button type="button" class="task-btn btn-complete task-complete-btn" data-task-id="${t.id}" disabled>Ho√†n Th√†nh</button>
          </div>
          <div class="task-link-feedback" data-link-feedback="${t.id}"></div>
          <div class="task-completed-actions hidden" data-completed-actions="${t.id}">
            <button type="button" class="task-btn btn-view task-view-btn" data-view-btn="${t.id}" disabled>View</button>
            <div class="edit-dropdown-wrapper">
              <button type="button" class="task-icon-btn" data-dropdown-btn="${t.id}" aria-label="T√πy ch·ªçn ch·ªânh s·ª≠a task">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M16.768 3.768a2 2 0 112.828 2.828L7 19.192 3 21l1.808-4z"></path></svg>
              </button>
              <div class="edit-dropdown-menu" data-dropdown-menu="${t.id}">
                <div class="dropdown-item" data-action="edit" data-task-id="${t.id}"><span>‚úèÔ∏è</span><span>Ch·ªânh s·ª≠a</span></div>
                <div class="dropdown-item delete" data-action="delete" data-task-id="${t.id}"><span>üóëÔ∏è</span><span>X√≥a</span></div>
              </div>
            </div>
          </div>
        </div>`;
      return card;
    }

    function renderTasks(){
      const mounts = {
        'gd1-week1-2': $('#gd1-week1-2'),
        'gd1-week3-4': $('#gd1-week3-4'),
        'gd2-week5-8': $('#gd2-week5-8'),
        'gd2-week9-11': $('#gd2-week9-11'),
        'gd2-week12-13': $('#gd2-week12-13'),
        'gd3-week14-15': $('#gd3-week14-15'),
        'gd3-week16-17': $('#gd3-week16-17'),
        'gd4-week18': $('#gd4-week18'),
      };
      Object.values(mounts).forEach(n => { if(n) n.innerHTML = ''; });
      tasksData.forEach(t => {
        ensureTaskEntry(t.id);
        const m = mounts[t.week];
        if(m) m.appendChild(createTaskCard(t));
      });

      allTasks = $$('.task-link-input').map(input => {
        const card = input.closest('.task-card');
        const deadlineSpan = card ? card.querySelector('.deadline-countdown') : null;
        return {
          id: input.dataset.taskId,
          phase: input.dataset.phase,
          deadline: deadlineSpan ? deadlineSpan.dataset.deadline : null,
          title: card ? card.querySelector('.task-title').textContent : '',
          startDate: card ? card.dataset.start : null,
          endDate: card ? card.dataset.end : null,
        };
      });
    }

    function updateShareLink(){
      const shareInfo = $('#project-share-info');
      const shareUrlEl = $('#project-share-url');
      const idLabel = $('#project-id-label');
      if(shareUrlEl) shareUrlEl.textContent = '';
      if(idLabel) idLabel.textContent = '';
      if(shareInfo){
        shareInfo.classList.add('hidden');
      }
    }

    function ensureProjectReady(showAlert = true){
      if(isProjectReady) return true;
      if(showAlert && !hasShownSyncWarning){
        alert('H·ªá th·ªëng ƒëang k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau √≠t ph√∫t.');
        hasShownSyncWarning = true;
      }
      return false;
    }

    function handleViewLink(id){
      if(!ensureProjectReady(false)) return;
      const state = taskState[id];
      if(state && state.link){
        window.open(state.link, '_blank', 'noopener');
      } else {
        alert('Ch∆∞a c√≥ link ƒë·ªÉ xem cho task n√†y.');
      }
    }

    // ========= UI / LOGIC =========
    const deleteTaskModal = $('#delete-task-modal');
    const confirmDeleteTaskBtn = $('#confirm-delete-task-btn');
    const cancelDeleteTaskBtn = $('#cancel-delete-task-btn');
    const deleteNoteModal = $('#delete-note-modal');
    const confirmDeleteNoteBtn = $('#confirm-delete-note-btn');
    const cancelDeleteNoteBtn = $('#cancel-delete-note-btn');
    noteDetailModal = $('#note-detail-modal');
    noteModalContent = $('#note-modal-content');
    noteModalAttachment = $('#note-modal-attachment');
    noteModalCloseBtn = $('#note-modal-close');

    let currentDeleteTaskId = null;
    let currentDeleteNoteId = null;

    function bindTaskEvents(){
      taskInputs = $$('.task-link-input');
      completeButtons = $$('.task-complete-btn');
      viewButtons = $$('.task-view-btn');

      taskInputs.forEach(inp => {
        const taskId = inp.dataset.taskId;
        ensureTaskEntry(taskId);
        updateCompleteButtonState(taskId);
        inp.addEventListener('input', e => {
          const id = e.target.dataset.taskId;
          const link = e.target.value.trim();
          const state = ensureTaskEntry(id);
          const previous = state.link || '';
          state.link = link;
          showLinkFeedback(id, '');
          updateCompleteButtonState(id);
          if(previous !== link){
            state.updatedAt = new Date().toISOString();
            if(isProjectReady) debouncedSyncTaskState();
            renderActivityLog();
          }
        });
        inp.addEventListener('blur', e => {
          const id = e.target.dataset.taskId;
          const value = e.target.value.trim();
          if(value && !isValidUrl(value)){
            showLinkFeedback(id, 'Link ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng http:// ho·∫∑c https://', 'error');
          }
        });
      });

      completeButtons.forEach(btn => {
        btn.addEventListener('click', e => {
          if(!ensureProjectReady()) return;
          const id = e.currentTarget.dataset.taskId;
          const state = ensureTaskEntry(id);
          if(!hasValidCompletionLink(state)){
            showLinkFeedback(id, 'C·∫ßn nh·∫≠p link h·ª£p l·ªá (http:// ho·∫∑c https://) tr∆∞·ªõc khi ho√†n th√†nh.', 'error');
            return;
          }
          const nowIso = new Date().toISOString();
          state.completed = true;
          state.completedAt = nowIso;
          state.updatedAt = nowIso;
          taskState[id] = state;
          updateUI();
          renderActivityLog();
          syncTaskState();
          showLinkFeedback(id, '');
        });
      });

      viewButtons.forEach(btn => {
        btn.addEventListener('click', e => {
          const id = e.currentTarget.dataset.viewBtn;
          handleViewLink(id);
        });
      });
    }

    function setupDropdowns(){
      $$('[data-dropdown-btn]').forEach(btn => {
        btn.addEventListener('click', function(e){
          e.stopPropagation();
          const id = this.dataset.dropdownBtn;
          const menu = document.querySelector(`[data-dropdown-menu="${id}"]`);
          $$('.edit-dropdown-menu').forEach(m => { if(m !== menu) m.classList.remove('show'); });
          if(menu) menu.classList.toggle('show');
        });
      });

      $$('.dropdown-item').forEach(item => {
        item.addEventListener('click', function(e){
          e.stopPropagation();
          const action = this.dataset.action;
          const id = this.dataset.taskId;
          const menu = this.closest('.edit-dropdown-menu');
          if(menu) menu.classList.remove('show');
          if(action === 'edit') handleEditTask(id);
          else if(action === 'delete') handleDeleteTaskClick(id);
        });
      });

      document.addEventListener('click', () => $$('.edit-dropdown-menu').forEach(m => m.classList.remove('show')));
      document.addEventListener('keydown', (e) => { if(e.key === 'Escape') $$('.edit-dropdown-menu').forEach(m => m.classList.remove('show')); });
    }

    function handleEditTask(id){
      if(!ensureProjectReady()) return;
      const state = ensureTaskEntry(id);
      state.completed = false;
      state.completedAt = null;
      state.updatedAt = new Date().toISOString();
      updateUI();
      renderActivityLog();
      syncTaskState();
      showLinkFeedback(id, '');
      setTimeout(() => {
        const input = document.querySelector(`[data-task-id="${id}"]`);
        if(input){ input.disabled = false; input.focus(); input.select(); }
      }, 80);
    }
    function handleDeleteTaskClick(id){
      if(!ensureProjectReady()) return;
      currentDeleteTaskId = id;
      if(deleteTaskModal){
        deleteTaskModal.classList.add('active');
        deleteTaskModal.setAttribute('aria-hidden','false');
      }
    }
    function confirmDeleteTask(){
      const id = currentDeleteTaskId;
      if(!id || !taskState[id]) return;
      taskState[id] = {
        completed:false,
        link:'',
        completedAt:null,
        updatedAt:new Date().toISOString(),
      };
      updateUI();
      renderActivityLog();
      syncTaskState();
      currentDeleteTaskId = null;
      if(deleteTaskModal){
        deleteTaskModal.classList.remove('active');
        deleteTaskModal.setAttribute('aria-hidden','true');
      }
      showLinkFeedback(id, '');
    }
    function cancelDeleteTask(){
      currentDeleteTaskId = null;
      if(deleteTaskModal){
        deleteTaskModal.classList.remove('active');
        deleteTaskModal.setAttribute('aria-hidden','true');
      }
    }

    function initChart(){
      const canvas = document.getElementById('progressChart');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      progressChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels:['Ho√†n Th√†nh','Ch∆∞a Xong'], datasets:[{ data:[0,0], backgroundColor:['#10b981','#e5e7eb'], hoverOffset:4 }] },
        options: { responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{ legend:{ position:'bottom' } } }
      });
    }

    function calculateDeadlines(){
      const upcomingList = $('#upcoming-deadlines-list');
      const upcomingContainer = $('#upcoming-deadlines-container');
      const overdueList = $('#overdue-tasks-list');
      const overdueContainer = $('#overdue-tasks-container');
      if(!upcomingList || !overdueList) return;

      upcomingList.innerHTML = '';
      overdueList.innerHTML = '';
      let upcomingCount = 0, overdueCount = 0;

      allTasks.forEach(task => {
        const state = ensureTaskEntry(task.id);
        if(!task.deadline) return;
        if(state.completed) return;
        const info = evaluateDeadline(task.deadline, false);
        if(!info) return;
        if(info.status === 'danger'){
          const li = document.createElement('li');
          li.innerHTML = `<b>${task.title}</b>: ${task.deadline} <span class="text-red-600 font-semibold">(${info.text})</span>`;
          overdueList.appendChild(li);
          overdueCount++;
        } else if(info.status === 'warning'){
          const li = document.createElement('li');
          li.innerHTML = `<b>${task.title}</b>: ${task.deadline} <span class="text-orange-600 font-semibold">(${info.text})</span>`;
          upcomingList.appendChild(li);
          upcomingCount++;
        }
      });

      if(upcomingContainer) upcomingContainer.classList.toggle('hidden', upcomingCount === 0);
      if(overdueContainer) overdueContainer.classList.toggle('hidden', overdueCount === 0);
    }

    function renderActivityLog(){
      const tbody = $('#activity-log-body');
      const countLabel = $('#activity-log-count');
      const toggleBtn = $('#activity-log-toggle');
      if(!tbody) return;

      const sanitized = sanitizeTaskState();
      const toTime = (iso) => {
        if(!iso) return 0;
        const time = new Date(iso).getTime();
        return Number.isFinite(time) ? time : 0;
      };
      const entries = Object.keys(sanitized).map(id => {
        const state = sanitized[id];
        const meta = taskMap[id] || {};
        const completedAt = state.completedAt || null;
        const updatedAt = state.updatedAt || null;
        const lastActivity = Math.max(toTime(completedAt), toTime(updatedAt));
        return {
          id,
          title: meta.title || `Task ${id}`,
          phase: meta.phase || '',
          completedAt,
          updatedAt,
          lastActivity,
        };
      }).filter(entry => entry.completedAt || entry.updatedAt).sort((a,b) => b.lastActivity - a.lastActivity);

      const total = entries.length;
      const visibleEntries = activityLogShowAll ? entries : entries.slice(0, 10);

      tbody.innerHTML = '';
      if(visibleEntries.length === 0){
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-6">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o.</td></tr>';
      } else {
        visibleEntries.forEach(entry => {
          const tr = document.createElement('tr');
          const completedTime = toTime(entry.completedAt);
          const updatedTime = toTime(entry.updatedAt);
          let statusText = 'Ch∆∞a ho√†n th√†nh';
          let statusClass = 'text-gray-500';
          if(entry.completedAt){
            if(entry.updatedAt && updatedTime > completedTime){
              statusText = 'ƒêang ch·ªânh s·ª≠a';
              statusClass = 'text-orange-500 font-semibold';
            } else {
              statusText = 'Ho√†n th√†nh';
              statusClass = 'text-green-600 font-semibold';
            }
          }
          tr.innerHTML = `
            <td>${phaseLabels[entry.phase] || entry.phase || '-'}</td>
            <td><span class="${statusClass}">${statusText}</span></td>
            <td><button type="button" class="task-log-link" data-jump-task="${entry.id}">${entry.title}</button></td>
            <td>${entry.completedAt ? formatDateTime(entry.completedAt) : '-'}</td>
            <td>${entry.updatedAt ? formatDateTime(entry.updatedAt) : '-'}</td>`;
          tbody.appendChild(tr);
        });
      }

      if(countLabel){
        if(total === 0){
          countLabel.textContent = 'Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o';
        } else {
          const shown = visibleEntries.length;
          countLabel.textContent = activityLogShowAll ? `ƒêang hi·ªÉn th·ªã ${shown} ho·∫°t ƒë·ªông` : `Hi·ªÉn th·ªã ${shown}/${total} ho·∫°t ƒë·ªông g·∫ßn nh·∫•t`;
        }
      }

      if(toggleBtn){
        if(total > 10 && !activityLogShowAll){
          toggleBtn.classList.remove('hidden');
        } else {
          toggleBtn.classList.add('hidden');
        }
      }
    }

    function updateUI(){
      let total = 0, done = 0;
      const phaseCounts = { gd1:{total:0,completed:0}, gd2:{total:0,completed:0}, gd3:{total:0,completed:0}, gd4:{total:0,completed:0} };

      allTasks.forEach(task => {
        const state = ensureTaskEntry(task.id);
        total++;
        if(phaseCounts[task.phase]) phaseCounts[task.phase].total++;

        const card = document.getElementById('task-card-'+task.id);
        const statusBadge = document.getElementById('task-status-'+task.id);
        const input = document.querySelector(`[data-task-id="${task.id}"]`);
        const inputGroup = document.querySelector(`[data-input-group="${task.id}"]`);
        const actions = document.querySelector(`[data-completed-actions="${task.id}"]`);
        const viewBtn = actions ? actions.querySelector('[data-view-btn]') : null;
        const countdownSpan = card ? card.querySelector('.deadline-countdown') : null;
        const deadlineInfo = evaluateDeadline(task.deadline, state.completed);
        const isOverdueTask = deadlineInfo && deadlineInfo.status === 'danger';

        if(input) input.value = state.link || '';

        if(state.completed){
          done++;
          if(phaseCounts[task.phase]) phaseCounts[task.phase].completed++;
          if(card){ card.classList.add('completed'); card.classList.remove('overdue'); }
          if(statusBadge){ statusBadge.className = 'task-status status-completed'; statusBadge.textContent = 'HO√ÄN TH√ÄNH'; }
          if(inputGroup) inputGroup.classList.add('hidden');
          if(actions) actions.classList.remove('hidden');
          if(input) input.disabled = true;
          if(viewBtn){
            const disabled = !isProjectReady || !hasValidCompletionLink(state);
            viewBtn.disabled = disabled;
            viewBtn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
          }
          if(countdownSpan){
            const completedText = formatDateFromISO(state.completedAt);
            countdownSpan.className = 'deadline-countdown deadline-safe';
            countdownSpan.textContent = completedText ? `Ho√†n th√†nh: ${completedText}` : 'ƒê√£ ho√†n th√†nh';
          }
        } else {
          if(card){
            card.classList.remove('completed');
            if(isOverdueTask) card.classList.add('overdue'); else card.classList.remove('overdue');
          }
          if(statusBadge){
            const statusClass = isOverdueTask ? 'status-overdue' : 'status-pending';
            statusBadge.className = 'task-status ' + statusClass;
            statusBadge.textContent = isOverdueTask ? 'QU√Å H·∫†N' : 'CH∆ØA XONG';
          }
          if(inputGroup) inputGroup.classList.remove('hidden');
          if(actions) actions.classList.add('hidden');
          if(input) input.disabled = false;
          const btn = inputGroup ? inputGroup.querySelector('.task-complete-btn') : null;
          if(btn) btn.disabled = !(isProjectReady && hasValidCompletionLink(state));
          if(viewBtn){
            viewBtn.disabled = true;
            viewBtn.setAttribute('aria-disabled','true');
          }
          if(countdownSpan){
            countdownSpan.className = 'deadline-countdown' + (deadlineInfo ? ` ${deadlineInfo.className}` : '');
            countdownSpan.textContent = deadlineInfo && deadlineInfo.text ? deadlineInfo.text : '';
          }
        }
        updateCompleteButtonState(task.id);
      });

      const totalText = $('#total-progress-text');
      const totalBar = $('#total-progress-bar');
      if(totalText) totalText.textContent = `${done} / ${total} Tasks`;
      if(totalBar) totalBar.style.width = (total > 0 ? (done/total)*100 : 0) + '%';

      ['gd1','gd2','gd3','gd4'].forEach(ph => {
        const d = phaseCounts[ph];
        const pct = d.total > 0 ? (d.completed/d.total)*100 : 0;
        const t = document.getElementById(`${ph}-progress-text`);
        const b = document.getElementById(`${ph}-progress-bar`);
        if(t) t.textContent = `${d.completed} / ${d.total} (${Math.round(pct)}%)`;
        if(b) b.style.width = pct + '%';
      });

      if(progressChart){
        progressChart.data.datasets[0].data = [done, Math.max(0, total - done)];
        progressChart.update();
      }

      const totalPercentEl = $('#total-progress-percent');
      const totalPercent = total > 0 ? Math.round((done / total) * 100) : 0;
      if(totalPercentEl) totalPercentEl.textContent = `${totalPercent}%`;

      calculateDeadlines();
      renderActivityLog();
      renderNoteStatistics();
      refreshNotifications();
    }

    function pushNotification(type, task){
      if(!task) return;
      const now = new Date();
      const owner = (task.owner || '').trim();
      const message = type === 'completed'
        ? `${owner || 'Nh√≥m d·ª± √°n'} ƒë√£ ho√†n th√†nh task: ${task.title}.`
        : `Task: ${task.title} hi·ªán ƒë√£ qu√° h·∫°n.`;
      notifications.unshift({
        id: `${type}-${task.id}-${now.getTime()}`,
        taskId: task.id,
        type,
        message,
        timestamp: now.toISOString(),
        read: false,
      });
      if(notifications.length > 30){
        notifications = notifications.slice(0, 30);
      }
    }

    function renderNotifications(){
      const list = $('#notification-list');
      const emptyState = $('#notification-empty');
      const badge = $('#notification-badge');
      if(!list || !emptyState || !badge) return;

      list.innerHTML = '';
      if(notifications.length === 0){
        emptyState.style.display = 'block';
      } else {
        emptyState.style.display = 'none';
        notifications.forEach(item => {
          const li = document.createElement('li');
          li.className = 'notification-item' + (item.read ? '' : ' unread');
          li.innerHTML = `<div class="text-sm text-gray-700">${escapeHtml(item.message)}</div><div class="notification-time">${formatDateTime(item.timestamp)}</div>`;
          list.appendChild(li);
        });
      }

      const unreadCount = notifications.filter(item => !item.read).length;
      if(unreadCount > 0){
        badge.textContent = unreadCount > 9 ? '9+' : String(unreadCount);
        badge.classList.add('show');
      } else {
        badge.textContent = '0';
        badge.classList.remove('show');
      }
    }

    function refreshNotifications(){
      const silent = !notificationsInitialized;
      tasksData.forEach(task => {
        const state = ensureTaskEntry(task.id);
        const prev = notificationState[task.id] || { completed:false, overdue:false };
        const nowCompleted = !!state.completed;
        const deadlineInfo = evaluateDeadline(task.deadline, nowCompleted);
        const nowOverdue = !nowCompleted && deadlineInfo && deadlineInfo.status === 'danger';
        if(nowCompleted && !prev.completed && !silent){
          pushNotification('completed', task);
        }
        if(nowOverdue && !prev.overdue && !silent){
          pushNotification('overdue', task);
        }
        notificationState[task.id] = { completed: nowCompleted, overdue: nowOverdue };
      });
      notificationsInitialized = true;
      renderNotifications();
    }

    function closeNotificationDropdown(){
      const dropdown = $('#notification-dropdown');
      const bell = $('#notification-bell');
      if(!dropdown || !bell) return;
      dropdown.classList.remove('show');
      dropdown.setAttribute('aria-hidden', 'true');
      bell.setAttribute('aria-expanded', 'false');
    }

    // ========= NOTES =========
    function renderNoteStatistics(){
      const totalEl = $('#note-stats-total');
      if(totalEl) totalEl.textContent = `T·ªïng s·ªë ghi ch√∫: ${notes.length}`;

      const counts = notes.reduce((acc, note) => {
        const type = (note.type || '').trim() || 'Kh√°c';
        acc[type] = (acc[type] || 0) + 1;
        return acc;
      }, {});

      const labels = Object.keys(counts).sort((a, b) => a.localeCompare(b, 'vi'));
      const data = labels.map(label => counts[label]);
      const hasData = labels.length > 0;

      // Update text column
      const textContainer = $('#note-stats-text');
      if(textContainer){
        if(!hasData){
          textContainer.innerHTML = '<div class="text-gray-500 italic">Ch∆∞a c√≥ ghi ch√∫ n√†o.</div>';
        } else {
          textContainer.innerHTML = labels.map((label, index) => {
            const count = data[index];
            return `<div class="flex items-center justify-between py-1.5 px-3 bg-gray-50 rounded-lg hover:bg-blue-50 transition-colors">
              <span class="font-medium text-gray-800">${escapeHtml(label)}</span>
              <span class="text-blue-600 font-semibold">${count}</span>
            </div>`;
          }).join('');
        }
      }

      // Update chart
      const canvas = document.getElementById('note-stats-chart');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const colors = labels.map(() => '#2563eb');

      if(!noteStatsChart){
        noteStatsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'S·ªë ghi ch√∫',
              data,
              backgroundColor: colors,
              borderRadius: 6,
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, ticks: { precision: 0 } },
            },
            plugins: { legend: { display: false } },
          },
        });
      } else {
        noteStatsChart.data.labels = labels;
        noteStatsChart.data.datasets[0].data = data;
        noteStatsChart.data.datasets[0].backgroundColor = colors;
        noteStatsChart.update();
      }
    }

    function renderNotes(){
      const tbody = $('#notes-list-container'); if(!tbody) return;
      tbody.innerHTML = '';
      if(filteredNotes.length === 0){
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-8">Ch∆∞a c√≥ ghi ch√∫ n√†o.</td></tr>';
        return;
      }
      filteredNotes.slice().reverse().forEach(n => {
        const noteId = String(n.id);
        const tr = document.createElement('tr');

        const dateTd = document.createElement('td');
        dateTd.textContent = n.date || '';

        const typeTd = document.createElement('td');
        const typeBadge = document.createElement('span');
        typeBadge.className = 'custom-type-item';
        typeBadge.textContent = n.type || 'Kh√°c';
        typeTd.appendChild(typeBadge);

        const contentTd = document.createElement('td');
        const contentDiv = document.createElement('div');
        contentDiv.className = 'note-content-clamp text-gray-700';
        contentDiv.textContent = n.content || '';
        contentTd.appendChild(contentDiv);

        const hasAttachment = !!(n.attachmentUrl);
        if(hasAttachment){
          const chip = document.createElement('div');
          chip.className = 'note-attachment-chip';
          chip.innerHTML = `<span>üìé</span><span class="font-medium">${escapeHtml(n.attachmentName || 'T·ªáp ƒë√≠nh k√®m')}</span>`;
          contentTd.appendChild(chip);
        }

        const requiresReadMore = (n.content || '').length > NOTE_TRUNCATE_LIMIT || hasAttachment;
        if(requiresReadMore){
          const moreBtn = document.createElement('button');
          moreBtn.type = 'button';
          moreBtn.className = 'note-read-more-btn';
          moreBtn.dataset.noteId = noteId;
          moreBtn.innerHTML = '<span>üîé</span><span>Xem th√™m</span>';
          contentTd.appendChild(moreBtn);
        }

        const deleteTd = document.createElement('td');
        deleteTd.style.textAlign = 'center';
        const deleteBtn = document.createElement('span');
        deleteBtn.className = 'note-delete-btn cursor-pointer';
        deleteBtn.dataset.noteId = noteId;
        deleteBtn.textContent = 'üóëÔ∏è';
        deleteTd.appendChild(deleteBtn);

        tr.appendChild(dateTd);
        tr.appendChild(typeTd);
        tr.appendChild(contentTd);
        tr.appendChild(deleteTd);
        tbody.appendChild(tr);
      });

      $$('.note-delete-btn').forEach(btn => btn.addEventListener('click', e => {
        e.preventDefault();
        currentDeleteNoteId = e.currentTarget.dataset.noteId;
        if(deleteNoteModal){
          deleteNoteModal.classList.add('active');
          deleteNoteModal.setAttribute('aria-hidden','false');
        }
      }));

      $$('.note-read-more-btn').forEach(btn => btn.addEventListener('click', e => {
        e.preventDefault();
        const noteId = e.currentTarget.dataset.noteId;
        const note = notes.find(item => String(item.id) === String(noteId));
        if(note){
          openNoteDetailModal(note);
        }
      }));
    }

    function startOfDayDate(date){
      const d = new Date(date);
      d.setHours(0,0,0,0);
      return d;
    }
    function endOfDayDate(date){
      const d = new Date(date);
      d.setHours(23,59,59,999);
      return d;
    }
    function getTimeRangeDates(range){
      if(!range || range === 'all' || range === 'custom') return null;
      const today = new Date();
      today.setHours(0,0,0,0);
      switch(range){
        case 'today':
          return { from: startOfDayDate(today), to: endOfDayDate(today) };
        case 'yesterday': {
          const y = new Date(today);
          y.setDate(y.getDate() - 1);
          return { from: startOfDayDate(y), to: endOfDayDate(y) };
        }
        case '7days': {
          const start = new Date(today);
          start.setDate(start.getDate() - 6);
          return { from: startOfDayDate(start), to: endOfDayDate(today) };
        }
        case '14days': {
          const start = new Date(today);
          start.setDate(start.getDate() - 13);
          return { from: startOfDayDate(start), to: endOfDayDate(today) };
        }
        case 'thisMonth': {
          const first = new Date(today.getFullYear(), today.getMonth(), 1);
          const last = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          return { from: startOfDayDate(first), to: endOfDayDate(last) };
        }
        case 'lastMonth': {
          const first = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          const last = new Date(today.getFullYear(), today.getMonth(), 0);
          return { from: startOfDayDate(first), to: endOfDayDate(last) };
        }
        default:
          return null;
      }
    }
    function parseDateInput(value, isEnd=false){
      if(!value) return null;
      const date = new Date(value);
      if(Number.isNaN(date.getTime())) return null;
      return isEnd ? endOfDayDate(date) : startOfDayDate(date);
    }
    function toggleCustomDateInputs(){
      const popover = $('#custom-date-popover');
      const fromInput = $('#filter-date-from');
      const toInput = $('#filter-date-to');
      const show = selectedTimeFilter === 'custom';
      if(popover){
        popover.classList.toggle('hidden', !show);
        popover.setAttribute('aria-hidden', show ? 'false' : 'true');
      }
      if(!show){
        if(fromInput) fromInput.value = '';
        if(toInput) toInput.value = '';
      }
    }

    function applyFilters(){
      const type = $('#filter-type');
      const keywordInput = $('#filter-keyword');
      const keywordValue = keywordInput && keywordInput.value ? keywordInput.value.trim() : '';
      const keyword = keywordValue.length >= 4 ? keywordValue.toLowerCase() : '';

      let fromDate = null;
      let toDate = null;
      if(selectedTimeFilter === 'custom'){
        const fromInput = $('#filter-date-from');
        const toInput = $('#filter-date-to');
        fromDate = parseDateInput(fromInput ? fromInput.value : '', false);
        toDate = parseDateInput(toInput ? toInput.value : '', true);
      } else {
        const quickRange = getTimeRangeDates(selectedTimeFilter);
        if(quickRange){
          fromDate = quickRange.from;
          toDate = quickRange.to;
        }
      }

      filteredNotes = notes.filter(n => {
        let noteDate = null;
        if(typeof n.date === 'string'){
          const datePart = n.date.split(' ')[0];
          const parts = datePart.split('/').map(Number);
          if(parts.length === 3 && parts.every(Number.isFinite)){
            const [d, m, y] = parts;
            if(d && m && y){
              noteDate = new Date(y, m - 1, d);
              noteDate.setHours(0,0,0,0);
            }
          }
        }
        if(fromDate && (!noteDate || noteDate < fromDate)) return false;
        if(toDate && (!noteDate || noteDate > toDate)) return false;
        if(type && type.value && n.type !== type.value) return false;
        const content = (n.content || '').toLowerCase();
        if(keyword && !content.includes(keyword)) return false;
        return true;
      });
      renderNotes();
      renderNoteStatistics();
    }
    function resetFilters(){
      const from = $('#filter-date-from'), to = $('#filter-date-to'), type = $('#filter-type'), keywordInput = $('#filter-keyword');
      if(from) from.value = '';
      if(to) to.value = '';
      if(type) type.value = '';
      if(keywordInput) keywordInput.value = '';
      const timeSelect = $('#filter-time');
      selectedTimeFilter = 'all';
      if(timeSelect) timeSelect.value = 'all';
      toggleCustomDateInputs();
      applyFilters();
    }

    async function saveNewNote(){
      if(!ensureProjectReady()) return;
      const textarea = $('#notes-textarea'); if(!textarea) return;
      const content = textarea.value.trim();
      if(!content){ alert('Vui l√≤ng nh·∫≠p n·ªôi dung ghi ch√∫'); return; }
      if(!selectedNoteType){ alert('Vui l√≤ng ch·ªçn lo·∫°i ghi ch√∫'); return; }

      const fileInput = $('#note-file-upload');
      const file = fileInput && fileInput.files ? fileInput.files[0] : null;

      let attachmentUrl = null;
      let attachmentStoragePath = '';
      let attachmentName = '';
      let attachmentMime = '';

      if(file){
        attachmentName = file.name;
        attachmentMime = file.type || '';
        const uploadResult = await uploadAsset(file, 'notes_attachments');
        if(uploadResult.url){
          attachmentUrl = uploadResult.url;
          attachmentStoragePath = uploadResult.storagePath || '';
        }
      }

      const now = new Date();
      const id = now.getTime();
      const date = now.toLocaleString('vi-VN',{ day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });

      notes.push({
        id,
        date,
        type: selectedNoteType,
        content,
        attachmentUrl: attachmentUrl || null,
        attachmentName: attachmentName,
        attachmentMime,
        attachmentStoragePath,
      });

      textarea.value = '';
      if(fileInput) fileInput.value = '';
      applyFilters();
      await updateProjectData({ notes });
      showToast('ƒê√£ l∆∞u ghi ch√∫ th√†nh c√¥ng', 'success');
    }

    async function confirmDeleteNote(){
      if(!currentDeleteNoteId) return;
      const idToRemove = currentDeleteNoteId;
      notes = notes.filter(n => String(n.id) !== String(idToRemove));
      currentDeleteNoteId = null;
      if(deleteNoteModal){
        deleteNoteModal.classList.remove('active');
        deleteNoteModal.setAttribute('aria-hidden','true');
      }
      closeNoteDetailModal();
      applyFilters();
      if(isProjectReady) await updateProjectData({ notes });
    }
    function cancelDeleteNote(){
      currentDeleteNoteId = null;
      if(deleteNoteModal){
        deleteNoteModal.classList.remove('active');
        deleteNoteModal.setAttribute('aria-hidden','true');
      }
    }

    // ========= NOTE TYPE DROPDOWN =========
    function renderNoteTypeDropdown(){
      const dropdown = $('#note-type-dropdown');
      const triggerLabel = $('#note-type-trigger-label');
      const optionsContainer = $('#note-type-options');
      const input = $('#note-type-new-input');
      const createBtn = $('#note-type-create-btn');

      if(triggerLabel){
        triggerLabel.textContent = selectedNoteType ? `Lo·∫°i: ${selectedNoteType}` : 'Ch·ªçn lo·∫°i ghi ch√∫';
      }

      if(optionsContainer){
        optionsContainer.innerHTML = '';
        if(customTypes.length === 0){
          const empty = document.createElement('div');
          empty.className = 'text-sm text-gray-500 py-2';
          empty.textContent = 'Ch∆∞a c√≥ lo·∫°i ghi ch√∫.';
          optionsContainer.appendChild(empty);
        } else {
          customTypes.forEach(type => {
            const option = document.createElement('div');
            option.className = 'note-type-option' + (selectedNoteType === type ? ' active' : '');
            option.setAttribute('data-note-type-option', type);
            option.setAttribute('role','option');
            option.tabIndex = 0;
            option.innerHTML = `<span>${type}</span><button type="button" class="note-type-remove" data-remove-type="${type}" title="X√≥a ${type}">üóëÔ∏è</button>`;
            optionsContainer.appendChild(option);
          });
        }
      }

      const atLimit = customTypes.length >= 10;
      const currentValue = input ? input.value.trim() : '';
      if(input){
        input.disabled = atLimit;
        if(atLimit) input.value = '';
        input.placeholder = atLimit ? 'ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 10 lo·∫°i' : 'Th√™m lo·∫°i m·ªõi...';
      }
      if(createBtn) createBtn.disabled = atLimit || currentValue === '';

      if(atLimit){
        showNoteTypeFeedback('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 10 lo·∫°i ghi ch√∫', 'error');
      } else if(currentValue === ''){
        showNoteTypeFeedback('');
      }

      if(dropdown){
        const trigger = $('#note-type-trigger');
        if(trigger) trigger.setAttribute('aria-expanded', dropdown.classList.contains('open') ? 'true' : 'false');
      }
    }

    function updateTypeFilterOptions(){
      const filterSel = $('#filter-type');
      if(!filterSel) return;
      const previous = filterSel.value;
      filterSel.innerHTML = '<option value="">T·∫•t c·∫£ lo·∫°i</option>';
      customTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        filterSel.appendChild(option);
      });
      if(previous && customTypes.includes(previous)){
        filterSel.value = previous;
      }
    }

    function closeNoteTypeDropdown(){
      const dropdown = $('#note-type-dropdown');
      const trigger = $('#note-type-trigger');
      if(dropdown) dropdown.classList.remove('open');
      if(trigger) trigger.setAttribute('aria-expanded','false');
    }

    async function setSelectedNoteType(type){
      if(!type || !customTypes.includes(type)) return;
      if(selectedNoteType === type) return;
      selectedNoteType = type;
      renderNoteTypeDropdown();
      if(isProjectReady) await updateProjectData({ selectedNoteType });
    }

    async function addNewNoteType(value){
      const name = (value || '').trim();
      if(!name){
        showNoteTypeFeedback('Vui l√≤ng nh·∫≠p t√™n lo·∫°i ghi ch√∫', 'error');
        return;
      }
      const exists = customTypes.some(t => t.toLowerCase() === name.toLowerCase());
      if(exists){
        showNoteTypeFeedback('Lo·∫°i ƒë√£ t·ªìn t·∫°i', 'error');
        return;
      }
      if(customTypes.length >= 10){
        showNoteTypeFeedback('ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 10 lo·∫°i ghi ch√∫', 'error');
        return;
      }
      customTypes.push(name);
      selectedNoteType = name;
      renderNoteTypeDropdown();
      updateTypeFilterOptions();
      closeNoteTypeDropdown();
      const input = $('#note-type-new-input');
      if(input){
        input.value = '';
        const createBtnEl = $('#note-type-create-btn');
        if(createBtnEl) createBtnEl.disabled = true;
      }
      showNoteTypeFeedback(`ƒê√£ th√™m "${name}"`, 'success');
      if(isProjectReady) await updateProjectData({ customTypes, selectedNoteType });
    }

    async function removeNoteType(type){
      if(!customTypes.includes(type)) return;
      if(customTypes.length <= 1){
        alert('C·∫ßn √≠t nh·∫•t 1 lo·∫°i ghi ch√∫');
        return;
      }
      customTypes = customTypes.filter(t => t !== type);
      const fallback = customTypes[0] || defaultCustomTypes[0] || 'Kh√°c';
      notes = notes.map(note => note.type === type ? { ...note, type: fallback } : note);
      if(selectedNoteType === type) selectedNoteType = fallback;
      renderNoteTypeDropdown();
      updateTypeFilterOptions();
      applyFilters();
      showNoteTypeFeedback(`ƒê√£ x√≥a "${type}"`, 'info');
      if(isProjectReady) await updateProjectData({ customTypes, notes, selectedNoteType });
    }

    function bindNoteTypeDropdown(){
      const dropdown = $('#note-type-dropdown');
      const trigger = $('#note-type-trigger');
      const optionsContainer = $('#note-type-options');
      const input = $('#note-type-new-input');
      const createBtn = $('#note-type-create-btn');

      if(trigger){
        trigger.addEventListener('click', e => {
          e.preventDefault();
          if(!dropdown) return;
          dropdown.classList.toggle('open');
          trigger.setAttribute('aria-expanded', dropdown.classList.contains('open') ? 'true' : 'false');
        });
      }

      if(optionsContainer){
        optionsContainer.addEventListener('click', e => {
          const removeBtn = e.target.closest('[data-remove-type]');
          const option = e.target.closest('[data-note-type-option]');
          if(removeBtn){
            e.stopPropagation();
            if(!ensureProjectReady()) return;
            removeNoteType(removeBtn.getAttribute('data-remove-type'));
          } else if(option){
            const type = option.getAttribute('data-note-type-option');
            setSelectedNoteType(type);
            closeNoteTypeDropdown();
          }
        });
      }

      if(createBtn && input){
        createBtn.addEventListener('click', () => {
          if(!ensureProjectReady()) return;
          addNewNoteType(input.value);
        });
        input.addEventListener('input', () => {
          if(createBtn) createBtn.disabled = customTypes.length >= 10 || input.value.trim() === '';
          if(input.value.trim() !== '') showNoteTypeFeedback('');
        });
        input.addEventListener('keypress', e => {
          if(e.key === 'Enter'){
            e.preventDefault();
            if(!ensureProjectReady()) return;
            addNewNoteType(input.value);
          }
        });
      }

      document.addEventListener('click', e => {
        if(dropdown && !dropdown.contains(e.target)){
          closeNoteTypeDropdown();
        }
      });

      document.addEventListener('keydown', e => {
        if(e.key === 'Escape') closeNoteTypeDropdown();
      });
    }

    // ========= NAV =========
    const sectionToPath = {
      overview: '/tongquan',
      gd1: '/giaidoan1',
      gd2: '/giaidoan2',
      gd3: '/giaidoan3',
      gd4: '/giaidoan4',
      notes: '/ghichu',
      settings: '/cai-dat',
    };
    const sectionTitles = {
      overview: 'T·ªïng Quan',
      gd1: 'Giai ƒêo·∫°n 1: N·ªÅn T·∫£ng & Chi·∫øn L∆∞·ª£c',
      gd2: 'Giai ƒêo·∫°n 2: X√¢y D·ª±ng H·∫° T·∫ßng & T√†i S·∫£n',
      gd3: 'Giai ƒêo·∫°n 3: V·∫≠n H√†nh & T·ªëi ∆Øu',
      gd4: 'Giai ƒêo·∫°n 4: Ra M·∫Øt',
      notes: 'Ghi Ch√∫ D·ª± √Ån',
      settings: 'C√†i ƒê·∫∑t D·ª± √Ån',
    };
    const DEFAULT_NAV_HREF = sectionToPath.overview;
    const routeConfig = {
      '/': { layout: 'cover', section: null, navHref: null },
      '/tongquan': { layout: 'app', section: 'overview', navHref: DEFAULT_NAV_HREF },
      '/giaidoan1': { layout: 'app', section: 'gd1', navHref: sectionToPath.gd1 },
      '/giaidoan2': { layout: 'app', section: 'gd2', navHref: sectionToPath.gd2 },
      '/giaidoan3': { layout: 'app', section: 'gd3', navHref: sectionToPath.gd3 },
      '/giaidoan4': { layout: 'app', section: 'gd4', navHref: sectionToPath.gd4 },
      '/ghichu': { layout: 'app', section: 'notes', navHref: sectionToPath.notes },
      '/cai-dat': { layout: 'app', section: 'settings', navHref: sectionToPath.settings },
    };
    let router = null;

    function showSection(id){
      $$('.content-section').forEach(s => s.classList.toggle('hidden', s.id !== id));
      const main = document.querySelector('main');
      if(main) main.scrollTop = 0;
      const header = $('#current-section-title');
      const title = sectionTitles[id] || '';
      if(header){
        if(title){
          header.textContent = title;
          header.classList.remove('hidden');
        } else {
          header.textContent = '';
          header.classList.add('hidden');
        }
      }
    }

    function setLayoutMode(mode){
      const cover = $('#cover-page');
      const app = $('#app-layout');
      const showCover = mode === 'cover';
      if(cover) cover.classList.toggle('hidden', !showCover);
      if(app) app.classList.toggle('hidden', showCover);
      const header = $('#current-section-title');
      if(header){
        if(showCover){
          header.textContent = '';
          header.classList.add('hidden');
        }
      }
    }

    function setActiveNavByHref(href){
      const links = $$('.nav-link');
      links.forEach(link => {
        if(href && link.getAttribute('href') === href){
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    }

    function normalizeRoutePath(pathname){
      if(!pathname) return '/';
      let normalized = pathname;
      const indexSuffix = '/index.html';
      if(normalized.endsWith(indexSuffix)){
        normalized = normalized.slice(0, -indexSuffix.length) || '/';
      }
      if(normalized.length > 1 && normalized.endsWith('/')){
        normalized = normalized.slice(0, -1);
      }
      return normalized || '/';
    }

    function createRouter(config){
      const defaultRoute = config['/'];
      function resolve(pathname){
        const normalized = normalizeRoutePath(pathname);
        if(config[normalized]){
          return { path: normalized, route: config[normalized] };
        }
        return { path: '/', route: defaultRoute };
      }
      function handle(pathname){
        const { path, route } = resolve(pathname);
        if(!route) return path;
        setLayoutMode(route.layout === 'cover' ? 'cover' : 'app');
        if(route.layout === 'app' && route.section){
          showSection(route.section);
        }
        setActiveNavByHref(route.navHref || null);
        return path;
      }
      function navigate(pathname){
        const { path, route } = resolve(pathname);
        if(!route) return;
        const currentPath = normalizeRoutePath(window.location.pathname);
        if(currentPath !== path){
          window.history.pushState({}, '', path);
        }
        handle(path);
      }
      window.addEventListener('popstate', () => handle(window.location.pathname));
      return {
        navigate,
        handleCurrent: () => handle(window.location.pathname),
      };
    }

    function navigateToTask(taskId){
      if(!taskId) return;
      const meta = taskMap[taskId];
      const sectionId = meta ? meta.phase : null;
      if(sectionId){
        const targetPath = sectionToPath[sectionId] || DEFAULT_NAV_HREF;
        if(router){
          router.navigate(targetPath);
        } else {
          setActiveNavByHref(targetPath);
          showSection(sectionId);
        }
      }
      const card = document.getElementById('task-card-' + taskId);
      if(card){
        card.scrollIntoView({ behavior:'smooth', block:'center' });
        card.classList.add('ring-2','ring-offset-2','ring-blue-400');
        setTimeout(() => {
          card.classList.remove('ring-2','ring-offset-2','ring-blue-400');
        }, 2000);
      }
    }

    function bindNav(){
      $$('.nav-link').forEach(link => link.addEventListener('click', e => {
        e.preventDefault();
        const targetPath = link.getAttribute('href');
        if(router && targetPath){
          router.navigate(targetPath);
        }
        if(window.innerWidth < 1024){
          const sidebar = $('#sidebar');
          if(sidebar) sidebar.classList.remove('open');
        }
      }));
      const openBtn = $('#open-menu'), closeBtn = $('#close-menu'), sidebar = $('#sidebar');
      if(openBtn) openBtn.addEventListener('click', e => { e.stopPropagation(); if(sidebar) sidebar.classList.add('open'); });
      if(closeBtn) closeBtn.addEventListener('click', () => { if(sidebar) sidebar.classList.remove('open'); });
      document.addEventListener('click', e => {
        if(window.innerWidth < 1024 && sidebar){
          if(!sidebar.contains(e.target) && e.target !== openBtn && !(openBtn && openBtn.contains(e.target))){
            sidebar.classList.remove('open');
          }
        }
      });
    }

    function ensureProjectId(){
      return STATIC_PROJECT_ID;
    }

    async function updateProjectData(partial){
      if(!projectRef) return;
      try {
        await updateDoc(projectRef, { ...partial, updatedAt: serverTimestamp() });
      } catch(error){
        console.error('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu d·ª± √°n:', error);
      }
    }

    async function syncTaskState(){
      if(!isProjectReady) return;
      await updateProjectData({ taskState: sanitizeTaskState() });
    }

    async function ensureProjectDocument(projectId){
      if(!projectRef) return;
      const snapshot = await getDoc(projectRef);
      if(!snapshot.exists()){
        await setDoc(projectRef, {
          taskState: buildDefaultTaskState(),
          notes: [],
          customTypes: defaultCustomTypes,
          selectedNoteType: defaultCustomTypes[0] || '',
          settings: defaultSettings,
          meta: {
            projectId,
            projectStart: formatDate(projectPlanStart),
            launchDate: formatDate(projectLaunchDate),
            createdAt: serverTimestamp(),
          },
          updatedAt: serverTimestamp(),
        }, { merge:true });
      } else {
        const data = snapshot.data() || {};
        const normalized = normalizeTaskState(data.taskState || {});
        const existing = data.taskState || {};
        let needsUpdate = Object.keys(existing).length !== Object.keys(normalized).length;
        if(!needsUpdate){
          needsUpdate = Object.keys(normalized).some(id => {
            const prev = existing[id] || {};
            const norm = normalized[id];
            return prev.completed !== norm.completed ||
                   (prev.link || '').trim() !== norm.link ||
                   normalizeTimestamp(prev.completedAt) !== norm.completedAt ||
                   normalizeTimestamp(prev.updatedAt) !== norm.updatedAt;
          });
        }
        if(needsUpdate){
          await updateDoc(projectRef, { taskState: normalized, updatedAt: serverTimestamp() });
        }
        if(!data.settings){
          await updateDoc(projectRef, { settings: defaultSettings, updatedAt: serverTimestamp() });
        }
      }
    }

    async function initializeRealtimePersistence(){
      const firebaseConfig = window.FIREBASE_CONFIG;
      if(!firebaseConfig){
        console.error('Thi·∫øu c·∫•u h√¨nh Firebase. Vui l√≤ng g√°n window.FIREBASE_CONFIG.');
        const shareInfo = $('#project-share-info');
        if(shareInfo){
          shareInfo.classList.remove('hidden');
          shareInfo.innerHTML = '<span class="text-red-500">Thi·∫øu c·∫•u h√¨nh Firebase (window.FIREBASE_CONFIG).</span>';
        }
        return;
      }

      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      storage = getStorage(app);
      const projectId = ensureProjectId();
      projectRef = doc(db, 'projects', projectId);
      await ensureProjectDocument(projectId);

      onSnapshot(projectRef, snapshot => {
        if(!snapshot.exists()) return;
        const data = snapshot.data() || {};
        if(!isProjectReady){
          notifications = [];
          notificationState = {};
          notificationsInitialized = false;
        }
        taskState = normalizeTaskState(data.taskState || {});
        notes = Array.isArray(data.notes) ? data.notes.map(note => ({ ...note })) : [];
        customTypes = Array.isArray(data.customTypes) && data.customTypes.length ? data.customTypes.slice(0,10) : defaultCustomTypes.slice();
        if(customTypes.length === 0) customTypes = defaultCustomTypes.slice();
        selectedNoteType = data.selectedNoteType && customTypes.includes(data.selectedNoteType) ? data.selectedNoteType : (customTypes[0] || '');
        filteredNotes = notes.slice();
        currentSettings = { ...defaultSettings, ...(data.settings || {}) };
        isProjectReady = true;
        debouncedSyncTaskState = debounce(syncTaskState, 400);
        renderNoteTypeDropdown();
        updateTypeFilterOptions();
        applyFilters();
        renderCoverPage(currentSettings);
        renderSidebar(currentSettings);
        applyFavicon(currentSettings.faviconUrl || '');
        populateSettingsForm(currentSettings);
        updateUI();
        updateShareLink();
      }, error => {
        console.error('L·ªói ƒë·ªìng b·ªô d·ªØ li·ªáu th·ªùi gian th·ª±c:', error);
      });
    }

    // ========= MODALS WIRING =========
    if(confirmDeleteTaskBtn) confirmDeleteTaskBtn.addEventListener('click', confirmDeleteTask);
    if(cancelDeleteTaskBtn) cancelDeleteTaskBtn.addEventListener('click', cancelDeleteTask);
    if(confirmDeleteNoteBtn) confirmDeleteNoteBtn.addEventListener('click', confirmDeleteNote);
    if(cancelDeleteNoteBtn) cancelDeleteNoteBtn.addEventListener('click', cancelDeleteNote);
    const deleteTaskModalEl = $('#delete-task-modal');
    const deleteNoteModalEl = $('#delete-note-modal');
    if(deleteTaskModalEl) deleteTaskModalEl.addEventListener('click', e => { if(e.target === deleteTaskModalEl) cancelDeleteTask(); });
    if(deleteNoteModalEl) deleteNoteModalEl.addEventListener('click', e => { if(e.target === deleteNoteModalEl) cancelDeleteNote(); });
    if(noteModalCloseBtn) noteModalCloseBtn.addEventListener('click', e => { e.preventDefault(); closeNoteDetailModal(); });
    if(noteDetailModal) noteDetailModal.addEventListener('click', e => { if(e.target === noteDetailModal) closeNoteDetailModal(); });
    document.addEventListener('keydown', e => { if(e.key === 'Escape') closeNoteDetailModal(); });

    // ========= BOOT =========
    router = createRouter(routeConfig);
    renderTasks();
    bindTaskEvents();
    setupDropdowns();
    bindNav();
    initChart();
    updateUI();

    filteredNotes = notes.slice();
    renderNotes();
    renderNoteStatistics();
    renderNoteTypeDropdown();
    bindNoteTypeDropdown();
    updateTypeFilterOptions();
    renderCoverPage(currentSettings);
    renderSidebar(currentSettings);
    applyFavicon(currentSettings.faviconUrl || '');
    populateSettingsForm(currentSettings);

    if(router) router.handleCurrent();

    selectedTimeFilter = 'all';
    toggleCustomDateInputs();
    applyFilters();

    const startPlanBtn = $('#start-plan-btn');
    if(startPlanBtn) startPlanBtn.addEventListener('click', e => {
      e.preventDefault();
      if(router) router.navigate('/tongquan');
    });

    ['#cover-logo-link', '#sidebar-logo-link'].forEach(sel => {
      const link = $(sel);
      if(link){
        link.addEventListener('click', e => {
          e.preventDefault();
          if(router) router.navigate('/');
          if(window.innerWidth < 1024){
            const sidebarEl = $('#sidebar');
            if(sidebarEl) sidebarEl.classList.remove('open');
          }
        });
      }
    });

    const saveNoteBtn = $('#save-note-btn'); if(saveNoteBtn) saveNoteBtn.addEventListener('click', saveNewNote);
    const resetFilterBtn = $('#reset-filter-btn'); if(resetFilterBtn) resetFilterBtn.addEventListener('click', e => { e.preventDefault(); resetFilters(); });
    const filterTypeSelect = $('#filter-type'); if(filterTypeSelect) filterTypeSelect.addEventListener('change', applyFilters);
    const filterTimeSelect = $('#filter-time');
    if(filterTimeSelect){
      filterTimeSelect.addEventListener('change', () => {
        selectedTimeFilter = filterTimeSelect.value || 'all';
        toggleCustomDateInputs();
        applyFilters();
      });
    }
    const keywordInputEl = $('#filter-keyword');
    if(keywordInputEl){
      const triggerKeywordFilter = debounce(() => applyFilters(), 250);
      keywordInputEl.addEventListener('input', () => {
        const value = keywordInputEl.value.trim();
        if(value.length === 0 || value.length >= 4){
          triggerKeywordFilter();
        }
      });
    }
    const filterDateFrom = $('#filter-date-from'); if(filterDateFrom) filterDateFrom.addEventListener('change', () => { if(selectedTimeFilter === 'custom') applyFilters(); });
    const filterDateTo = $('#filter-date-to'); if(filterDateTo) filterDateTo.addEventListener('change', () => { if(selectedTimeFilter === 'custom') applyFilters(); });
    const saveSettingsBtn = $('#save-settings-btn'); if(saveSettingsBtn) saveSettingsBtn.addEventListener('click', async e => { e.preventDefault(); await saveSettings(); });
    const logoUploadInput = $('#setting-logo-upload');
    const logoDefaultWrapper = $('#setting-logo-default');
    const logoActiveWrapper = $('#setting-logo-active');
    const logoFilenameLabel = $('#setting-logo-filename');
    const logoSelectedLabel = $('#setting-logo-selected-name');
    const logoPreviewEl = $('#logo-preview');
    const logoChooseBtn = $('#setting-logo-choose');
    const logoChangeBtn = $('#setting-logo-change');
    const logoRemoveBtn = $('#setting-logo-remove');
    const faviconUploadInput = $('#setting-favicon-upload');
    const faviconDefaultWrapper = $('#setting-favicon-default');
    const faviconActiveWrapper = $('#setting-favicon-active');
    const faviconFilenameLabel = $('#setting-favicon-filename');
    const faviconSelectedLabel = $('#setting-favicon-selected-name');
    const faviconPreviewEl = $('#favicon-preview');
    const faviconChooseBtn = $('#setting-favicon-choose');
    const faviconChangeBtn = $('#setting-favicon-change');
    const faviconRemoveBtn = $('#setting-favicon-remove');
    const coverImageUploadInput = $('#setting-cover-image-upload');
    const coverImageDefaultWrapper = $('#setting-cover-image-default');
    const coverImageActiveWrapper = $('#setting-cover-image-active');
    const coverImageFilenameLabel = $('#setting-cover-image-filename');
    const coverImageSelectedLabel = $('#setting-cover-image-selected-name');
    const coverImagePreviewEl = $('#cover-image-preview');
    const coverImageChooseBtn = $('#setting-cover-image-choose');
    const coverImageChangeBtn = $('#setting-cover-image-change');
    const coverImageRemoveBtn = $('#setting-cover-image-remove');
    const coverColorInput = $('#setting-cover-color');
    const computePreviewSettings = (extra = {}) => {
      const previewSettings = { ...currentSettings };
      if(pendingFileRemovals.logo){
        previewSettings.logoUrl = '';
      } else if(logoUploadInput && logoUploadInput.files && logoUploadInput.files[0] && logoPreviewEl && logoPreviewEl.src){
        previewSettings.logoUrl = logoPreviewEl.src;
      }
      if(pendingFileRemovals.coverImage){
        previewSettings.coverImageUrl = '';
      } else if(coverImageUploadInput && coverImageUploadInput.files && coverImageUploadInput.files[0] && coverImagePreviewEl && coverImagePreviewEl.src){
        previewSettings.coverImageUrl = coverImagePreviewEl.src;
      }
      return { ...previewSettings, ...extra };
    };
    const getPreviewCoverColor = () => (coverColorInput ? coverColorInput.value || '' : currentSettings.coverColor || '');
    logoFileControl = createSettingsFileControl({
      key: 'logo',
      input: logoUploadInput,
      defaultWrapper: logoDefaultWrapper,
      activeWrapper: logoActiveWrapper,
      defaultLabel: logoFilenameLabel,
      selectedLabel: logoSelectedLabel,
      preview: logoPreviewEl,
      chooseBtn: logoChooseBtn,
      changeBtn: logoChangeBtn,
      removeBtn: logoRemoveBtn,
      onPreviewChange: () => {
        renderCoverPage(computePreviewSettings({ coverColor: getPreviewCoverColor() }));
        renderSidebar(computePreviewSettings());
      },
    });
    faviconFileControl = createSettingsFileControl({
      key: 'favicon',
      input: faviconUploadInput,
      defaultWrapper: faviconDefaultWrapper,
      activeWrapper: faviconActiveWrapper,
      defaultLabel: faviconFilenameLabel,
      selectedLabel: faviconSelectedLabel,
      preview: faviconPreviewEl,
      chooseBtn: faviconChooseBtn,
      changeBtn: faviconChangeBtn,
      removeBtn: faviconRemoveBtn,
      onPreviewChange: value => {
        applyFavicon(value || '');
      },
    });
    coverImageFileControl = createSettingsFileControl({
      key: 'coverImage',
      input: coverImageUploadInput,
      defaultWrapper: coverImageDefaultWrapper,
      activeWrapper: coverImageActiveWrapper,
      defaultLabel: coverImageFilenameLabel,
      selectedLabel: coverImageSelectedLabel,
      preview: coverImagePreviewEl,
      chooseBtn: coverImageChooseBtn,
      changeBtn: coverImageChangeBtn,
      removeBtn: coverImageRemoveBtn,
      onPreviewChange: () => {
        renderCoverPage(computePreviewSettings({ coverColor: getPreviewCoverColor() }));
      },
    });
    if(coverColorInput){
      coverColorInput.addEventListener('input', () => {
        renderCoverPage(computePreviewSettings({ coverColor: getPreviewCoverColor() }));
      });
    }
    const activityLogToggleBtn = $('#activity-log-toggle'); if(activityLogToggleBtn) activityLogToggleBtn.addEventListener('click', () => { activityLogShowAll = true; renderActivityLog(); });
    const activityLogBody = $('#activity-log-body'); if(activityLogBody) activityLogBody.addEventListener('click', e => {
      const trigger = e.target.closest('[data-jump-task]');
      if(trigger){
        e.preventDefault();
        navigateToTask(trigger.getAttribute('data-jump-task'));
      }
    });
    const notificationBell = $('#notification-bell');
    const notificationDropdown = $('#notification-dropdown');
    const notificationMarkReadBtn = $('#notification-mark-read');
    if(notificationBell && notificationDropdown){
      notificationBell.addEventListener('click', e => {
        e.preventDefault();
        const isOpen = notificationDropdown.classList.toggle('show');
        notificationDropdown.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
        notificationBell.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      });
    }
    if(notificationMarkReadBtn){
      notificationMarkReadBtn.addEventListener('click', e => {
        e.preventDefault();
        let changed = false;
        notifications.forEach(item => {
          if(!item.read){
            item.read = true;
            changed = true;
          }
        });
        if(changed) renderNotifications();
      });
    }
    document.addEventListener('click', e => {
      if(!notificationDropdown || !notificationBell) return;
      if(!notificationDropdown.classList.contains('show')) return;
      if(notificationDropdown.contains(e.target) || notificationBell.contains(e.target)) return;
      closeNotificationDropdown();
    });
    document.addEventListener('keydown', e => {
      if(e.key === 'Escape') closeNotificationDropdown();
    });

    renderNotifications();

    initializeRealtimePersistence();
  });
  </script>
</body>
</html>


